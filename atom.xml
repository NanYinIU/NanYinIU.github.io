<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>NanYinçš„åšå®¢</title>
  
  <subtitle>è®°å½•ç”Ÿæ´»ç‚¹æ»´</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://nanyiniu.github.io/"/>
  <updated>2020-03-28T11:32:18.491Z</updated>
  <id>https://nanyiniu.github.io/</id>
  
  <author>
    <name>NanYin</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</title>
    <link href="https://nanyiniu.github.io/2020/03/29/%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    <id>https://nanyiniu.github.io/2020/03/29/çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ/</id>
    <published>2020-03-29T00:00:00.000Z</published>
    <updated>2020-03-28T11:32:18.491Z</updated>
    
    <content type="html"><![CDATA[<h1 id="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</h1><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20200328192955.png" alt="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"></p><p>ä¸Šå›¾å±•ç¤ºäº†çº¿ç¨‹ä»åˆ›å»ºåˆ°ç»“æŸçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ,ä¸‹é¢ä»çŠ¶æ€å’Œæ§åˆ¶ä¸¤ä¸ªæ–¹é¢åˆ†è§£å›¾ä¸­çš„å†…å®¹</p><h2 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h2><p>çº¿ç¨‹å…·æœ‰5ä¸­åŸºæœ¬çš„çŠ¶æ€:</p><ol><li>NEW(æ–°å»ºçŠ¶æ€): åˆ›å»ºçº¿ç¨‹,è¿˜æœªå¯åŠ¨</li><li>RUNNABLE(å°±ç»ªçŠ¶æ€): å¯è¿è¡ŒçŠ¶æ€,ä½†è¿˜æœªè·å¾—æ—¶é—´ç‰‡,ç­‰å¾…æ‰§è¡Œ</li><li>RUNNING(æ‰§è¡ŒçŠ¶æ€): è¿è¡ŒçŠ¶æ€,åœ¨å°±ç»ªçŠ¶æ€è·å¾—äº†æ—¶é—´ç‰‡,è¿›å…¥è¿è¡ŒçŠ¶æ€</li><li>BLOCKED(é˜»å¡çŠ¶æ€):å½“æŸäº›æƒ…å†µä¸‹,çº¿ç¨‹è¢«é˜»æ­¢è¿è¡Œ,è¿›å…¥é˜»å¡çŠ¶æ€,é˜»å¡çš„çŠ¶æ€å¯åˆ†ä¸ºä¸‰ç§:<ul><li>ç¬¬ä¸€ç§ä¸ºæ‰§è¡Œäº†<code>wait()</code>åä¼šè¿›å…¥æ”¾å…¥çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ä¸­,è¿™ç§æƒ…å†µå«ç­‰å¾…é˜»å¡.</li><li>ç¬¬äºŒç§ä¸ºç­‰å¾…è·å–<code>synchronized()</code>åŒæ­¥é”æ—¶,ä¼šè®²çº¿ç¨‹æ”¾å…¥åŒæ­¥é”é˜Ÿåˆ—ä¸­,ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ<code>synchronized</code>ä¸­çš„å†…å®¹,è¿™ç§æƒ…å†µå«åŒæ­¥é˜»å¡.</li><li>ç¬¬ä¸‰ç§ä¸ºæ‰§è¡Œäº†<code>sleep()</code>æˆ–<code>join()</code>æ—¶,å’Œ<code>wait()</code>ä¸åŒ,å®ƒ<strong>ä¸ä¼šé‡Šæ”¾</strong>å¯¹è±¡é”.</li></ul></li><li>TERMINATED(ç»ˆæ­¢çŠ¶æ€):å½“çº¿ç¨‹æ­£å¸¸ç»“æŸæˆ–å¼‚å¸¸é€€å‡ºæ—¶,ä¼šåˆ°è¾¾ç»ˆæ­¢çŠ¶æ€</li></ol><h2 id="çº¿ç¨‹æ–¹æ³•"><a href="#çº¿ç¨‹æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ–¹æ³•"></a>çº¿ç¨‹æ–¹æ³•</h2><ul><li>run/start<br>  éœ€è¦å¹¶è¡Œå¤„ç†çš„ä»£ç æ”¾åœ¨<code>run()</code>æ–¹æ³•ä¸­ï¼Œ<code>start()</code>æ–¹æ³•å¯åŠ¨çº¿ç¨‹å°†è‡ªåŠ¨è°ƒç”¨ <code>run()</code> æ–¹æ³•ï¼Œè¿™æ˜¯ç”±Javaçš„å†…å­˜æœºåˆ¶è§„å®šçš„ã€‚å¹¶ä¸”<code>run()</code>æ–¹æ³•å¿…é¡»æ˜¯publicè®¿é—®æƒé™ï¼Œè¿”å›å€¼ç±»å‹ä¸ºvoidã€‚</li><li>wait<br>  å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œå¹¶é‡Šæ”¾å¯¹è±¡é”æ ‡å¿—ï¼Œè®©å…¶ä»–çº¿ç¨‹å¯ä»¥è¿›å…¥<code>synchronized</code>æ•°æ®å—ï¼Œå½“å‰çº¿ç¨‹è¢«æ”¾å…¥å¯¹è±¡ç­‰å¾…æ± ä¸­</li><li>nodify/nodifyAll<br>  å”¤é†’ç­‰å¾…(wait)çš„çº¿ç¨‹</li><li>sleep<br>  ä¼‘çœ ä¸€æ®µæ—¶é—´åï¼Œä¼šè‡ªåŠ¨å”¤é†’ã€‚ä½†å®ƒå¹¶ä¸é‡Šæ”¾å¯¹è±¡é”ã€‚ä¹Ÿå°±æ˜¯å¦‚æœæœ‰ <code>synchronized</code>åŒæ­¥å—ï¼Œå…¶ä»–çº¿ç¨‹ä»ç„¶ä¸èƒ½è®¿é—®å…±äº«æ•°æ®ã€‚æ³¨æ„è¯¥æ–¹æ³•è¦æ•è·å¼‚å¸¸</li><li>join<br>  å½“å‰çº¿ç¨‹åœä¸‹æ¥ç­‰å¾…ï¼Œç›´è‡³å¦ä¸€ä¸ªè°ƒç”¨joinæ–¹æ³•çš„çº¿ç¨‹ç»ˆæ­¢ï¼Œçº¿ç¨‹åœ¨è¢«æ¿€æ´»åä¸ä¸€å®šé©¬ä¸Šå°±è¿è¡Œï¼Œè€Œæ˜¯è¿›å…¥åˆ°å¯è¿è¡Œçº¿ç¨‹çš„é˜Ÿåˆ—ä¸­</li><li>yield<br>  åœæ­¢å½“å‰çº¿ç¨‹ï¼Œè®©åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆyield()æ–¹æ³•å°†ä¸ä¼šèµ·ä½œç”¨</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ&quot;&gt;&lt;a href=&quot;#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ&quot; class=&quot;headerlink&quot; title=&quot;çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ&quot;&gt;&lt;/a&gt;çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/NanYinIU/P
      
    
    </summary>
    
      <category term="Java" scheme="https://nanyiniu.github.io/categories/Java/"/>
    
    
      <category term="Thread" scheme="https://nanyiniu.github.io/tags/Thread/"/>
    
  </entry>
  
  <entry>
    <title>Javaä¸­çš„ä½è¿ç®—</title>
    <link href="https://nanyiniu.github.io/2020/03/28/%E4%BD%8D%E8%BF%90%E7%AE%97/"/>
    <id>https://nanyiniu.github.io/2020/03/28/ä½è¿ç®—/</id>
    <published>2020-03-28T12:00:00.000Z</published>
    <updated>2020-03-28T09:57:49.363Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Javaä¸­çš„ä½è¿ç®—"><a href="#Javaä¸­çš„ä½è¿ç®—" class="headerlink" title="Javaä¸­çš„ä½è¿ç®—"></a>Javaä¸­çš„ä½è¿ç®—</h1><p>Javaæä¾›äº†å¤šç§ä½è¿ç®—ï¼ŒåŒ…æ‹¬ å·¦ç§»( &lt;&lt; )ã€å³ç§»( &gt;&gt; ) ã€æ— ç¬¦å·å³ç§»( &gt;&gt;&gt; ) ã€ä½ä¸( &amp; ) ã€ä½æˆ–( | )ã€ä½é( ~ )ã€ä½å¼‚æˆ–( ^ )ï¼Œé™¤äº† ~ ä¸ºä¸€å…ƒæ“ä½œç¬¦ï¼Œå…¶ä»–éƒ½ä¸ºäºŒå…ƒæ“ä½œç¬¦ã€‚</p><h2 id="å·¦ç§»å’Œå³ç§»"><a href="#å·¦ç§»å’Œå³ç§»" class="headerlink" title="å·¦ç§»å’Œå³ç§»"></a>å·¦ç§»å’Œå³ç§»</h2><h3 id="ä»€ä¹ˆæ˜¯å·¦å³ç§»æ“ä½œï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ä»€ä¹ˆ"><a href="#ä»€ä¹ˆæ˜¯å·¦å³ç§»æ“ä½œï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»€ä¹ˆæ˜¯å·¦å³ç§»æ“ä½œï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ä»€ä¹ˆ"></a>ä»€ä¹ˆæ˜¯å·¦å³ç§»æ“ä½œï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ä»€ä¹ˆ</h3><p>ä½¿ç”¨ ç¬¦å· <code>&lt;&lt;</code> å¯¹æ•°å­—äº§ç”Ÿçš„å½±å“å°±æ˜¯å·¦ç§»ï¼ŒåŒç†å³ç§»ã€‚ä¸‹é¢é€šè¿‡ä¾‹å­æ¥çœ‹å·¦ç§»ï¼ˆå³ç§»ï¼‰çš„ç»“æœï¼š</p><p>åœ¨ <code>ArrayList</code> ä¸­ï¼Œä½¿ç”¨äº†<code>grow()</code>æ–¹æ³•è¿›è¡ŒListçš„æ‰©å®¹æ“ä½œï¼Œå…¶å®ï¼Œåœ¨<code>grow()</code>æ–¹æ³•å†…éƒ¨å°±ä½¿ç”¨åˆ°äº†å³ç§»æ“ä½œã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// overflow-conscious code</span></span><br><span class="line">        <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">        <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            newCapacity = minCapacity;</span><br><span class="line">        <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">            newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">        <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">        elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><p>grow() å‡½æ•°çš„ä½œç”¨å°±æ˜¯å¯¹ List è¿›è¡Œå€æ•°çš„æ‰©å®¹ï¼Œè¿™ä¸ªå€æ•°å°±æ˜¯ <code>x + x &gt;&gt; 1</code> ,å…·ä½“äº§ç”Ÿçš„ç»“æœç”¨ä¸»å‡½æ•°è¿›è¡Œæµ‹è¯•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">10</span>+(<span class="number">10</span>&gt;&gt;<span class="number">1</span>));</span><br></pre></td></tr></table></figure></div><p>äº§ç”Ÿçš„ç»“æœä¸º15.ä¹Ÿå°±æ˜¯è¯´ <code>10&gt;&gt;1</code>çš„ç»“æœä¸º5.é‚£ä¹ˆè®¡ç®—è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Œæ‰ä¼šäº§ç”Ÿè¿™æ ·çš„ç»“æœï¼Ÿ</p><h4 id="è½¬åŒ–ä¸ºäºŒè¿›åˆ¶"><a href="#è½¬åŒ–ä¸ºäºŒè¿›åˆ¶" class="headerlink" title="è½¬åŒ–ä¸ºäºŒè¿›åˆ¶"></a>è½¬åŒ–ä¸ºäºŒè¿›åˆ¶</h4><p>å¯¹ä½çš„è¿ç®—ï¼Œç¬¬ä¸€æ­¥ä¸€å®šæ˜¯å…ˆè½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œå†å¯¹äºŒè¿›åˆ¶è¿›è¡Œè®¡ç®—ã€‚</p><p>ä¾‹å­ä¸­çš„ 10 è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ä¸ºï¼š</p><p><code>0000 0000 0000 0000 0000 0000 0000 1010</code></p><h4 id="è¿›è¡Œä¸ºè¿ç®—"><a href="#è¿›è¡Œä¸ºè¿ç®—" class="headerlink" title="è¿›è¡Œä¸ºè¿ç®—"></a>è¿›è¡Œä¸ºè¿ç®—</h4><p>å¦‚æœæ˜¯å·¦ç§»ï¼Œåˆ™åœ¨å³ä¾§è¡¥0ï¼ŒåŒç†å¦‚æœæ˜¯å³ç§»ï¼Œåˆ™åœ¨å·¦ä¾§è¡¥0ã€‚</p><p>æ¯”å¦‚ä¸Šé¢çš„ 10&gt;&gt;1 , å³ç§»ä¸€ä½ï¼Œåˆ™åœ¨å·¦ä¾§è¡¥ä¸€ä¸ª0ã€‚</p><p>ç»“æœä¸º <code>...... 0101</code> ç»“æœä¸º 5</p><p>å¦‚æœ 10&lt;&lt;1 ,å·¦ç§»ä¸€ä½ï¼Œåˆ™åœ¨å³ä¾§è¡¥ä¸€ä¸ª0</p><p>ç»“æœä¸º <code>......1 0100</code> ç»“æœä¸º 20</p><h4 id="æ— ç¬¦å·å·¦ç§»å³ç§»"><a href="#æ— ç¬¦å·å·¦ç§»å³ç§»" class="headerlink" title="æ— ç¬¦å·å·¦ç§»å³ç§»"></a>æ— ç¬¦å·å·¦ç§»å³ç§»</h4><p>è´Ÿæ•°ä»¥åŸç çš„è¡¥ç å½¢å¼è¡¨è¾¾ï¼Œå¦‚æœæ˜¯è´Ÿæ•°æ—¶ï¼Œæ¯”å¦‚ -10 ï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶å°±æ˜¯</p><p><code>1111 1111 1111 1111 1111 1111 1111 1011</code></p><p>ä¹Ÿå°±æ˜¯é«˜ä½ä¸º1ï¼Œä¸æ­£æ•°ç›¸åï¼ŒåŒç†ï¼Œåœ¨è¿›è¡Œç§»åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦å°†åŸæ¥çš„è¡¥0ï¼Œè°ƒæ•´ä¸ºè¡¥1ï¼›</p><p>å¦‚ -10&gt;&gt;1,å³ç§»ä¸€ä½ï¼Œå·¦ä¾§è¡¥1</p><p><code>1......1101</code> ,ç»“æœä¸º -5</p><p>æ— ç¬¦å·åˆ™å§‹ç»ˆè¡¥0ï¼›</p><p>ç»¼ä¸Šï¼š</p><ol><li>è½¬åŒ–ä¸ºäºŒè¿›åˆ¶</li><li>æ­£æ•°åå‘è¡¥0</li><li>è´Ÿæ•°åå‘è¡¥1</li><li>æ— ç¬¦å·åå‘è¡¥0</li></ol><h2 id="ä½ä¸ï¼ˆ-amp-ï¼‰"><a href="#ä½ä¸ï¼ˆ-amp-ï¼‰" class="headerlink" title="ä½ä¸ï¼ˆ&amp;ï¼‰"></a>ä½ä¸ï¼ˆ&amp;ï¼‰</h2><p>åœ¨HashMapä¸­è¿›è¡Œputå…ƒç´ çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ <code>putVal()</code> æ–¹æ³•è¿›è¡Œå®é™…çš„è®¡ç®—å’Œæ·»åŠ ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            n = (tab = resize()).length;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ (n-1)&amp;hash æŸ¥æ‰¾ä½ç½®æ˜¯å¦å·²ç»è¢«å ç”¨</span></span><br><span class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure></div><p>è¿™é‡Œä½¿ç”¨ &amp; çš„ä½œç”¨å…¶å®æ˜¯ä¸ºäº†ä¿è¯ hash çš„å€¼ä¸è¶…è¿‡èŒƒå›´ã€‚æ•°ç»„å…·æœ‰2çš„å¹‚æ•°é•¿åº¦ï¼Œä»¥ç”¨&amp;æ›¿æ¢æ˜‚è´µçš„å–æ¨¡è¿ç®—ã€‚</p><p>è¿ç®—è§„åˆ™ï¼šç¬¬ä¸€ä¸ªæ•°çš„çš„ç¬¬nä½å’Œç¬¬äºŒä¸ªæ•°çš„ç¬¬nä½å¦‚æœéƒ½æ˜¯1ï¼Œé‚£ä¹ˆç»“æœçš„ç¬¬nä¸ºä¹Ÿä¸º1ï¼Œå¦åˆ™ä¸º0 ç®€åŒ–æè¿°è§„åˆ™:<strong>åŒä¸€ä¸ºä¸€,å¦åˆ™ä¸ºé›¶</strong></p><p>5è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0101</code></p><p>3è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0011</code></p><p>ç»“æœï¼š<code>0000 0000 0000 0000 0000 0000 0000 0001</code></p><p>è½¬åŒ–ä¸º10è¿›åˆ¶ä¸º 1</p><p>å¯ä»¥ä½œç”¨ä¸ºå…³é—­ï¼ˆå±è”½ï¼‰ç‰¹å®šä½çš„æ‰‹æ®µ</p><h2 id="ä½æˆ–ï¼ˆï½œï¼‰"><a href="#ä½æˆ–ï¼ˆï½œï¼‰" class="headerlink" title="ä½æˆ–ï¼ˆï½œï¼‰"></a>ä½æˆ–ï¼ˆï½œï¼‰</h2><p>è¿ç®—è§„åˆ™ï¼šç¬¬ä¸€ä¸ªæ•°çš„çš„ç¬¬nä½äºç¬¬äºŒä¸ªæ•°çš„ç¬¬nä½ åªè¦æœ‰ä¸€ä¸ªæ˜¯1ï¼Œé‚£ä¹ˆç»“æœçš„ç¬¬nä¸ºä¹Ÿä¸º1ï¼Œå¦åˆ™ä¸º0. ç®€åŒ–è§„åˆ™æè¿°: <strong>æœ‰ä¸€åˆ™ä¸€,å¦åˆ™ä¸ºé›¶</strong></p><p>5è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0101</code></p><p>3è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0011</code></p><p>ç»“æœï¼š<code>0000 0000 0000 0000 0000 0000 0000 0110</code></p><p>è½¬åŒ–ä¸º10è¿›åˆ¶ä¸º 7</p><p>å¯ä»¥ä½œä¸ºå°†ç‰¹å®šä½ç½®ä¸º1çš„æ‰‹æ®µ</p><h2 id="å¼‚æˆ–ï¼ˆ-ï¼‰"><a href="#å¼‚æˆ–ï¼ˆ-ï¼‰" class="headerlink" title="å¼‚æˆ–ï¼ˆ^ï¼‰"></a>å¼‚æˆ–ï¼ˆ^ï¼‰</h2><p>è¿ç®—è§„åˆ™ï¼šç¬¬ä¸€ä¸ªæ•°çš„çš„ç¬¬nä½äºç¬¬äºŒä¸ªæ•°çš„ç¬¬nä½ <strong>ç›¸å</strong>ï¼Œé‚£ä¹ˆç»“æœçš„ç¬¬nä¸ºä¹Ÿä¸º1ï¼Œå¦åˆ™ä¸º0,ç®€åŒ–è§„åˆ™æè¿°: <strong>ç›¸åä¸ºä¸€,å¦åˆ™ä¸ºé›¶</strong></p><p>5è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0101</code></p><p>3è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼š<code>0000 0000 0000 0000 0000 0000 0000 0011</code></p><p>ç»“æœï¼š<code>0000 0000 0000 0000 0000 0000 0000 0110</code></p><p>è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ä¸º 7</p><ol><li>æŒ‰ä½â€œå¼‚æˆ–â€è¿ç®—å¯ä»¥ä½¿ç‰¹å®šçš„ä½å–å</li><li>ç›´æ¥äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a^=b</span><br><span class="line">b^=a</span><br><span class="line">a^=b</span><br></pre></td></tr></table></figure></div><p>è¿™æ ·açš„å€¼ä¸bçš„å€¼å°±å½¢æˆäº†äº’æ¢ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Javaä¸­çš„ä½è¿ç®—&quot;&gt;&lt;a href=&quot;#Javaä¸­çš„ä½è¿ç®—&quot; class=&quot;headerlink&quot; title=&quot;Javaä¸­çš„ä½è¿ç®—&quot;&gt;&lt;/a&gt;Javaä¸­çš„ä½è¿ç®—&lt;/h1&gt;&lt;p&gt;Javaæä¾›äº†å¤šç§ä½è¿ç®—ï¼ŒåŒ…æ‹¬ å·¦ç§»( &amp;lt;&amp;lt; )ã€å³ç§»( &amp;gt;&amp;gt
      
    
    </summary>
    
      <category term="Java" scheme="https://nanyiniu.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>lambdaè¡¨è¾¾å¼å­¦ä¹ å’Œåº”ç”¨</title>
    <link href="https://nanyiniu.github.io/2020/03/24/Lambda%20expression/"/>
    <id>https://nanyiniu.github.io/2020/03/24/Lambda expression/</id>
    <published>2020-03-23T19:45:00.000Z</published>
    <updated>2020-03-23T12:26:21.529Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Lambdaè¡¨è¾¾å¼"><a href="#Lambdaè¡¨è¾¾å¼" class="headerlink" title="Lambdaè¡¨è¾¾å¼"></a>Lambdaè¡¨è¾¾å¼</h1><p>Lamdba è¡¨è¾¾å¼æ˜¯Java 8 çš„æ–°ç‰¹æ€§ï¼Œä¹Ÿæ˜¯Java 8 ä¸­æœ€é‡è¦çš„çš„æ–°åŠŸèƒ½ã€‚Lamdabaè¡¨è¾¾å¼ä¿ƒè¿›äº†Javaä½¿ç”¨å‡½æ•°æ–¹å¼è¿›è¡Œç¼–ç¨‹ã€‚</p><p>åœ¨è¿›è¡Œè¯­æ³•çš„è®²è§£ä¹‹å‰,éœ€è¦äº†è§£å’ŒLambdaæ¯æ¯ç›¸å…³çš„<code>Function Interface</code>,å¯ä»¥è¯´åªæœ‰å‡½æ•°å¼æ¥å£çš„å­˜åœ¨,æ‰æœ‰lambdaè¡¨è¾¾å¼çš„å­˜åœ¨,æ¢å¥è¯å¯ä»¥è¯´lambdaè¡¨è¾¾å¼æ˜¯å‡½æ•°å¼æ¥å£çš„å®ç°.</p><h2 id="å‡½æ•°å¼æ¥å£"><a href="#å‡½æ•°å¼æ¥å£" class="headerlink" title="å‡½æ•°å¼æ¥å£"></a>å‡½æ•°å¼æ¥å£</h2><p>Function æ¥å£å…·æœ‰å•ä¸ªåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯æœ‰å•ä¸ªæŠ½è±¡æ–¹æ³•.å¦‚ <code>Comparable</code> æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• <code>compareTo</code> ç”¨æ¥è¿›è¡Œæ¯”è¾ƒã€‚</p><p>Java8å®šä¹‰äº†å‡½æ•°æ¥å£è¢«ç”¨æ¥æ‹“å±•Lamdbaè¡¨è¾¾å¼ã€‚åœ¨ <code>java.util.Function</code> åŒ…ä¸‹æœ‰éå¸¸å¤šçš„å‡½æ•°æ¥å£ã€‚</p><p>å¸¸ç”¨çš„æ¥å£åŒ…æ‹¬ï¼›</p><table><thead><tr><th>æ¥å£</th><th>æŠ½è±¡æ–¹æ³•</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>Function&lt;T,R&gt;</td><td>R apply(T t);</td><td>æ¥å—Tç±»å‹å‚æ•°,è¿”å›Rç±»å‹ç»“æœ</td></tr><tr><td>Consumer<t></t></td><td>void accept(T t);</td><td>æ¥å—Tç±»å‹å‚æ•°,ä¸è¿”å›ç»“æœ</td></tr><tr><td>Predicate<t></t></td><td>boolean test(T t);</td><td>æ¥å—Tç±»å‹å‚æ•°,è¿”å›Booleanç»“æœ</td></tr><tr><td>Suppler<t></t></td><td>T get();</td><td>æ— å‚æ•°,è¿”å›Tç±»å‹ç»“æœ</td></tr></tbody></table><h3 id="å®šä¹‰å‡½æ•°æ¥å£"><a href="#å®šä¹‰å‡½æ•°æ¥å£" class="headerlink" title="å®šä¹‰å‡½æ•°æ¥å£"></a>å®šä¹‰å‡½æ•°æ¥å£</h3><ol><li>ä½¿ç”¨ <code>@FunctionalInterface</code> æ³¨è§£,è¯¥æ³¨è§£ä¸æ˜¯å¿…é¡»çš„,ä½†æ˜¯å¦‚æœæ ‡æ³¨,åˆ™ç¼–è¯‘å™¨ä¼šæ£€æŸ¥è¿™ä¸ªæ¥å£ä¸‹æ˜¯å¦åªæœ‰å•ä¸ªæŠ½è±¡æ–¹æ³•,å¦‚æœä¸æ˜¯ä¼šæŠ¥é”™.</li><li>æ–°å¢defaultæ–¹æ³•,æ˜¯ä¸ºäº†åœ¨ç°æœ‰çš„ç±»åº“ä¸­ä¸­æ–°å¢åŠŸèƒ½è€Œä¸å½±å“ä»–ä»¬çš„å®ç°ç±»</li><li>æ–°å¢æ¥å£å†…staticæ–¹æ³•,å¯å®šä¹‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªé™æ€æ–¹æ³•,å’Œæ™®é€šçš„é™æ€æ–¹æ³•æ²¡æœ‰åŒºåˆ«,éƒ½æ˜¯<code>æ¥å£å.æ–¹æ³•å</code>è¿›è¡Œè°ƒç”¨</li><li>åœ¨å‡½æ•°å¼æ¥å£çš„å®šä¹‰ä¸­æ˜¯åªå…è®¸æœ‰ä¸”åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•(å¿…é¡»)ï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ªstaticæ–¹æ³•å’Œdefaultæ–¹æ³•ã€‚</li></ol><h2 id="Lambdaè¯­æ³•"><a href="#Lambdaè¯­æ³•" class="headerlink" title="Lambdaè¯­æ³•"></a>Lambdaè¯­æ³•</h2><p>ä¸€ä¸ªLambdaè¡¨è¾¾å¼æœ‰å¦‚ä¸‹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">paramter -&gt; expression body</span><br></pre></td></tr></table></figure></div><p>ä»¥ä¸‹æ˜¯lambdaè¡¨è¾¾å¼çš„å‡ ä¸ªç‰¹æ€§</p><ul><li><strong>å¯é€‰çš„ç±»å‹æè¿°</strong> - ä¸éœ€è¦å£°æ˜å‚æ•°çš„ç±»å‹ï¼Œç¼–è¯‘å™¨å¯æ ¹æ®å‚æ•°çš„å€¼è¿›è¡Œæ¨æ–­</li><li><strong>å¯é€‰çš„å‚æ•°ä¸¤æ—çš„æ‹¬å·</strong> - å£°æ˜å•ä¸ªå‚æ•°çš„æ—¶å€™ä¸éœ€è¦ä½¿ç”¨æ‹¬å·ï¼Œä½†æ˜¯å¦‚ä½•å£°æ˜å¤šä¸ªå‚æ•°ï¼Œæ‹¬å·è¿˜æ˜¯å¿…é¡»çš„ã€‚</li><li><strong>å¯é€‰çš„å¤§æ‹¬å·</strong> - å¦‚æœå‡½æ•°ä½“ä¸­åªæœ‰å•è¡Œï¼Œåˆ™ä¸éœ€è¦åœ¨å‡½æ•°ä½“ä¸¤ä¾§æ·»åŠ å¤§æ‹¬å·</li><li><strong>å¯é€‰çš„è¿”å›å€¼</strong> - å¦‚æœå‡½æ•°ä¸­åªæœ‰å•è¡Œï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è¿”å›è¿™ä¸ªå•è¡Œçš„è¿”å›å€¼</li></ul><p>ä¸‹é¢æ ¹æ®å®ä¾‹æ¥çœ‹ä¸Šé¢çš„å››ä¸ªç‰¹æ€§ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java8Tester</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      GreetingService greetService1 = message -&gt; System.out.println(<span class="string">"Say:"</span>+message);</span><br><span class="line">      greetService1.sayMessage(<span class="string">"Hello!!"</span>);</span><br><span class="line">      MathOperation add = (<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; a+b;</span><br><span class="line">      MathOperation sub= (a,b) -&gt; a-b;</span><br><span class="line">      MathOperation muti = (a,b) -&gt; &#123;<span class="keyword">return</span> a*b;&#125;;</span><br><span class="line">      System.out.println(<span class="string">"add å‡½æ•°ç»“æœï¼š"</span>+add.operation(<span class="number">2</span>,<span class="number">2</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">interface</span> <span class="title">GreetingService</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">void</span> <span class="title">sayMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">interface</span> <span class="title">MathOperation</span></span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">operation</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»“æœï¼š</span></span><br><span class="line">Say:Hello!!</span><br><span class="line">add å‡½æ•°ç»“æœï¼š<span class="number">4</span></span><br></pre></td></tr></table></figure></div><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹é‡è¦çš„ä¸¤ç‚¹ï¼š</p><ul><li>Lambda è¡¨è¾¾å¼ä¸»è¦ç”¨æ¥å®šä¹‰åŠŸèƒ½æ¥å£çš„å†…è”å®ç°ï¼Œå¦‚ï¼šä¸€ä¸ªæ¥å£é‡Œåªæœ‰ä¸€ä¸ªæ¥å£æ–¹æ³•ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œé¢æˆ‘ä»¬ä½¿ç”¨äº†å¯¹MathOperationæ¥å£è¿›è¡Œäº†å¤šç§å®ç°ã€‚</li><li>Lambda è¡¨è¾¾å¼æ¶ˆé™¤äº†å¯¹åŒ¿åç±»çš„éœ€æ±‚ï¼Œå¦‚<code>new Thread(new Runnable{..})</code> ,ä¸ºJavaæä¾›äº†éå¸¸ç®€å•è€Œå¼ºå¤§çš„å‡½æ•°ç¼–ç¨‹èƒ½åŠ›ã€‚</li></ul><h2 id="ä½¿ç”¨æ–¹æ³•å¼•ç”¨"><a href="#ä½¿ç”¨æ–¹æ³•å¼•ç”¨" class="headerlink" title="ä½¿ç”¨æ–¹æ³•å¼•ç”¨"></a>ä½¿ç”¨æ–¹æ³•å¼•ç”¨</h2><p>æ–¹æ³•å¼•ç”¨ï¼ˆMethod Refrencesï¼‰å¸®åŠ©é€šè¿‡æ–¹æ³•åç§°æŒ‡å‘æ–¹æ³•ã€‚æ–¹æ³•å¼•ç”¨ä½¿ç”¨ç¬¦å·â€œ::â€è¡¨ç¤ºã€‚æ–¹æ³•å¼•ç”¨å¯ä»¥ç”¨çˆ±æŒ‡å‘å¦‚ä¸‹ç±»å‹çš„æ–¹æ³•ï¼š</p><ul><li>é™æ€æ–¹æ³•</li><li>å®ä¾‹æ–¹æ³•</li><li>æ„é€ æ–¹æ³•ä½¿ç”¨newå…³é”®å­—ï¼ˆTreeSet::newï¼‰</li></ul><p>[æ–¹æ³•å¼•ç”¨]çš„æ ¼å¼æ˜¯ ç±»å::æ–¹æ³•å</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.stream(objectArray).forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><h2 id="ä½¿ç”¨Lambda"><a href="#ä½¿ç”¨Lambda" class="headerlink" title="ä½¿ç”¨Lambda"></a>ä½¿ç”¨Lambda</h2><blockquote><p>ç†Ÿèƒ½ç”Ÿå·§,å¸¸å¸¸ç»ƒä¹ è‚¯å®šèƒ½è®°ä½</p></blockquote><h3 id="1-åˆ›å»ºThread"><a href="#1-åˆ›å»ºThread" class="headerlink" title="1. åˆ›å»ºThread"></a>1. åˆ›å»ºThread</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ä½¿ç”¨Lambdaåˆ›å»ºThread</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹å‡ºå†…éƒ¨ç›´æ¥åˆ›å»ºäº†Runnableçš„åŒ¿åç±»</span></span><br><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ–°å»ºçº¿ç¨‹ã€‚ã€‚"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨lambdaåˆ›å»ºThread</span></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"ä½¿ç”¨Lambdaæ–°å»ºçº¿ç¨‹ã€‚ã€‚"</span>)).start();</span><br></pre></td></tr></table></figure></div><h3 id="2-åˆ—è¡¨è¿­ä»£"><a href="#2-åˆ—è¡¨è¿­ä»£" class="headerlink" title="2. åˆ—è¡¨è¿­ä»£"></a>2. åˆ—è¡¨è¿­ä»£</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// ä¸ä½¿ç”¨Lambda</span></span><br><span class="line"><span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">    System.out.println(integer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä½¿ç”¨Lambda</span></span><br><span class="line">list.forEach((s) -&gt; System.out.println(s));</span><br><span class="line"><span class="comment">//æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">list.forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><h3 id="3-Map-amp-Reduce"><a href="#3-Map-amp-Reduce" class="headerlink" title="3. Map&amp;Reduce"></a>3. Map&amp;Reduce</h3><ul><li>ä½¿ç”¨Mapå¤„ç†åˆ—è¡¨å†…æ‰€æœ‰å…ƒç´ å…¨éƒ¨åŠ 2</li></ul><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ä½¿ç”¨Lambda</span></span><br><span class="line"><span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">    <span class="keyword">int</span> order = integer + <span class="number">2</span>;</span><br><span class="line">    System.out.println(order);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨Lambda</span></span><br><span class="line">list.stream().map((a) -&gt; a + <span class="number">2</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><ul><li>ä½¿ç”¨ Map + collect å®Œæˆå¯¹æ¯ä¸ªå…ƒç´ è®¡ç®—åè¿”å›æ–°çš„ç»“æœåˆ—è¡¨</li></ul><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; newList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ä½¿ç”¨Lambda</span></span><br><span class="line"><span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">    <span class="keyword">int</span> order = integer + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> result = order / integer;</span><br><span class="line">    newList.add(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (Integer integer : newList) &#123;</span><br><span class="line">    System.out.println(integer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨Lambda</span></span><br><span class="line">newList = list.stream().map((a) -&gt; (a + <span class="number">2</span>)/a).collect(Collectors.toList());</span><br><span class="line">newList.forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><h3 id="4-ä½¿ç”¨filterå®ç°å…ƒç´ çš„è¿‡æ»¤"><a href="#4-ä½¿ç”¨filterå®ç°å…ƒç´ çš„è¿‡æ»¤" class="headerlink" title="4. ä½¿ç”¨filterå®ç°å…ƒç´ çš„è¿‡æ»¤"></a>4. ä½¿ç”¨filterå®ç°å…ƒç´ çš„è¿‡æ»¤</h3><p>ä½¿ç”¨lambda,å¯ç›´æ¥ä½¿ç”¨filterè¿›è¡Œå…ƒç´ çš„è¿‡æ»¤</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ä½¿ç”¨lambdaæ—¶</span></span><br><span class="line">List&lt;Integer&gt; list_1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Integer integer : list) &#123;</span><br><span class="line">    <span class="keyword">if</span>(integer != <span class="number">3</span>)&#123;</span><br><span class="line">        list_1.add(integer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ filter è¿›è¡Œè¿‡æ»¤</span></span><br><span class="line">List&lt;Integer&gt; list_2 = list.stream().filter((a) -&gt; a!=<span class="number">3</span>).collect(Collectors.toList());</span><br><span class="line">list_2.forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><h3 id="5-æ‰§è¡Œå‡½æ•°"><a href="#5-æ‰§è¡Œå‡½æ•°" class="headerlink" title="5. æ‰§è¡Œå‡½æ•°"></a>5. æ‰§è¡Œå‡½æ•°</h3><p>ç¨å¤æ‚çš„å­—ç¬¦ä¸²å¤„ç†,ç”¨lambdaåˆé€‚ä¸è¿‡äº†,ä¸‹é¢çš„ä¾‹å­,åªå°†ç‰¹å®šå­—ç¬¦çš„å­—ç¬¦ä¸²è¿›è¡Œ toUpperCase</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; s = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">s.add(<span class="string">"hello "</span>);</span><br><span class="line">s.add(<span class="string">"world "</span>);</span><br><span class="line">s.add(<span class="string">"!! "</span>);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; s_1 = s.stream()</span><br><span class="line">        .filter(a -&gt; a.startsWith(<span class="string">"h"</span>) || a.startsWith(<span class="string">"w"</span>))</span><br><span class="line">        .map(String::toUpperCase)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">s_1.forEach(System.out::println);</span><br></pre></td></tr></table></figure></div><h3 id="6-ç®—æ•°è¿ç®—"><a href="#6-ç®—æ•°è¿ç®—" class="headerlink" title="6. ç®—æ•°è¿ç®—"></a>6. ç®—æ•°è¿ç®—</h3><p>æ”¯æŒä½¿ç”¨minã€maxç­‰ç›´æ¥å®ç°Comparatorè¿›è¡Œè¿ç®—,å¦‚:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Integer&gt; min = list.stream().min(Integer::compareTo);</span><br></pre></td></tr></table></figure></div><p>ä¹Ÿæ”¯æŒä½¿ç”¨ IntSummaryStatistics çŠ¶æ€,å¦‚:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IntSummaryStatistics intSummaryStatistics = list.stream().mapToInt(x -&gt; x).summaryStatistics();</span><br><span class="line">System.out.println(<span class="string">"æœ€å¤§å€¼ï¼š"</span>+intSummaryStatistics.getMax());</span><br><span class="line">System.out.println(<span class="string">"æœ€å°å€¼ï¼š"</span>+intSummaryStatistics.getMin());</span><br><span class="line">System.out.println(<span class="string">"å¹³å‡å€¼ï¼š"</span>+intSummaryStatistics.getAverage());</span><br><span class="line">System.out.println(<span class="string">"æ•°é‡ï¼š"</span>+intSummaryStatistics.getCount());</span><br></pre></td></tr></table></figure></div><h3 id="7-è‡ªå®šä¹‰æ–¹æ³•ä½¿ç”¨Function-Intefaceå®ç°å¤æ‚åŠŸèƒ½"><a href="#7-è‡ªå®šä¹‰æ–¹æ³•ä½¿ç”¨Function-Intefaceå®ç°å¤æ‚åŠŸèƒ½" class="headerlink" title="7. è‡ªå®šä¹‰æ–¹æ³•ä½¿ç”¨Function Intefaceå®ç°å¤æ‚åŠŸèƒ½"></a>7. è‡ªå®šä¹‰æ–¹æ³•ä½¿ç”¨Function Intefaceå®ç°å¤æ‚åŠŸèƒ½</h3><p>Java 8 æä¾›äº†ä¸‰ä¸ªå¸¸ç”¨çš„å‡½æ•°æ¥å£åŒ…æ‹¬ï¼›</p><ul><li>Function&lt;T,R&gt;</li><li>Predicate<t> åˆ¤æ–­</t></li><li>Consumer<t> æ¶ˆè´¹</t></li></ul><p>é€šè¿‡å®šä¹‰æ–¹æ³•ä½¿ç”¨è¿™ä¸‰ç±»æ¥å£,èƒ½å®Œæˆæ›´å¤æ‚çš„è°ƒç”¨é€»è¾‘,åœ¨è¿™é‡Œä»…ä»…ä¸¾ä¸€ä¸ªå°ä¾‹å­ğŸŒ°</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Integer&gt; <span class="title">functionMethods2</span><span class="params">(List&lt;Integer&gt; a, Function&lt;List&lt;Integer&gt;, List&lt;Integer&gt;&gt; function)</span> </span>&#123;</span><br><span class="line">    a = a.stream()</span><br><span class="line">            .filter(demoFilter(<span class="number">2</span>))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> function.apply(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Predicate&lt;Integer&gt; <span class="title">demoFilter</span><span class="params">(Integer number)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a) -&gt; !a.equals(number);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯è°ƒç”¨</span></span><br><span class="line">JavaTester javaTester = <span class="keyword">new</span> JavaTester();</span><br><span class="line">List&lt;Integer&gt; resList = javaTester.functionMethods2(list, a -&gt; &#123;</span><br><span class="line">        a.add(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Lambdaè¡¨è¾¾å¼&quot;&gt;&lt;a href=&quot;#Lambdaè¡¨è¾¾å¼&quot; class=&quot;headerlink&quot; title=&quot;Lambdaè¡¨è¾¾å¼&quot;&gt;&lt;/a&gt;Lambdaè¡¨è¾¾å¼&lt;/h1&gt;&lt;p&gt;Lamdba è¡¨è¾¾å¼æ˜¯Java 8 çš„æ–°ç‰¹æ€§ï¼Œä¹Ÿæ˜¯Java 8 ä¸­æœ€é‡è¦çš„çš„æ–°åŠŸèƒ½ã€‚
      
    
    </summary>
    
      <category term="Java" scheme="https://nanyiniu.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="åŸºç¡€" scheme="https://nanyiniu.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlä¸­çš„INSTRå’ŒFIND_IN_SETå‡½æ•°åº”ç”¨</title>
    <link href="https://nanyiniu.github.io/2020/03/09/INSTR%E5%92%8CFIND_IN_SET%E5%87%BD%E6%95%B0/"/>
    <id>https://nanyiniu.github.io/2020/03/09/INSTRå’ŒFIND_IN_SETå‡½æ•°/</id>
    <published>2020-03-09T12:00:00.000Z</published>
    <updated>2020-03-09T01:11:36.728Z</updated>
    
    <content type="html"><![CDATA[<h1 id="INSTRå‡½æ•°"><a href="#INSTRå‡½æ•°" class="headerlink" title="INSTRå‡½æ•°"></a>INSTRå‡½æ•°</h1><p>The INSTR() function returns the position of the first occurrence of a string in another string.</p><p>This function performs a case-insensitive search.</p><p>èƒ½å¤Ÿæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°ä½ç½®,ç±»ä¼¼javaä¸­çš„firstIndexOf,å¹¶ä¸”æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„æœç´¢</p><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>é¦–å…ˆ:äº†è§£åˆ° INSTR å‡½æ•°çš„åŸºæœ¬åŠŸèƒ½æ—¶èƒ½å¤Ÿ <strong>è¿”å›å­—ç¬¦ä¸²åœ¨æŸä¸€ä¸ªå­—æ®µçš„å†…å®¹ä¸­çš„ä½ç½®, æ²¡æœ‰æ‰¾åˆ°å­—ç¬¦ä¸²è¿”å›0ï¼Œå¦åˆ™è¿”å›ä½ç½®ï¼ˆä»1å¼€å§‹ï¼‰</strong> .æ¯”å¦‚:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="SQL"><figure class="iseeu highlight /sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç»“æœä¸º10</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">INSTR</span>(<span class="string">"this is mysql"</span>,<span class="string">"y"</span>)  </span><br><span class="line"><span class="comment">-- ç»“æœä¸º0</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">INSTR</span>(<span class="string">"this is mysql"</span>,<span class="string">"a"</span>)</span><br></pre></td></tr></table></figure></div><p>2å¦‚æœinstrå½“ä½œæŸ¥è¯¢æ¡ä»¶,å°±èƒ½èµ·åˆ°<strong>ç±»ä¼¼inçš„ä½œç”¨</strong></p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="SQL"><figure class="iseeu highlight /sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿”å›ç”¨æˆ·idä¸º12çš„æ•°æ®,åŒæ ·çš„,ä¹Ÿä¼šè¿”å›idä¸º 1,2çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> u <span class="keyword">where</span> <span class="keyword">INSTR</span>(<span class="string">'12'</span>,u.id);</span><br></pre></td></tr></table></figure></div><p>æ›´å¤æ‚çš„èƒ½å¤ŸæŸ¥è¯¢æ•°æ®ä¸ºå­—ç¬¦ä¸²,å¹¶ä¸”ç”¨ç‰¹å®šç¬¦å·åˆ†éš”çš„ç‰¹å®šçš„æ•°æ®</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="SQL"><figure class="iseeu highlight /sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">GROUP_CONCAT</span>(u.username) <span class="keyword">as</span> <span class="keyword">name</span> </span><br><span class="line"><span class="keyword">from</span> <span class="string">`user`</span> u </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">INSTR</span>(<span class="keyword">concat</span>(<span class="string">','</span>,(p.leaderIds),<span class="string">','</span>),<span class="keyword">concat</span>(<span class="string">','</span>,(u.id),<span class="string">','</span>))</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> product p </span><br><span class="line"><span class="keyword">WHERE</span> p.product_uid =<span class="string">'02124ff31eac4c14934b045358b10cca'</span></span><br></pre></td></tr></table></figure></div><h1 id="FIND-IN-SET-å‡½æ•°"><a href="#FIND-IN-SET-å‡½æ•°" class="headerlink" title="FIND_IN_SET å‡½æ•°"></a>FIND_IN_SET å‡½æ•°</h1><p>The FIND_IN_SET() function returns the position of a string within a list of strings.</p><p>èƒ½å¤Ÿè¿”å›listä¸­çš„å­—ç¬¦ä¸²ä½ç½®(ä½¿ç”¨é€—å·åˆ†éš”)</p><p>åŸºç¡€çš„å°±ä¸å¤šè¯´,ç›´æ¥ä¸¾ä¾‹</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="SQL"><figure class="iseeu highlight /sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä¼šåªè¿”å›idä¸º12,13çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> u <span class="keyword">where</span> FIND_IN_SET(u.id,<span class="string">'12,13'</span>)</span><br></pre></td></tr></table></figure></div><p>find_in_set å’Œ instr å‡½æ•°åšä¾‹å­ä¸Šçš„å¯¹æ¯”æ—¶,å‘ç°instræ˜¯æ¨¡ç³ŠåŒ¹é…,åªè¦ç¬¦åˆéƒ½ä¼šæŸ¥å‡ºæ¥,è€Œfind_in_setæ˜¯é’ˆå¯¹ä½¿ç”¨é€—å·åˆ†éš”çš„å¯¹instrçš„è¿›ä¸€æ­¥å¤„ç†,åªæœ‰å‡ºç°åœ¨é€—å·ä¹‹é—´çš„è¿›è¡Œç²¾ç¡®åŒ¹é….</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;INSTRå‡½æ•°&quot;&gt;&lt;a href=&quot;#INSTRå‡½æ•°&quot; class=&quot;headerlink&quot; title=&quot;INSTRå‡½æ•°&quot;&gt;&lt;/a&gt;INSTRå‡½æ•°&lt;/h1&gt;&lt;p&gt;The INSTR() function returns the position of the f
      
    
    </summary>
    
      <category term="MYSQL" scheme="https://nanyiniu.github.io/categories/MYSQL/"/>
    
    
      <category term="MYSQL" scheme="https://nanyiniu.github.io/tags/MYSQL/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootæ•´åˆJPAä½¿ç”¨</title>
    <link href="https://nanyiniu.github.io/2020/03/05/SpringBoot%E6%95%B4%E5%90%88JPA%E4%BD%BF%E7%94%A8/"/>
    <id>https://nanyiniu.github.io/2020/03/05/SpringBootæ•´åˆJPAä½¿ç”¨/</id>
    <published>2020-03-05T12:00:00.000Z</published>
    <updated>2020-03-05T13:25:27.008Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBootæ•´åˆJPAä½¿ç”¨"><a href="#SpringBootæ•´åˆJPAä½¿ç”¨" class="headerlink" title="SpringBootæ•´åˆJPAä½¿ç”¨"></a>SpringBootæ•´åˆJPAä½¿ç”¨</h1><h2 id="æ•´åˆJPA"><a href="#æ•´åˆJPA" class="headerlink" title="æ•´åˆJPA"></a>æ•´åˆJPA</h2><p>SpringBootæ•´åˆJPAååˆ†æ–¹ä¾¿,åœ¨Pomä¸­æ·»åŠ å¦‚ä¸‹:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ•°æ®åº“é…ç½®,ä½¿ç”¨druid --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h3 id="JPAåŸºæœ¬é…ç½®"><a href="#JPAåŸºæœ¬é…ç½®" class="headerlink" title="JPAåŸºæœ¬é…ç½®"></a>JPAåŸºæœ¬é…ç½®</h3><p>åœ¨application.properties æˆ–è€… application.yaml æ–‡ä»¶ä¸­é…ç½®æ•°æ®åº“é“¾æ¥å’ŒJPAçš„åŸºæœ¬é…ç½®(æœ¬ä¾‹ä½¿ç”¨yamlæ–‡ä»¶):</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="YAML"><figure class="iseeu highlight /yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line"><span class="attr">        driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">        druid:</span></span><br><span class="line"><span class="attr">            initial-size:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">            max-active:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">            max-wait:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">            stat-view-servlet:</span></span><br><span class="line"><span class="attr">                login-password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">                login-username:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">        password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">jdbc:mysql://127.0.0.1:3306/web?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    jpa:</span></span><br><span class="line">    <span class="comment">#   é…ç½®åˆ›å»ºè¡¨ä½¿ç”¨çš„SQLDialect</span></span><br><span class="line"><span class="attr">        database-platform:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br><span class="line"><span class="attr">        show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#   è‡ªåŠ¨æ›´æ–°æ•°æ®åº“è¡¨</span></span><br><span class="line"><span class="attr">        hibernate:</span></span><br><span class="line"><span class="attr">            ddl-auto:</span> <span class="string">update</span></span><br><span class="line"><span class="attr">        properties:</span></span><br><span class="line"><span class="attr">            hibernate:</span></span><br><span class="line">            <span class="comment">#   ä½¿ç”¨@Queryæ—¶SQLçš„dialectæ–¹è¨€</span></span><br><span class="line"><span class="attr">                dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br></pre></td></tr></table></figure></div><h2 id="ä½¿ç”¨JPA"><a href="#ä½¿ç”¨JPA" class="headerlink" title="ä½¿ç”¨JPA"></a>ä½¿ç”¨JPA</h2><p>åœ¨SpringBootä¸­ä½¿ç”¨JPAååˆ†ç®€å•,åªè¦å¼•ç”¨JPAçš„starterå³å¯</p><h3 id="å®ä½“ç±»ä¸­å±æ€§"><a href="#å®ä½“ç±»ä¸­å±æ€§" class="headerlink" title="å®ä½“ç±»ä¸­å±æ€§"></a>å®ä½“ç±»ä¸­å±æ€§</h3><p>ä½¿ç”¨Spring Data JPA,ä¸Mybatisä¸åŒ,æ›´å¤šçš„æ˜¯é¢å‘å¯¹è±¡æŸ¥è¯¢.æ‰€ä»¥æ„é€ å¯¹è±¡å®ä½“ç±»å°±éå¸¸é‡è¦,å¦‚æœé…ç½®äº†è‡ªåŠ¨æ›´æ–°è¡¨ç»“æ„,å°±éœ€è¦æ³¨æ„å¦‚ä½•åœ¨å®ä½“ä¸­ä½¿ç”¨ç‰¹å®šçš„æ³¨è§£å®Œæˆå¯¹å®ä½“çš„é…ç½®.</p><h4 id="1-Entity"><a href="#1-Entity" class="headerlink" title="1. @Entity"></a>1. @Entity</h4><p>ä½¿ç”¨ <code>@Entity</code> æ³¨è§£åœ¨ç±»ä¸Š,ç”¨æ¥è¡¨ç¤ºè¯¥ç±»ä¸ºä¸€ä¸ªå®ä½“ç±»</p><h4 id="2-Table"><a href="#2-Table" class="headerlink" title="2. @Table"></a>2. @Table</h4><p>ä½¿ç”¨ @Table æ³¨è§£æ ‡æ³¨åœ¨ç±»ä¸Š, å¯ä»¥æŒ‡å®šä½¿ç”¨ @Entity æ³¨è§£æ ‡æ³¨çš„ç±»æ‰€ç”Ÿæˆçš„æ•°æ®åº“è¡¨ä¿¡æ¯,å¦‚è¡¨åç§°ç­‰.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span> <span class="comment">// æŒ‡å®šè¿™ä¸ªç±»ä¸ºå®ä½“ç±»</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"user"</span>) <span class="comment">// æŒ‡å®š@Entityæ ‡æ³¨çš„ä¸»è¡¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="3-Id-Column"><a href="#3-Id-Column" class="headerlink" title="3. @Id,@Column"></a>3. @Id,@Column</h4><p>ä½¿ç”¨ @Id æ³¨è§£æ ‡æ³¨åœ¨å˜é‡æˆ–è€…setæ–¹æ³•ä¸Š,ç”¨æ¥æ ‡æ³¨è¯¥å˜é‡ä¸ºä¸»é”®ID.</p><p>ä½¿ç”¨ @Column æ³¨è§£åŒæ ·æ ‡æ³¨åœ¨å˜é‡ä¸Š,èƒ½å¤Ÿè®¾ç½®ç”Ÿæˆè¡¨çš„å„ç§è¯¦ç»†ä¿¡æ¯,å¦‚å­—æ®µåç§°,å­—æ®µé•¿åº¦ç­‰ç­‰â€¦</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@Column</span>(columnDefinition = <span class="string">"INT(11)"</span>)</span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy=GenerationType.IDENTITY)</span><br><span class="line"><span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Column</span>(name = <span class="string">"is_deleted"</span>,columnDefinition = <span class="string">"TINYINT(1)"</span>,nullable =</span><br><span class="line"><span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">private</span> Short isDeleted=<span class="number">0</span>;</span><br></pre></td></tr></table></figure></div><h4 id="4-GeneratedValue"><a href="#4-GeneratedValue" class="headerlink" title="4. @GeneratedValue"></a>4. @GeneratedValue</h4><p>ä½¿ç”¨ @GeneratedValue æ³¨è§£æ ‡æ³¨åœ¨ å’Œ @Id ç›¸åŒçš„ä½ç½®,ç”¨æ¥è¡¨ç¤ºä¸»é”®IDçš„ç”Ÿæˆç­–ç•¥.è¯¥æ³¨è§£æœ‰ä¸¤ä¸ªå±æ€§,ç¬¬ä¸€ä¸ªæ˜¯å¸¸ç”¨åˆ°çš„ strategy å³ç”Ÿæˆç­–ç•¥,ç¬¬äºŒä¸ªæ˜¯ä¸å¸¸ç”¨åˆ°çš„generatoræŒ‡å®šç”Ÿæˆå™¨.</p><h5 id="strategy"><a href="#strategy" class="headerlink" title="strategy"></a>strategy</h5><p>GenerationType åŒ…å«å››ç§ç­–ç•¥:</p><ul><li>TABLE,ä½¿ç”¨ç‰¹å®šçš„è¡¨æ¥å­˜å‚¨ç”Ÿæˆçš„ä¸»é”®,ä¹Ÿå°±æ˜¯è¯´ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ç§è®°å½•ä¸»é”®çš„è¡¨,ä¸€èˆ¬ä¼šåŒ…å«ä¸¤ä¸ªå­—æ®µ,ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯å­—æ®µç”Ÿæˆç­–ç•¥çš„åç§°,ç¬¬äºŒä¸ªæ˜¯IDçš„æœ€å¤§åºåˆ—å€¼.é€šå¸¸ä¼šå’Œ @TableGenerator ä¸€èµ·æ¥ä½¿ç”¨,èƒ½å¤ŸæŒ‡å®šç‰¹å®šè¡¨æ¥ç”Ÿæˆä¸»é”®,å¦‚æœä¸æŒ‡å®š,ä¼šé»˜è®¤ç”Ÿæˆä¸€ä¸ªåç§°ä¸º sequence çš„è¡¨æ¥è®°å½•.</li><li>SEQUENCE,åœ¨ç‰¹å®šçš„æ•°æ®åº“,å¦‚ORACLE,ä¸æ”¯æŒè‡ªå¢ä¸»é”®,ä½†æ˜¯ä¼šæä¾›ä¸€ç§å«åšåºåˆ—çš„æ–¹å¼ç”Ÿæˆä¸»é”®,æ­¤æ—¶å°±éœ€è¦æŒ‡å®š SEQUENCE ä¸ºç”Ÿæˆä¸»é”®çš„ç­–ç•¥,å’ŒTABLEç›¸ä¼¼,é€šå¸¸ä¼šä½¿ç”¨ @SequenceGenerator ä¸€èµ·ä½¿ç”¨</li><li>IDENTITY ,é‡åˆ°å‘MYSQLèƒ½å¤Ÿè®©ä¸»é”®è‡ªå¢çš„æ•°æ®åº“,å°±å¯ä»¥æŒ‡å®šç”Ÿæˆç­–ç•¥ä¸ºIDENTITY,ç”Ÿæˆè¡¨å, Mysqlä¼šé»˜è®¤å°†è¯¥å­—æ®µè®¾ç½®ä¸º â€˜auto_incrementâ€™,</li><li>AUTO ,ä½¿ç”¨ @GeneratedValue é»˜è®¤çš„ç”Ÿæˆç­–ç•¥,æŠŠå…·ä½“ç”Ÿæˆä¸»é”®çš„è§„åˆ™äº¤ç»™æŒä¹…åŒ–å¼•æ“æ¥å®ç°,ä¹Ÿæ˜¯æˆ‘ä½¿ç”¨æœ€å¤šçš„ä¸€ç§æ–¹å¼.</li></ul><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ GenerationType.TABLE æŒ‡å®šç”Ÿæˆçš„è®°å½•è¡¨,å…¶ä¸­nameå¿…é¡»,å…¶ä»–å¯é€‰</span></span><br><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy = GenerationType.TABLE, generator = <span class="string">"roleSeq"</span>)</span><br><span class="line"><span class="meta">@TableGenerator</span>(name = <span class="string">"roleSeq"</span>, allocationSize = <span class="number">1</span>, table = <span class="string">"seq_table"</span>, pkColumnName = <span class="string">"seq_id"</span>, valueColumnName = <span class="string">"seq_count"</span>)</span><br><span class="line"><span class="keyword">private</span> Integer id;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ SEQUENCE </span></span><br><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy = GenerationType.SEQUENCE, generator = <span class="string">"menuSeq"</span>)</span><br><span class="line"><span class="meta">@SequenceGenerator</span>(name = <span class="string">"menuSeq"</span>, initialValue = <span class="number">1</span>, allocationSize = <span class="number">1</span>, sequenceName = <span class="string">"MENU_SEQUENCE"</span>)</span><br><span class="line"><span class="keyword">private</span> Integer id;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ IDENTITY è¿›è¡Œè‡ªå¢</span></span><br><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line"><span class="keyword">private</span> Integer id;</span><br><span class="line"><span class="comment">// ä½¿ç”¨AUTO,æˆ–è€…ä¸æŒ‡å®šç­–ç•¥</span></span><br><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line"><span class="keyword">private</span> Integer id</span><br></pre></td></tr></table></figure></div><h5 id="generator"><a href="#generator" class="headerlink" title="generator"></a>generator</h5><p>é€šè¿‡ä¸Šé¢å¯¹ç­–ç•¥çš„æè¿°,ä¹Ÿå°±æ˜ç™½generatorçš„ä½œç”¨,å°±æ˜¯æŒ‡å®šç‰¹å®šnameçš„Generator</p><h4 id="5-Transient"><a href="#5-Transient" class="headerlink" title="5. @Transient"></a>5. @Transient</h4><p>ä½¿ç”¨ @Transient æ³¨è§£,æ ‡æ³¨åœ¨å­—æ®µä¸Š,åœ¨JPAç”Ÿæˆè¡¨å­—æ®µæ—¶èƒ½å¤Ÿå¿½ç•¥è¯¥å­—æ®µ,è®©å­—æ®µä¸å‡ºç°åœ¨æ•°æ®åº“ä¸­.</p><h4 id="6-Embeddedå’Œ-Embeddable"><a href="#6-Embeddedå’Œ-Embeddable" class="headerlink" title="6. @Embeddedå’Œ@Embeddable"></a>6. @Embeddedå’Œ@Embeddable</h4><p>å½“å®ä½“Aå‡ºç°åœ¨å®ä½“Bä¸­,ä½†å®ä½“Aä¸éœ€è¦å•ç‹¬ç”Ÿæˆä¸€å¼ è¡¨çš„ä½¿ç”¨,ä½¿ç”¨@@Embeddedå’Œ@Embeddableæ ‡æ³¨åœ¨ç±»ä¸Š,èƒ½å¤Ÿé˜²æ­¢å®ä½“Aç”Ÿæˆæ•°æ®åº“è¡¨.</p><h4 id="7-Temporal"><a href="#7-Temporal" class="headerlink" title="7. @Temporal"></a>7. @Temporal</h4><p>ä½¿ç”¨ @Temporal æ³¨è§£ç‰¹æ®Šæ ‡è®°åœ¨éœ€è¦æŒä¹…åŒ–çš„å­—æ®µä¸Š,å¹¶ä¸”å­—æ®µç±»å‹ä¸º <code>java.util.Date</code> æˆ– <code>java.util.Calendar</code>çš„æ—¶å€™,å¯æŒ‡å®š TemporalType æ¥ç”Ÿæˆå¯¹åº”æ•°æ®åº“ä¸­çš„æ—¶é—´æ ¼å¼(java.sql.xxxx). </p><h4 id="8-ä¸€å¯¹ä¸€-ä¸€å¯¹å¤š-å¤šå¯¹å¤šå…³ç³»"><a href="#8-ä¸€å¯¹ä¸€-ä¸€å¯¹å¤š-å¤šå¯¹å¤šå…³ç³»" class="headerlink" title="8. ä¸€å¯¹ä¸€,ä¸€å¯¹å¤š,å¤šå¯¹å¤šå…³ç³»"></a>8. ä¸€å¯¹ä¸€,ä¸€å¯¹å¤š,å¤šå¯¹å¤šå…³ç³»</h4><p>åœ¨ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ä¸­,å…ä¸äº†ä¸Šè¿°å…³ç³»çš„ç”Ÿæˆ,ä¸‹é¢å°±æ¥è¯´ä¸€ä¸‹,å¦‚ä½•é’ˆå¯¹ä¸€å¯¹ä¸€å…³ç³»ã€ä¸€å¯¹å¤šå…³ç³»ã€å¤šå¯¹å¤šå…³ç³»çš„é€šç”¨è®¾ç½®,åœ¨åˆ†åˆ«å®éªŒå‰,å…ˆäº†è§£ä¸€ä¸‹ @JoinColumn çš„ä½œç”¨</p><p>æˆ‘è®¤ä¸ºçš„JoinColumnæ˜¯ç‰¹æ®Šçš„@Column,å½“éœ€è¦ä½¿ç”¨åˆ°â€œå…³ç³»â€æ—¶,éœ€è¦ä½¿ç”¨åˆ°JoinColumnæ¥æ›¿ä»£æ™®é€šçš„Columnæ³¨è§£</p><h5 id="OneToOne"><a href="#OneToOne" class="headerlink" title="OneToOne"></a>OneToOne</h5><p>ä½¿ç”¨OneToOneæ³¨è§£,æŒ‡å®šä¸¤æ–¹å…³ç³»æ˜¯ä¸€å¯¹ä¸€çš„.æ¯”å¦‚Userå’ŒStatus,Statusæ˜¯Userçš„ä¸€ä¸ªå±æ€§,åœ¨Userè¡¨ä¸­åªéœ€è®°å½•Stautsè¡¨ä¸­çš„ä¸»é”®,æ‰€ä»¥éœ€è¦åœ¨Userè¡¨(ä¸»)ä¸­å£°æ˜ä¸€ä¸ªStatus(ä»)å³å¯:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OneToOne</span>()</span><br><span class="line"><span class="meta">@JoinColumn</span>(columnDefinition = <span class="string">"INT(11)"</span>,name = <span class="string">"status_id"</span>)</span><br><span class="line"><span class="keyword">private</span> Status status;</span><br></pre></td></tr></table></figure></div><h5 id="OneToManyã€ManyToOne"><a href="#OneToManyã€ManyToOne" class="headerlink" title="OneToManyã€ManyToOne"></a>OneToManyã€ManyToOne</h5><p>ä½¿ç”¨ @OneToMany æˆ– @ManyToOne æ³¨è§£æ¥è¡¨ç¤ºä¸€å¯¹å¤šã€å¤šå¯¹ä¸€çš„å…³ç³».å…¸å‹çš„å¦‚Projectä¹‹äºTask,ä¸€ä¸ªProjectåŒ…å«å¤šä¸ªTask,æ‰€ä»¥Projectä¸ºOne,Taskä¸ºMany.</p><p>å¦‚æœåœ¨Project(ä¸»)ä¸­å£°æ˜Task(ä»)æ—¶,å¯ä»¥ä½¿ç”¨ OneToMany è¡¨ç¤ºä¸€å¯¹å¤šå…³ç³»</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OneToMany</span>(cascade = CascadeType.ALL)</span><br><span class="line"><span class="meta">@JoinColumn</span>(name=<span class="string">"project_id"</span>) <span class="comment">// taskè¡¨æŒ‡å‘projectè¡¨çš„å¤–é”®</span></span><br><span class="line">Set&lt;Task&gt; tasks;</span><br></pre></td></tr></table></figure></div><p>ä¹Ÿå¯ä»¥åœ¨å¤šçš„ä¸€æ–¹ä½¿ç”¨ ManyToOne æ³¨è§£,è¡¨ç¤ºå¤šå¯¹ä¸€çš„å…³ç³»</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="comment">// åœ¨ one çš„ä¸€æ–¹ç”Ÿæˆ nameä¸º project_id çš„å­—æ®µ,æŒ‡å‘task</span></span><br><span class="line"><span class="meta">@JoinColumn</span>(name=<span class="string">"project_id"</span>) </span><br><span class="line">Project project;</span><br></pre></td></tr></table></figure></div><p>ä»¥ä¸Šæ˜¯å•ç‹¬ä½¿ç”¨ @OneToMany æˆ– @ManyToOne æ„é€ å•å‘çš„å…³ç³»,ä½†æ˜¯è¿™æ ·æœ‰ç¼ºç‚¹,æ³¨å®šæœ‰ä¸€æ–¹æ‰¾ä¸åˆ°å¦å¤–ä¸€æ–¹(åªå»ºç«‹äº†å•å‘å…³ç³»).æ‰€ä»¥ç¨³å¦¥çš„æ–¹å¼æ˜¯æ„å»ºåŒå‘å…³ç³»,åœ¨Oneå’ŒManyåŒæ–¹,ä½¿ç”¨ä¸¤ä¸ªæ³¨è§£ç›¸äº’æŒ‡å®š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Projectä¸­,å…¶ä¸­mappedByæ˜¯åŒå‘å…³ç³»ä¸­å¿…é¡»è¦ä½¿ç”¨çš„å±æ€§</span></span><br><span class="line"><span class="meta">@OneToMany</span>(cascade = CascadeType.ALL,mappedBy =<span class="string">"project_id"</span>)</span><br><span class="line">Set&lt;Task&gt; tasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Taskä¸­</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn</span>(name=<span class="string">"project_id"</span>)</span><br><span class="line">Project project</span><br></pre></td></tr></table></figure></div><h5 id="ManyToMany"><a href="#ManyToMany" class="headerlink" title="ManyToMany"></a>ManyToMany</h5><p>ä½¿ç”¨ @ManyToMany æ³¨è§£æ¥æ ‡æ³¨å¤šå¯¹å¤šå…³ç³»,æ¯”å¦‚ç”¨æˆ·å’Œè§’è‰²ä¹‹é—´å°±å¯ä»¥ç†è§£ä¸ºå¤šå¯¹å¤šçš„å…³ç³»,åŒæ–¹éœ€è¦äº’ç›¸æ‹¥æœ‰å¤šä¸ª.å¤šåœ°å¤šå…³ç³»éœ€è¦ä½¿ç”¨ä¸­é—´è¡¨æ¥ç»´æŠ¤ä¸¤æ–¹å…³ç³».å»ºç«‹å…³ç³»è¡¨ä½¿ç”¨@JoinTableæ³¨è§£æ¥æŒ‡å®šå®ç°.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Userè¡¨ä¸­</span></span><br><span class="line"><span class="meta">@JSONField</span>(name = <span class="string">"roles"</span>)</span><br><span class="line"><span class="meta">@ManyToMany</span>(mappedBy = <span class="string">"users"</span>,fetch = FetchType.EAGER,cascade = CascadeType.ALL)</span><br><span class="line"><span class="keyword">private</span> Set&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Role è¡¨ä¸­</span></span><br><span class="line"><span class="meta">@JSONField</span>(serialize = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ManyToMany</span>(cascade = CascadeType.ALL,fetch = FetchType.EAGER)</span><br><span class="line"><span class="meta">@JoinTable</span>(name = <span class="string">"r_user_role"</span>,</span><br><span class="line">        joinColumns = &#123;<span class="meta">@JoinColumn</span>(name = <span class="string">"role_id"</span>)&#125;,</span><br><span class="line">        inverseJoinColumns = &#123;<span class="meta">@JoinColumn</span>(name = <span class="string">"user_id"</span>)&#125;)</span><br><span class="line"><span class="keyword">private</span> List&lt;User&gt; users;</span><br></pre></td></tr></table></figure></div><h5 id="å…³ç³»ä½¿ç”¨æ—¶çš„å‘"><a href="#å…³ç³»ä½¿ç”¨æ—¶çš„å‘" class="headerlink" title="å…³ç³»ä½¿ç”¨æ—¶çš„å‘"></a>å…³ç³»ä½¿ç”¨æ—¶çš„å‘</h5><ol><li>åŒå‘å…³ç³»éœ€è¦åŒæ–¹éƒ½è¿›è¡Œç»´æŠ¤,å¦åˆ™ä¿å­˜ä¸ä¸Š :)</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User user = one.get();</span><br><span class="line"><span class="comment">// å¤šå¯¹å¤šå…³ç³»éœ€è¦åŒå‘å…³è”ä¿å­˜æ‰èµ·ä½œç”¨</span></span><br><span class="line">user.getRoles().add(role);</span><br><span class="line">role.getUsers().add(user);</span><br></pre></td></tr></table></figure></div><ol start="2"><li>ä½¿ç”¨JSONæ—¶,å¦‚æœå‡ºç°å¾ªç¯å¼•ç”¨å¯¼å‡ºæº¢å‡ºæ—¶,åœ¨ä¸€æ–¹åŠ å…¥è®¾ç½®é˜²æ­¢åºåˆ—åŒ–</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä½¿ç”¨çš„æ˜¯FastJosn,Jacksonæœ‰ä¸åŒçš„å®ç°æ–¹å¼</span></span><br><span class="line"><span class="meta">@JSONField</span>(serialize = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ManyToMany</span>(cascade = CascadeType.ALL,fetch = FetchType.EAGER)</span><br><span class="line"><span class="meta">@JoinTable</span>(name = <span class="string">"r_user_routemeta"</span>,</span><br><span class="line">        joinColumns = &#123;<span class="meta">@JoinColumn</span>(name = <span class="string">"role_id"</span>)&#125;,</span><br><span class="line">        inverseJoinColumns = &#123;<span class="meta">@JoinColumn</span>(name = <span class="string">"meta_id"</span>)&#125;)</span><br><span class="line"><span class="keyword">private</span> Set&lt;RouteMeta&gt; routeMeta;</span><br></pre></td></tr></table></figure></div><h3 id="ä½¿ç”¨-Repository-æŸ¥è¯¢"><a href="#ä½¿ç”¨-Repository-æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨ Repository æŸ¥è¯¢"></a>ä½¿ç”¨ Repository æŸ¥è¯¢</h3><p>Repository æ˜¯ Spring Data JPA ä¸­æœ€é‡è¦çš„æ¥å£,ä½¿ç”¨å®ä½“ç±»å’Œå®ä½“ç±»ä¸­çš„ä¸»é”®IDä½œä¸ºç±»å‹å‚æ•°.å…¶ä¸­CURDRepositoryä¸ºå®ä½“ç±»æä¾›äº†å¤æ‚å¢åˆ æ”¹æŸ¥çš„å‡½æ•°.</p><h4 id="1-CrudRepositoryæ¥å£"><a href="#1-CrudRepositoryæ¥å£" class="headerlink" title="1. CrudRepositoryæ¥å£"></a>1. CrudRepositoryæ¥å£</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CrudRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure></div><p>åŒæ ·æä¾›äº†ç‰¹å®šçš„Repository,æ¯”å¦‚JPARepositoryã€MongoRepository,è¿™å‡ ä¸ªéƒ½æ˜¯ç»§æ‰¿çš„ CrudRepository æ¥å£,æ ¹æ®ä¸åŒçš„æŠ€æœ¯ç‰¹æ€§æš´éœ²ä¸åŒçš„æ¥å£æ–¹æ³•.ä¸€èˆ¬ä½¿ç”¨ä¸Šç›´æ¥ç»§æ‰¿CurdRepositoryå°±å¯ä»¥å®ŒæˆåŸºæœ¬çš„å·¥ä½œ.</p><h4 id="2-PagingAndSortingRepositoryæ¥å£"><a href="#2-PagingAndSortingRepositoryæ¥å£" class="headerlink" title="2. PagingAndSortingRepositoryæ¥å£"></a>2. PagingAndSortingRepositoryæ¥å£</h4><p>å¦‚æœä½¿ç”¨åˆ†é¡µæˆ–è€…æ’åºéœ€è¦ç»§æ‰¿ PagingAndSortingRepository æ¥å£,è¿™ä¸ªæ¥å£ä¸­åŒ…å« <code>Iterable&lt;T&gt; findAll(Sort sort);</code> å’Œ <code>Page&lt;T&gt; findAll(Pageable pageable);</code>,è¿™æ ·èƒ½å¤Ÿå…·æœ‰æŸ¥è¯¢æ—¶åˆ†é¡µçš„ç‰¹æ€§</p><h4 id="3-æ¥å£ä¸­çš„åç§°æ¨å¯¼æŸ¥è¯¢"><a href="#3-æ¥å£ä¸­çš„åç§°æ¨å¯¼æŸ¥è¯¢" class="headerlink" title="3. æ¥å£ä¸­çš„åç§°æ¨å¯¼æŸ¥è¯¢"></a>3. æ¥å£ä¸­çš„åç§°æ¨å¯¼æŸ¥è¯¢</h4><ul><li>é€šè¿‡å‘½åæŸ¥è¯¢,å…·ä½“å¯æŸ¥çœ‹ç›¸å…³æ–‡æ¡£,å†™çš„éå¸¸å…¨ <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation" target="_blank" rel="noopener">create-query</a></li></ul><table><thead><tr><th>å…³é”®å­—</th><th>æ–¹æ³•å‘½å</th><th>sql whereå­—å¥</th></tr></thead><tbody><tr><td>And</td><td>findByNameAndPwd</td><td>where name= ? and pwd =?</td></tr><tr><td>Or</td><td>findByNameOrSex</td><td>where name= ? or sex=?</td></tr><tr><td>Is,Equals</td><td>findById,findByIdEquals</td><td>where id= ?</td></tr><tr><td>Between</td><td>findByIdBetween</td><td>where id between ? and ?</td></tr><tr><td>LessThan</td><td>findByIdLessThan</td><td>where id &lt; ?</td></tr><tr><td>LessThanEquals</td><td>findByIdLessThanEquals</td><td>where id &lt;= ?</td></tr><tr><td>GreaterThan</td><td>findByIdGreaterThan</td><td>where id &gt; ?</td></tr><tr><td>GreaterThanEquals</td><td>findByIdGreaterThanEquals</td><td>where id &gt; = ?</td></tr><tr><td>After</td><td>findByIdAfter</td><td>where id &gt; ?</td></tr><tr><td>Before</td><td>findByIdBefore</td><td>where id &lt; ?</td></tr><tr><td>IsNull</td><td>findByNameIsNull</td><td>where name is null</td></tr><tr><td>isNotNull,NotNull</td><td>findByNameNotNull</td><td>where name is not null</td></tr><tr><td>Like</td><td>findByNameLike</td><td>where name like ?</td></tr><tr><td>NotLike</td><td>findByNameNotLike</td><td>where name not like ?</td></tr><tr><td>StartingWith</td><td>findByNameStartingWith</td><td>where name like â€˜?%â€™</td></tr><tr><td>EndingWith</td><td>findByNameEndingWith</td><td>where name like â€˜%?â€™</td></tr><tr><td>Containing</td><td>findByNameContaining</td><td>where name like â€˜%?%â€™</td></tr><tr><td>OrderBy</td><td>findByIdOrderByXDesc</td><td>where id=? order by x desc</td></tr><tr><td>Not</td><td>findByNameNot</td><td>where name &lt;&gt; ?</td></tr><tr><td>In</td><td>findByIdIn(Collection&lt;?&gt; c)</td><td>where id in (?)</td></tr><tr><td>NotIn</td><td>findByIdNotIn(Collection&lt;?&gt; c)</td><td>where id not in (?)</td></tr><tr><td>True</td><td>findByAaaTue</td><td>where aaa = true</td></tr><tr><td>False</td><td>findByAaaFalse</td><td>where aaa = false</td></tr><tr><td>IgnoreCase</td><td>findByNameIgnoreCase</td><td>where UPPER(name)=UPPER(?)</td></tr></tbody></table><h4 id="4-ä½¿ç”¨-Repository-æŸ¥è¯¢å®ä¾‹"><a href="#4-ä½¿ç”¨-Repository-æŸ¥è¯¢å®ä¾‹" class="headerlink" title="4. ä½¿ç”¨ Repository æŸ¥è¯¢å®ä¾‹"></a>4. ä½¿ç”¨ Repository æŸ¥è¯¢å®ä¾‹</h4><ol><li>å£°æ˜ä¸€ä¸ªæ¥å£ç»§æ‰¿ç‰¹å®šçš„Repository</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JpaRepository ç»§æ‰¿è‡ª PagingAndSortingRepository,å…¶ä¸­ç±»å‹å‚æ•°</span></span><br><span class="line"><span class="comment"> * ç¬¬ä¸€ä¸ªæ˜¯æ“ä½œå®ä½“ç±»çš„ç±»å‹</span></span><br><span class="line"><span class="comment"> * ç¬¬äºŒä¸ªæ˜¯æ“ä½œå®ä½“ç±»çš„æ ‡è¯†ID</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Integer</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure></div><ol start="2"><li>(å¯é€‰)åœ¨æ¥å£ä¸­å®šä¹‰æ–¹æ³•</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…·ä½“åç§°æ¨å¯¼æŸ¥è¯¢å¯ä»¥æŸ¥çœ‹ä¸Šé¢çš„è¡¨æ ¼</span></span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname)</span></span>;</span><br></pre></td></tr></table></figure></div><ol start="3"><li>ä½¿ç”¨@AutoWireæ³¨è§£injectåˆ°ç‰¹å®šçš„serviceä¸­è°ƒç”¨</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">UserRepository userRepository;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUserFromUserName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userRepository.findUserByName(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åˆ°è¿™é‡Œ,å¢åˆ æ”¹æŸ¥åŸºæœ¬éƒ½èƒ½å¤Ÿå®ç°,å¤æ‚çš„åœ¨äºåˆ†é¡µã€å¤šæ¡ä»¶å¤æ‚æŸ¥è¯¢.</p><h4 id="5-ä½¿ç”¨-PagingAndSortingRepository-è¿›è¡Œåˆ†é¡µæŸ¥è¯¢"><a href="#5-ä½¿ç”¨-PagingAndSortingRepository-è¿›è¡Œåˆ†é¡µæŸ¥è¯¢" class="headerlink" title="5. ä½¿ç”¨ PagingAndSortingRepository è¿›è¡Œåˆ†é¡µæŸ¥è¯¢"></a>5. ä½¿ç”¨ PagingAndSortingRepository è¿›è¡Œåˆ†é¡µæŸ¥è¯¢</h4><p>å‰é¢è¯´åˆ° PagingAndSortingRepository æä¾›äº†ä¸¤ä¸ªæ–¹æ³•,ä¸€ä¸ªæ˜¯è¿”å›Iterableçš„ findAll(Sort) æ–¹æ³•,å¦ä¸€ä¸ªæ˜¯è¿”å›Pageçš„findAllæ–¹æ³•</p><ol><li>åœ¨æ²¡æœ‰å…¶ä»–æŸ¥è¯¢æ¡ä»¶çš„æƒ…å†µä¸‹,ç›´æ¥å®šä¹‰ä¸€ä¸ªPageableå˜é‡,ç„¶åä½¿ç”¨ç‰¹å®šæ–¹æ³•å³å¯:</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Book&gt; <span class="title">findBookNoCriteria</span><span class="params">(Integer page,Integer size)</span> </span>&#123;</span><br><span class="line">    Pageable pageable = <span class="keyword">new</span> PageRequest(page, size, Sort.Direction.ASC, <span class="string">"id"</span>);</span><br><span class="line">    <span class="keyword">return</span> bookRepository.findAll(pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><ol start="2"><li>åœ¨å­˜åœ¨å¤šæ ·çš„æŸ¥è¯¢æ¡ä»¶çš„æƒ…å†µä¸‹,è¿˜éœ€è¦æ¥å£ç»§æ‰¿ <code>JpaSpecificationExecutor</code></li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Book&gt; <span class="title">findBookCriteria</span><span class="params">(Integer page, Integer size, <span class="keyword">final</span> BookQuery bookQuery)</span> </span>&#123;</span><br><span class="line">    Pageable pageable = <span class="keyword">new</span> PageRequest(page, size, Sort.Direction.ASC, <span class="string">"id"</span>);</span><br><span class="line">    Page&lt;Book&gt; bookPage = bookRepository.findAll(<span class="keyword">new</span> Specification&lt;Book&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Predicate <span class="title">toPredicate</span><span class="params">(Root&lt;Book&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder)</span> </span>&#123;</span><br><span class="line">            Predicate p1 = criteriaBuilder.equal(root.get(<span class="string">"name"</span>).as(String.class), bookQuery.getName());</span><br><span class="line">            Predicate p2 = criteriaBuilder.equal(root.get(<span class="string">"isbn"</span>).as(String.class), bookQuery.getIsbn());</span><br><span class="line">            Predicate p3 = criteriaBuilder.equal(root.get(<span class="string">"author"</span>).as(String.class), bookQuery.getAuthor());</span><br><span class="line">            query.where(criteriaBuilder.and(p1,p2,p3));</span><br><span class="line">            <span class="keyword">return</span> query.getRestriction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,pageable);</span><br><span class="line">    <span class="keyword">return</span> bookPage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="ä½¿ç”¨-Queryè¯­å¥æŸ¥è¯¢"><a href="#ä½¿ç”¨-Queryè¯­å¥æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨@Queryè¯­å¥æŸ¥è¯¢"></a>ä½¿ç”¨@Queryè¯­å¥æŸ¥è¯¢</h3><p>å°½ç®¡é€šè¿‡ä¸Šé¢çš„æ–¹æ³•èƒ½å¤Ÿéå¸¸æ–¹ä¾¿å¿«æ·çš„ä½¿ç”¨æŸ¥è¯¢,ä½†æ˜¯æœ‰æ—¶å€™åŒ…å«ç‰¹æ®Šå­—æ®µçš„æŸ¥è¯¢æˆ–è€…ä½¿ç”¨åç§°ç»„åˆå‡ºæ¥çš„æ–¹æ³•ååˆé•¿æœ‰ä¸‘â€¦è€Œä¸”æ‹…å¿ƒæ•ˆç‡ä½,è¿™æ—¶å€™JPAæä¾›äº†ä¸€ç§ç±»ä¼¼Hibernateçš„æ–¹æ³•,å°±æ˜¯ä½¿ç”¨@Queryè¿›è¡ŒæŸ¥è¯¢</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"select u from User u where u.emailAddress = ?1"</span>)</span><br><span class="line"><span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br></pre></td></tr></table></figure></div><p>æˆ–è€…ä½¿ç”¨åŸç”ŸSQLæŸ¥è¯¢,å°†Queryçš„å‚æ•°nativeQueryè®¾ç½®ä¸ºtrue</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(nativeQuery = <span class="keyword">true</span>,value = <span class="string">"select u.name from user u where u.id:id limit 1"</span>)</span><br><span class="line"><span class="function">String <span class="title">getUserNameById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure></div><h3 id="ä½¿ç”¨QueryDSLè¿›è¡Œå¤æ‚æŸ¥è¯¢"><a href="#ä½¿ç”¨QueryDSLè¿›è¡Œå¤æ‚æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨QueryDSLè¿›è¡Œå¤æ‚æŸ¥è¯¢"></a>ä½¿ç”¨QueryDSLè¿›è¡Œå¤æ‚æŸ¥è¯¢</h3><p>å¦‚æœä¸Šé¢çš„æŸ¥è¯¢æ–¹å¼ä»ç„¶æ»¡è¶³ä¸äº†éœ€æ±‚,é‚£ä¹ˆå¯ä»¥å°è¯•ä½¿ç”¨QueryDSLè¿›è¡ŒæŸ¥è¯¢ <a href="http://www.querydsl.com/static/querydsl/latest/reference/html/ch02.html#jpa_integration" target="_blank" rel="noopener">QueryDSL</a></p><h4 id="1-è¿‡ç¨‹"><a href="#1-è¿‡ç¨‹" class="headerlink" title="1. è¿‡ç¨‹"></a>1. è¿‡ç¨‹</h4><ol><li>æ·»åŠ MAVENä¾èµ–</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.querydsl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>querydsl-apt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;querydsl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.querydsl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>querydsl-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;querydsl.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æ·»åŠ APT PLUGIN --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysema.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apt-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>process<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/generated-sources/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">processor</span>&gt;</span>com.querydsl.apt.jpa.JPAAnnotationProcessor<span class="tag">&lt;/<span class="name">processor</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>JPAAnnotationProcessor ä¼šæŸ¥æ‰¾æ‰€æœ‰çš„ Entity æ³¨è§£æ ‡æ³¨çš„å®ä½“ç±»åœ¨ç›®æ ‡è·¯å¾„ä¸‹ç”Ÿæˆ Qxxx çš„ç±».ç¬¬ä¸€æ¬¡éœ€è¦ä½¿ç”¨ maven install ç”Ÿæˆä¸€ä¸‹.</p><ol start="2"><li>ä½¿ç”¨æŸ¥è¯¢</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ³¨å…¥ jpaQueryFactory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entityManager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">jpaQueryFactory</span><span class="params">(EntityManager entityManager)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(entityManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨@BeanæŠŠJPAQueryFactoryæ³¨å…¥åˆ°å®¹å™¨ä¸­,ç„¶åä½¿ç”¨JpaQueryFactoryæŸ¥è¯¢.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;User&gt; <span class="title">doGetrolePerson</span><span class="params">(Integer role,<span class="keyword">boolean</span> in,List&lt;User&gt; users)</span></span>&#123;</span><br><span class="line">    QUser user = QUser.user;</span><br><span class="line">    Predicate predicate = user.isNotNull().or(user.isNull());</span><br><span class="line">    <span class="keyword">if</span>(in)&#123;</span><br><span class="line">        predicate = role == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.roles.any().id.in(role));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        predicate = role == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.notIn(users));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jpaQueryFactory.selectFrom(user).where(predicate).fetch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä»¥ä¸Šæ˜¯ä½¿ç”¨åŸºæœ¬çš„QueryDSLè¿›è¡ŒæŸ¥è¯¢çš„æ–¹å¼,æ›´å¤šçš„å¢åˆ æ”¹æŸ¥çš„æ–¹æ³•å¯ä»¥å‚è€ƒä¸Šé¢å¼•ç”¨çš„æ–‡æ¡£,è¿™é‡Œä¸åœ¨è¿‡å¤šæè¿°.</p><h4 id="2-ç»“åˆæŸ¥è¯¢"><a href="#2-ç»“åˆæŸ¥è¯¢" class="headerlink" title="2. ç»“åˆæŸ¥è¯¢"></a>2. ç»“åˆæŸ¥è¯¢</h4><p>SpringDataJPA å¯¹ QueryDSL æä¾›äº†ä¸€ä¸ªé€šç”¨çš„Repository â€“ QuerydslPredicateExecutor</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Optional&lt;T&gt; <span class="title">findOne</span><span class="params">(Predicate var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;T&gt; <span class="title">findAll</span><span class="params">(Predicate var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;T&gt; <span class="title">findAll</span><span class="params">(Predicate var1, Sort var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;T&gt; <span class="title">findAll</span><span class="params">(Predicate var1, OrderSpecifier&lt;?&gt;... var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;T&gt; <span class="title">findAll</span><span class="params">(OrderSpecifier&lt;?&gt;... var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">findAll</span><span class="params">(Predicate var1, Pageable var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">(Predicate var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(Predicate var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä½¿ç”¨éœ€è¦è®©å®šä¹‰çš„Repositoryç»§æ‰¿è¿™ä¸ªQuerydslPredicateExecutor,ç„¶åè°ƒç”¨æ–¹æ³•å³å¯:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;User&gt; <span class="title">findUsers</span><span class="params">(Integer offset, Integer limit, String order, String search, Integer status, Integer sex, Integer role)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Sort sort = <span class="keyword">null</span>;</span><br><span class="line">    String propertie = order.substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (order.startsWith(<span class="string">"-"</span>)) &#123;</span><br><span class="line">        sort = Sort.by(propertie).descending();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (order.startsWith(<span class="string">"+"</span>)) &#123;</span><br><span class="line">        sort = Sort.by(propertie).ascending();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(offset == <span class="keyword">null</span> || limit == <span class="keyword">null</span>)&#123;</span><br><span class="line">        offset = <span class="number">1</span>;</span><br><span class="line">        limit = Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    PageRequest pageRequest = <span class="keyword">new</span> PageRequest(offset - <span class="number">1</span>, limit, sort);</span><br><span class="line">    QUser user = QUser.user;</span><br><span class="line">    com.querydsl.core.types.Predicate predicate = user.isNotNull().or(user.isNull());</span><br><span class="line">    predicate = search == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.name.like(<span class="string">"%"</span> + search + <span class="string">"%"</span>));</span><br><span class="line">    predicate = sex == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.sex.id.eq(sex));</span><br><span class="line">    predicate = status == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.status.id.eq(status));</span><br><span class="line">    predicate = role == <span class="keyword">null</span> ? predicate : ExpressionUtils.and(predicate, user.roles.any().id.eq(role));</span><br><span class="line">    <span class="keyword">return</span> userRepository.findAll(predicate, pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBootæ•´åˆJPAä½¿ç”¨&quot;&gt;&lt;a href=&quot;#SpringBootæ•´åˆJPAä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;SpringBootæ•´åˆJPAä½¿ç”¨&quot;&gt;&lt;/a&gt;SpringBootæ•´åˆJPAä½¿ç”¨&lt;/h1&gt;&lt;h2 id=&quot;æ•´åˆJPA
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„Beançš„å®ä¾‹åŒ–</title>
    <link href="https://nanyiniu.github.io/2020/01/17/Spring%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
    <id>https://nanyiniu.github.io/2020/01/17/Springä»é›¶å¼€å§‹ä¹‹æºç åˆ†æï¼ˆå››ï¼‰/</id>
    <published>2020-01-17T15:00:00.000Z</published>
    <updated>2020-01-18T01:26:29.628Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Beançš„å®ä¾‹åŒ–"><a href="#Beançš„å®ä¾‹åŒ–" class="headerlink" title="Beançš„å®ä¾‹åŒ–"></a>Beançš„å®ä¾‹åŒ–</h1><p>åœ¨refreshæ–¹æ³•æ‰§è¡Œåˆ° <code>finishBeanFacotyInitializawtion</code> æ—¶ï¼Œåœ¨æ–¹æ³•å†…éƒ¨ä¼šæ‰§è¡Œå¯¹Beançš„å®ä¾‹åŒ–æ“ä½œï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  ä¸ºBeanFactoyæ·»åŠ conversionService</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; <span class="comment">// æ˜¯å¦åŒ…å« conversionService</span></span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">    <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">    <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°½æ—©åˆå§‹åŒ–LoadTimeWeaverAware Beanï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå…¶è½¬æ¢å™¨ã€‚</span></span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–æ¶ˆä½¿ç”¨ä¸´æ—¶çš„classLoader</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸ç¼“å­˜æ‰€æœ‰çš„Bean Definition å…ƒæ•°æ®ï¼Œ</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéæ‡’åŠ è½½çš„ï¼‰å•ä¾‹çš„Bean</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é‡ç‚¹åœ¨äº <code>preInstantiateSingletons</code> æ–¹æ³•ï¼Œç”¨æ¥åˆå§‹åŒ–æ‰€æœ‰çš„å•ä¾‹Beanã€‚å®é™…ä¸Šåœ¨å‰é¢çš„getBeanè·å–weaverAwareå°±èƒ½å¤Ÿçœ‹å‡ºçœŸæ­£è°ƒç”¨è·å–å•å®ä¾‹çš„Beançš„æ–¹æ³•å°±æ˜¯ <code>getBean</code> æ–¹æ³•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// logging ....</span></span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘æœ‰éæ‡’åŠ è½½çš„Beançš„åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰çš„RootBeanDefinition,æ‰€è°“çš„Rootxxxï¼Œå…¶å®å°±æ˜¯ç»Ÿä¸€çš„BeanDefinitionè§†å›¾</span></span><br><span class="line">        RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯FactoryBeanï¼Œåˆ™ä½¿ç”¨getBeanæ—¶éœ€è¦åŠ ä¸Šå‰ç¼€ &amp;</span></span><br><span class="line">                Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">                    <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">                    <span class="keyword">boolean</span> isEagerInit;</span><br><span class="line">                    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœç»§æ‰¿SmartFactoryBean</span></span><br><span class="line">                        isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                                        ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                                getAccessControlContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                                ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                    <span class="comment">// æ‰§è¡ŒgetBeanè·å–Bean</span></span><br><span class="line">                        getBean(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒgetBeanè·å–Bean</span></span><br><span class="line">                getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘åˆå§‹åŒ–åçš„callback...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨<code>preInstantiateSingletons</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä¼šéå†æ‰€æœ‰çš„å·²ç»æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„Beanï¼Œæœ€åä¼šé€šè¿‡ <code>getBean()</code> è¿›è¡Œå¯¹Beançš„åˆå§‹åŒ–æ“ä½œã€‚</p><p>å…¶ä¸­åˆ¤æ–­äº†å¦‚æœæ˜¯ <code>Factorybean</code> çš„æƒ…å†µä¸‹åº”è¯¥å…ˆå»æ·»åŠ ä¸€ä¸ªå‰ç¼€ â€˜&amp;â€™ ï¼Œæ‰èƒ½è·å–çœŸæ­£çš„FactoryBeançš„å®ç°ç±»çš„å¯¹è±¡Beanã€‚å¦‚æœä¸æ·»åŠ å‰ç¼€ â€˜&amp;â€™ï¼Œåˆ™ä¼šè¿”å›å®ç°ç±»ä¸­çš„getObjectæ–¹æ³•è¿”å›çš„å¯¹è±¡ã€‚</p><p>å› ä¸ºç»è¿‡åˆ†æï¼Œæ˜¯ getBean æ–¹æ³•æ˜¯è¾¾åˆ°åˆå§‹åŒ–Beanå®ä¾‹çš„ç›®çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çœ‹ getBean ä¸­æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h2 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h2><p>getBeanæ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä¾æ®è°ƒç”¨é¡ºåºæ‹†å‡ºæ¥å¤§è‡´5ä¸ªå°ç« èŠ‚æ¥å±•å¼€è®²ã€‚</p><h3 id="1-getBeané€šè¿‡è°ƒç”¨doGetBeanåˆ›å»ºå®ä¾‹"><a href="#1-getBeané€šè¿‡è°ƒç”¨doGetBeanåˆ›å»ºå®ä¾‹" class="headerlink" title="1.getBeané€šè¿‡è°ƒç”¨doGetBeanåˆ›å»ºå®ä¾‹"></a>1.getBeané€šè¿‡è°ƒç”¨doGetBeanåˆ›å»ºå®ä¾‹</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="2-æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨"><a href="#2-æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨" class="headerlink" title="2. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨"></a>2. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨</h3><p>è°ƒç”¨doGetBeanæ–¹æ³•åï¼Œé¦–å…ˆä¼šå…ˆä½¿ç”¨getSingletonæ–¹æ³•åˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å®ä¾‹ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p><ol><li>åˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ï¼Ÿ</li><li>å¦‚æœå­˜åœ¨ï¼Œå¦‚æœå½“å‰å•ä¾‹æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™è¯´æ˜å‡ºç°äº†å¾ªç¯å¼•ç”¨ã€‚</li><li>å¦‚æœå­˜åœ¨ï¼Œå®ä¾‹æ²¡æœ‰æ­£åœ¨åˆ›å»ºï¼Œæ²¡æœ‰å¾ªç¯å¼•ç”¨ã€‚</li><li>åªè¦ç¼“å­˜ä¸­å­˜åœ¨ï¼Œéƒ½ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„BeanInstance</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, @Nullable <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// è·å¾—Beannameå­—ç¬¦ä¸²ï¼Œå› ä¸ºæœ‰FactoryBeanéœ€è¦æ·»åŠ &amp;ç¬¦å·</span></span><br><span class="line">    <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">    Object bean;</span><br><span class="line"></span><br><span class="line">    Object sharedInstance = getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                logger.trace(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</span><br><span class="line">                        <span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.trace(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure></div><h3 id="3-å¦‚æœtypeCheckOnlyä¸ºfalseï¼Œåˆ™æ ‡è®°å·²åˆ›å»º"><a href="#3-å¦‚æœtypeCheckOnlyä¸ºfalseï¼Œåˆ™æ ‡è®°å·²åˆ›å»º" class="headerlink" title="3. å¦‚æœtypeCheckOnlyä¸ºfalseï¼Œåˆ™æ ‡è®°å·²åˆ›å»º"></a>3. å¦‚æœtypeCheckOnlyä¸ºfalseï¼Œåˆ™æ ‡è®°å·²åˆ›å»º</h3><p>ä½œç”¨æ˜¯ï¼šå°†æŒ‡å®šçš„beanæ ‡è®°ä¸ºå·²åˆ›å»ºï¼Œå…è®¸beanå·¥å‚ä¼˜åŒ–å…¶ç¼“å­˜ä»¥é‡å¤åˆ›å»ºæŒ‡å®šçš„beanã€‚</p><h3 id="4-è·å–depend-onçš„Beanï¼Œå…ˆå¯¹å…¶è¿›è¡Œregisterå’Œå®ä¾‹åŒ–"><a href="#4-è·å–depend-onçš„Beanï¼Œå…ˆå¯¹å…¶è¿›è¡Œregisterå’Œå®ä¾‹åŒ–" class="headerlink" title="4. è·å–depend-onçš„Beanï¼Œå…ˆå¯¹å…¶è¿›è¡Œregisterå’Œå®ä¾‹åŒ–"></a>4. è·å–depend-onçš„Beanï¼Œå…ˆå¯¹å…¶è¿›è¡Œregisterå’Œå®ä¾‹åŒ–</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ depend-on çš„å†…å®¹æ˜¯ä½¿ç”¨ <code>@DependsOn</code> æ³¨è§£æŒ‡å®šçš„BeanNameï¼ˆæ³¨è§£æ–¹å¼ï¼‰</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—RootBeanDefinition</span></span><br><span class="line"><span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line"><span class="comment">// æ£€æŸ¥mergeåçš„beanDefinition</span></span><br><span class="line">checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"><span class="comment">// ç¡®ä¿å½“å‰beanä¾èµ–çš„beançš„åˆå§‹åŒ–ã€‚</span></span><br><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line"><span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">            <span class="comment">// throw exception ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…ˆregistr ä¾èµ–çš„Bean</span></span><br><span class="line">        registerDependentBean(dep, beanName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¯¹æ¯ä¸€ä¸ªdepè¿›è¡Œå…ˆè¡Œçš„å®ä¾‹åŒ–</span></span><br><span class="line">            getBean(dep);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="comment">// throw exception ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="5-è°ƒç”¨createBeanåˆ›å»ºBeanå®ä¾‹"><a href="#5-è°ƒç”¨createBeanåˆ›å»ºBeanå®ä¾‹" class="headerlink" title="5.è°ƒç”¨createBeanåˆ›å»ºBeanå®ä¾‹"></a>5.è°ƒç”¨createBeanåˆ›å»ºBeanå®ä¾‹</h3><p>åœ¨ä½¿ç”¨createBeanåˆ›å»ºBeanæ—¶ï¼Œä¼šé€šè¿‡ <code>Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</code>æ¥å¤„ç†åˆå§‹åŒ–Beanå‰ç½®æ–¹æ³•è§¦å‘AOPçš„åŠŸèƒ½ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">resolveBeforeInstantiation</span><span class="params">(String beanName, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">    Object bean = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;</span><br><span class="line">        <span class="comment">// Make sure bean class is actually resolved at this point.</span></span><br><span class="line">        <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">            Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);</span><br><span class="line">            <span class="keyword">if</span> (targetType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå‰ç½®æ–¹æ³•ï¼Œè·å–ä»£ç†Bean</span></span><br><span class="line">                bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mbd.beforeInstantiationResolved = (bean != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ EnableAspectJAutoProxy æ³¨è§£ï¼Œå°†AbstractAutoProxyCreator import è¿›æ¥ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥åœ¨è¿™é‡Œå¯ä»¥è°ƒç”¨ AbstractAutoProxyCreatoråç½®çš„å¤„ç†å™¨æ–¹æ³•ï¼Œæ¥å®ç°AOPåŠŸèƒ½</span></span><br><span class="line">        <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">            InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">            Object result = ibp.postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">    Object cacheKey = getCacheKey(beanClass, beanName); <span class="comment">//è·å¾—beanClass</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(beanName) || !<span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.advisedBeans.containsKey(cacheKey)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;<span class="comment">// å¦‚æœæ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½çš„ç±» æˆ–è€…æ˜¯ä¸€ä¸ªoriginal instance</span></span><br><span class="line">            <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE); <span class="comment">//æ·»åŠ åˆ°advisedBeansé‡Œé¢</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰è‡ªå®šä¹‰çš„ TargetSource</span></span><br><span class="line">    <span class="comment">// æŠ‘åˆ¶ç›®æ ‡Beançš„ä¸å¿…è¦çš„é»˜è®¤å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="comment">// TargetSourceå°†ä»¥è‡ªå®šä¹‰æ–¹å¼å¤„ç†ç›®æ ‡å®ä¾‹ã€‚</span></span><br><span class="line">    TargetSource targetSource = getCustomTargetSource(beanClass, beanName); <span class="comment">//è·å¾—targetSource</span></span><br><span class="line">    <span class="keyword">if</span> (targetSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.targetSourcedBeans.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä»£ç†</span></span><br><span class="line">        Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource); <span class="comment">//åˆ›å»ºä»£ç†ç±»</span></span><br><span class="line">        <span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        <span class="comment">// è¿”å›ç”Ÿæˆçš„ä»£ç†Bean</span></span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœå­˜åœ¨éœ€è¦åˆ›å»ºProxyä»£ç†Beanï¼Œåˆ™å…ˆå»åˆ›å»ºä»£ç†Beanï¼Œåœ¨åˆ›å»ºå®Œåï¼Œåˆ™ä¼šå¼€å§‹è°ƒç”¨ <code>doCreateBean</code> æ–¹æ³•åˆ›å»ºBeanå®ä¾‹ã€‚</p><p>æ¥ç€è°ƒç”¨ <code>Object beanInstance = doCreateBean(beanName, mbdToUse, args);</code> åˆ›å»ºå®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªObjectçš„ç±»å‹çš„beanInstance</p><p>doCreateBeanè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œå¤§è‡´èƒ½é€šè¿‡è¿™å‡ æ­¥å®Œæˆè¿™ä¸ªæ–¹æ³•ï¼›</p><ol><li>ä½¿ç”¨ <code>createBeanInstance</code>  åˆ›å»ºä¸€ä¸ªåŒ…è£…Bean</li><li>å…è®¸<code>MergedBeanPostProcessor</code>ä½¿ç”¨åç½®æ–¹æ³•å¤„ç†åŒ…è£…åçš„Bean</li><li>å¦‚æœ <code>allowCircularReferences</code> å±æ€§ä¸ºtrueï¼Œåˆ™å…ˆè·å– è¾¾åˆ°è¿™ä¸ªBeançš„æ—©æœŸçš„ref ï¼Œç”¨æ¥ <strong>é˜²æ­¢Beanåœ¨ç”Ÿæˆæ—¶å¾ªç¯å¼•ç”¨</strong> çš„é—®é¢˜ï¼Œåé¢ä¼šè¯¦ç»†è®²è¿™é‡Œæ˜¯å¦‚æœè·å–æ—©æœŸçš„refåº”ç”¨ï¼Œå’Œåˆæ˜¯å¦‚ä½•é˜²æ­¢Beançš„å¾ªç¯åº”ç”¨çš„é—®é¢˜ã€‚</li><li>é€šè¿‡ <code>populateBean</code> æ–¹æ³•ä¸ºBeanè¿›è¡Œèµ‹å€¼ï¼ŒåŒ…æ‹¬ä¾èµ–ï¼ï¼</li><li>é€šè¿‡ <code>initializeBean</code> æ–¹æ³•ï¼Œæ‰§è¡Œå„ç§åˆå§‹åŒ–æ–¹æ³•å’Œå‰ã€åç½®æ–¹æ³•ã€‚</li><li>é€šè¿‡ä¸‰çº§ç¼“å­˜æœºåˆ¶ï¼Œç”¨æ¥é˜²æ­¢å‡ºç°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚</li><li>æ³¨å†ŒBeanä¸ºä¸€æ¬¡æ€§çš„</li></ol><h4 id="createBeanInstance-åˆ›å»ºä¸€ä¸ªåŒ…è£…Bean"><a href="#createBeanInstance-åˆ›å»ºä¸€ä¸ªåŒ…è£…Bean" class="headerlink" title="createBeanInstance åˆ›å»ºä¸€ä¸ªåŒ…è£…Bean"></a>createBeanInstance åˆ›å»ºä¸€ä¸ªåŒ…è£…Bean</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//.....çœç•¥éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">// Shortcut when re-creating the same bean...</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿™é‡ŒæŒ‡çš„ShortCutçš„å«ä¹‰æ˜¯å½“å¤šæ¬¡æ„å»ºåŒä¸€ä¸ª bean æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªShortcutï¼Œ</span></span><br><span class="line"><span class="comment">     * ä¹Ÿå°±æ˜¯è¯´ä¸åœ¨éœ€è¦æ¯æ¬¡æ¨æ–­åº”è¯¥ä½¿ç”¨å“ªç§æ–¹å¼æ„é€ bean</span></span><br><span class="line"><span class="comment">     * æ¯”å¦‚åœ¨å¤šæ¬¡æ„å»ºåŒä¸€ä¸ªprototypeç±»å‹çš„ bean æ—¶ï¼Œå°±å¯ä»¥èµ°æ­¤å¤„çš„Shortcut</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œçš„ resolved å’Œ autowireNecessary å°†ä¼šåœ¨ bean ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­è¢«è®¾ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resolved = <span class="keyword">true</span>;</span><br><span class="line">                autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»åˆ›å»ºè¿‡äº†</span></span><br><span class="line">    <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä»¥è§£ææ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">            <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Candidate constructors for autowiring?</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯é€šè¿‡æ„é€ å‡½æ•°æ¥è‡ªåŠ¨æ³¨å…¥çš„</span></span><br><span class="line">    Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">    <span class="keyword">if</span> (ctors != <span class="keyword">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">            mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;</span><br><span class="line">        <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Preferred constructors for default construction?</span></span><br><span class="line">    ctors = mbd.getPreferredConstructors();</span><br><span class="line">    <span class="keyword">if</span> (ctors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ç‰¹æ®Šå¤„ç†ï¼Œä½¿ç”¨æ— å‚æ•°æ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœä½¿ç”¨é»˜è®¤çš„æ— å‚æ•°æ„é€ èµ·ï¼Œä¼šè°ƒç”¨<code>beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</code> è·å–ä½¿ç”¨åå°„ç”Ÿæˆçš„å®ä¾‹ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æµ‹ bean é…ç½®ä¸­æ˜¯å¦é…ç½®äº† lookup-method æˆ– replace-method</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„JDKä»£ç†ç”Ÿæˆå¯¹è±¡ï¼Œå¦åˆ™ä½¿ç”¨CGlibä»£ç†</span></span><br><span class="line"><span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line"><span class="comment">// çœç•¥ä»£ç ã€‚ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¿…é¡»ç”ŸæˆCGLIBå­ç±»</span></span><br><span class="line">    <span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>çŸ¥é“æœ€åä½¿ç”¨Constructor.newInstanceåˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚</p><h4 id="å…ˆç¼“å­˜æ—©æœŸçš„å®ä¾‹"><a href="#å…ˆç¼“å­˜æ—©æœŸçš„å®ä¾‹" class="headerlink" title="å…ˆç¼“å­˜æ—©æœŸçš„å®ä¾‹"></a>å…ˆç¼“å­˜æ—©æœŸçš„å®ä¾‹</h4><p>Springä¸­å­˜åœ¨ä¸‰å±‚ç¼“å­˜ï¼Œåˆ†åˆ«ä¸ºç¬¬ä¸€çº§çš„ <code>singletonObjects</code> ã€ç¬¬äºŒçº§çš„ <code>earlySingletonObjects</code> ã€ç¬¬ä¸‰çº§çš„<code>singletonFactories</code>ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></table></figure></div><p>é‚£ä¹ˆï¼ŒSpringå¦‚ä½•ä¾é è¿™ä¸‰çº§ç¼“å­˜æ¥é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircular referencesï¼‰çš„ä½œç”¨çš„å‘¢ï¼Ÿå…ˆé€šè¿‡ä¸‹é¢çš„å›¾ç‰‡æ¥ç®€å•äº†è§£ä¸‹ï¼Œå½“å‘ç”Ÿå¾ªç¯å¼•ç”¨æ—¶ï¼ŒSpringå¦‚ä½•ä½¿ç”¨ä¸‰çº§ç¼“å­˜çš„ã€‚</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/Spring%E5%BE%AA%E7%8E%AF%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B2.png" alt="å›¾1"></p><p>å¦‚å›¾ä¸­æ‰€ç¤ºï¼Œå¯¹è±¡Aä¾èµ–äºå¯¹è±¡Bï¼Œè€Œå¯¹è±¡Bä¾èµ–å¯¹è±¡Açš„æƒ…å†µã€‚ä¸‹é¢æ ¹æ®å›¾ä¸­å„èŠ‚ç‚¹æƒ…å†µæ¥å…·ä½“åˆ†æä»£ç çš„å®ç°ï¼š</p><h5 id="1-å®ä¾‹åŒ–Aï¼Œå‘ç°ä¾èµ–B"><a href="#1-å®ä¾‹åŒ–Aï¼Œå‘ç°ä¾èµ–B" class="headerlink" title="1. å®ä¾‹åŒ–Aï¼Œå‘ç°ä¾èµ–B"></a>1. å®ä¾‹åŒ–Aï¼Œå‘ç°ä¾èµ–B</h5><p>åœ¨åˆå§‹åŒ–Açš„è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ populateBean æ–¹æ³•è¿›è¡Œå±æ€§çš„èµ‹å€¼ï¼Œå…¶ä¸­ AutoWired çš„ç±»å‹æ¥åˆ†åˆ«å¤„ç†ï¼ˆBy Name è¿˜æ˜¯ By Typeï¼‰,<br>ä½†ä¸ç®¡æ˜¯å“ªä¸ªç±»å‹ï¼Œæœ€åéƒ½ä¼šä½¿ç”¨ getBean æ¥å…ˆè·å–ä¾èµ–ã€‚</p><h5 id="2-è·å–Bï¼Œå°†Aæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­"><a href="#2-è·å–Bï¼Œå°†Aæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­" class="headerlink" title="2. è·å–Bï¼Œå°†Aæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­"></a>2. è·å–Bï¼Œå°†Aæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­</h5><p>å…¶å®åœ¨è¿›è¡ŒAçš„å±æ€§èµ‹å€¼å‰ï¼Œå°±å·²ç»é€šè¿‡ <code>doCreateBean</code> æ–¹æ³•ä¸­çš„ <code>addSingletonFactory</code> æ–¹æ³•å°†Aæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">    <span class="comment">// å¦‚æœ allowCircularReferences ä¸ºtrue</span></span><br><span class="line"><span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="comment">// log.....</span></span><br><span class="line">    <span class="comment">// æ”¾åˆ°ç¬¬ä¸‰çº§çš„singletonFactoryé‡Œ</span></span><br><span class="line">    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯SingleFactory</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡æ²¡æœ‰ç”Ÿæˆè¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">        <span class="comment">// æ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼ŒåŒæ—¶å¦‚æœäºŒçº§ç¼“å­˜ä¸­å­˜åœ¨ï¼Œç§»é™¤æ‰</span></span><br><span class="line">            <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="3-å®ä¾‹åŒ–Bï¼Œå‘ç°ä¾èµ–A"><a href="#3-å®ä¾‹åŒ–Bï¼Œå‘ç°ä¾èµ–A" class="headerlink" title="3. å®ä¾‹åŒ–Bï¼Œå‘ç°ä¾èµ–A"></a>3. å®ä¾‹åŒ–Bï¼Œå‘ç°ä¾èµ–A</h5><p>åœ¨ä¸Šä¸€æ­¥ä¸­ï¼ŒAä¾èµ–Bï¼Œä¼šè°ƒç”¨<code>getBean</code>å…ˆå»è·å–Bï¼Œä½†åŒæ ·åœ¨<code>doCreateBean</code> æ–¹æ³•ä¸­çš„ <code>populateBean</code> æ–¹æ³•ä¸­åŒæ ·ä¼šè°ƒç”¨ <code>getBean</code> å…ˆå»è·å–ä¾èµ–Aã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object sharedInstance = getSingleton(beanName);</span><br><span class="line"><span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// log....</span></span><br><span class="line"><span class="comment">// é€šè¿‡getObjectForBeanInstanceè·å–Beanï¼Œå®Œæˆå®ä¾‹åŒ–</span></span><br><span class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡getSingletonæ–¹æ³•ä»ä¸‰çº§ç¼“å­˜è·å–beanï¼Œå¦‚æœæˆåŠŸçš„åœ¨ç¬¬ä¸‰çº§ç¼“å­˜ä¸­æ‰¾åˆ°Beanï¼Œåˆ™ç§»é™¤ç¬¬ä¸‰çº§ç¼“å­˜ä¸­çš„Beanï¼Œå¹¶æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸‰çº§ç¼“å­˜ä¸­æœ‰beanï¼Œåˆ™æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­</span></span><br><span class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="4-å®ä¾‹åŒ–å®Œæˆï¼Œå°†Bæ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­"><a href="#4-å®ä¾‹åŒ–å®Œæˆï¼Œå°†Bæ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­" class="headerlink" title="4. å®ä¾‹åŒ–å®Œæˆï¼Œå°†Bæ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­"></a>4. å®ä¾‹åŒ–å®Œæˆï¼Œå°†Bæ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­</h5><p>åœ¨è°ƒç”¨<code>doGetBean</code>æ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡ <code>getSingleton</code>æ–¹æ³•ä¸­çš„<code>addSingleton</code>å°†å®ä¾‹æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡å¥½åï¼Œè¿›è¡Œåˆ›å»ºå½“å‰Beanå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div><p>åœ¨<code>getSingleton</code>ä¸­è°ƒç”¨äº†<code>addSingleton(beanName, singletonObject)</code>,å°†å®Œæˆçš„å®ä¾‹æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">        <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">        <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">        <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="5-è¿”å›Açš„åˆ›å»ºè¿‡ç¨‹ï¼Œç»§ç»­åˆ›å»ºA"><a href="#5-è¿”å›Açš„åˆ›å»ºè¿‡ç¨‹ï¼Œç»§ç»­åˆ›å»ºA" class="headerlink" title="5. è¿”å›Açš„åˆ›å»ºè¿‡ç¨‹ï¼Œç»§ç»­åˆ›å»ºA"></a>5. è¿”å›Açš„åˆ›å»ºè¿‡ç¨‹ï¼Œç»§ç»­åˆ›å»ºA</h5><p>æœ€ååˆ›å»ºå®ŒæˆAåï¼ŒåŒæ ·ä¼šå°†Aæ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚è‡³æ­¤å¯¹è±¡Aï¼Œå¯¹è±¡Bå…¨éƒ¨åˆ›å»ºå®Œæˆã€‚åˆ©ç”¨äº†ä¸‰çº§ç¼“å­˜æœºåˆ¶é¿å…äº†å¾ªç¯å¼•ç”¨ã€‚</p><h4 id="populateBean-æ‰§è¡ŒBeançš„åˆå§‹åŒ–"><a href="#populateBean-æ‰§è¡ŒBeançš„åˆå§‹åŒ–" class="headerlink" title="populateBean æ‰§è¡ŒBeançš„åˆå§‹åŒ–"></a>populateBean æ‰§è¡ŒBeançš„åˆå§‹åŒ–</h4><p>åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°äº†ï¼Œåˆå§‹åŒ–å¯¹è±¡æ—¶ï¼Œéœ€è¦è°ƒç”¨<code>populateBean(beanName, mbd, instanceWrapper)</code>è¯¥æ–¹æ³•æ¥è¾¾åˆ°å±æ€§å€¼çš„å¡«å……ã€‚</p><p>å¿½ç•¥ <code>BeanPostProcessor</code>åç½®å¤„ç†å™¨ï¼Œé‚£ä¹ˆå®é™…ä¸Šæ­¥éª¤æ¯”è¾ƒç®€å•æ˜äº†ï¼š</p><ol><li>å¦‚æœä¸å­˜åœ¨å±æ€§å€¼ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œè·³è¿‡è¿™ä¸ªæ–¹æ³•ã€‚</li><li>å¦‚æœå­˜åœ¨ï¼Œå…ˆè·å¾—æ‰€æœ‰çš„å±æ€§å€¼ï¼Œä¾æ®AutoWiredå±æ€§ï¼Œå°†ä¾èµ–é¡¹æ³¨å…¥åˆ°å®¹å™¨ä¸­</li><li>æœ€åè¿›è¡ŒçœŸæ­£çš„å±æ€§å¡«å……</li></ol><h5 id="1-æ£€æŸ¥æ˜¯å¦å­˜åœ¨å±æ€§"><a href="#1-æ£€æŸ¥æ˜¯å¦å­˜åœ¨å±æ€§" class="headerlink" title="1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨å±æ€§"></a>1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨å±æ€§</h5><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bw == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (mbd.hasPropertyValues()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">"Cannot apply property values to null instance"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ç›´æ¥è·³è¿‡</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="2-ä¾æ®ByNameè¿˜æ˜¯ByTypeè¿›è¡Œå±æ€§çš„æ³¨å…¥"><a href="#2-ä¾æ®ByNameè¿˜æ˜¯ByTypeè¿›è¡Œå±æ€§çš„æ³¨å…¥" class="headerlink" title="2.ä¾æ®ByNameè¿˜æ˜¯ByTypeè¿›è¡Œå±æ€§çš„æ³¨å…¥"></a>2.ä¾æ®ByNameè¿˜æ˜¯ByTypeè¿›è¡Œå±æ€§çš„æ³¨å…¥</h5><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—å±æ€§</span></span><br><span class="line">PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// è·å¾—autowiredç±»å‹ï¼ˆby type è¿˜æ˜¯ by nameï¼‰æ ¸å¿ƒæ˜¯pvs.add(propertyName, bean); è·å¾—é€‚å½“çš„beanå½“é“pvsä¸­</span></span><br><span class="line"><span class="keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line"><span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">  MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line">  <span class="comment">// å¦‚æœé€‚ç”¨ï¼ŒæŒ‰åç§°æ·»åŠ åŸºäºè‡ªåŠ¨è£…é…çš„å±æ€§å€¼ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">    autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœé€‚ç”¨ï¼ŒæŒ‰ç±»å‹æ·»åŠ åŸºäºè‡ªåŠ¨è£…é…çš„å±æ€§å€¼ã€‚.</span></span><br><span class="line">  <span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">    <span class="comment">// å…¶ä¸­resolveDependencyåŒ…å«JSR330ä¸­çš„Injectæ–¹æ³•</span></span><br><span class="line">    autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä½†æ˜¯ä¸ç®¡æ˜¯ByTypeè¿˜æ˜¯ByNameæœ€åéƒ½æ˜¯è°ƒç”¨getBeanæ–¹æ³•å…ˆè·å–å±æ€§ä¾èµ–Bean</span></span><br><span class="line">  pvs = newPvs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>æ ¹æ® <code>resolvedAutowireMode</code> çš„å€¼çš„ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„è£…é…æ–¹å¼</p><ul><li>æŒ‰åç§°æ³¨å…¥ï¼Œä½¿ç”¨@Autowiredé»˜è®¤çš„æ–¹å¼</li><li>æŒ‰ç±»å‹æ³¨å…¥ï¼Œä½¿ç”¨@Resourceæˆ–è€…ä½¿ç”¨JSR330æ ‡å‡†ä¸­çš„@Injectæ³¨è§£çš„é»˜è®¤æ–¹å¼</li></ul><p>ä½†æ˜¯ï¼Œä¸ç®¡ä¾èµ–å“ªç§æ–¹å¼è¿›è¡Œè£…é…ï¼Œæœ€åéƒ½ä¼šä½¿ç”¨getBeanæ¥è·å–å±æ€§ä¾èµ–ï¼Œè£…é…åˆ°å®¹å™¨ä¸­ï¼Œå¹¶å°†å€¼æ”¾åˆ° <code>newPvs</code> ç­‰å¾…å¡«å……ã€‚</p><h5 id="3-å±æ€§å¡«å……"><a href="#3-å±æ€§å¡«å……" class="headerlink" title="3.å±æ€§å¡«å……"></a>3.å±æ€§å¡«å……</h5><p>æœ€åé€šè¿‡ä½¿ç”¨ <code>applyPropertyValues</code> æ–¹æ³•å®ç°å±æ€§çš„å¡«å……ï¼š</p><p>ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœpvsæ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥è¿”å›</li><li>å¦åˆ™åˆ›å»ºä¸€ä¸ª<code>deep copy</code>ï¼Œç”¨äºè§£å†³æ‰€æœ‰å¯¹å€¼çš„å¼•ç”¨ï¼Œå¯¹æœªè¢«è§£æçš„å…ˆè§£æ&amp;&amp;å·²è§£æçš„ç›´æ¥åŠ å…¥<code>deepCopy</code>ä¸­ã€‚</li><li>è·å–åˆ° <code>deepCopy</code> åï¼Œä½¿ç”¨ <code>setPropertyValues</code> æ·»åŠ åˆ°<code>BeanWrapper</code>ä¸­</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyPropertyValues</span><span class="params">(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs)</span> </span>&#123;</span><br><span class="line"><span class="comment">// å¦‚æœpvså†…å®¹æ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥return</span></span><br><span class="line"><span class="keyword">if</span> (pvs.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾ç½® SecurityContextProvider</span></span><br><span class="line"><span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; bw <span class="keyword">instanceof</span> BeanWrapperImpl) &#123;</span><br><span class="line">((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</span><br><span class="line">&#125;</span><br><span class="line">MutablePropertyValues mpvs = <span class="keyword">null</span>;</span><br><span class="line">List&lt;PropertyValue&gt; original;</span><br><span class="line"><span class="keyword">if</span> (pvs <span class="keyword">instanceof</span> MutablePropertyValues) &#123;</span><br><span class="line">mpvs = (MutablePropertyValues) pvs;</span><br><span class="line"><span class="comment">// å·²ç»æ˜¯è½¬åŒ–è¿‡çš„</span></span><br><span class="line"><span class="keyword">if</span> (mpvs.isConverted()) &#123;</span><br><span class="line"><span class="comment">// Shortcut: use the pre-converted values as-is.</span></span><br><span class="line"><span class="comment">// ç…§åŸæ ·ä½¿ç”¨é¢„å…ˆè½¬æ¢çš„å€¼</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">bw.setPropertyValues(mpvs);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">original = mpvs.getPropertyValueList(); <span class="comment">// è·å–ä¸€ä¸ªList&lt;PropertyValue&gt; å±æ€§ç»„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">original = Arrays.asList(pvs.getPropertyValues());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å¾— BeanDefinitionValueResolver</span></span><br><span class="line">TypeConverter converter = getCustomTypeConverter();</span><br><span class="line"><span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</span><br><span class="line">converter = bw;</span><br><span class="line">&#125;</span><br><span class="line">BeanDefinitionValueResolver valueResolver = <span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>, beanName, mbd, converter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a deep copy, resolving any references for values. </span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ·±å±‚å‰¯æœ¬ï¼Œä»¥è§£å†³æ‰€æœ‰å¯¹å€¼çš„å¼•ç”¨ã€‚å¯¹æœªè¢«è§£æçš„å…ˆè§£æ/å·²è§£æçš„ç›´æ¥åŠ å…¥deepCopyä¸­</span></span><br><span class="line">List&lt;PropertyValue&gt; deepCopy = <span class="keyword">new</span> ArrayList&lt;&gt;(original.size());</span><br><span class="line"><span class="keyword">boolean</span> resolveNecessary = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">for</span> (PropertyValue pv : original) &#123;</span><br><span class="line"><span class="keyword">if</span> (pv.isConverted()) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå·²è½¬åŒ–ï¼Œç›´æ¥æ·»åŠ åˆ°deepCopyä¸­</span></span><br><span class="line">deepCopy.add(pv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è·å¾—å±æ€§åå’Œå±æ€§å€¼</span></span><br><span class="line">String propertyName = pv.getName();</span><br><span class="line">Object originalValue = pv.getValue();</span><br><span class="line"><span class="comment">// æ˜¯å¦æ˜¯AutowiredPropertyMarker</span></span><br><span class="line"><span class="keyword">if</span> (originalValue == AutowiredPropertyMarker.INSTANCE) &#123;</span><br><span class="line"><span class="comment">//è·å–åº”ç”¨äºå†™å…¥å±æ€§å€¼çš„æ–¹æ³•</span></span><br><span class="line">Method writeMethod = bw.getPropertyDescriptor(propertyName).getWriteMethod();</span><br><span class="line"><span class="keyword">if</span> (writeMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Autowire marker for property without write method: "</span> + pv);</span><br><span class="line">&#125;</span><br><span class="line">originalValue = <span class="keyword">new</span> DependencyDescriptor(<span class="keyword">new</span> MethodParameter(writeMethod, <span class="number">0</span>), <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨valueResolverè§£æå±æ€§å€¼,ç»™å®šä¸€ä¸ªPropertyValueï¼Œè¿”å›ä¸€ä¸ªå€¼ï¼Œå¦‚æœ‰å¿…è¦ï¼Œè§£æå·¥å‚ä¸­å¯¹å…¶ä»–beançš„ä»»ä½•å¼•ç”¨</span></span><br><span class="line">Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">Object convertedValue = resolvedValue;</span><br><span class="line"><span class="keyword">boolean</span> convertible = bw.isWritableProperty(propertyName) &amp;&amp;</span><br><span class="line">!PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</span><br><span class="line"><span class="keyword">if</span> (convertible) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå¯è½¬åŒ–ï¼Œè½¬åŒ–è¿™ä¸ªå±æ€§</span></span><br><span class="line">convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¯èƒ½å°†è½¬æ¢åçš„å€¼å­˜å‚¨åœ¨åˆå¹¶çš„beanå®šä¹‰ä¸­ï¼Œé¿å…å¯¹æ¯ä¸ªåˆ›å»ºçš„beanå®ä¾‹è¿›è¡Œé‡æ–°è½¬æ¢</span></span><br><span class="line"><span class="keyword">if</span> (resolvedValue == originalValue) &#123;</span><br><span class="line"><span class="keyword">if</span> (convertible) &#123;</span><br><span class="line">pv.setConvertedValue(convertedValue);</span><br><span class="line">&#125;</span><br><span class="line">deepCopy.add(pv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (convertible &amp;&amp; originalValue <span class="keyword">instanceof</span> TypedStringValue &amp;&amp;</span><br><span class="line">!((TypedStringValue) originalValue).isDynamic() &amp;&amp;</span><br><span class="line">!(convertedValue <span class="keyword">instanceof</span> Collection || ObjectUtils.isArray(convertedValue))) &#123;</span><br><span class="line">pv.setConvertedValue(convertedValue);</span><br><span class="line">deepCopy.add(pv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">resolveNecessary = <span class="keyword">true</span>;</span><br><span class="line">deepCopy.add(<span class="keyword">new</span> PropertyValue(pv, convertedValue));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mpvs != <span class="keyword">null</span> &amp;&amp; !resolveNecessary) &#123;</span><br><span class="line"><span class="comment">// è®¾ç½®å·²è½¬åŒ–å±æ€§</span></span><br><span class="line">mpvs.setConverted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// æ”¾åˆ°PropertyValuesé‡Œé¢</span></span><br><span class="line">bw.setPropertyValues(<span class="keyword">new</span> MutablePropertyValues(deepCopy));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="initializeBean-åˆå§‹åŒ–Bean"><a href="#initializeBean-åˆå§‹åŒ–Bean" class="headerlink" title="initializeBean åˆå§‹åŒ–Bean"></a>initializeBean åˆå§‹åŒ–Bean</h4><p>åœ¨ä½¿ç”¨populateBeanåï¼Œè°ƒç”¨initializeBeanæ–¹æ³•è¿›è¡Œbeançš„initï¼Œåœ¨initæ–¹æ³•å†…éƒ¨ï¼Œå¯åˆ†ä¸ºä¸€ä¸‹å‡ éƒ¨åˆ†è°ƒç”¨</p><ol><li>invokeAwareMethods æ–¹æ³•ï¼Œè®¾ç½®Awareå±æ€§</li><li>applyBeanPostProcessorsBeforeInitialization æ–¹æ³•ï¼Œè°ƒç”¨ BeanProcessorä¸­çš„Beanåˆå§‹åŒ–å‰çš„åç½®æ–¹æ³•</li><li>invokeInitMethods æ–¹æ³•ï¼Œæ¿€æ´»è‡ªå®šä¹‰çš„initæ–¹æ³•</li><li>æ‰§è¡ŒBeanProcessorä¸­çš„åˆå§‹åŒ–åçš„åç½®æ–¹æ³•</li></ol><h5 id="1-invokeAwareMethods"><a href="#1-invokeAwareMethods" class="headerlink" title="1. invokeAwareMethods"></a>1. invokeAwareMethods</h5><p>å¯»æ‰¾æ˜¯å¦æ»¡è¶³ç‰¹å®šçš„æ¡ä»¶ï¼Œå¦‚æœæ»¡è¶³åˆ™è¿›è¡Œç›¸å…³å±æ€§çš„å¡«å……</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ BeanNameAwareï¼Œè®¾ç½®BeanName</span></span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯  BeanClassLoaderAwareï¼Œè®¾ç½®classloader</span></span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">ClassLoader bcl = getBeanClassLoader();</span><br><span class="line"><span class="keyword">if</span> (bcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="2-applyBeanPostProcessorsBeforeInitialization"><a href="#2-applyBeanPostProcessorsBeforeInitialization" class="headerlink" title="2. applyBeanPostProcessorsBeforeInitialization"></a>2. applyBeanPostProcessorsBeforeInitialization</h5><p>å¾ªç¯å®¹å™¨ä¸­æ¯ä¸€ä¸ªBeanPostProcessorï¼Œæ‰§è¡ŒBeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">Object result = existingBean;</span><br><span class="line"><span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">Object current = processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line"><span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">result = current;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="3-invokeInitMethods-æ‰§è¡Œinitæ–¹æ³•"><a href="#3-invokeInitMethods-æ‰§è¡Œinitæ–¹æ³•" class="headerlink" title="3.invokeInitMethods æ‰§è¡Œinitæ–¹æ³•"></a>3.invokeInitMethods æ‰§è¡Œinitæ–¹æ³•</h5><p>å¦‚æœæ˜¯isInitializingBeanåˆ™å…ˆä¼šæ‰§è¡Œè‡ªå·±çš„å†…ç½®æ–¹æ³•afterPropertiesSetã€‚å¦‚æœåˆ¶å®šäº†initMethodï¼Œé‚£ä¹ˆåç»­ä¼šé€šè¿‡åå°„æ‰§è¡Œè¿™ä¸ªæ–¹æ³•</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeInitMethods</span><span class="params">(String beanName, <span class="keyword">final</span> Object bean, @Nullable RootBeanDefinition mbd)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> isInitializingBean = (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line"><span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="string">"afterPropertiesSet"</span>))) &#123;</span><br><span class="line"><span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;, getAccessControlContext());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mbd != <span class="keyword">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">String initMethodName = mbd.getInitMethodName();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">!(isInitializingBean &amp;&amp; <span class="string">"afterPropertiesSet"</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="4-applyBeanPostProcessorsAfterInitialization"><a href="#4-applyBeanPostProcessorsAfterInitialization" class="headerlink" title="4.applyBeanPostProcessorsAfterInitialization"></a>4.applyBeanPostProcessorsAfterInitialization</h5><p>å¾ªç¯å®¹å™¨ä¸­æ¯ä¸€ä¸ªBeanPostProcessorï¼Œæ‰§è¡ŒBeanPostProcessorçš„ postProcessAfterInitialization æ–¹æ³•ã€‚</p><p>è‡³æ­¤Beançš„å®ä¾‹åŒ–è¿‡ç¨‹å°±å¤§è‡´å®Œæˆäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Beançš„å®ä¾‹åŒ–&quot;&gt;&lt;a href=&quot;#Beançš„å®ä¾‹åŒ–&quot; class=&quot;headerlink&quot; title=&quot;Beançš„å®ä¾‹åŒ–&quot;&gt;&lt;/a&gt;Beançš„å®ä¾‹åŒ–&lt;/h1&gt;&lt;p&gt;åœ¨refreshæ–¹æ³•æ‰§è¡Œåˆ° &lt;code&gt;finishBeanFacotyInitializa
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„Beançš„æ³¨å†Œ</title>
    <link href="https://nanyiniu.github.io/2019/12/20/Spring%E4%BB%8E%E9%9B%B6%E5%AD%A6%E8%B5%B7%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>https://nanyiniu.github.io/2019/12/20/Springä»é›¶å­¦èµ·ä¹‹æºç åˆ†æï¼ˆä¸‰ï¼‰/</id>
    <published>2019-12-20T15:00:00.000Z</published>
    <updated>2020-01-18T01:25:22.287Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Beançš„æ³¨å†Œ"><a href="#Beançš„æ³¨å†Œ" class="headerlink" title="Beançš„æ³¨å†Œ"></a>Beançš„æ³¨å†Œ</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°äº†åœ¨ä½¿ç”¨<code>invokeBeanFactoryPostProcessors(beanFactory)</code> æ–¹æ³•ä¸­ï¼Œ<br>è°ƒç”¨äº† <code>ConfigurationClassPostProcessor</code> ä¸­çš„ <code>postProcessBeanDefinitionRegistry</code> æ–¹æ³•ï¼Œ<br>å®ç°äº†å¯¹configurationé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹å¾—åˆ°åŠ è½½å’Œè§£æã€‚å®Œæˆå¯¹æ ‡æ³¨ä¸ºBeançš„æ–¹æ³•æ³¨å†Œã€Œregistã€åˆ°å®¹å™¨ä¸­ã€‚</p><p>ä¸‹é¢å°±é’ˆå¯¹è¿™ä¸€æ³¨å†Œé…ç½®æ–‡ä»¶å†…çš„Beançš„è¿‡ç¨‹è¿›è¡Œæºç çš„åˆ†æï¼š</p><h2 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a>ConfigurationClassPostProcessor</h2><p>åœ¨ <code>invokeBeanFactoryPostProcessor</code> æ–¹æ³•ä¸­ï¼Œ<br>å¾ªç¯è°ƒç”¨ç±»ä¸­çš„åç½®æ–¹æ³• <code>postProcessBeanDefinitionRegistry</code> ,<br>å…¶ä¸­åŒ…æ‹¬äº† <code>ConfigurationClassPostProcessor</code> ç±»ã€‚<br>æ ¹æ®åå­—ä¹Ÿèƒ½çœ‹å‡ºè¿™ä¸ªç±»æ˜¯é…ç½®æ–‡ä»¶ç±»çš„åç½®å¤„ç†ç±»ã€‚é‚£ä¹ˆå°±ä¹‹é—´çœ‹ä»£ç ï¼Œäº†è§£é…ç½®æ–‡ä»¶çš„åç½®å¤„ç†å™¨éƒ½åšäº†äº›ä»€ä¹ˆã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> registryId = System.identityHashCode(registry);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                <span class="string">"postProcessBeanDefinitionRegistry already called on this post-processor against "</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                <span class="string">"postProcessBeanFactory already called on this post-processor against "</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.registriesPostProcessed.add(registryId);</span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸‹é¢å¯¹ processConfigBeanDefinitions ä¸­çš„æ–¹æ³•ä¸€æ­¥ä¸€æ­¥çœ‹ï¼š</p><h3 id="ä½¿ç”¨processConfigBeanDefinitionsè§£ææ³¨å†ŒBean"><a href="#ä½¿ç”¨processConfigBeanDefinitionsè§£ææ³¨å†ŒBean" class="headerlink" title="ä½¿ç”¨processConfigBeanDefinitionsè§£ææ³¨å†ŒBean"></a>ä½¿ç”¨processConfigBeanDefinitionsè§£ææ³¨å†ŒBean</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// è·å¾—æ‰€æœ‰çš„å·²ç»æ³¨å†Œçš„Beanï¼Œå…¶ä¸­åŒ…æ‹¬Springå†…ç½®çš„Processorï¼Œ</span></span><br><span class="line">    <span class="comment">// å½“ç„¶ä¹ŸåŒ…æ‹¬è‡ªå·±å†™çš„@Configurationç±»</span></span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">    <span class="comment">// å¯¹æ¯ä¸ªå€™é€‰çš„Beanè¿›è¡Œç­›é€‰</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">        BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Bean definition has already been processed as a configuration class: "</span> + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ä½¿ç”¨AnnotatedBeanDefinitionå®šä¹‰ï¼ˆ@Configurationï¼‰,å¦‚æœæ˜¯</span></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸€äº›å±æ€§å¦‚æ ¹æ®proxyBeanMethodsæŒ‡å®šç”¨æ¥é¿å…è¿è¡Œæ—¶åˆ›å»ºCGLIBçš„å­ç±»ç­‰ç­‰ã€‚ã€‚</span></span><br><span class="line">            configCandidates.add(<span class="keyword">new</span> BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return immediately if no @Configuration classes were found</span></span><br><span class="line">    <span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹ç»™å®šçš„Orderï¼ˆ@Orderï¼‰è¿›è¡Œæ’åº</span></span><br><span class="line">    configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">int</span> i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">        <span class="keyword">int</span> i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®Beançš„åç§°çš„ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">    SingletonBeanRegistry sbr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) &#123;</span><br><span class="line">        sbr = (SingletonBeanRegistry) registry;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.localBeanNameGeneratorSet) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤çš„åç§°ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">            BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(</span><br><span class="line">                    AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">            <span class="keyword">if</span> (generator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.componentScanBeanNameGenerator = generator;</span><br><span class="line">                <span class="keyword">this</span>.importBeanNameGenerator = generator;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ææ‰€æœ‰çš„@Configurationç±»ï¼Œé¦–å…ˆå…ˆå£°æ˜å‡ºä¸€ä¸ªè§£æå™¨</span></span><br><span class="line">    ConfigurationClassParser parser = <span class="keyword">new</span> ConfigurationClassParser(</span><br><span class="line">            <span class="keyword">this</span>.metadataReaderFactory, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.environment,</span><br><span class="line">            <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line">    Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="keyword">new</span> HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨è§£æå™¨å¯¹æ‰€æœ‰çš„é…ç½®ç±»è¿›è¡Œè§£æï¼Œåœ¨è§£æçš„è¿‡ç¨‹ä¸­</span></span><br><span class="line">        <span class="comment">// å®Œæˆå¯¹Beançš„æ³¨å†Œ</span></span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        <span class="comment">// è¿›è¡ŒéªŒè¯</span></span><br><span class="line">        parser.validate();</span><br><span class="line">        <span class="comment">// é€šè¿‡parserå¤„ç†å¾—åˆ°äº†é…ç½®æ–‡ä»¶ä¸‹çš„Bean</span></span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">        <span class="comment">// ç§»é™¤æ‰€æœ‰çš„å·²ç»è§£æè¿‡çš„Bean'</span></span><br><span class="line">        configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reader = <span class="keyword">new</span> ConfigurationClassBeanDefinitionReader(</span><br><span class="line">                    registry, <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment,</span><br><span class="line">                    <span class="keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        <span class="comment">// å¯¹æ‰€æœ‰å·²ç»è§£æçš„Beanè¿›è¡Œæ ‡è®°</span></span><br><span class="line">        alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">        candidates.clear();</span><br><span class="line">        <span class="comment">// å¦‚æœregistryä¸­çš„Beanå®šä¹‰æ•°é‡ å¤§äº candidateNames çš„æ•°é‡ï¼Œè¯´æ˜åœ¨Beanæ³¨å†Œè¿‡ç¨‹ä¸­</span></span><br><span class="line">        <span class="comment">// äº§ç”Ÿäº†å…¶ä»–Beanï¼Œé‡å¤è¿‡ç¨‹æ³¨å†Œè¿™ä¸ªBean</span></span><br><span class="line">        <span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">            <span class="comment">// ã€‚ã€‚ã€‚ã€‚ã€‚çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ImportRegistryæ³¨å†Œä¸ºBeanï¼Œä»¥æ”¯æŒImportAware @Configurationç±»</span></span><br><span class="line">    <span class="keyword">if</span> (sbr != <span class="keyword">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">        sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><strong>ä¸Šè¿°ä»£ç å®Œæˆäº†çš„è¿‡ç¨‹å¤§è‡´åˆ†ä¸ºè¿™å‡ æ­¥</strong></p><ol><li>æ‰¾å‡ºConfigé…ç½®ç±»ï¼ŒåŒ…æ‹¬ä½¿ç”¨@Configurationæ³¨è§£æ ‡æ³¨çš„é…ç½®ç±»</li><li>æ ¹æ®@Orderè¿›è¡Œè¿›è¡Œé¡ºåºçš„è°ƒæ•´</li><li>è§£ææ‰€æœ‰çš„@Configurationå†…çš„Beanï¼Œå®Œæˆå¯¹é…ç½®ç±»ä¸­æ‰€æœ‰ <strong>Beançš„æ³¨å†Œ</strong>ã€‚</li><li>éªŒè¯å¹¶è¿›è¡Œæ ‡è®°Beanå·²ç»è¢«è§£ææ³¨å†Œ</li></ol><p>å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯ç¬¬3æ­¥ï¼Œéœ€è¦æ‰¾å‡ºBeanï¼Œå¹¶è¿›è¡Œæ³¨å†Œ</p><h4 id="parseæ–¹æ³•è§£æå¹¶å®Œæˆæ³¨å†ŒBeançš„ã€‚"><a href="#parseæ–¹æ³•è§£æå¹¶å®Œæˆæ³¨å†ŒBeançš„ã€‚" class="headerlink" title="parseæ–¹æ³•è§£æå¹¶å®Œæˆæ³¨å†ŒBeançš„ã€‚"></a>parseæ–¹æ³•è§£æå¹¶å®Œæˆæ³¨å†ŒBeançš„ã€‚</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;</span><br><span class="line">    <span class="comment">// è·å¾—é…ç½®ç±»çš„å®šä¹‰ä¿¡æ¯</span></span><br><span class="line">        BeanDefinition bd = holder.getBeanDefinition();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// å¦‚æœæ˜¯ä½¿ç”¨æ³¨è§£æ–¹å¼é…ç½®ç±»</span></span><br><span class="line">            <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// else if ...  if .... etc</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// etc ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.deferredImportSelectorHandler.process();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(AnnotationMetadata metadata, String beanName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    processConfigurationClass(<span class="keyword">new</span> ConfigurationClass(metadata, beanName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœä½¿ç”¨æ³¨è§£æ–¹å¼è¿›è¡Œé…ç½®ç±»çš„é…ç½®çš„æƒ…å†µï¼Œæœ€åä¼šè°ƒç”¨ <code>processConfigurationClass</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processConfigurationClass</span><span class="params">(ConfigurationClass configClass)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®Contionalæ³¨è§£æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡é…ç½®ç±»çš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦è·³è¿‡ï¼Œåˆ™ç›´æ¥è¿›è¡Œreturn</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationClass existingClass = <span class="keyword">this</span>.configurationClasses.get(configClass);</span><br><span class="line">    <span class="keyword">if</span> (existingClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœå·²ç»å­˜åœ¨çš„æƒ…å†µ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€’å½’å¤„ç†é…ç½®ç±»åŠå…¶è¶…ç±»å±‚æ¬¡ç»“æ„</span></span><br><span class="line">    SourceClass sourceClass = asSourceClass(configClass);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sourceClass = doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (sourceClass != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>æœ€åä¼šé€’å½’ä½¿ç”¨ <code>doProcessConfigurationClass</code> è¿›è¡Œå¤„ç†é…ç½®ç±»å’Œå…¶è¶…ç±».</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title">doProcessConfigurationClass</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurationClass configClass, SourceClass sourceClass)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸Šæœ‰æ ‡æ³¨Componentæ³¨è§£ï¼Œåˆ™ä¼šé€’å½’å¤„ç†ä»»ä½•æˆå‘˜ç±»</span></span><br><span class="line">    <span class="keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">        processMemberClasses(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç† @PropertySource æ³¨è§£,ç”¨äºåŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">            org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">            <span class="comment">// ... etc ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†æ‰€æœ‰çš„ @ComponentScan æ³¨è§£</span></span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !<span class="keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">            <span class="comment">// è·å–æ¯ä¸€ä¸ª  componentScans çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰ scan ç±»ï¼Œåˆ™ç«‹å³æ‰§è¡Œè§£æã€æ‰«æ</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">                    <span class="keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            <span class="comment">//æ£€æŸ¥æ‰«æçš„å®šä¹‰é›†æ˜¯å¦æœ‰å…¶ä»–é…ç½®ç±»ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€’å½’è§£æ</span></span><br><span class="line">            <span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">                BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                <span class="keyword">if</span> (bdCand == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">                    parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ‰€æœ‰çš„ @Import æ³¨è§£</span></span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†@Beanæ–¹æ³•</span></span><br><span class="line">    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">    <span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">        configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤„ç†æ¥å£ä¸Šçš„é»˜è®¤æ–¹æ³•</span></span><br><span class="line">    processInterfaces(configClass, sourceClass);</span><br><span class="line">    <span class="comment">// å¤„ç†è¶…ç±»</span></span><br><span class="line">    <span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">        String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">        <span class="keyword">if</span> (superclass != <span class="keyword">null</span> &amp;&amp; !superclass.startsWith(<span class="string">"java"</span>) &amp;&amp;</span><br><span class="line">                !<span class="keyword">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">            <span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">            <span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰è¶…ç±»ï¼Œå¤„ç†å®Œæˆã€‚</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure></div><p>æ€»ç»“åœ¨ä½¿ç”¨ doProcessConfigurationClass æ–¹æ³•æ—¶ï¼Œå¤§è‡´ä¼šæœ‰è¿™æ ·å‡ æ­¥ï¼š</p><ol><li>å¦‚æœæ ‡è®°æœ‰ <code>@Component</code> æ³¨è§£ï¼Œåˆ™ä¼šå…ˆå»é€’å½’å¤„ç†æˆå‘˜ç±»,é‚£ä¹ˆä»–æ˜¯å¦‚ä½•è¿›è¡Œé€’å½’å¤„ç†çš„å‘¢ï¼Œçœ‹ä¸»è¦æ–¹æ³•çš„è°ƒç”¨å°±èƒ½å¤Ÿç†è§£ï¼š<br>processMemberClasses -&gt; processConfigurationClass -&gt; doProcessConfigurationClass -&gt; processMemberClasses<br>æ¯æ¬¡éƒ½ä¼šé€’å½’çš„å…ˆå¤„ç†æˆå‘˜ç±»ã€‚</li><li>å¤„ç† <code>@PropertySource</code> æ³¨è§£,ä½œç”¨ä¸ºåŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶</li><li>å¤„ç†æ‰€æœ‰çš„ <code>@ComponentScan</code> æ³¨è§£ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­æ ‡è®°æœ‰ <code>@ComponentSacn</code> æˆ–è€… <code>@ComponentScans</code> æ³¨è§£çš„è¯ï¼Œä¼šå…ˆå»è§£æå¯¹åº”è·¯å¾„ä¸‹çš„Beanï¼ŒåŒ…è£…æˆ <code>BeanDefinitionHolder</code> å†æ¬¡è¿›è¡Œparseã€‚</li><li>å¤„ç†æ‰€æœ‰çš„ <code>@Import</code> æ³¨è§£,å¤„ç†æ‰€æœ‰ä½¿ç”¨Importæ³¨è§£å¼•å…¥çš„é…ç½®æ–‡ä»¶</li><li>å¤„ç†æ‰€æœ‰çš„ <code>@ImportResource</code> æ³¨è§£</li><li>å¤„ç†æ‰€æœ‰ <code>@Bean</code> æ–¹æ³•,æ·»åŠ ä¸º BeanMethodï¼Œè§£æé…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸º@Beançš„æ–¹æ³•ï¼Œæ·»åŠ åˆ°configClassä¸­çš„BeanMethodä¸­</li><li>å¤„ç†æ¥å£çš„é»˜è®¤æ–¹æ³•</li><li>æŒ‰ç…§ä»¥ä¸Šé€»è¾‘è¿›è¡Œé€’å½’çš„å¤„ç†è¶…ç±»ã€‚</li></ol><p>åœ¨æ–¹æ³•ä¸­ï¼Œå¯ä»¥æ‰¾æ—¶é—´ç”»ä¸€å¼ å›¾æ¥è§£æè¿™ä¸ªæ–¹æ³•çœŸæ­£åšäº†å†™ä»€ä¹ˆã€‚[todo] ã€‚</p><h2 id="æ³¨å†Œçš„ç²¾ç®€è¿‡ç¨‹"><a href="#æ³¨å†Œçš„ç²¾ç®€è¿‡ç¨‹" class="headerlink" title="æ³¨å†Œçš„ç²¾ç®€è¿‡ç¨‹"></a>æ³¨å†Œçš„ç²¾ç®€è¿‡ç¨‹</h2><p>æœ€åçš„parseæ–¹æ³•æ˜¯å…³é”®ï¼Œç»è¿‡ä»¥ä¸Šæ­¥éª¤å¯ä»¥,åœ¨æœ¬ç« èŠ‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ @ComponentSacn  å’Œ å¤„ç†æ‰€æœ‰çš„ @Bean è¿™ä¸¤æ­¥ï¼š</p><p>åœ¨å¤„ç† @ComponentSacn ä¸­ï¼Œå°†ç›´æ¥å°†æ ¹æ®è·¯å¾„è§£æå‡ºæ¥çš„Beanä½¿ç”¨ <code>componentScanParser.parse</code> æ–¹æ³•ï¼Œæœ€ç»ˆåœ¨ <code>registerBeanDefinition</code>() æ–¹æ³•ä¸­æ³¨å†Œè¿›å»ã€‚</p><p>è€Œåœ¨å¤„ç†@Beanæ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯å°†Beanæ–¹æ³•åŒ…è£…æˆBeanMethod æ”¾åˆ° <code>this.beanMethods</code> ä¸­ï¼Œç­‰å¾…åœ¨ <code>parse()</code> å <code>this.reader.loadBeanDefinitions(configClasses);</code> ä¸­è¿›è¡Œæ“ä½œ.</p><p>è€Œåœ¨å‰é¢è¯´çš„loadBeanDefinitions ä¸­ä¼šå°†å‰é¢æåˆ°çš„ Importã€ImportReourceå’Œ BeanMethod ç»Ÿä¸€è¿›è¡Œæ³¨å†Œã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">    registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line">    loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars())</span><br></pre></td></tr></table></figure></div><p>åœ¨loadBeanDefinitionsForBeanMethodä¸­ï¼Œè¿›è¡Œäº†å¯¹è§£æå‡ºæ¥çš„ä½¿ç”¨@Beanæ ‡æ³¨çš„æ–¹æ³•è¿›è¡Œæ³¨å†Œã€‚ä»è€Œå®Œæˆæ³¨å†ŒBeançš„ä¸»çº¿åŠŸèƒ½ã€‚ä¸å…·ä½“è¿›è¡Œæ¢³ç†è¿™ä¸ªæ–¹æ³•çš„è¿‡ç¨‹ï¼Œå¤§è‡´ä¸ºæ„å»ºä¸€ä¸ªBeanDefintionåï¼Œé€šè¿‡registerBeanDefinitionæ–¹æ³•è¿›è¡Œæ³¨å†Œ,æ”¾åˆ°beanDefinitionMapä¸­ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Beançš„æ³¨å†Œ&quot;&gt;&lt;a href=&quot;#Beançš„æ³¨å†Œ&quot; class=&quot;headerlink&quot; title=&quot;Beançš„æ³¨å†Œ&quot;&gt;&lt;/a&gt;Beançš„æ³¨å†Œ&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°äº†åœ¨ä½¿ç”¨&lt;code&gt;invokeBeanFactoryPostProcessors
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„æ ¸å¿ƒRefresh</title>
    <link href="https://nanyiniu.github.io/2019/12/15/Spring%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>https://nanyiniu.github.io/2019/12/15/Springä»é›¶å¼€å§‹ä¹‹æºç åˆ†æï¼ˆäºŒï¼‰/</id>
    <published>2019-12-15T15:00:00.000Z</published>
    <updated>2020-01-18T01:25:17.553Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰"><a href="#åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰" class="headerlink" title="åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰"></a>åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œä¸»è¦ç†æ¸…äº†Springæ˜¯å¦‚ä½•ï¼ˆé€šè¿‡ <code>register(Class&lt;?&gt;... componentClasses)</code> ï¼‰æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªè¦å¤„ç†çš„ç»„ä»¶ç±»ï¼ˆé…ç½®ç±»ï¼‰ã€‚</p><p>ä½†æ˜¯å¦‚æœä¸è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯åˆ·æ–°ï¼ˆrefreshï¼‰å®¹å™¨ï¼Œæ•´ä¸ªç±»æ˜¯å¾—ä¸åˆ°å®Œå…¨çš„å¤„ç†çš„ã€‚ä¸‹å›¾æ˜¯å¯¹ refresh æ–¹æ³•è¿›è¡Œçš„ä¸»è¦è¿‡ç¨‹æ€»ç»“ã€‚ä¼šé€šè¿‡å¯¹æ¯ä¸€æ¡çº¿ä¸Šçš„æ–¹æ³•è¿›è¡Œåˆ†æå’Œæ€»ç»“æ–¹æ³•çš„ç”¨é€”ã€‚</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20191123225557.png" alt="20191123225557.png"></p><h2 id="1-prepareRefresh-å‡†å¤‡åˆ·æ–°"><a href="#1-prepareRefresh-å‡†å¤‡åˆ·æ–°" class="headerlink" title="1. prepareRefresh å‡†å¤‡åˆ·æ–°"></a>1. prepareRefresh å‡†å¤‡åˆ·æ–°</h2><p>æ˜¯ <code>refresh</code> çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥å‡†å¤‡ä¸Šä¸‹æ–‡ç¯å¢ƒä»¥ç”¨æ¥åˆ·æ–°ï¼ˆrefreshï¼‰ã€‚</p><ol><li>è®¾ç½®startupDateå¯åŠ¨æ—¶é—´ã€è®¾ç½®closedä¸ºfalseï¼Œè®¾ç½®activeä¸ºtrue.</li><li>initPropertySources()æ–¹æ³•ï¼Œç•™ç»™å­ç±»è‡ªè¡Œå®ç°ï¼Œç”¨æ¥åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­åˆå§‹åŒ–ä»»ä½•å ä½ç¬¦å±æ€§æº.</li><li>validateRequiredProperties() ç”¨æ¥éªŒè¯æ‰€æœ‰çš„Propritieséƒ½æ˜¯å¯è§£æçš„.</li><li>æœ€åå­˜å‚¨é¢„åˆ·æ–°çš„ApplicationListenersã€‚ä¹Ÿå°±æ˜¯åˆå§‹åŒ–earlyApplicationEventsï¼›</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">this</span>.active.set(**<span class="keyword">true</span>**);</span><br><span class="line">    <span class="comment">// ...çœç•¥éƒ¨åˆ†ä»£ç .</span></span><br><span class="line">    <span class="comment">// åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­åˆå§‹åŒ–ä»»ä½•å ä½ç¬¦å±æ€§æºï¼Œå­ç±»ç»§æ‰¿å®ç°</span></span><br><span class="line">    initPropertySources();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éªŒè¯æ‰€æœ‰å¿…é¡»çš„Propertyéƒ½æ˜¯å¯è§£æçš„</span></span><br><span class="line">    getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="2-obtainFreshBeanFactory-è·å–BeanFactory"><a href="#2-obtainFreshBeanFactory-è·å–BeanFactory" class="headerlink" title="2. obtainFreshBeanFactory è·å–BeanFactory"></a>2. obtainFreshBeanFactory è·å–BeanFactory</h2><p>åœ¨ <code>obtainFreshBeanFactory</code> æ–¹æ³•ä¸­æœ‰ä¸¤ä¸ªå­æ–¹æ³•ã€‚åˆ†åˆ«ç”¨æ¥è®¾ç½®SerializationIdå’Œè·å–åœ¨registerè¿‡ç¨‹ä¸­å·²ç»äº§ç”Ÿçš„beanFactoryã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">    <span class="comment">// ...çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="comment">// åœ¨registerçš„æ—¶å€™ï¼Œé€šè¿‡registerBeanDefinitionæ—¶ä¼šåˆ›å»ºä¸€ä¸ªbeanFactoryä¸ºDefaultListableBeanFactory</span></span><br><span class="line">    <span class="keyword">this</span>.beanFactory.setSerializationId(getId());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="3-prepareBeanFactory-å‡†å¤‡BeanFactory"><a href="#3-prepareBeanFactory-å‡†å¤‡BeanFactory" class="headerlink" title="3.prepareBeanFactory å‡†å¤‡BeanFactory"></a>3.prepareBeanFactory å‡†å¤‡BeanFactory</h2><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å®ç°ç±»å¯¹BeanFactoryçš„åŸºæœ¬åˆå§‹åŒ–ã€‚è®¾ç½®äº† <code>classLoador</code>ã€<code>ExpressionResolver</code>ã€<code>BeanPostProcessor</code>ç­‰ç­‰å±æ€§ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®PostProcessor å›è°ƒæ–¹æ³•</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">    <span class="comment">// å¿½ç•¥ç»™å®šçš„æ¥å£ç±»çš„è‡ªåŠ¨è£…é…ï¼ˆå°±æ˜¯ä¸è£…é…ç»™å®šçš„æ¥å£ç±»ï¼‰</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// registerResolvableDependencyçš„ä½œç”¨å°±æ˜¯å°† ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºä¾èµ–æ³¨å…¥åˆ°ç¬¬äºŒä¸ªå‚æ•°ä¸­</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„thisæŒ‡çš„å°±æ˜¯AbstractApplicationContext</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners. æ³¨å†Œä¸€ä¸ªapplicationListenersæ£€æµ‹å™¨</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œç¯å¢ƒç›¸å…³Bean</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="3-postProcessBeanFactory-å¯¹BeanFactoryçš„åç½®å¤„ç†"><a href="#3-postProcessBeanFactory-å¯¹BeanFactoryçš„åç½®å¤„ç†" class="headerlink" title="3.postProcessBeanFactory å¯¹BeanFactoryçš„åç½®å¤„ç†"></a>3.postProcessBeanFactory å¯¹BeanFactoryçš„åç½®å¤„ç†</h2><p>è¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯ç©ºçš„ï¼Œå®é™…å«ä¹‰å°±æ˜¯è®©å­ç±»å»å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åè°ƒç”¨çš„æ—¶å€™å¯ä»¥å¯¹BeanFactoryè¿›è¡Œè‡ªå®šä¹‰çš„åç½®å¤„ç†ã€‚</p><h2 id="4-invokeBeanFactoryPostProcessors-è°ƒç”¨å·²æ³¨å†Œä¸ºBeançš„å·¥å‚å¤„ç†å™¨"><a href="#4-invokeBeanFactoryPostProcessors-è°ƒç”¨å·²æ³¨å†Œä¸ºBeançš„å·¥å‚å¤„ç†å™¨" class="headerlink" title="4.invokeBeanFactoryPostProcessors è°ƒç”¨å·²æ³¨å†Œä¸ºBeançš„å·¥å‚å¤„ç†å™¨"></a>4.invokeBeanFactoryPostProcessors è°ƒç”¨å·²æ³¨å†Œä¸ºBeançš„å·¥å‚å¤„ç†å™¨</h2><p>æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å®ä¾‹åŒ–å¹¶è°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„BeanFactoryPostProcessorï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™ä¸€æ­¥<strong>å®Œæˆå¯¹configurationé…ç½®ç±»ä¸­çš„Beançš„æ³¨å†Œè¿‡ç¨‹[todo]</strong>ã€‚ä¸»è¦çš„æ‰§è¡Œæ–¹æ³•æ˜¯ <code>PostProcessorRegistrationDelegate</code> ä¸­çš„ <code>invokeBeanFactoryPostProcessors</code> æ–¹æ³•ã€‚</p><blockquote><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°äº†åœ¨ register æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº† <code>this.reader = new AnnotatedBeanDefinitionReader(this)</code> åï¼Œä½¿ç”¨ <code>registerAnnotationConfigProcessors</code> æ³¨å†Œä¸€äº›æ³¨è§£ç›¸å…³beanï¼Œå¦‚<code>ConfigurationClassPostProcessor</code>ç­‰ç­‰ã€‚</p></blockquote><p>ä»£ç å¾ˆå¤šï¼Œæ²¡å¿…è¦éƒ½çœ‹ï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œå…ˆæ€»ç»“ä¸‹è¿‡ç¨‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç¿»ç¿»æºç å†çœ‹çœ‹å…·ä½“å®ç°ï¼š</p><h3 id="å¦‚æœæœ‰BeanFactoryPostProcessor-åˆ™ä¼šå…ˆæ‰§è¡Œç±»ä¸­çš„-postProcessBeanDefinitionRegistry-æ–¹æ³•"><a href="#å¦‚æœæœ‰BeanFactoryPostProcessor-åˆ™ä¼šå…ˆæ‰§è¡Œç±»ä¸­çš„-postProcessBeanDefinitionRegistry-æ–¹æ³•" class="headerlink" title="å¦‚æœæœ‰BeanFactoryPostProcessor,åˆ™ä¼šå…ˆæ‰§è¡Œç±»ä¸­çš„ postProcessBeanDefinitionRegistry æ–¹æ³•"></a>å¦‚æœæœ‰BeanFactoryPostProcessor,åˆ™ä¼šå…ˆæ‰§è¡Œç±»ä¸­çš„ <code>postProcessBeanDefinitionRegistry</code> æ–¹æ³•</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">        BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">                (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">        registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">        registryProcessors.add(registryProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        regularPostProcessors.add(postProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="ç¬¬ä¸€æ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„-ç»§æ‰¿BeanDefinitionRegistryPostProcessor-å¹¶ä¸”å®ç°äº†PriorityOrdered-æ¥å£çš„ç±»"><a href="#ç¬¬ä¸€æ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„-ç»§æ‰¿BeanDefinitionRegistryPostProcessor-å¹¶ä¸”å®ç°äº†PriorityOrdered-æ¥å£çš„ç±»" class="headerlink" title="ç¬¬ä¸€æ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„ ç»§æ‰¿BeanDefinitionRegistryPostProcessor å¹¶ä¸”å®ç°äº†PriorityOrdered æ¥å£çš„ç±»"></a>ç¬¬ä¸€æ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„ ç»§æ‰¿<code>BeanDefinitionRegistryPostProcessor</code> å¹¶ä¸”å®ç°äº†<code>PriorityOrdered</code> æ¥å£çš„ç±»</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String[] postProcessorNames =</span><br><span class="line">        beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">        processedBeans.add(ppName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¯¹ä¾èµ–æ’åº</span></span><br><span class="line">sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line"><span class="comment">// æ·»åŠ åˆ°registryProcessorsä¸­</span></span><br><span class="line">registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line"><span class="comment">// æ‰§è¡Œ&#123;ConfigurationClassPostProcessorçš„&#125;åç½®æ–¹æ³•</span></span><br><span class="line">invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line"><span class="comment">// æ¸…ç©ºå½“å‰æ³¨å†Œå¤„ç†å™¨</span></span><br><span class="line">currentRegistryProcessors.clear();</span><br></pre></td></tr></table></figure></div><h3 id="ç¬¬äºŒæ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„-ç»§æ‰¿-BeanDefinitionRegistryPostProcessor-å¹¶ä¸”å®ç°äº†Ordered-æ¥å£çš„ç±»ä¸­çš„"><a href="#ç¬¬äºŒæ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„-ç»§æ‰¿-BeanDefinitionRegistryPostProcessor-å¹¶ä¸”å®ç°äº†Ordered-æ¥å£çš„ç±»ä¸­çš„" class="headerlink" title="ç¬¬äºŒæ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„ ç»§æ‰¿ BeanDefinitionRegistryPostProcessor å¹¶ä¸”å®ç°äº†Ordered æ¥å£çš„ç±»ä¸­çš„"></a>ç¬¬äºŒæ­¥ã€ä¼šå¤„ç†åœ¨beanFactoryä¸­å­˜åœ¨çš„ ç»§æ‰¿ BeanDefinitionRegistryPostProcessor å¹¶ä¸”å®ç°äº†Ordered æ¥å£çš„ç±»ä¸­çš„</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªåˆ—å‡ºå·®å¼‚ç‚¹</span></span><br><span class="line"><span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">    processedBeans.add(ppName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å’Œç¬¬ä¸€æ­¥å‡ ä¹ä¸€æ ·ï¼ŒåŒæ ·ä¼šå¯¹ä¾èµ–æ’åºã€æ·»åŠ åˆ°registryProcessorsä¸­åˆ°ã€å¤„ç†åç½®æ–¹æ³•ç­‰ã€‚</p><h3 id="æœ€åã€å¤„ç†å‰©ä¸‹çš„BeanDefinitionRegistryPostProcessorç±»"><a href="#æœ€åã€å¤„ç†å‰©ä¸‹çš„BeanDefinitionRegistryPostProcessorç±»" class="headerlink" title="æœ€åã€å¤„ç†å‰©ä¸‹çš„BeanDefinitionRegistryPostProcessorç±»"></a>æœ€åã€å¤„ç†å‰©ä¸‹çš„BeanDefinitionRegistryPostProcessorç±»</h3><p>å’Œå‰ä¸¤æ­¥ç›¸ä¼¼çš„é‡å¤çš„æ“ä½œã€‚å°±ä¸å±•ç¤ºä»£ç äº†ã€‚</p><h3 id="å¤„ç†å®Œæ‰€æœ‰çš„BeanFactoryPostProcessoråï¼Œå¤„ç†æ‰€æœ‰BeanPostProcessor"><a href="#å¤„ç†å®Œæ‰€æœ‰çš„BeanFactoryPostProcessoråï¼Œå¤„ç†æ‰€æœ‰BeanPostProcessor" class="headerlink" title="å¤„ç†å®Œæ‰€æœ‰çš„BeanFactoryPostProcessoråï¼Œå¤„ç†æ‰€æœ‰BeanPostProcessor"></a>å¤„ç†å®Œæ‰€æœ‰çš„BeanFactoryPostProcessoråï¼Œå¤„ç†æ‰€æœ‰BeanPostProcessor</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å‰é¢å¤„ç†è¿‡çš„ registryProcessors å¤„ç†å™¨</span></span><br><span class="line">invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Collection&lt;? extends BeanFactoryPostProcessor&gt; postProcessors, ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// æ‰§è¡ŒpostProcessBeanFactoryå›è°ƒæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">        postProcessor.postProcessBeanFactory(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸Šé¢æ˜¯é’ˆå¯¹ <code>beanFactory instanceof BeanDefinitionRegistry</code> çš„æƒ…å†µï¼Œå¦‚æœè¿”å›falseï¼Œå…·ä½“å†…å®¹å¯èƒ½ç¨æœ‰ä¸å®¹ã€‚ä½†å¤§è‡´ä¸Šæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå°±ä¸å†åˆ†æä¸‹é¢çš„ä»£ç äº†ã€‚</p><h2 id="5-registerBeanPostProcessors-æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨"><a href="#5-registerBeanPostProcessors-æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨" class="headerlink" title="5.registerBeanPostProcessors æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨"></a>5.registerBeanPostProcessors æ³¨å†ŒBeançš„åç½®å¤„ç†å™¨</h2><p>å°±åƒåå­—ä¸€æ ·ï¼Œ<code>registerBeanPostProcessors</code> çš„ä½œç”¨å°±æ˜¯æ³¨å†Œ <code>BeanPostProcessors</code>ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è°ƒç”¨PostProcessorRegistrationDelegateçš„é™æ€æ–¹æ³• <code>registerBeanPostProcessors</code></p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å¾—æ‰€æœ‰çš„BeanPostProcessor</span></span><br><span class="line">    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">    <span class="comment">// æ³¨å†Œä¸€ä¸ªBeanPostProcessorCheckerç”¨æ¥åœ¨BeanPostProcessorå®ä¾‹åŒ–Beanæ—¶æ‰“å°ä¿¡æ¯</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">            priorityOrderedPostProcessors.add(pp);</span><br><span class="line">            <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">                internalPostProcessors.add(pp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, register the BeanPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        orderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now, register all regular BeanPostProcessors.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        nonOrderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, re-register all internal BeanPostProcessors.</span></span><br><span class="line">    sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span></span><br><span class="line">    <span class="comment">// moving it to the end of the processor chain (for picking up proxies etc).</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿‡ç¨‹ç±»ä¼¼ <code>invokeBeanFactoryPostProcessors</code> çš„è¿‡ç¨‹ï¼Œå®é™…è¿‡ç¨‹åˆ†æ­¥å¯ä»¥æ•´ç†å¦‚ä¸‹ï¼š</p><ol><li>è·å¾—æ‰€æœ‰çš„BeanPostProcessorï¼Œå¹¶æ³¨å†Œä¸€ä¸ª<code>BeanPostProcessorChecker</code>ï¼Œç”¨æ¥åœ¨BeanPostProcessorä¸­åˆ›å»ºBeanæ—¶æ‰“å°ä¿¡æ¯ã€‚</li><li>é¦–å…ˆæ³¨å†Œç»§æ‰¿äº†PriorityOrderedæ¥å£çš„BeanPostProcessor;</li><li>ç„¶åæ³¨å†Œç»§æ‰¿äº†Orderedæ¥å£çš„ BeanPostProcessor;ç„¶åæ³¨å†Œæ‰€æœ‰çš„æ™®é€šçš„ BeanPostProcessorï¼›</li><li>æœ€åæ³¨å†Œæ‰€æœ‰çš„å†…éƒ¨çš„BeanPostProcessor;</li></ol><h2 id="6-initMessageSource-å¤„ç†åˆå§‹åŒ–æ¶ˆæ¯æ¥æºMessageSource"><a href="#6-initMessageSource-å¤„ç†åˆå§‹åŒ–æ¶ˆæ¯æ¥æºMessageSource" class="headerlink" title="6.initMessageSource å¤„ç†åˆå§‹åŒ–æ¶ˆæ¯æ¥æºMessageSource"></a>6.initMessageSource å¤„ç†åˆå§‹åŒ–æ¶ˆæ¯æ¥æºMessageSource</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å¾—beanFactory</span></span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    <span class="comment">// å¦‚æœåŒ…å«nameä¸º messageSource çš„bean</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">        <span class="comment">// è®©å½“å‰ MessageSource çŸ¥é“çˆ¶MessageSource </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">            HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">            <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">                <span class="comment">// registered already.</span></span><br><span class="line">                hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"Using MessageSource ["</span> + <span class="keyword">this</span>.messageSource + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸å­˜åœ¨MSï¼Œåˆ™æ–°å»ºä¸€ä¸ªç©ºçš„ MessageSource</span></span><br><span class="line">        DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">        dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">        <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">        beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"No '"</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">"' bean, using ["</span> + <span class="keyword">this</span>.messageSource + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨ initMessageSource è¿‡ç¨‹ä¸­ï¼Œåšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œä¸»è¦åˆ†ä¸¤æ­¥ï¼š</p><ol><li>å¦‚æœåŒ…å«messageSourceçš„Beanï¼Œåˆ™è®¾ç½®çˆ¶MessageSource</li><li>å¦‚æœä¸åŒ…å« messageSource çš„ Beanï¼Œåˆ™åˆ›å»ºä¸€ä¸ª DelegatingMessageSource å¹¶æ³¨å†Œåˆ° beanFactory ä¸­ã€‚</li></ol><h2 id="7-initApplicationEventMulticaster-åˆå§‹åŒ–åº”ç”¨äº‹ä»¶å¤šæ’­å™¨"><a href="#7-initApplicationEventMulticaster-åˆå§‹åŒ–åº”ç”¨äº‹ä»¶å¤šæ’­å™¨" class="headerlink" title="7. initApplicationEventMulticaster åˆå§‹åŒ–åº”ç”¨äº‹ä»¶å¤šæ’­å™¨"></a>7. initApplicationEventMulticaster åˆå§‹åŒ–åº”ç”¨äº‹ä»¶å¤šæ’­å™¨</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">                beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"Using ApplicationEventMulticaster ["</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"No '"</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">"' bean, using "</span> +</span><br><span class="line">                    <span class="string">"["</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å’Œåˆå§‹åŒ–MessageSourceè¿‡ç¨‹ç›¸ä¼¼,å¦‚æœåŒ…å«applicationEventMulticasterï¼Œåˆ™è®¾ç½® <code>this.applicationEventMulticaster</code> ä¸ºå®¹å™¨ä¸­çš„å¤šæ’­å™¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºï¼Œå¹¶ä½¿ç”¨beanFactoryè¿›è¡Œæ³¨å†Œä¸ºå•ä¾‹çš„Beanã€‚</p><h2 id="8-onRefresh-åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbean"><a href="#8-onRefresh-åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbean" class="headerlink" title="8. onRefresh åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbean"></a>8. onRefresh åœ¨ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­åˆå§‹åŒ–å…¶ä»–ç‰¹æ®Šbean</h2><p>ç‚¹è¿›æ–¹æ³•åæ˜¾ç¤ºæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œæ˜¯ç•™ç»™å­ç±»è‡ªè¡Œå»å®ç°çš„ï¼Œå»å¤„ç†ç‰¹æ®Šçš„beanã€‚</p><h2 id="9-registerListeners-æ³¨å†ŒListeners"><a href="#9-registerListeners-æ³¨å†ŒListeners" class="headerlink" title="9. registerListeners æ³¨å†ŒListeners"></a>9. registerListeners æ³¨å†ŒListeners</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆæ³¨å†Œé™æ€çš„listener</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘å¸ƒæ—©èµ·çš„åº”ç”¨äº‹ä»¶</span></span><br><span class="line">    Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">            getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="10-finishBeanFactoryInitialization-å®ŒæˆBeanFactoryçš„åˆå§‹åŒ–"><a href="#10-finishBeanFactoryInitialization-å®ŒæˆBeanFactoryçš„åˆå§‹åŒ–" class="headerlink" title="10.finishBeanFactoryInitialization å®ŒæˆBeanFactoryçš„åˆå§‹åŒ–"></a>10.finishBeanFactoryInitialization å®ŒæˆBeanFactoryçš„åˆå§‹åŒ–</h2><p>åœ¨è¿™ä¸€æ­¥å®Œæˆäº†æ‰€æœ‰çš„å‰©ä½™çš„å•å®ä¾‹Beançš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ– conversionService Bean</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">    <span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">    <span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸»è¦è¿‡ç¨‹åŒ…æ‹¬ï¼š</p><ol><li>åˆå§‹åŒ– conversionService ;</li><li>å¦‚æœæ²¡æœ‰å†…ç½®çš„Valueè§£æå™¨ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªStringValueResolverè§£æå™¨åˆ°beanFactoryä¸­ã€‚</li><li>åˆå§‹åŒ–LoadTimeWeaverAwareï¼›</li><li>åœæ­¢ä½¿ç”¨ä¸´æ—¶çš„ClassLoaderè¿›è¡Œç±»å‹åŒ¹é…ã€‚</li><li>å…è®¸ç¼“å­˜æ‰€æœ‰beanå®šä¹‰å…ƒæ•°æ®ï¼Œè€Œä¸æœŸæœ›è¿›ä¸€æ­¥çš„æ›´æ”¹ã€‚</li><li>å®ä¾‹åŒ–æ‰€æœ‰çš„å‰©ä½™çš„ã€éæ‡’åŠ è½½çš„å•å®ä¾‹Beanã€‚</li></ol><p>è¿™é‡Œåªé’ˆå¯¹ç¬¬6æ¡çš„å®ä¾‹åŒ–å‰©ä½™çš„å•å®ä¾‹Beanè¿›è¡Œæºç åˆ†æï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.preInstantiateSingletons();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span></span><br><span class="line">    <span class="comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span></span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯¹åº”å­Beançš„å®šä¹‰ï¼Œåˆ™éå†çˆ¶Beanå®šä¹‰å¾—åˆ°ä¸€ä¸ªåˆå¹¶çš„RootBeanDefinition</span></span><br><span class="line">        RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        <span class="comment">//å¦‚æœè¿™ä¸ªBeanä¸æ˜¯abstractã€æ˜¯å•ä¾‹çš„ã€éæ‡’åŠ è½½çš„</span></span><br><span class="line">        <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯FactoryBean</span></span><br><span class="line">            <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            <span class="comment">// æƒ³ä½¿ç”¨getBeanæ—¶éœ€è¦æ·»åŠ  &amp; å‰ç¼€</span></span><br><span class="line">                Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">                    <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">                    <span class="keyword">boolean</span> isEagerInit;</span><br><span class="line">                    <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                        isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                                        ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                                getAccessControlContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                                ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                    <span class="comment">// è°ƒç”¨getBeanè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                        getBean(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨getBeanè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ç»è¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼šåœ¨preInstantiateSingletonsæ–¹æ³•ä¸­ï¼ŒçœŸæ­£å»å®ä¾‹åŒ–çš„æ–¹å¼æ˜¯å»è°ƒç”¨ <code>getBean</code> [todo]æ–¹æ³•ã€‚</p><p>æ¥ä¸‹æ¥åˆ†æé…ç½®æ–‡ä»¶ä¸­çš„Beançš„æ³¨å†Œå’Œä½¿ç”¨ <code>getBean</code> è¿›è¡ŒçœŸæ­£çš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰&quot;&gt;&lt;a href=&quot;#åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰&quot; class=&quot;headerlink&quot; title=&quot;åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰&quot;&gt;&lt;/a&gt;åœ¨æ³¨å†Œé…ç½®æ–‡ä»¶åçš„åˆ·æ–°ï¼ˆRefreshï¼‰&lt;/h1&gt;&lt;
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ</title>
    <link href="https://nanyiniu.github.io/2019/12/11/%EF%BC%88%E5%9B%9B%EF%BC%89AOP%E5%88%87%E9%9D%A2%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86/"/>
    <id>https://nanyiniu.github.io/2019/12/11/ï¼ˆå››ï¼‰AOPåˆ‡é¢ä½¿ç”¨ä¸åŸç†/</id>
    <published>2019-12-11T12:00:00.000Z</published>
    <updated>2019-12-11T12:35:39.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ"><a href="#SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ" class="headerlink" title="SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ"></a>SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç°åœ¨æ¥çœ‹ï¼ˆAspect-oriented Programmingï¼‰ é¢å‘åˆ‡é¢ç¼–ç¨‹aopï¼Œæ˜¯å’Œoopï¼ˆObject-oriented Programmingï¼‰æ˜¯å¯¹ç¼–ç¨‹ç»“æœçš„ä¸åŒçš„æ€è€ƒçš„æ–¹å‘ã€‚åœ¨é¢å‘å¯¹è±¡ä¸­ï¼Œå½¢æˆç»„åˆçš„ç»„ä»¶æ˜¯ç±»ï¼ˆclassï¼‰ã€‚è€Œåœ¨é¢å‘åˆ‡é¢ï¼Œå½¢æˆç»„åˆçš„ç»„ä»¶æ˜¯åˆ‡é¢ï¼ˆAspectï¼‰,åˆ‡é¢èƒ½å¤Ÿå¯¹å…³æ³¨çš„åœ°æ–¹æ¨¡å—åŒ–ï¼Œæ¨ªåˆ‡å¤šç§ä¸åŒçš„ç±»å‹å’Œå¯¹è±¡ï¼ˆæ¯”å¦‚äº‹åŠ¡ç®¡ç†ï¼‰ã€‚è€Œè¿™ä¸ªæ‰€è°“çš„â€œå…³æ³¨çš„åœ°æ–¹â€ï¼Œä¹Ÿå¯ä»¥åœ¨AOPä¸­ç§°ä¸º<strong>è·¨é¢†åŸŸå…³æ³¨ç‚¹</strong>ã€‚</p><p>Springæä¾› é…ç½®æ–‡ä»¶ å’Œ @AspectJæ³¨è§£ æ–¹å¼ç¼–å†™AOPï¼Œä¸¤ç§æ–¹å¼éƒ½æ”¯æŒå„ç§çš„ Adviceï¼ˆé€šçŸ¥ï¼‰ï¼Œå¦‚æœä½¿ç”¨@AspectJæ³¨è§£ï¼Œä»ç„¶ä¼šé€šè¿‡Springçš„è¿›è¡Œç»‡å…¥ã€‚</p><h2 id="AOPä¸­å…³é”®å­—çš„æ¦‚å¿µ"><a href="#AOPä¸­å…³é”®å­—çš„æ¦‚å¿µ" class="headerlink" title="AOPä¸­å…³é”®å­—çš„æ¦‚å¿µ"></a>AOPä¸­å…³é”®å­—çš„æ¦‚å¿µ</h2><h3 id="1-Aspect"><a href="#1-Aspect" class="headerlink" title="1.Aspect"></a>1.Aspect</h3><p>åˆ‡é¢ï¼š å¯¹å¤šç§ä¸åŒçš„ç±»çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œè¿™ä¸ªå…³æ³¨ç‚¹è¢«æ¨¡å—åŒ–ä¸ºä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å°±å«åšåˆ‡é¢ï¼ˆåˆ‡é¢ç±»ï¼‰ï¼Œé€šè¿‡åœ¨æ™®é€šç±»ä¸Šæ ‡æ³¨ <code>@Aspect</code>æ³¨è§£æ¥å®ç°ã€‚</p><h3 id="2-Join-point"><a href="#2-Join-point" class="headerlink" title="2.Join point"></a>2.Join point</h3><p>è¿æ¥ç‚¹ï¼šç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ‰§è¡Œé€šçŸ¥ï¼ˆAdviceï¼‰çš„ç‚¹ã€‚</p><h3 id="3-Advice"><a href="#3-Advice" class="headerlink" title="3.Advice"></a>3.Advice</h3><p>é€šçŸ¥ï¼šé€šçŸ¥æŒ‡çš„æ˜¯åˆ‡é¢åœ¨æŒ‡å®šçš„è¿æ¥ç‚¹å¤„æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒçš„é€šçŸ¥ç±»å‹åŒ…æ‹¬ï¼šâ€œaroundâ€, â€œbeforeâ€ and â€œafterâ€</p><h3 id="4-Pointcut"><a href="#4-Pointcut" class="headerlink" title="4.Pointcut"></a>4.Pointcut</h3><p>åˆ‡ç‚¹ï¼šåˆ‡ç‚¹ä¼šåŒ¹é…é€šçŸ¥æ‰€è¦ç»‡å…¥çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿æ¥ç‚¹ï¼Œé€šçŸ¥æ˜¯ä¸åˆ‡ç‚¹å‘å…³è”çš„ï¼Œå¹¶ä¸”åœ¨ä»»ä½•åŒ¹é…åˆ°åˆ‡ç‚¹çš„åœ°æ–¹æ‰§è¡Œåœ¨è¿æ¥ç‚¹ä¸Šçš„æ“ä½œã€‚</p><h3 id="5-Target-object"><a href="#5-Target-object" class="headerlink" title="5.Target object"></a>5.Target object</h3><p>ç›®æ ‡å¯¹è±¡ï¼šä¸€ä¸ªã€è¢«ä¸€ä¸ªæˆ–å¤šä¸ªåˆ‡é¢è¿›è¡Œé€šçŸ¥ã€‘çš„å¯¹è±¡å«åšç›®æ ‡å¯¹è±¡ï¼Œä¹Ÿå«ä»£ç†å¯¹è±¡ã€‚</p><h3 id="6-AOP-proxy"><a href="#6-AOP-proxy" class="headerlink" title="6.AOP proxy"></a>6.AOP proxy</h3><p>AOPä»£ç†ï¼šåœ¨Springä¸­ï¼Œä¸€ä¸ªæ˜¯JDKåŠ¨æ€ä»£ç†ï¼Œä¸€ä¸ªæ˜¯ CGLIB ä»£ç†ã€‚</p><h3 id="7-Weaving"><a href="#7-Weaving" class="headerlink" title="7.Weaving"></a>7.Weaving</h3><p>ç»‡å…¥ï¼šç»‡å…¥æ˜¯å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºçš„ä»£ç†å¯¹è±¡è¿‡ç¨‹</p><h2 id="ä½¿ç”¨æ³¨è§£æ–¹å¼è¿›è¡ŒAOPçš„é…ç½®å’Œä½¿ç”¨"><a href="#ä½¿ç”¨æ³¨è§£æ–¹å¼è¿›è¡ŒAOPçš„é…ç½®å’Œä½¿ç”¨" class="headerlink" title="ä½¿ç”¨æ³¨è§£æ–¹å¼è¿›è¡ŒAOPçš„é…ç½®å’Œä½¿ç”¨"></a>ä½¿ç”¨æ³¨è§£æ–¹å¼è¿›è¡ŒAOPçš„é…ç½®å’Œä½¿ç”¨</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. ä½¿ç”¨ <span class="doctag">@Aspect</span> æ³¨è§£åˆ›å»ºåˆ‡é¢ç±»</span></span><br><span class="line"><span class="comment"> * 2. ä½¿ç”¨ <span class="doctag">@Pointcut</span> æ³¨è§£æ³¨æ˜åˆ‡ç‚¹ï¼ˆä½¿ç”¨Aspectè¡¨è¾¾å¼ï¼‰</span></span><br><span class="line"><span class="comment"> * 3. å£°æ˜é€šçŸ¥ï¼ˆBeforeï¼ŒAfterï¼ŒAroundï¼ŒAfterReturningï¼ŒAfterThrowingï¼‰å…·ä½“å«ä¹‰å¯ä»¥å‚è€ƒRefæ–‡æ¡£ 5.4.4. Declaring Advice</span></span><br><span class="line"><span class="comment"> * åªæ˜¯ä»¥ä¸Šä¸‰æ­¥æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºæ²¡æœ‰å¼€å¯Springå¯¹æ³¨è§£ç‰ˆAOPçš„æ”¯æŒ</span></span><br><span class="line"><span class="comment"> * æ‰€ä»¥ï¼Œéœ€è¦ä½¿ç”¨ <span class="doctag">@EnableAspectJAutoProxy</span> å¼€å¯å¯¹<span class="doctag">@Aspect</span>æ³¨è§£çš„æ”¯æŒ</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspects</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut</span>(value=<span class="string">"within(com.nanyin.service.*)"</span>)</span><br><span class="line"><span class="comment">// @Pointcut("execution(public * (..))")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointCut</span><span class="params">()</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span>(<span class="string">"pointCut()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logBefore</span><span class="params">(JoinPoint jp)</span></span>&#123;</span><br><span class="line">System.out.println(jp.getSignature().getName());</span><br><span class="line">System.out.println(<span class="string">"before..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@After</span>(<span class="string">"pointCut()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logAfter</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">"after..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AfterReturning</span>(<span class="string">"pointCut()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logAfterReturn</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">"after return..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AfterThrowing</span>(value = <span class="string">"pointCut()"</span>,throwing = <span class="string">"ex"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logAfterThrowing</span><span class="params">(JoinPoint joinPoint,Exception ex)</span></span>&#123;</span><br><span class="line">joinPoint.getSignature().getName();</span><br><span class="line">System.out.println(<span class="string">"after throwing..."</span>);</span><br><span class="line">System.out.println(ex.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// aroundåœ¨proceed ä¹‹å‰æ˜¯åœ¨ beforeä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// aroundåœ¨proceed ä¹‹å‰æ˜¯åœ¨ afterä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// å¯å…¼å®¹beforeå’Œafter</span></span><br><span class="line"><span class="meta">@Around</span>(<span class="string">"pointCut()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">logAround</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"><span class="comment">// æ–¹æ³•å¼€å§‹</span></span><br><span class="line">System.out.println(<span class="string">"around methods begin ..."</span>);</span><br><span class="line">Object object = joinPoint.proceed();</span><br><span class="line">System.out.println(<span class="string">"around methods end ..."</span>);</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿›è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(BasicConfig.class);</span><br><span class="line">BasicService basicService = (BasicService) applicationContext.getBean(<span class="string">"basicService"</span>);</span><br><span class="line"><span class="comment">// å› ä¸ºåˆ‡ç‚¹åŒ…æ‹¬è¿™ä¸ªbasicServiceï¼Œæ‰€ä»¥æ‰§è¡Œhelloå°±ä¼šè§¦å‘AOP</span></span><br><span class="line">basicService.hello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æœ</span></span><br><span class="line">around methods begin ...</span><br><span class="line">hello</span><br><span class="line">before...</span><br><span class="line">hello world!!</span><br><span class="line">around methods end ...</span><br><span class="line">after...</span><br><span class="line">after <span class="keyword">return</span>...</span><br></pre></td></tr></table></figure></div><h2 id="AOPä»£ç åŸç†åˆ†æ"><a href="#AOPä»£ç åŸç†åˆ†æ" class="headerlink" title="AOPä»£ç åŸç†åˆ†æ"></a>AOPä»£ç åŸç†åˆ†æ</h2><p>é€šè¿‡ä»¥ä¸Šå®è·µï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœéœ€è¦ä½¿ç”¨Springçš„AOPåŠŸèƒ½ï¼Œéœ€è¦å…ˆä½¿ç”¨ <code>@EnableAspectJAutoProxy</code> æ³¨è§£æ ‡æ³¨åœ¨é…ç½®ç±»ä¸­ï¼Œä½¿ <code>@Aspect</code> ç”Ÿæ•ˆä¸ºä¸€ä¸ªåˆ‡é¢ç±»ã€‚</p><h3 id="1-EnableAspectJAutoProxy-å¼€å¯springAOPæ”¯æŒ"><a href="#1-EnableAspectJAutoProxy-å¼€å¯springAOPæ”¯æŒ" class="headerlink" title="1. @EnableAspectJAutoProxy å¼€å¯springAOPæ”¯æŒ"></a>1. @EnableAspectJAutoProxy å¼€å¯springAOPæ”¯æŒ</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE) <span class="comment">//æ ‡æ³¨åœ¨ç±»ä¸Š</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(AspectJAutoProxyRegistrar.class) <span class="comment">//å¼•å…¥ AspectJAutoProxyRegistrar</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ˜¯å¦ä½¿ç”¨CGLIBè¿›è¡Œä»£ç†ï¼Œé»˜è®¤æ˜¯falseï¼Œå³é»˜è®¤ä½¿ç”¨JDKåŠ¨æ€ä»£ç†</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ˜¯å¦éœ€è¦ ä»£ç†åº”ç”±AOPæ¡†æ¶å…¬å¼€ä¸º&#123;ThreadLocal&#125;ï¼Œä»¥ä¾¿é€šè¿‡&#123;AopContext&#125;ç±»è¿›è¡Œæ£€ç´¢ã€‚</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">exposeProxy</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é‡è¦çš„æ˜¯æ³¨è§£Importå†…å¼•ç”¨çš„<code>AspectJAutoProxyRegistrar</code>ç±»ã€‚è¿™ä¸ªç±»é€šè¿‡ä½¿ç”¨ <code>BeanDefinitionRegistry</code> æ³¨å†Œä¸€ä¸ª <code>AnnotationAwareAspectJAutoProxyCreator</code>.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"><span class="comment">//å¦‚æœéœ€è¦ æ³¨å†ŒAspectJæ³¨è§£è‡ªåŠ¨ä»£ç†åˆ›å»ºç±» internalAutoProxyCreator</span></span><br><span class="line">AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BeanDefinition <span class="title">registerOrEscalateApcAsRequired</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;?&gt; cls, BeanDefinitionRegistry registry, @Nullable Object source)</span> </span>&#123;</span><br><span class="line"><span class="comment">//cls=AnnotationAwareAspectJAutoProxyCreator</span></span><br><span class="line">Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null"</span>);</span><br><span class="line"><span class="comment">// æ˜¯å¦å­˜åœ¨internalAutoProxyCreator</span></span><br><span class="line"><span class="keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å¾—ä¸€ä¸ª AnnotationAwareAspectJAutoProxyCreator çš„ beanDefinition</span></span><br><span class="line">RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(cls);</span><br><span class="line">beanDefinition.setSource(source);</span><br><span class="line">beanDefinition.getPropertyValues().add(<span class="string">"order"</span>, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line"><span class="comment">// æ³¨å†Œåä¸º org.springframework.aop.config.internalAutoProxyCreator çš„ç±»</span></span><br><span class="line"><span class="comment">// å®é™…å¯¹åº”çš„æ˜¯ AnnotationAwareAspectJAutoProxyCreator ç±»ï¼Œè€Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥ä½¿@Aspectèµ·ä½œç”¨çš„</span></span><br><span class="line">registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line"><span class="keyword">return</span> beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸ºä»€ä¹ˆå¿…é¡»è¦ä½¿ç”¨ <code>@EnableAspectJAutoProxy</code> æ³¨è§£ æ‰èƒ½ä½¿ Spring AOP èµ·åˆ°ä½œç”¨ï¼Œç»è¿‡ä¸Šé¢çš„åˆ†æå°±èƒ½å¤Ÿç»™å‡ºç­”æ¡ˆäº†ï¼Œå› ä¸ºåªæœ‰æ·»åŠ äº† <code>@EnableAspectJAutoProxy</code> è¿™ä¸ªæ³¨è§£ï¼Œæ‰èƒ½ä½¿è§£æ <code>@Aspect</code> æ³¨è§£çš„ <strong>AnnotationAwareAspectJAutoProxyCreator</strong> æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</p><p>é‚£ä¹ˆ <strong>AnnotationAwareAspectJAutoProxyCreator</strong> æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ã€‚ã€‚</p><h3 id="2-AnnotationAwareAspectJAutoProxyCreator-å®ç°AOPåŠŸèƒ½"><a href="#2-AnnotationAwareAspectJAutoProxyCreator-å®ç°AOPåŠŸèƒ½" class="headerlink" title="2. AnnotationAwareAspectJAutoProxyCreator å®ç°AOPåŠŸèƒ½"></a>2. AnnotationAwareAspectJAutoProxyCreator å®ç°AOPåŠŸèƒ½</h3><h4 id="ç±»ç»“æ„åˆæ­¥åˆ†æ"><a href="#ç±»ç»“æ„åˆæ­¥åˆ†æ" class="headerlink" title="ç±»ç»“æ„åˆæ­¥åˆ†æ"></a>ç±»ç»“æ„åˆæ­¥åˆ†æ</h4><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20191117135450.jpg" alt="å›¾1"></p><p>æ ¹æ®ä¸Šé¢çš„å›¾ç‰‡å¯ä»¥çœ‹å‡º AnnotationAwareAspectJAutoProxyCreator æœ‰ä¸¤ä¸ªé¡¶çº§æ¥å£ï¼Œåˆ†åˆ«æ˜¯ BeanPostProcesser å’Œ Aware æ¥å£ã€‚</p><p>Aware æ¥å£ä¸»è¦ç”¨äºæ ‡è®°è¶…çº§æ¥å£ï¼Œç”¨äºæŒ‡ç¤ºbeanæœ‰èµ„æ ¼é€šè¿‡å›è°ƒæ ·å¼æ–¹æ³•ç”±Springå®¹å™¨é€šçŸ¥ç‰¹å®šæ¡†æ¶å¯¹è±¡ã€‚</p><p>BeanPostProcesser å¯ä»¥é€šè¿‡å®ç° BeanPostProcesser å…è®¸è‡ªå®šä¹‰ä¿®æ”¹æ–°çš„beanå®ä¾‹ã€‚ å…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªåç½®å¤„ç†å™¨ï¼š1.<code>postProcessBeforeInitialization(Object bean, String beanName)</code>  2.<code>postProcessAfterInitialization(Object bean, String beanName)</code> åˆ†åˆ«é’ˆå¯¹åˆå§‹åŒ–å‰åçš„æ‹¦æˆªå¤„ç†ã€‚</p><h5 id="a-AbstractAutoProxyCreator"><a href="#a-AbstractAutoProxyCreator" class="headerlink" title="a. AbstractAutoProxyCreator"></a>a. AbstractAutoProxyCreator</h5><p>åœ¨é€šè¿‡ä¸Šé¢å›¾ç‰‡ä¸­æ‰€çœ‹åˆ°çš„ AbstractAutoProxyCreator ç»§æ‰¿äº† ProxyProcessorSupport ç±»</p><table><thead><tr><th>ç»§æ‰¿ç±»/æ¥å£</th><th>ä½œç”¨</th><th>éœ€è¦å®ç°æ–¹æ³•</th></tr></thead><tbody><tr><td>ProxyConfigç±»</td><td>ç”¨äºåˆ›å»ºä»£ç†çš„é…ç½®çš„ä¾¿åˆ©è¶…ç±»ï¼Œä¿è¯æ‰€æœ‰çš„ä»£ç†åˆ›å»ºç±»æœ‰ä¸€è‡´çš„å±æ€§</td><td></td></tr><tr><td>Orderedæ¥å£</td><td>è¡¨ç¤ºç»§æ‰¿ç±»æ˜¯æœ‰åºçš„</td><td></td></tr><tr><td>BeanClassLoaderAwareæ¥å£</td><td>ä½¿ç”¨æŒ‡å®šçš„classLoaderæ¥åŠ è½½Bean</td><td>setBeanClassLoader(ClassLoader classLoader)</td></tr><tr><td>AopInfrastructureBeanæ¥å£</td><td>æ ‡ç¤ºè¯¥Beanæ˜¯ä½œä¸ºSpring AOPçš„åŸºç¡€ç»„ä»¶è¿›è¡Œä½¿ç”¨ï¼Œå› æ­¤ä¸ä¼šè¢«ä»£ç†ï¼Œå³ä½¿è¢«PointCutæŒ‡å®šåˆ°ä¹Ÿä¸ä¼šè¢«ä»£ç†åˆ°</td><td></td></tr><tr><td>BeanFactoryAware</td><td>ä½¿ç”¨æŒ‡å®šçš„ BeanFactory æ¥å®ä¾‹åŒ–Bean</td><td>void setBeanFactory(BeanFactory beanFactory)</td></tr></tbody></table><h5 id="b-SmartInstantiationAwareBeanPostProcessor"><a href="#b-SmartInstantiationAwareBeanPostProcessor" class="headerlink" title="b. SmartInstantiationAwareBeanPostProcessor"></a>b. SmartInstantiationAwareBeanPostProcessor</h5><p>AbstractAutoProxyCreator -&gt; å®ç°è‡ª <code>SmartInstantiationAwareBeanPostProcessor</code>  -&gt; ç»§æ‰¿è‡ª <code>InstantiationAwareBeanPostProcessor</code> -&gt; ç»§æ‰¿è‡ª <code>BeanPostProcessor</code>.</p><ul><li>InstantiationAwareBeanPostProcessor</li></ul><p>åœ¨è¿™ä¸ªæ¥å£ä¸­ï¼Œä¸ä»…ä»…æœ‰ç»§æ‰¿äº BeanPostProcessor çš„ <code>postProcessBeforeInitialization(Object bean, String beanName)</code>  å’Œ <code>postProcessAfterInitialization(Object bean, String beanName)</code> ä¸¤ä¸ªBeanåˆå§‹åŒ–å‰åçš„å¤„ç†æ–¹æ³•ï¼Œæœ¬èº«è¿˜å®šä¹‰äº† <code>postProcessProperties</code> å’Œ <code>postProcessPropertyValues</code>æ–¹æ³•ã€‚ä½œç”¨æ˜¯åœ¨é’ˆå¯¹Beançš„åˆå§‹åŒ–åå¯¹å±æ€§è¿›è¡Œåç½®å¤„ç†ã€‚</p><ul><li>SmartInstantiationAwareBeanPostProcessor</li></ul><p>åœ¨è¿™ä¸ªæ¥å£ä¸­å®šä¹‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä¸º <code>default Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName)</code> ç”¨æ¥é¢„æµ‹ä½¿ç”¨BeanPostProcessorçš„postProcessBeforeInstantiationæ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œé»˜è®¤ä¸ºnullã€‚<code>default Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName)</code> ç”¨æ¥å†³å®šä½¿ç”¨å“ªä¸ªå€™é€‰çš„æ„é€ å™¨ã€‚</p><h4 id="AbstractAutoProxyCreatorç±»æºç åˆ†æ"><a href="#AbstractAutoProxyCreatorç±»æºç åˆ†æ" class="headerlink" title="AbstractAutoProxyCreatorç±»æºç åˆ†æ"></a>AbstractAutoProxyCreatorç±»æºç åˆ†æ</h4><p>åœ¨ <code>AbstractAutoProxyCreator</code> ä½œä¸º <code>AnnotationAwareAspectJAutoProxyCreator</code> çš„çˆ¶ç±»ï¼Œèµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p><p>åœ¨ <code>AbstractAutoProxyCreator</code> ä¸­ï¼Œå®ç°äº† <code>BeanPostProcessor</code> çš„åˆå§‹åŒ–å‰åå¤„ç†æ–¹æ³•ï¼Œç”¨æ¥é’ˆå¯¹æ¯æ¬¡åˆå§‹åŒ–Beanå‰åå¯¹åˆ‡é¢çš„è¯†åˆ«åˆ¤æ–­å’Œå¯¹ç¬¦åˆæ¡ä»¶çš„Beanè¿›è¡Œé€šçŸ¥çš„ä»£ç†ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// postProcessBeforeInitialization ,BeanPostProcessorçš„å®ç°æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">Object cacheKey = getCacheKey(beanClass, beanName); <span class="comment">//è·å¾—beanClass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!StringUtils.hasLength(beanName) || !<span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.advisedBeans.containsKey(cacheKey)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†@AspectJæ³¨è§£å®šä¹‰çš„åˆ‡é¢ç±»è¿˜æ˜¯ å®ç°Adviceã€Pointcutã€Advisorã€AopInfrastructureBean</span></span><br><span class="line"><span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE); <span class="comment">//æ·»åŠ åˆ°advisedBeansé‡Œé¢ï¼Œç­‰å¾…å¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœä¸æ˜¯åŸºç¡€è®¾æ–½çš„ç±»</span></span><br><span class="line">TargetSource targetSource = getCustomTargetSource(beanClass, beanName); <span class="comment">//è·å¾—targetSource</span></span><br><span class="line"><span class="keyword">if</span> (targetSource != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(beanName)) &#123;</span><br><span class="line"><span class="keyword">this</span>.targetSourcedBeans.add(beanName);</span><br><span class="line">&#125;</span><br><span class="line">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br><span class="line">Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource); <span class="comment">//åˆ›å»ºä»£ç†ç±»</span></span><br><span class="line"><span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line"><span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨postProcessBeforeInstantiationå®ç°ç±»ä¸­ï¼Œå…·ä½“æµç¨‹å¤§è‡´ä¸º å¦‚æœæ˜¯Aspectåˆ‡é¢ç±»ï¼Œåˆ™å°†ç±»æ·»åŠ åˆ°advisedBeansä¸­ç­‰å¾…è¿›è¡ŒAdviceçš„ç»„è£…ï¼Œå¦‚æœä¸æ˜¯åˆ‡é¢ç±»ï¼Œåˆ™ä¼šå…ˆå»åˆ¤æ–­æ˜¯å¦è‡ªå®šä¹‰ä¸€ä¸ª  customTargetSourceCreators æ•°ç»„ ï¼Œå¦‚æœå®šä¹‰äº†ã€‚åˆ™ç»„è£…æˆè‡ªå®šä¹‰çš„ä»£ç†ç±»è¿›è¡Œè¿”å›ã€‚</p><h5 id="1-åˆ¤æ–­æ˜¯å¦æ˜¯ä¸ªåˆ‡é¢"><a href="#1-åˆ¤æ–­æ˜¯å¦æ˜¯ä¸ªåˆ‡é¢" class="headerlink" title="1. åˆ¤æ–­æ˜¯å¦æ˜¯ä¸ªåˆ‡é¢"></a>1. åˆ¤æ–­æ˜¯å¦æ˜¯ä¸ªåˆ‡é¢</h5><p>é‚£ä¹ˆæœ€ä¸»è¦çš„é—®é¢˜æ˜¯å¦‚ä½•è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯Aspectåˆ‡é¢ç±»å‘¢ã€‚åªæœ‰ç³»ç»Ÿè®¤ä¸ºæ˜¯åˆ‡é¢ç±»ï¼Œæ‰èƒ½è¿›è¡Œæ¥ä¸‹æ¥çš„ç»„è£…Adviceå‘é€šçŸ¥çš„åç»­æ“ä½œã€‚å¦åˆ™å°±ä¸èƒ½è¿›è¡Œé€šçŸ¥äº†ã€‚<br>æ‰€ä»¥å…³é”®ç‚¹åœ¨äº <code>isInfrastructureClass</code> æ–¹æ³•ã€‚</p><p>åœ¨ AnnotationAwareAspectJAutoProxyCreator ä¸­å­˜åœ¨ çš„isInfrastructureClass å®ç°æ–¹æ³•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isInfrastructureClass</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åŠ ä¸Šçˆ¶ç±»ä¸­çš„isInfrastructureClassåˆ¤æ–­è§„åˆ™</span></span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">super</span>.isInfrastructureClass(beanClass) ||</span><br><span class="line">(<span class="keyword">this</span>.aspectJAdvisorFactory != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.aspectJAdvisorFactory.isAspect(beanClass)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAspect</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (hasAspectAnnotation(clazz) &amp;&amp; !compiledByAjc(clazz));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ¨è¿™é‡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ Aspect æ³¨è§£</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasAspectAnnotation</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (AnnotationUtils.findAnnotation(clazz, Aspect.class) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AbstractAutoProxyCreator ä¸­çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isInfrastructureClass</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line"><span class="keyword">boolean</span> retVal = Advice.class.isAssignableFrom(beanClass) || <span class="comment">//æ˜¯å¦å®ç° Advice</span></span><br><span class="line">Pointcut.class.isAssignableFrom(beanClass) || <span class="comment">//æ˜¯å¦å®ç° Pointcut</span></span><br><span class="line">Advisor.class.isAssignableFrom(beanClass) || <span class="comment">//æ˜¯å¦å®ç° Advisor</span></span><br><span class="line">AopInfrastructureBean.class.isAssignableFrom(beanClass); <span class="comment">//æ˜¯å¦å®ç° AopInfrastructureBean</span></span><br><span class="line"><span class="keyword">if</span> (retVal &amp;&amp; logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">"Did not attempt to auto-proxy infrastructure class ["</span> + beanClass.getName() + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="2-è¿›è¡Œä»£ç†"><a href="#2-è¿›è¡Œä»£ç†" class="headerlink" title="2.è¿›è¡Œä»£ç†"></a>2.è¿›è¡Œä»£ç†</h5><p>çœŸæ­£çš„ä»£ç†æ˜¯å‘ç”Ÿåœ¨å®ç°çš„ <code>beanPostProcessor</code> çš„ <code>postProcessAfterInitialization</code></p><p>åœ¨ <code>AbstractAutoProxyCreator</code> ä¸­æä¾›ç±»ä¸€ä¸ªåˆå§‹åŒ–åç½®å¤„ç†å™¨ <code>postProcessAfterInitialization</code> ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(@Nullable Object bean, String beanName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123; <span class="comment">// å¦‚æœä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦è¿›è¡Œä»£ç†çš„åŒ…è£…</span></span><br><span class="line"><span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœ‰å¿…è¦ï¼ŒåŒ…è£…ç»™å®šçš„beanï¼Œå³æ˜¯å¦æœ‰èµ„æ ¼è¢«ä»£ç†</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœåœ¨ postProcessBeforeInitialization ä¸­å®šä¹‰äº†targetSourcedBeans,åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Boolean.FALSE.equals(<span class="keyword">this</span>.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»æ·»åŠ åˆ°advisedBeansä¸­ä¹Ÿç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ˜¯ä¸€ä¸ªåŸºæœ¬é…ç½®Aspectç±»ï¼Œåˆ™æ”¾åˆ°advisedBeansä¸­ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line"><span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºAdviceï¼Œåˆ›å»ºadviceçš„è¿‡ç¨‹å…ˆçœç•¥</span></span><br><span class="line">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// Adviceå­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä»£ç†</span></span><br><span class="line"><span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line"><span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line"><span class="comment">// åˆ›å»ºä»£ç†</span></span><br><span class="line">Object proxy = createProxy(</span><br><span class="line">bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</span><br><span class="line"><span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line"><span class="comment">// è¿”å›ä»£ç†å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="AOPå¯¹ç±»çš„åŠ è½½åŒ…è£…è¿‡ç¨‹"><a href="#AOPå¯¹ç±»çš„åŠ è½½åŒ…è£…è¿‡ç¨‹" class="headerlink" title="AOPå¯¹ç±»çš„åŠ è½½åŒ…è£…è¿‡ç¨‹"></a>AOPå¯¹ç±»çš„åŠ è½½åŒ…è£…è¿‡ç¨‹</h3><p>æ¯æ¬¡åœ¨åˆ›å»ºBeanæ—¶ï¼Œä¼šé€šè¿‡createBean()æ–¹æ³•æ¥åˆ›å»ºBeanï¼Œå…¶ä¸­åœ¨çœŸæ­£çš„åˆ›å»ºBeanä¹‹å‰æ‰§è¡Œäº†resolveBeforeInstantiation å»ç”Ÿæˆä»£ç†Beanã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line"><span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºBean</span></span><br><span class="line">Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">"Finished creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> beanInstance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”Ÿæˆä»£ç†å¯¹è±¡æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">resolveBeforeInstantiation</span><span class="params">(String beanName, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">Object bean = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;</span><br><span class="line"><span class="comment">// Make sure bean class is actually resolved at this point.</span></span><br><span class="line"><span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);</span><br><span class="line"><span class="keyword">if</span> (targetType != <span class="keyword">null</span>) &#123;</span><br><span class="line">bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);</span><br><span class="line"><span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">mbd.beforeInstantiationResolved = (bean != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨è¿™é‡ŒçœŸæ­£æ‰§è¡Œäº†åˆ›å»ºä»£ç†å¯¹è±¡ä¸­çš„beanåˆå§‹åŒ–å‰åæ–¹æ³•ã€‚å…ˆæ‰§è¡Œäº† <code>applyBeanPostProcessorsBeforeInstantiation</code> , è¿›è¡ŒAOPåˆ‡é¢ç±»çš„è¯†åˆ«ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line"><span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line"><span class="comment">// å¯¹æ¯ä¸€ä¸ªBeanåˆ›å»ºå‰éƒ½è¿›è¡Œä¸€æ¬¡å¤„ç†ï¼Œå‰ææ˜¯ è¿™ä¸ªç±»å®ç°</span></span><br><span class="line"><span class="comment">// InstantiationAwareBeanPostProcessor æ¥å£ã€‚</span></span><br><span class="line">InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line"><span class="comment">// å¦‚æœå®ç°è¿™ä¸ªæ¥å£ï¼Œåˆ™è¿›è¡Œå®ä¾‹åŒ–å‰çš„åç½®å¤„ç†ã€‚</span></span><br><span class="line">Object result = ibp.postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨createBeanæ–¹æ³•æ—¶ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize the bean instance.</span></span><br><span class="line">Object exposedObject = bean;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// å¡«å……Bean</span></span><br><span class="line">populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–Bean</span></span><br><span class="line">exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨ initializeBean ä¸­æ‰çœŸæ­£çš„æ‰§è¡Œç»§æ‰¿ BeanPostProcessor ç±»çš„Beanåˆå§‹åŒ–å‰åçš„CallBackæ–¹æ³•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">(mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">beanName, <span class="string">"Invocation of init method failed"</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>æ‰€ä»¥ï¼Œç»¼ä¸Šï¼Œåœ¨ createbean æ–¹æ³•ä¹‹å‰ä¼šæ‰§è¡Œå¯¹åˆ‡é¢ç±»çš„è¯†åˆ«ï¼Œä¹Ÿå°±æ˜¯åˆ‡é¢ç±»çš„å‰ç½®å¤„ç†ã€‚ä½†çœŸæ­£å»æ‰§è¡Œæ‰€æœ‰çš„Beançš„é€šçŸ¥ï¼Œéƒ½æ˜¯åœ¨ initializeBean ä¸­çš„  applyBeanPostProcessorsAfterInitialization æ–¹æ³•ä¸­æ‰§è¡Œçš„ã€‚</p><h3 id="Springåˆ›å»ºä»£ç†çš„æ–¹å¼"><a href="#Springåˆ›å»ºä»£ç†çš„æ–¹å¼" class="headerlink" title="Springåˆ›å»ºä»£ç†çš„æ–¹å¼"></a>Springåˆ›å»ºä»£ç†çš„æ–¹å¼</h3><p>SpringAOPåˆ›å»ºä»£ç†æœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§ï¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚ç¬¬äºŒç§ï¼šä½¿ç”¨CGLIBä»£ç†ã€‚ä¸‹é¢æ¥é’ˆå¯¹ä»£ç†æ–¹å¼çš„é€‰æ‹©æ–¹å¼ï¼ŒæŸ¥çœ‹æºç ä¸€æ¢ç©¶ç«Ÿã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°çš„åœ¨ <code>AbstractAutoProxyCreator</code> ä¸­çš„åœ¨åç½®å¤„ç†å™¨ä¸­ <code>postProcessAfterInitialization</code> çš„ <code>wrapIfNecessary</code>ä¸­è¿›è¡Œäº†å¯¹Beançš„ä»£ç†åŒ…è£…å¤„ç†.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœå­˜åœ¨å¯ç”¨çš„é€šçŸ¥ï¼Œåˆ™å¯¹Beanè¿›è¡Œä»£ç†</span></span><br><span class="line">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line"><span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line"><span class="comment">// åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">Object proxy = createProxy(</span><br><span class="line">bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</span><br><span class="line"><span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line"><span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨ <code>createProxy</code> ä¸­å†³å®šäº†ä½¿ç”¨å“ªç§æ–¹å¼ï¼ˆJDKåŠ¨æ€ä»£ç†ã€CGLIBä»£ç†ï¼‰è¿›è¡Œä»£ç†ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createProxy</span><span class="params">(Class&lt;?&gt; beanClass, @Nullable String beanName,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Object[] specificInterceptors, TargetSource targetSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) <span class="keyword">this</span>.beanFactory, beanName, beanClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">proxyFactory.copyFrom(<span class="keyword">this</span>);<span class="comment">// å¤åˆ¶é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;<span class="comment">//è¿”å›æ˜¯å¦ç›´æ¥ä»£ç†ç›®æ ‡ç±»ä»¥åŠä»»ä½•æ¥å£ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœ proxy-target-class æ ‡ç­¾å±æ€§è¿”å›trueï¼Œåˆ™è¡¨æ˜éœ€è¦åŸºäºç±»çš„ä»£ç†ï¼Œ</span></span><br><span class="line"><span class="comment">// åä¹‹åˆ™éœ€è¦åŸºäºæ¥å£çš„ä»£ç†</span></span><br><span class="line">proxyFactory.setProxyTargetClass(<span class="keyword">true</span>); <span class="comment">//ä½¿ç”¨CGLIBä»£ç†ï¼ˆtrueï¼‰</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">evaluateProxyInterfaces(beanClass, proxyFactory); <span class="comment">//æ£€æŸ¥æ˜¯å¦å®ç°äº†æ¥å£</span></span><br><span class="line"><span class="comment">// å¦‚æœå®ç°äº†æ¥å£ï¼Œåˆ™è®¾ç½®interfaceï¼Œå¦åˆ™è®¾ç½®proxyTargetClassä¸ºtrueï¼Œä½†å‰ææ˜¯</span></span><br><span class="line"><span class="comment">// ç”¨æˆ·æ²¡æœ‰è‡ªå·±è®¾ç½®proxyTargetClasså±æ€§</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * if (hasReasonableProxyInterface) &#123;</span></span><br><span class="line"><span class="comment"> * Must allow for introductions; can't just set interfaces to the target's interfaces only.</span></span><br><span class="line"><span class="comment"> *for (Class&lt;?&gt; ifc : targetInterfaces) &#123;</span></span><br><span class="line"><span class="comment"> *proxyFactory.addInterface(ifc);</span></span><br><span class="line"><span class="comment"> *&#125;</span></span><br><span class="line"><span class="comment">     *&#125;else &#123;</span></span><br><span class="line"><span class="comment"> *proxyFactory.setProxyTargetClass(true);</span></span><br><span class="line"><span class="comment"> *&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">proxyFactory.addAdvisors(advisors);</span><br><span class="line">proxyFactory.setTargetSource(targetSource);</span><br><span class="line">customizeProxyFactory(proxyFactory);</span><br><span class="line"></span><br><span class="line">proxyFactory.setFrozen(<span class="keyword">this</span>.freezeProxy);</span><br><span class="line"><span class="keyword">if</span> (advisorsPreFiltered()) &#123;</span><br><span class="line">proxyFactory.setPreFiltered(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨è¿™é‡Œè®¾ç½®äº†æœ‰å…³äºproxyFactoryçš„ç›¸å…³å±æ€§ï¼Œ å¦‚æ˜¯å¦ç»§æ‰¿æ¥å£çš„interfaceï¼Œå’Œ ProxyTargetClass ã€‚å¦‚æœæ²¡æœ‰å®ç°interfaceï¼Œåˆ™ä¼šè‡ªåŠ¨å°†ProxyTargeClassä¸ºtrueï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤ä¸ªå±æ€§æ˜¯ç›¸å¯¹çš„ã€‚</p><p>åœ¨æœ€åçš„retrunçš„ <code>getProxy()</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ <code>DefaultAopProxyFactory</code> ç±»ä¸­çš„ <code>createAopProxy</code> æ–¹æ³•å†³å®šä½¿ç”¨å“ªä¸­ä»£ç†æ–¹å¼è¿›è¡Œä»£ç†ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* ä¸‹é¢çš„ä¸‰ä¸ªæ¡ä»¶ç®€å•åˆ†æä¸€ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*   æ¡ä»¶1ï¼šconfig.isOptimize() - æ˜¯å¦éœ€è¦ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">*   æ¡ä»¶2ï¼šconfig.isProxyTargetClass() - æ£€æµ‹ proxyTargetClass çš„å€¼ï¼Œ</span></span><br><span class="line"><span class="comment">*   æ¡ä»¶3ï¼šhasNoUserSuppliedProxyInterfaces(config) - ç›®æ ‡ bean æ˜¯å¦å®ç°äº†æ¥å£</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœè®¾ç½®äº†optimize æˆ–è€… proxyTargetClass æˆ–è€…è®¾ç½®äº†è¿›è¡Œä»£ç†çš„æ¥å£</span></span><br><span class="line">Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line"><span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"TargetSource cannot determine target class: "</span> +</span><br><span class="line"><span class="string">"Either an interface or a target is required for proxy creation."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config); <span class="comment">//å¦‚æœä»£ç†çš„æ˜¯æ¥å£ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ObjenesisCglibAopProxy(config);<span class="comment">//å¦åˆ™ä½¿ç”¨CGlibä»£ç†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="comment">//å¦åˆ™éƒ½ä½¿ç”¨JDKè¿›è¡Œä»£ç†</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å‰é¢è¯´çš„å¦‚æœè‡ªå·±è®¾ç½®ç±»proxyTargetClasså±æ€§ä¸ºtrueï¼Œå°±ä¸ä¼šåˆ¤æ–­æ˜¯ç»§æ‰¿äº†interfaceã€‚å¦‚æœæ²¡æœ‰å•ç‹¬è®¾ç½®ï¼Œåˆ™ä¼šå…ˆåˆ¤æ–­æ˜¯å¦ç»§æ‰¿äº†æ¥å£ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šè‡ªåŠ¨è®¾ç½®proxyTargetClasså±æ€§ä¸ºtrueã€‚</p><p><em>æ‰€ä»¥å¾—å‡ºç»“è®ºï¼š</em></p><ol><li><strong>å¦‚æœè®¾ç½®äº†proxyTargetClassä¸ºtrueï¼Œåˆ™ä½¿ç”¨CGLIBä»£ç†ã€‚</strong></li><li><strong>å¦‚æœæ²¡æœ‰è®¾ç½®proxyTargetClassï¼Œå¦‚æœæ˜¯æ¥å£ï¼Œåˆ™ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚å¦‚æœæ²¡æœ‰å®ç°æ¥å£ï¼Œåˆ™è¿˜æ˜¯ä¼šä½¿ç”¨CGLIBè¿›è¡Œä»£ç†ã€‚</strong> </li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ&quot;&gt;&lt;a href=&quot;#SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ&quot;&gt;&lt;/a&gt;SpringAOPçš„ä½¿ç”¨å’Œæºç åˆ†æ&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springä¸­çš„è‡ªåŠ¨è£…é…</title>
    <link href="https://nanyiniu.github.io/2019/12/07/%EF%BC%88%E4%B8%89%EF%BC%89%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D/"/>
    <id>https://nanyiniu.github.io/2019/12/07/ï¼ˆä¸‰ï¼‰è‡ªåŠ¨è£…é…/</id>
    <published>2019-12-07T12:00:00.000Z</published>
    <updated>2019-12-11T12:35:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Springä¸­çš„è‡ªåŠ¨è£…é…"><a href="#Springä¸­çš„è‡ªåŠ¨è£…é…" class="headerlink" title="Springä¸­çš„è‡ªåŠ¨è£…é…"></a>Springä¸­çš„è‡ªåŠ¨è£…é…</h1><h2 id="Autowireã€-Qualifierã€-Primary"><a href="#Autowireã€-Qualifierã€-Primary" class="headerlink" title="@Autowireã€ @Qualifierã€@Primary"></a>@Autowireã€ @Qualifierã€@Primary</h2><p><code>@Autowire</code> æ³¨è§£æ ‡æ³¨åœ¨constructor, field, setter method ä¸Šï¼Œæ–¹ä¾¿åœ¨Springä¸­è¿›è¡Œä¾èµ–çš„æ³¨å…¥ï¼ˆ<code>dependency injection</code>ï¼‰ã€‚å’ŒJSR-330æ ‡å‡†javax.inject.Injectè¾¾åˆ°ä¸€æ ·çš„æ•ˆæœï¼Œä¸è¿‡autowiredæ—¶SpringæŒæœ‰çš„ã€‚</p><ul><li>é»˜è®¤ä½¿ç”¨Autowireæ˜¯æŒ‰ç…§ç±»å‹è¿›è¡Œæ³¨å…¥çš„ï¼Œä½†æ˜¯å¦‚æœåœ¨å®¹å™¨ä¸­å­˜åœ¨å¤šä¸ªç±»å‹ç›¸åŒçš„beanæ—¶ï¼Œ@Autowiredä¹Ÿä¼šæŒ‰ç…§åç§°è¿›è¡ŒåŒ¹é…ã€‚</li><li>ä½¿ç”¨<code>@Qualifier</code>æ³¨è§£ï¼Œåœ¨è·å–Beanæ—¶ï¼ŒæŒ‡å®šè¦è·å–çš„beançš„åç§°ã€‚</li><li>ä½¿ç”¨<code>@Primary</code>æ³¨è§£ï¼Œåœ¨å£°æ˜Beanæ—¶ï¼ŒæŒ‡å®šå¦‚æœæ³¨å…¥ï¼Œåˆ™é¦–é€‰çš„beanã€‚</li></ul><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> String firstName;</span><br><span class="line"><span class="keyword">private</span> String lastName;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.firstName = <span class="string">"w"</span>;</span><br><span class="line"><span class="keyword">this</span>.lastName = <span class="string">"y"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"abc"</span>)</span><br><span class="line"><span class="keyword">private</span> Pet pet;</span><br><span class="line"><span class="comment">// çœç•¥getter setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…åœ¨å£°æ˜Beanæ—¶ï¼Œä½¿ç”¨Primaryè¿›è¡ŒæŒ‡å®šã€‚</span></span><br><span class="line"><span class="meta">@Bean</span>(<span class="string">"dotdot"</span>)</span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Pet <span class="title">pet2</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">"dotdot"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨åŒæ—¶æŒ‡å®šQualifierå’ŒPrimaryæ—¶ï¼Œä¼šä»¥<strong>Qualifier</strong>ä¸ºä¸»ã€‚</p></blockquote><h2 id="Injectã€-Named"><a href="#Injectã€-Named" class="headerlink" title="@Injectã€@Named"></a>@Injectã€@Named</h2><p>@Injectã€@Named éƒ½æ˜¯Javaxè§„èŒƒçš„æ³¨è§£ï¼Œå¹¶ä¸æ˜¯Springçš„æ³¨è§£ã€‚</p><p>ä½¿ç”¨ Inject æ³¨è§£åŒæ ·èƒ½å¤Ÿæ ‡æ³¨åœ¨constructor, field, setter method ä¸Šã€‚åŸºæœ¬èƒ½å¤Ÿä»£æ›¿ Autowired æ³¨è§£ï¼Œå¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ Named æ³¨è§£ï¼ŒæŒ‡å®šåç§°è¿›è¡Œå®ä¾‹çš„æ³¨å…¥ï¼Œå¯ä»¥ä»£æ›¿ Qualifier æ³¨è§£ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> String firstName;</span><br><span class="line"><span class="keyword">private</span> String lastName;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.firstName = <span class="string">"w"</span>;</span><br><span class="line"><span class="keyword">this</span>.lastName = <span class="string">"y"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@Named</span>(<span class="string">"abc"</span>)</span><br><span class="line"><span class="keyword">private</span> Pet pet;</span><br><span class="line"><span class="comment">// çœç•¥getter setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><blockquote><p>åŒºåˆ«ç‚¹åœ¨äº Autowired æ³¨è§£æ”¯æŒ required() å±æ€§ã€‚è€Œ Inject æ³¨è§£å¹¶ä¸æ”¯æŒã€‚å¯ä»¥ä½¿ç”¨java.util.Optionalæˆ–è€…Spring Framework 5.0 åæä¾›çš„ @Nullable æ³¨è§£ï¼Œæ ‡å¿—åœ¨æ„é€ æ–¹æ³•ä¸Šã€‚</p></blockquote><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMovieLister</span> </span>&#123;</span><br><span class="line"><span class="meta">@Autowired</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMovieFinder</span><span class="params">(@Nullable MovieFinder movieFinder)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Springä¸­çš„è‡ªåŠ¨è£…é…&quot;&gt;&lt;a href=&quot;#Springä¸­çš„è‡ªåŠ¨è£…é…&quot; class=&quot;headerlink&quot; title=&quot;Springä¸­çš„è‡ªåŠ¨è£…é…&quot;&gt;&lt;/a&gt;Springä¸­çš„è‡ªåŠ¨è£…é…&lt;/h1&gt;&lt;h2 id=&quot;Autowireã€-Qualifierã€-Prim
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„å¯åŠ¨å’Œæ³¨å†Œ</title>
    <link href="https://nanyiniu.github.io/2019/12/05/Spring%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://nanyiniu.github.io/2019/12/05/Springä»é›¶å¼€å§‹ä¹‹æºç åˆ†æï¼ˆä¸€ï¼‰/</id>
    <published>2019-12-05T15:00:00.000Z</published>
    <updated>2020-01-18T01:24:35.577Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯åŠ¨Springåº”ç”¨"><a href="#å¯åŠ¨Springåº”ç”¨" class="headerlink" title="å¯åŠ¨Springåº”ç”¨"></a>å¯åŠ¨Springåº”ç”¨</h1><p>åªéœ€ç®€å•çš„å‡ è¡Œä»£ç ä¾¿å¯å£°æ˜ã€åˆ›å»ºä¸€ä¸ªSpringåº”ç”¨å®¹å™¨ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(BasicConfig.class);</span><br><span class="line"><span class="comment">// å‰ææ˜¯éœ€è¦ä¼ å…¥ç»™å®šçš„classé…ç½®ç±»</span></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">// ä½¿ç”¨Configuration è¡¨æ˜æ˜¯ä¸ªé…ç½®ç±»</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span><span class="comment">// å¼€å§‹AOPæ”¯æŒ</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.nanyin"</span>)<span class="comment">//æ‰«æåŒ…</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicConfig</span> </span>&#123;</span><br><span class="line"><span class="meta">@Bean</span>(<span class="string">"person"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="string">"1"</span>,<span class="string">"2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h1 id="åˆ›å»ºå®¹å™¨"><a href="#åˆ›å»ºå®¹å™¨" class="headerlink" title="åˆ›å»ºå®¹å™¨"></a>åˆ›å»ºå®¹å™¨</h1><p>åœ¨è¿›å…¥åˆ° <code>new AnnotationConfigApplicationContext()</code> æ–¹æ³•åï¼Œè¿›è¡Œå¯¹å®¹å™¨çš„å£°æ˜å’Œåˆ›å»ºã€‚å…¶ä¸­ä¼šå…ˆå¯¹ç»™å®šçš„é…ç½®æ–‡ä»¶ç±»è¿›è¡Œæ ¡éªŒå’Œæ³¨å†Œã€‚è°ƒç”¨è¿‡ç¨‹è‰å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ˆä»…å‚è€ƒï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8.png" alt="åˆ›å»ºå®¹å™¨.png"></p><p>å¯ä»¥çœ‹åˆ°åŸºæœ¬çš„è°ƒç”¨é¡ºåºï¼Œä¸‹é¢æ ¹æ®å›¾ä¸­æ‰€ç¤ºï¼Œé’ˆå¯¹è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œæºç çš„åˆ†æã€‚</p><h2 id="åˆ›å»º-AnnotationConfigApplicationContext"><a href="#åˆ›å»º-AnnotationConfigApplicationContext" class="headerlink" title="åˆ›å»º AnnotationConfigApplicationContext"></a>åˆ›å»º AnnotationConfigApplicationContext</h2><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20191123153835.png" alt="20191123153835.png"></p><p>å› ä¸ºåœ¨ä½¿ç”¨ new AnnotationConfigApplicationContext() æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„åŒæ—¶ä¼šå…ˆå»è°ƒç”¨çˆ¶ç±»çš„ç©ºå‚æ•°çš„æ„é€ æ–¹æ³•ã€‚æ‰€ä»¥æ ¹æ®å›¾ä¸­çš„å…³ç³»ï¼Œéœ€è¦å…ˆçœ‹çˆ¶ç±»ä¸­é€šè¿‡è¿™äº›æ„é€ æ–¹æ³•åšäº†ä»€ä¹ˆï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.resourcePatternResolver = getResourcePatternResolver();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> ResourcePatternResolver <span class="title">getResourcePatternResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> PathMatchingResourcePatternResolver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultResourceLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.classLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡ä¸Šè¿°ä»£ç å¯ä»¥å‘ç°è°ƒç”¨ <code>new AnnotationConfigApplicationContext()</code> æ—¶ä¼šå‘ç”Ÿï¼š</p><ol><li>è®¾ç½® <code>beanFactory</code> ä¸º <code>DefaultListableBeanFactory</code> ç±»å‹</li><li>è®¾ç½® <code>resourcePatternResolver</code> ä¸º <code>PathMatchingResourcePatternResolver</code> ç±»å‹</li><li>è®¾ç½® <code>classLoader</code> ä¸ºé»˜è®¤çš„çº¿ç¨‹ç¯å¢ƒçš„ <code>classLoader</code></li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    register(componentClasses); <span class="comment">//æ³¨å†Œç»™å®šçš„é…ç½®ç±»Bean</span></span><br><span class="line">    refresh(); <span class="comment">//åˆ·æ–°æ–¹æ³•</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// thisè°ƒç”¨ç©ºçš„æ„é€ å‡½æ•°ï¼Œå…¶ä¸­åˆ¶å®šäº† AnnotatedBeanDefinitionReader å’Œ ClassPathBeanDefinitionScanner</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>.scanner = <span class="keyword">new</span> ClassPathBeanDefinitionScanner(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨å‰ä¸€èŠ‚ä¸­ä½¿ç”¨äº† <code>new AnnotationConfigApplicationContext(BasicConfig.class)</code> æ¥åˆ›å»ºäº†ä¸€ä¸ª <code>AnnotationConfigApplicationContext</code> ã€‚è¿›å…¥åˆ°æºç ä¸­å¯ä»¥å‘ç°ä»–ä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ª <code>reader</code> å’Œä¸€ä¸ª <code>sacnner</code>ã€‚ åˆ†åˆ«çš„ä½œç”¨ä¸º ï¼š</p><ol><li>AnnotatedBeanDefinitionReader ç”¨äºä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†ŒBeanç±»,è¿™äº›Beanä¸»è¦æŒ‡çš„æ—¶ä¸€äº›PostProcessor</li><li>ClassPathBeanDefinitionScanner ä¸€ä¸ªå¯åœ¨ç±»è·¯å¾„ä¸Šæœç´¢å€™é€‰beançš„beanå®šä¹‰æ‰«æå™¨ã€‚</li></ol><h3 id="AnnotatedBeanDefinitionReader"><a href="#AnnotatedBeanDefinitionReader" class="headerlink" title="AnnotatedBeanDefinitionReader"></a>AnnotatedBeanDefinitionReader</h3><p>ç”¨äºä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†ŒBeanç±»,è¿™äº›Beanä¸»è¦æŒ‡çš„æ—¶ä¸€äº›PostProcessor.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry, Environment environment)</span> </span>&#123;</span><br><span class="line">Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null"</span>);</span><br><span class="line">Assert.notNull(environment, <span class="string">"Environment must not be null"</span>);</span><br><span class="line"><span class="keyword">this</span>.registry = registry;</span><br><span class="line"><span class="comment">//ConditionEvaluator  ç”¨äºå¯¹ @Condition æ³¨è§£çš„è¯„ä¼°</span></span><br><span class="line"><span class="keyword">this</span>.conditionEvaluator = <span class="keyword">new</span> ConditionEvaluator(registry, environment, <span class="keyword">null</span>);</span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="keyword">this</span>.registry);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†ç›¸å…³æ³¨è§£çš„åç½®å¤„ç†å™¨å¦‚ ConfigurationClassPostProcessor ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">BeanDefinitionRegistry registry, @Nullable Object source)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è·å– BeanFactory,å…¶å®è¿™é‡Œè¿”å›äº†ä¸€ä¸ªthis.beanFactory,ä¹Ÿå°±æ˜¯ DefaultListableBeanFactory</span></span><br><span class="line">DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</span><br><span class="line"><span class="keyword">if</span> (beanFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(beanFactory.getDependencyComparator() <span class="keyword">instanceof</span> AnnotationAwareOrderComparator)) &#123;</span><br><span class="line">beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!(beanFactory.getAutowireCandidateResolver() <span class="keyword">instanceof</span> ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line">beanFactory.setAutowireCandidateResolver(<span class="keyword">new</span> ContextAnnotationAutowireCandidateResolver());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"><span class="comment">// æ³¨å†ŒConfigurationClassPostProcessor ä¹Ÿå°±æ˜¯å¯¹åº”çš„@Configurationæ³¨è§£postprocessor</span></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">def.setSource(source);</span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ³¨å†ŒAutowiredAnnotationBeanPostProcessor,å¯¹åº”çš„æ—¶@Autowiredå¯¹åº”çš„postProcessor</span></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">def.setSource(source);</span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  ........</span></span><br><span class="line"><span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="ClassPathBeanDefinitionScanner"><a href="#ClassPathBeanDefinitionScanner" class="headerlink" title="ClassPathBeanDefinitionScanner"></a>ClassPathBeanDefinitionScanner</h3><p>ä¸€ä¸ªå¯åœ¨ç±»è·¯å¾„ä¸Šæœç´¢å€™é€‰beançš„beanå®šä¹‰æ‰«æå™¨ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathBeanDefinitionScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters,</span></span></span><br><span class="line"><span class="function"><span class="params">Environment environment, @Nullable ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null"</span>);</span><br><span class="line"><span class="keyword">this</span>.registry = registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (useDefaultFilters) &#123;</span><br><span class="line">registerDefaultFilters();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„environmentæ—¶åœ¨çˆ¶ç±»ä¸­çš„æ„é€ å‡½æ•°ä¸­ç»™å‡ºçš„ new StandardEnvironment()</span></span><br><span class="line">setEnvironment(environment);</span><br><span class="line">setResourceLoader(resourceLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸Šé¢çš„é€»è¾‘å¾ˆæ¸…æ™°ï¼š</p><ol><li>éœ€è¦æ³¨å†Œä¸€äº›é»˜è®¤çš„è¿‡æ»¤å™¨ï¼ˆFiltersï¼‰</li><li>è®¾ç½®ç¯å¢ƒå˜é‡environment</li><li>è®¾ç½®resourceLoader</li></ol><p>åœ¨å®šä¹‰å®Œæˆåè°ƒç”¨registeræ–¹æ³•è¿›è¡Œå¯¹æŒ‡å®šçš„é…ç½®æ–‡ä»¶è¿›è¡Œæ³¨å†Œã€‚</p><h2 id="register-æ³¨å†Œç»™å®šé…ç½®ç±»"><a href="#register-æ³¨å†Œç»™å®šé…ç½®ç±»" class="headerlink" title="register æ³¨å†Œç»™å®šé…ç½®ç±»"></a>register æ³¨å†Œç»™å®šé…ç½®ç±»</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line">Assert.notEmpty(componentClasses, <span class="string">"At least one component class must be specified"</span>);</span><br><span class="line"><span class="keyword">this</span>.reader.register(componentClasses); <span class="comment">//è°ƒç”¨ AnnotatedBeanDefinitionReader çš„register æ–¹æ³•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;?&gt; componentClass : componentClasses) &#123; </span><br><span class="line"><span class="comment">// å¯¹æ¯ä¸ªç»™å®šçš„classè¿›è¡Œ registerBean</span></span><br><span class="line">registerBean(componentClass);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="registerBean-Class-lt-gt-beanClass"><a href="#registerBean-Class-lt-gt-beanClass" class="headerlink" title="registerBean(Class&lt;?&gt; beanClass)"></a>registerBean(Class&lt;?&gt; beanClass)</h2><p>åœ¨ä¸Šä¸€æ­¥çš„ registerBean ä¸­è°ƒç”¨äº†å·²ç»åˆ›å»ºå¥½çš„ <code>AnnotatedBeanDefinitionReader</code> çš„ <code>registerBean</code>æ–¹æ³•ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;?&gt; componentClass : componentClasses) &#123; </span><br><span class="line"><span class="comment">// å¯¹æ¯ä¸ªç»™å®šçš„classè¿›è¡Œ registerBean</span></span><br><span class="line">registerBean(componentClass);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBean</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">doRegisterBean(beanClass, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œå¯¹æ¯ä¸€ä¸ª class å¾ªç¯è°ƒç”¨ <code>doRegisterBean</code> æ–¹æ³•è¿›è¡Œ å¯¹ <code>BeanClass</code> çš„æ³¨å†Œæ“ä½œã€‚</p><h2 id="doRegisterBean"><a href="#doRegisterBean" class="headerlink" title="doRegisterBean"></a>doRegisterBean</h2><p>è¿™ä¸€æ­¥æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€æ­¥ï¼š</p><ol><li>å£°æ˜ <code>BeanDefinition</code> ä¸º <code>AnnotatedGenericBeanDefinition</code> ã€‚</li><li>é€šè¿‡ <code>conditionEvaluator.shouldSkip()</code> æ–¹æ³•é€šè¿‡å¯¹ @Conditional æ³¨è§£æ¥åˆ¤æ–­æ˜¯å¦è·³è¿‡æ³¨å†Œ</li><li>é€šè¿‡ <code>scopeMetadataResolver.resolveScopeMetadata</code> æ¥è·å–ä½œç”¨åŸŸï¼Œç„¶åå†æ”¾åˆ° BeanDefinition ä¸­ã€‚</li><li>é€šè¿‡ <code>beanNameGenerator.generateBeanName</code> æ¥è®¾ç½®Beanåœ¨å®¹å™¨ä¸­çš„åç§°ã€‚</li><li>é€šè¿‡ <code>processCommonDefinitionAnnotations</code> è®¾ç½®Beançš„åŸºæœ¬å±æ€§</li><li>æœ€åé€šè¿‡ è°ƒç”¨<code>registerBeanDefinition</code> å¯¹åŒ…è£…å¥½çš„ BeanDefinitionHolder è¿›è¡Œæœ€åçš„æ³¨å†Œæ“ä½œã€‚</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">doRegisterBean</span><span class="params">(Class&lt;T&gt; beanClass, @Nullable String name,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Class&lt;? extends Annotation&gt;[] qualifiers, @Nullable Supplier&lt;T&gt; supplier,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable BeanDefinitionCustomizer[] customizers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotatedGenericBeanDefinition abd = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(beanClass); </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</span><br><span class="line"><span class="comment">// é€šè¿‡åˆ¤æ–­Conditionalæ³¨è§£ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è·³è¿‡</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¤„ç†åˆ›å»ºçš„å›è°ƒ</span></span><br><span class="line">abd.setInstanceSupplier(supplier);</span><br><span class="line">ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);</span><br><span class="line"><span class="comment">// å¤„ç†ä½œç”¨åŸŸ æ”¾åˆ°scopeMetadataé‡Œé¢</span></span><br><span class="line">abd.setScope(scopeMetadata.getScopeName());<span class="comment">//å†æ”¾åˆ° BeanDefinition é‡Œ</span></span><br><span class="line">String beanName = (name != <span class="keyword">null</span> ? name : <span class="keyword">this</span>.beanNameGenerator.generateBeanName(abd, <span class="keyword">this</span>.registry)); <span class="comment">//è®¾ç½®BeanName</span></span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.processCommonDefinitionAnnotations(abd); </span><br><span class="line"><span class="comment">// è®¾ç½®ä¸€äº›åŸºæœ¬å±æ€§ å¦‚ Lazyï¼ŒPrimary ã€‚ã€‚ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (qualifiers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;? extends Annotation&gt; qualifier : qualifiers) &#123;</span><br><span class="line"><span class="keyword">if</span> (Primary.class == qualifier) &#123;</span><br><span class="line">abd.setPrimary(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (Lazy.class == qualifier) &#123;</span><br><span class="line">abd.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">abd.addQualifier(<span class="keyword">new</span> AutowireCandidateQualifier(qualifier));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (customizers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (BeanDefinitionCustomizer customizer : customizers) &#123;</span><br><span class="line">customizer.customize(abd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(abd, beanName); <span class="comment">// åˆ›å»ºä¸€ä¸ªdefinitionHolderï¼Œä½œç”¨æ˜¯ å…·æœ‰åç§°å’Œåˆ«åçš„BeanDefinitionçš„æŒæœ‰äºº</span></span><br><span class="line">definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry); <span class="comment">//è®¾ç½®ä½œç”¨åŸŸ</span></span><br><span class="line">BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="registerBeanDefinition"><a href="#registerBeanDefinition" class="headerlink" title="registerBeanDefinition"></a>registerBeanDefinition</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">String beanName = definitionHolder.getBeanName();</span><br><span class="line">registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//  æ³¨å†Œåˆ«å</span></span><br><span class="line">String[] aliases = definitionHolder.getAliases();</span><br><span class="line"><span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (String alias : aliases) &#123;</span><br><span class="line">registry.registerAlias(beanName, alias);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¹‹åä¼šè°ƒç”¨ <code>DefaultListableBeanFactory</code> ä¸­çš„ <code>registBeanDefinition</code> æ–¹æ³•å¯¹Beanè¿›è¡Œæ³¨å†Œã€‚å®é™…çš„æ³¨å†Œè¿‡ç¨‹å°±æ˜¯å°†Beançš„åç§°ä½œä¸ºkeyï¼ŒBeançš„BeanDefinitionä½œä¸ºvalueå­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„beanDefinitionMapä¸­ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line"><span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition); <span class="comment">//å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªConcurrentHashMap å­˜å‚¨ beanDefinition ä½¿ç”¨BeanNameä½œä¸ºKey</span></span><br><span class="line">List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>); <span class="comment">// æ·»åŠ åˆ°updatedDefinitionsé‡Œé¢</span></span><br><span class="line">updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">updatedDefinitions.add(beanName);</span><br><span class="line"><span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">removeManualSingletonName(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è‡³æ­¤ï¼ŒSpringå®¹å™¨çš„åˆ›å»ºï¼Œå’Œå¯¹é…ç½®æ–‡ä»¶çš„æ³¨å†Œå°±å®Œæˆäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¯åŠ¨Springåº”ç”¨&quot;&gt;&lt;a href=&quot;#å¯åŠ¨Springåº”ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ¨Springåº”ç”¨&quot;&gt;&lt;/a&gt;å¯åŠ¨Springåº”ç”¨&lt;/h1&gt;&lt;p&gt;åªéœ€ç®€å•çš„å‡ è¡Œä»£ç ä¾¿å¯å£°æ˜ã€åˆ›å»ºä¸€ä¸ªSpringåº”ç”¨å®¹å™¨ã€‚&lt;/p&gt;
&lt;div
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Beançš„ç”Ÿå‘½å‘¨æœŸ</title>
    <link href="https://nanyiniu.github.io/2019/12/05/%EF%BC%88%E4%BA%8C%EF%BC%89Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    <id>https://nanyiniu.github.io/2019/12/05/ï¼ˆäºŒï¼‰Beançš„ç”Ÿå‘½å‘¨æœŸ/</id>
    <published>2019-12-05T12:00:00.000Z</published>
    <updated>2019-12-11T12:34:57.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Beançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Beançš„ç”Ÿå‘½å‘¨æœŸ"></a>Beançš„ç”Ÿå‘½å‘¨æœŸ</h1><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20191020160536.png" alt></p><h2 id="Beançš„åˆå§‹åŒ–å’Œé”€æ¯"><a href="#Beançš„åˆå§‹åŒ–å’Œé”€æ¯" class="headerlink" title="Beançš„åˆå§‹åŒ–å’Œé”€æ¯"></a>Beançš„åˆå§‹åŒ–å’Œé”€æ¯</h2><h3 id="ä¸€ã€ä½¿ç”¨-Beançš„åˆå§‹åŒ–å’Œé”€æ¯å±æ€§"><a href="#ä¸€ã€ä½¿ç”¨-Beançš„åˆå§‹åŒ–å’Œé”€æ¯å±æ€§" class="headerlink" title="ä¸€ã€ä½¿ç”¨@Beançš„åˆå§‹åŒ–å’Œé”€æ¯å±æ€§"></a>ä¸€ã€ä½¿ç”¨@Beançš„åˆå§‹åŒ–å’Œé”€æ¯å±æ€§</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨dogå®ä¾‹ä¸­æŒ‡å®šinitå’Œdestroyæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance dog execute init method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance dog execute destroy method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜beançš„æ—¶å€™æŒ‡å®š initMethod = "init",destroyMethod = "destroy"</span></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>,destroyMethod = <span class="string">"destroy"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"begin create dog"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LifeCycleTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(LifeCycleConfig.class);</span><br><span class="line">    System.out.println(<span class="string">"instance has created !!!"</span>);</span><br><span class="line"><span class="comment">//        Dog dog = (Dog) applicationContext.getBean("dog");</span></span><br><span class="line">    ((AnnotationConfigApplicationContext) applicationContext).close();</span><br><span class="line">    System.out.println(<span class="string">"context has closed !!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•ç»“æœ:</span></span><br><span class="line"><span class="comment">// begin create dog</span></span><br><span class="line"><span class="comment">// instance dog execute init method.....</span></span><br><span class="line"><span class="comment">// instance has created !!!</span></span><br><span class="line"><span class="comment">// instance dog execute destroy method.....</span></span><br><span class="line"><span class="comment">// context has closed !!!</span></span><br></pre></td></tr></table></figure></div><p>ä»æµ‹è¯•ç»“æœæ¥çœ‹å½“åˆ›å»ºå¯¹è±¡æ—¶,é€šè¿‡ <code>initMethod</code>,<code>destroyMethod</code>æŒ‡å®šåˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•æ—¶å¯è¡Œçš„.initæ–¹æ³•åœ¨å¯¹è±¡åˆ›å»ºåæ‰§è¡Œ.destroyåœ¨å®¹å™¨é”€æ¯å‰æ‰§è¡Œ.</p><h3 id="äºŒã€ä½¿ç”¨-InitializingBean-å’Œ-DisposableBean-æ¥å£æŒ‡å®š"><a href="#äºŒã€ä½¿ç”¨-InitializingBean-å’Œ-DisposableBean-æ¥å£æŒ‡å®š" class="headerlink" title="äºŒã€ä½¿ç”¨ InitializingBean å’Œ DisposableBean æ¥å£æŒ‡å®š"></a>äºŒã€ä½¿ç”¨ InitializingBean å’Œ DisposableBean æ¥å£æŒ‡å®š</h3><p>æ–¹æ³•åŒä¸Š,ä¸è¿‡éœ€è¦å¯¹è±¡ç±»å®ç°è¿™ä¸¤ä¸ªæ¥å£</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  æ¥å£ä¸­çš„destroy æ–¹æ³•,æ‰§è¡Œé”€æ¯bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance cat execute destroy method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// æ¥å£ä¸­çš„afterPropertiesSetæ–¹æ³•,ç”¨æ¥åˆ›å»ºbeanåçš„åˆå§‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance cat execute init method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸éœ€è¦åœ¨beanæ³¨è§£ä¸­æŒ‡å®šç›¸å…³æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cat <span class="title">cat</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"begin create cat"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Cat();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨åŒæ ·çš„æµ‹è¯•ç¨‹åºæµ‹è¯•å¾—åˆ°çš„ç»“æœå¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">// begin create cat</span></span><br><span class="line"><span class="comment">// instance dog execute init method.....</span></span><br><span class="line"><span class="comment">// instance has created !!!</span></span><br><span class="line"><span class="comment">// instance dog execute destroy method.....</span></span><br><span class="line"><span class="comment">// context has closed !!!</span></span><br></pre></td></tr></table></figure></div><h3 id="ä¸‰ã€ä½¿ç”¨JSRæ ‡å‡†çš„æ³¨è§£-PostConstruce-å’Œ-PreDestroy"><a href="#ä¸‰ã€ä½¿ç”¨JSRæ ‡å‡†çš„æ³¨è§£-PostConstruce-å’Œ-PreDestroy" class="headerlink" title="ä¸‰ã€ä½¿ç”¨JSRæ ‡å‡†çš„æ³¨è§£ @PostConstruce å’Œ @PreDestroy"></a>ä¸‰ã€ä½¿ç”¨JSRæ ‡å‡†çš„æ³¨è§£ @PostConstruce å’Œ @PreDestroy</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bug</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance Bug execute init method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"instance Bug execute destroy method....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="å››ã€BeanPostProcessorè‡ªå®šä¹‰åˆå§‹åŒ–å‰åæ–¹æ³•"><a href="#å››ã€BeanPostProcessorè‡ªå®šä¹‰åˆå§‹åŒ–å‰åæ–¹æ³•" class="headerlink" title="å››ã€BeanPostProcessorè‡ªå®šä¹‰åˆå§‹åŒ–å‰åæ–¹æ³•"></a>å››ã€BeanPostProcessorè‡ªå®šä¹‰åˆå§‹åŒ–å‰åæ–¹æ³•</h3><p>å…ˆè‡ªå®šä¹‰ä¸€ä¸ª MyBeanPostProcessor ï¼Œå¹¶å°†å®ƒæ”¾åˆ°å®¹å™¨ä¸­ï¼Œåœ¨å¯åŠ¨åï¼Œæ¯æ¬¡ç”Ÿæˆbeanæ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œä¸‹é¢çš„ postProcessBeforeInitialization å’Œ postProcessAfterInitializationã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"><span class="comment">// æ ¹æ®BeanNameå’Œbeanå¯ä»¥è·å–beançš„ç±»ä¿¡æ¯æ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œç­›é€‰ï¼Œåœ¨åˆå§‹åŒ–å‰è¿›è¡Œç›¸å…³æ“ä½œ</span></span><br><span class="line">System.out.println(beanName);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">System.out.println(beanName);</span><br><span class="line"><span class="comment">// åŒç†åˆå§‹åŒ–å</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Beançš„ç”Ÿå‘½å‘¨æœŸ&quot;&gt;&lt;a href=&quot;#Beançš„ç”Ÿå‘½å‘¨æœŸ&quot; class=&quot;headerlink&quot; title=&quot;Beançš„ç”Ÿå‘½å‘¨æœŸ&quot;&gt;&lt;/a&gt;Beançš„ç”Ÿå‘½å‘¨æœŸ&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.co
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•</title>
    <link href="https://nanyiniu.github.io/2019/12/01/%EF%BC%88%E4%B8%80%EF%BC%89%20%E5%B0%86%E7%B1%BB%E5%8A%A0%E5%85%A5%E5%88%B0%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E6%96%B9%E5%BC%8F/"/>
    <id>https://nanyiniu.github.io/2019/12/01/ï¼ˆä¸€ï¼‰ å°†ç±»åŠ å…¥åˆ°å®¹å™¨ä¸­çš„æ–¹å¼/</id>
    <published>2019-12-01T12:00:00.000Z</published>
    <updated>2019-12-11T12:34:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•"><a href="#å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•" class="headerlink" title="å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•"></a>å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•</h1><p>åœ¨Springä¸­,æœ‰å››ç§æ–¹æ³•å¯ä»¥å°†ç°æœ‰çš„ç±»çš„å®ä¾‹æ·»åŠ åˆ°å®¹å™¨ä¸­.åœ¨äº†è§£ä¹‹å‰éœ€è¦äº†è§£ä»¥ä¸‹ä¸¤ç§ä½œç”¨åŸŸ.</p><p>Springåœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™å…±æœ‰å››ç§ä½œç”¨åŸŸå¯é€‰.åˆ†åˆ«ä¸ºå¸¸ç”¨çš„<code>singleton</code>ã€<code>prototype</code>.å’Œåœ¨webåº”ç”¨å¼€å‘ä¸­çš„<code>request</code>å’Œ<code>session</code>.</p><p>ä¸‹é¢é’ˆå¯¹å¸¸ç”¨çš„<code>singleton</code>ã€<code>prototype</code>æ¥äº†è§£beançš„ä½œç”¨åŸŸ(SCOPE)</p><h2 id="Springçš„ä½œç”¨åŸŸ"><a href="#Springçš„ä½œç”¨åŸŸ" class="headerlink" title="Springçš„ä½œç”¨åŸŸ"></a>Springçš„ä½œç”¨åŸŸ</h2><h3 id="1-Singleton-å•ä¾‹"><a href="#1-Singleton-å•ä¾‹" class="headerlink" title="1. Singleton å•ä¾‹"></a>1. Singleton å•ä¾‹</h3><p>Singletonä¸ºSpringå¯¹è±¡çš„é»˜è®¤çš„åˆ›å»ºæ–¹å¼,ä¹Ÿå°±æ˜¯è¯´Springåœ¨åˆ›å»ºBeançš„æ—¶å€™é»˜è®¤æ˜¯å•ä¾‹çš„.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/å‡†å¤‡å¯¹è±¡Person</span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ›å»ºBeanå®ä¾‹ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="string">"li"</span>, <span class="string">"lei"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æµ‹è¯•</span></span><br><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(TestConfig.class);</span><br><span class="line"><span class="comment">// è·å–ä¸¤æ¬¡å¯¹è±¡,å¹¶ä¸”åœ¨è¿™æ˜¯å°±ä¼šæ‰“å° ã€Œåˆ›å»ºBeanå®ä¾‹ã€</span></span><br><span class="line">Person person = (Person) applicationContext.getBean(<span class="string">"person"</span>);</span><br><span class="line">Person person_copy = (Person) applicationContext.getBean(<span class="string">"person"</span>);</span><br><span class="line"><span class="comment">// è¿™é‡Œè¿”å›true,è¯´æ˜ä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸åŒçš„å¯¹è±¡</span></span><br><span class="line">System.out.println(person == person_copy);</span><br></pre></td></tr></table></figure></div><p>è¿è¡Œç»“æœï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åˆ›å»ºBeanå®ä¾‹ï¼</span><br><span class="line">å®¹å™¨åˆ›å»ºæˆåŠŸã€‚ã€‚æ¥ä¸‹æ¥åˆ›å»ºå¯¹è±¡ï¼</span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure></div><blockquote><p>å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ—¶,åœ¨Springåˆ›å»ºSingletonå¯¹è±¡çš„æ—¶å€™,æ˜¯åœ¨å®¹å™¨åˆ›å»ºåç«‹å³åˆ›å»ºçš„.</p></blockquote><h3 id="2-prototype-åŸå‹"><a href="#2-prototype-åŸå‹" class="headerlink" title="2. prototype åŸå‹"></a>2. prototype åŸå‹</h3><p>åŒæ ·ä¸Šè¿°çš„ä»£ç ,åœ¨@Beanä¸‹é¢å¢åŠ <code>@Scope(&quot;prototype&quot;)</code>å,ä¼šæ³¨æ„åˆ°ç»“æœçš„ä¸åŒ.è¿è¡Œæ—¶åœ¨è¿›è¡Œç»“æœçš„è§‚å¯Ÿ:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å®¹å™¨åˆ›å»ºæˆåŠŸã€‚ã€‚æ¥ä¸‹æ¥åˆ›å»ºå¯¹è±¡ï¼</span><br><span class="line">åˆ›å»ºBeanå®ä¾‹ï¼</span><br><span class="line">åˆ›å»ºBeanå®ä¾‹ï¼</span><br><span class="line"><span class="keyword">false</span></span><br></pre></td></tr></table></figure></div><table><thead><tr><th>ç±»å‹</th><th>æ˜¯å¦å•ä¾‹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ˜¯å¦é”€æ¯</th></tr></thead><tbody><tr><td>Singleton</td><td>å•ä¾‹</td><td>é»˜è®¤åœ¨å®¹å™¨å¯åŠ¨æ—¶åˆ›å»º</td><td>å®¹å™¨å…³é—­åé”€æ¯</td></tr><tr><td>prototype</td><td>å¤šå®ä¾‹</td><td>åœ¨è·å–å¯¹è±¡æ—¶åˆ›å»º</td><td>ä¸ä¼šè°ƒç”¨é”€æ¯æ–¹æ³•</td></tr></tbody></table><h2 id="ä¸€ã€Configurationæ³¨è§£å’ŒBeanæ³¨è§£"><a href="#ä¸€ã€Configurationæ³¨è§£å’ŒBeanæ³¨è§£" class="headerlink" title="ä¸€ã€Configurationæ³¨è§£å’ŒBeanæ³¨è§£"></a>ä¸€ã€Configurationæ³¨è§£å’ŒBeanæ³¨è§£</h2><p>ä»£æ›¿äº†åŸæ¥çš„Springé…ç½®æ–‡ä»¶,åœ¨ç±»ä¸Šæ ‡æ³¨<code>Configuration</code>æ³¨è§£è¯´æ˜è¿™ä¸ªç±»æ˜¯Springçš„é…ç½®ç±».</p><p>åœ¨æ–¹æ³•ä¸Šä½¿ç”¨<code>Bean</code>æ³¨è§£,åˆ™ä¼šå°†è¿”å›å€¼ä½œä¸ºå®ä¾‹æ·»åŠ åˆ°å®¹å™¨ä¸­,æ–¹æ³•åç§°ä½œä¸ºBeançš„ID.</p><p>ä¸€èˆ¬ä½¿ç”¨è¿™ç§æ–¹æ³•å°†ç¬¬ä¸‰æ–¹çš„åŒ…ä¸­çš„ç±»åŠ å…¥åˆ°å®¹å™¨ä¸­,å¦‚Shiroçš„é…ç½®ç±».</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ä½¿ç”¨@Confiurationæ³¨è§£å£°æ˜é…ç½®ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.nanyin"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>) <span class="comment">//å£°æ˜å¤šå®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ›å»ºBeanå®ä¾‹ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="string">"li"</span>, <span class="string">"lei"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="äºŒã€componentScanåŒ…æ‰«ææ³¨è§£"><a href="#äºŒã€componentScanåŒ…æ‰«ææ³¨è§£" class="headerlink" title="äºŒã€componentScanåŒ…æ‰«ææ³¨è§£"></a>äºŒã€componentScanåŒ…æ‰«ææ³¨è§£</h2><p>åœ¨é¢å¯¹è‡ªå·±å†™çš„<code>@Component</code>,<code>@Service</code>,<code>@Controller</code>,<code>@Repository</code>åˆ™ä¸éœ€è¦ä½¿ç”¨ç¬¬ä¸€ä¸ªä¸­çš„ä½¿ç”¨@Beanæ³¨è§£ä¸€ä¸ªä¸€ä¸ªçš„æ·»åŠ åˆ°é…ç½®ç±»ä¸­,åªéœ€è¦é…ç½®<code>@ComponentSacn</code>å°±è¡Œäº†.å®ƒä¼šè‡ªåŠ¨æ‰«æè·¯å¾„ä¸‹çš„æ‰€æœ‰è¿™äº›æ³¨è§£çš„ç±»åŠ å…¥åˆ°å®¹å™¨ä¸­.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.nanyin"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="ä¸‰ã€importæ³¨è§£"><a href="#ä¸‰ã€importæ³¨è§£" class="headerlink" title="ä¸‰ã€importæ³¨è§£"></a>ä¸‰ã€importæ³¨è§£</h2><h3 id="1-ç›´æ¥å¯¼å…¥-Configurationé…ç½®ç±»"><a href="#1-ç›´æ¥å¯¼å…¥-Configurationé…ç½®ç±»" class="headerlink" title="1. ç›´æ¥å¯¼å…¥@Configurationé…ç½®ç±»"></a>1. ç›´æ¥å¯¼å…¥@Configurationé…ç½®ç±»</h3><p>èƒ½å¤Ÿä½¿ç”¨<code>@Import(value=xxx.class)</code> å…¶ä¸­valueæ˜¯æ•°ç»„,å¯ä»¥ä¸€æ¬¡æ€§å¯¼å…¥å¤šä¸ªé…ç½®ç±».æ‰¹é‡çš„å¯¼å…¥é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰å£°æ˜çš„bean.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°çš„å®ä½“</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="comment">// éœ€è¦å¯¼å…¥TestConfigä¸­é…ç½®çš„æ‰€æœ‰bean</span></span><br><span class="line"><span class="meta">@Import</span>(value=TestConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ›å»ºBeanå®ä¾‹ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œé…ç½®äº†ä¸€ä¸ªperson</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ›å»ºBeanå®ä¾‹ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="string">"li"</span>, <span class="string">"lei"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">importTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(ImportConfig.class);</span><br><span class="line">    String[] names = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="comment">// æ‰“å°å‡ºæ‰€æœ‰æ·»åŠ åˆ°å®¹å™¨ä¸­çš„åç§°</span></span><br><span class="line">    <span class="keyword">for</span> (String temp :</span><br><span class="line">            names) &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç»“æœ:</span><br><span class="line">importConfig</span><br><span class="line">person</span><br><span class="line">com.nanyin.config.TestConfig</span><br><span class="line">dog</span><br></pre></td></tr></table></figure></div><p>å¯¼å…¥äº†<code>TestConfig</code>é…ç½®ç±»å’Œå…¶ä¸­çš„personå®ä¾‹</p><h3 id="2-ä½¿ç”¨importSelectorè‡ªå®šä¹‰å¯¼å…¥"><a href="#2-ä½¿ç”¨importSelectorè‡ªå®šä¹‰å¯¼å…¥" class="headerlink" title="2. ä½¿ç”¨importSelectorè‡ªå®šä¹‰å¯¼å…¥"></a>2. ä½¿ç”¨importSelectorè‡ªå®šä¹‰å¯¼å…¥</h3><p>é™¤äº†ä½¿ç”¨ <code>@import</code> ç›´æ¥å¯¼å…¥æŒ‡å®šçš„ç±»å¤–,è¿˜å¯ä»¥å¯¼å…¥ ç»§æ‰¿<code>importSelector</code>æ¥å£çš„ç±»,å¹¶ä¸”åœ¨å®ç°ç±»ä¸­è¿›è¡Œè‡ªå®šä¹‰æ“ä½œ.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">      <span class="comment">// å¯ä»¥é€šè¿‡importingClassMetadataè·å–ç±»æ³¨è§£ä¸Šçš„æ‰€æœ‰ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;Dog.class.getName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="comment">// @Import å¯ä»¥å¯¼å…¥æ•°ç»„(å¤šä¸ª) class,å¦‚ä¸Šé¢æåˆ°çš„ TestConfigé…ç½®ç±»,è¿™é‡ŒæŠŠMyImportSelectorä¹Ÿæ·»åŠ è¿›å»</span></span><br><span class="line"><span class="meta">@Import</span>(value=&#123;TestConfig.class,MyImportSelector.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">importTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(ImportConfig.class);</span><br><span class="line">    String[] names = applicationContext.getBeanDefinitionNames();</span><br><span class="line">    <span class="keyword">for</span> (String temp :</span><br><span class="line">            names) &#123;</span><br><span class="line">        System.out.println(temp);</span><br><span class="line">    &#125;</span><br><span class="line">    ((AnnotationConfigApplicationContext) applicationContext).close();;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰§è¡Œæµ‹è¯•å</span></span><br><span class="line"><span class="comment">// importConfig</span></span><br><span class="line"><span class="comment">// person</span></span><br><span class="line"><span class="comment">// com.nanyin.config.TestConfig</span></span><br><span class="line"><span class="comment">// com.nanyin.entity.Dog</span></span><br></pre></td></tr></table></figure></div><h3 id="3-ä½¿ç”¨-importBeanDefinitionRegister"><a href="#3-ä½¿ç”¨-importBeanDefinitionRegister" class="headerlink" title="3. ä½¿ç”¨ importBeanDefinitionRegister"></a>3. ä½¿ç”¨ importBeanDefinitionRegister</h3><p>å¯ä»¥ä½¿ç”¨ <code>importBeanDefinitionRegister</code> è‡ªå®šä¹‰æ³¨å†Œbean,å› ä¸ºåœ¨æ¥å£ä¸­æœ‰BeanRegiestä½œä¸ºå‚æ•°,é€šè¿‡å‚æ•°è°ƒç”¨Registeç›¸å…³æ–¹æ³•.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyimportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        AnnotatedGenericBeanDefinition beanDefinition = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(Dog.class);</span><br><span class="line">        <span class="comment">// å‰é¢å­—ç¬¦ä¸²æ˜¯ID,åé¢æ˜¯BeanDefinition</span></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">"dogx"</span>,beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Import</span>(MyimportBeanDefinitionRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åˆ›å»ºBeanå®ä¾‹ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»“æœé€šè¿‡ registry æ³¨å†Œäº† dogx</span></span><br><span class="line"><span class="comment">// importConfig</span></span><br><span class="line"><span class="comment">// dog</span></span><br><span class="line"><span class="comment">// dogx</span></span><br></pre></td></tr></table></figure></div><blockquote><p>åé¢çš„ä¸¤ç§æ–¹æ³•åœ¨SpringBootæºç ä¸­ä¼šç»å¸¸çœ‹åˆ°,æ‰€ä»¥è¿˜æ˜¯æŒºé‡è¦çš„.</p></blockquote><hr><h2 id="å››ã€ä½¿ç”¨FactoryBeanæ³¨å†Œbean"><a href="#å››ã€ä½¿ç”¨FactoryBeanæ³¨å†Œbean" class="headerlink" title="å››ã€ä½¿ç”¨FactoryBeanæ³¨å†Œbean"></a>å››ã€ä½¿ç”¨FactoryBeanæ³¨å†Œbean</h2><p>ç”¨äºåˆ›å»ºå¤æ‚çš„beanæ—¶,ä¼šç”¨åˆ°FactoryBean.</p><p>å¦‚æœç»§æ‰¿ <code>FactoryBean</code> æ¥å£å®ç°,åˆ™è¿™ä¸ªå°±ä¸èƒ½å½“ä½œä¸€ä¸ªæ™®é€šçš„beanä½¿ç”¨äº†,ä»–æš´éœ²å‡ºæ¥çš„è·å–çš„å¯¹è±¡æ˜¯ <code>getObject()</code>æ–¹æ³•è·å–çš„å·¥å‚ä¸­çš„å¯¹è±¡,è€Œä¸æ˜¯ä»–è‡ªèº«.é»˜è®¤åˆ›å»ºçš„æ—¶FactoryBeançš„å¯¹è±¡å®ä¾‹ï¼Œè€Œä¸æ˜¯å·¥å‚å®ä¾‹ï¼Œå¦‚æœæƒ³è·å–å·¥å‚çš„å®ä¾‹ï¼Œåœ¨getBeançš„æ—¶å€™åœ¨å¯¹è±¡IDå‰åŠ ä¸Š<code>&amp;</code>ç¬¦å·ã€‚</p><p>å…·ä½“å®ä¾‹:</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Dog</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›çš„å®ä¾‹å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Dog.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸ºtrue,å¦‚æœæ—¶falseåˆ™ä¸ºå¤šå®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•&quot;&gt;&lt;a href=&quot;#å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•&quot;&gt;&lt;/a&gt;å°†ç±»æ·»åŠ è‡³å®¹å™¨ä¸­çš„å››ç§æ–¹æ³•&lt;/h1&gt;&lt;p&gt;åœ¨Springä¸­,æœ‰å››ç§æ–¹æ³•å¯ä»¥å°†ç°æœ‰çš„ç±»çš„å®ä¾‹æ·»åŠ 
      
    
    </summary>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/categories/Spring/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="Spring" scheme="https://nanyiniu.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„ç¼“å­˜</title>
    <link href="https://nanyiniu.github.io/2019/08/15/2019-08-15-Spring%E7%9A%84%E7%BC%93%E5%AD%98/"/>
    <id>https://nanyiniu.github.io/2019/08/15/2019-08-15-Springçš„ç¼“å­˜/</id>
    <published>2019-08-15T12:00:00.000Z</published>
    <updated>2019-08-16T01:12:11.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Springçš„ç¼“å­˜"><a href="#Springçš„ç¼“å­˜" class="headerlink" title="Springçš„ç¼“å­˜"></a>Springçš„ç¼“å­˜</h1><p>Javaåœ¨ä½¿ç”¨<code>Cache</code>çš„æ—¶å€™ï¼Œä¸ºäº†ç»Ÿä¸€ç¼“å­˜çš„ä½¿ç”¨ï¼Œ<code>J2EE</code>å‘å¸ƒäº†<code>JSR107</code>ç¼“å­˜è§„èŒƒã€‚åŒ…æ‹¬äº†ä¸»è¦çš„5ä¸ªæ ¸å¿ƒæ¥å£ï¼ŒåŒ…æ‹¬<code>cachingProvider</code>ã€<code>cacheManager</code>ç­‰ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹<code>JSR107</code>ç¼“å­˜è§„ã€‚</p><h2 id="Springçš„ç¼“å­˜æŠ½è±¡"><a href="#Springçš„ç¼“å­˜æŠ½è±¡" class="headerlink" title="Springçš„ç¼“å­˜æŠ½è±¡"></a>Springçš„ç¼“å­˜æŠ½è±¡</h2><p>Springä¸ºäº†ç»Ÿä¸€ç¼“å­˜çš„æ“ä½œï¼Œä½¿ç”¨<code>org.springframework.cache</code>åŒ…ä¸‹çš„çš„<code>cacheManager</code>æ¥å£è¿›è¡Œå¼€å‘ã€‚å¹¶æ”¯æŒä¸Šé¢æ‰€è¯´çš„<code>JSR107</code>ç¼“å­˜è§„èŒƒï¼Œç”¨æ¥ç®€åŒ–å¼€å‘ã€‚</p><p>Springæ”¯æŒé€æ˜çš„å‘åº”ç”¨ä¸­çš„æ–¹æ³•æ·»åŠ ç¼“å­˜ã€‚å°†æŸ¥è¯¢å‡ºçš„ä¿¡æ¯æ”¾åˆ°ç¼“å­˜é‡Œï¼Œå‡å°‘åº”ç”¨ä¸å®é™…æ•°æ®åº“çš„æŸ¥è¯¢æ¬¡æ•°ã€‚æé«˜ç³»ç»Ÿç›¸åº”é€Ÿåº¦ã€‚</p><h2 id="SpringBootå¼€å¯ç¼“å­˜æ³¨è§£"><a href="#SpringBootå¼€å¯ç¼“å­˜æ³¨è§£" class="headerlink" title="SpringBootå¼€å¯ç¼“å­˜æ³¨è§£"></a>SpringBootå¼€å¯ç¼“å­˜æ³¨è§£</h2><p>SpringBootæ˜¯é»˜è®¤æ”¯æŒCacheç›¸å…³åŸºç¡€ç»„ä»¶çš„ã€‚éœ€è¦åœ¨å¯åŠ¨å™¨ç±»ä¸Šæ ‡æ³¨<code>@EnableCaching</code>æ³¨è§£ã€‚å¦‚ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span> <span class="comment">//å¼€å¯SpringBootçš„cacheæ”¯æŒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebProjectApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebProjectApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>æ·»åŠ ç¼“å­˜ï¼Œåªéœ€è¦åœ¨æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼Œ<code>Spring cache</code> å°±èƒ½å¤Ÿå¸®åŠ©åˆ›å»ºç¼“å­˜ã€‚å¦‚ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value=<span class="string">"user-status"</span>) <span class="comment">//ä½¿ç”¨Cacheableæ³¨è§£æ ‡å¿—è¿™éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œç¼“å­˜</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Status&gt; <span class="title">findNotDeletedUserStatus</span><span class="params">()</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statusRepository.findAllByIsDeletedOrderByOrd(DeletedStatusEnum.IS_NOT_DELETED.isJudge());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>SpringBootæ”¯æŒäº†å¤šç§çš„ç¼“å­˜å®ç°ï¼Œå¦‚<code>EhCache 2.x</code>ã€<code>Redis</code>ã€<code>Caffeine</code>ç­‰ç­‰ã€‚ä½†æ˜¯æ¥å£æ–¹æ³•æ˜¯ç›¸åŒçš„ï¼Œå°±å¦‚åŒä½¿ç”¨jdbcä¸€æ ·ã€‚è™½ç„¶å®ç°ä¸åŒï¼Œä½†æ˜¯ä½¿ç”¨ä¸Šå¹¶æ— å·®å¼‚ã€‚</p><h2 id="SpringBoot-ä½¿ç”¨ç¼“å­˜æ³¨è§£"><a href="#SpringBoot-ä½¿ç”¨ç¼“å­˜æ³¨è§£" class="headerlink" title="SpringBoot ä½¿ç”¨ç¼“å­˜æ³¨è§£"></a>SpringBoot ä½¿ç”¨ç¼“å­˜æ³¨è§£</h2><p>ç¼“å­˜æŠ½è±¡çš„æ ¸å¿ƒæ˜¯å°†ç¼“å­˜åº”ç”¨äºJavaæ–¹æ³•ä¸Šã€‚è¿™æ ·ï¼Œå¦‚æœæ–¹æ³•è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆåº”ç”¨äºæ–¹æ³•ä¸Šçš„ç¼“å­˜å°±å¼€å§‹æ£€æŸ¥æ˜¯å¦æŒ‰ç…§ç»™å®šè§„åˆ™è¿›è¡Œç¼“å­˜ã€‚</p><h3 id="åŸºäºæ³¨è§£çš„ç¼“å­˜"><a href="#åŸºäºæ³¨è§£çš„ç¼“å­˜" class="headerlink" title="åŸºäºæ³¨è§£çš„ç¼“å­˜"></a>åŸºäºæ³¨è§£çš„ç¼“å­˜</h3><p>å¯¹äºç¼“å­˜å£°æ˜ï¼ŒSpringçš„ç¼“å­˜æŠ½è±¡æä¾›äº†ä¸€ç»„Javaæ³¨è§£</p><h4 id="ä¸€ã€-Cacheable-è§¦å‘è¿›è¡Œç¼“å­˜"><a href="#ä¸€ã€-Cacheable-è§¦å‘è¿›è¡Œç¼“å­˜" class="headerlink" title="ä¸€ã€@Cacheable è§¦å‘è¿›è¡Œç¼“å­˜"></a>ä¸€ã€@Cacheable è§¦å‘è¿›è¡Œç¼“å­˜</h4><p>ä½¿ç”¨<code>@Cacheable</code>æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œæ ‡å¿—ç€è¿™ä¸ªæ–¹æ³•æ˜¯å¯ç¼“å­˜çš„ã€‚ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œå¯å°†æ–¹æ³•çš„è¿”å›ç»“æ„å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå†æ¬¡æŸ¥è¯¢æ˜¯ï¼Œå°±å¯ä»¥ä»ç¼“å­˜ä¸­å–ç»“æœè€Œä¸æ˜¯å†æ¬¡æ‰§è¡ŒæŸ¥è¯¢æ“ä½œã€‚å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(<span class="string">"books"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure></div><p>å› ä¸ºç¼“å­˜æ˜¯key-valueå½¢å¼çš„ï¼Œæ¯æ¬¡è°ƒç”¨ç¼“å­˜æ—¶ï¼Œéƒ½éœ€è¦å…ˆæ‰¾åˆ°æ­£ç¡®çš„keyã€‚ç¼“å­˜æŠ½è±¡æ”¯æŒç®€å•çš„<code>KeyGenerator</code>å‡ ç§ç”Ÿæˆçš„ç­–ç•¥ï¼šä½œä¸ºå‚è€ƒä¸Šé¢çš„æ–¹æ³•<code>findBook</code>çš„<code>Cacheable</code>çš„å‚æ•°æ˜¯<code>books</code>ã€‚</p><ul><li>å¦‚æœæ²¡æœ‰å‚æ•° ï¼Œåˆ™ä½¿ç”¨<code>SimpleKey.EMPTY</code>.</li><li>å¦‚æœæœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªå‚æ•°ä½œä¸ºkeyã€‚</li><li>å¦‚æœæœ‰å¤šä¸ªå‚æ•°ï¼Œåˆ™è¿”å› <code>SimpleKey</code> ä¸­åŒ…å«è¿™å¤šä¸ªå‚æ•°ã€‚</li></ul><p>è¿™ä¸‰ç§æ–¹å¼åŒ…å«äº†å¤§å¤šæ•°çš„ä½¿ç”¨åœºæ™¯ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰key ï¼Œ<code>@Cacheable</code> å…è®¸ä½¿ç”¨<code>key</code>å…³é”®å­—è¿›è¡Œkeyçš„ç”Ÿæˆï¼Œkeyå…³é”®å­—çš„å€¼å¯ä»¥ä½¿ç”¨<code>SPEL</code>è¡¨è¾¾å¼è¿›è¡Œè¡¨ç¤ºã€‚å¦‚<a href="https://docs.spring.io/spring/docs/5.1.9.RELEASE/spring-framework-reference/integration.html#cache-strategies" target="_blank" rel="noopener">Spring Docä¸­</a>æ‰€ä¸¾å‡ºçš„ä¾‹å­ä¸€æ ·ã€‚æ ¹æ®å®é™…çš„æƒ…å†µè¿›è¡Œæ–Ÿé…Œã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(cacheNames=<span class="string">"books"</span>, key=<span class="string">"#isbn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">@<span class="title">Cacheable</span><span class="params">(cacheNames=<span class="string">"books"</span>, key=<span class="string">"#isbn.rawNumber"</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">@<span class="title">Cacheable</span><span class="params">(cacheNames=<span class="string">"books"</span>, key=<span class="string">"T(someType).hash(#isbn)"</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span></span><br></pre></td></tr></table></figure></div><p><strong>è‡ªå®šä¹‰çš„ç¼“å­˜æ¡ä»¶</strong> ï¼š å¯ä»¥é€šè¿‡<code>condition</code>å…³é”®å­—åœ¨<code>@Cacheable</code>æ³¨è§£ä¸­è¿›è¡Œæ¡ä»¶çš„å®šåˆ¶ã€‚å¦‚ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(cacheNames=<span class="string">"book"</span>, condition=<span class="string">"#name.length() &lt; 32"</span>) </span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function"><span class="comment">//å¦‚æœæƒ³æ’é™¤æŸäº›æ¡ä»¶ ä½¿ç”¨unless</span></span></span><br><span class="line"><span class="function">@<span class="title">Cacheable</span><span class="params">(cacheNames=<span class="string">"book"</span>, condition=<span class="string">"#name.length() &lt; 32"</span>, unless=<span class="string">"#result.hardback"</span>)</span> </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(String name)</span></span></span><br></pre></td></tr></table></figure></div><p>å…·ä½“çš„æ›´å¤šçš„<code>spel</code>æ³¨è§£å±æ€§å¯ä»¥æŸ¥çœ‹Springæ–‡æ¡£ä¸­çš„å†…å®¹ <a href="https://docs.spring.io/spring/docs/5.1.9.RELEASE/spring-framework-reference/integration.html#cache-spel-context" target="_blank" rel="noopener">åœ°å€</a></p><h4 id="äºŒã€-CacheEvict-è§¦å‘æ¸…ç©ºç¼“å­˜"><a href="#äºŒã€-CacheEvict-è§¦å‘æ¸…ç©ºç¼“å­˜" class="headerlink" title="äºŒã€@CacheEvict è§¦å‘æ¸…ç©ºç¼“å­˜"></a>äºŒã€@CacheEvict è§¦å‘æ¸…ç©ºç¼“å­˜</h4><p>åœ¨<code>Spring cache</code>ä¸­ä¸ä»…å…è®¸æ”¾ç½®ç¼“å­˜ï¼Œè€Œä¸”å…è®¸ç§»é™¤ç¼“å­˜ã€‚ä½¿ç”¨ä¸<code>Cacheable</code>ç›¸å¯¹çš„<code>CacheEvict</code>æ³¨è§£æ¥æ¸…ç©ºå¯¹åº” keyçš„ç¼“å­˜æ•°æ®ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨allEntriesç”¨æ¥è¡¨ç¤ºåˆ é™¤æ‰€æœ‰è¿™ä¸ªcacheä¸­çš„ç¼“å­˜</span></span><br><span class="line"><span class="meta">@CacheEvict</span>(cacheNames=<span class="string">"books"</span>, allEntries=<span class="keyword">true</span>) </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBooks</span><span class="params">(InputStream batch)</span></span></span><br></pre></td></tr></table></figure></div><h4 id="ä¸‰ã€-CachePut-è§¦å‘æ›´æ–°ç¼“å­˜"><a href="#ä¸‰ã€-CachePut-è§¦å‘æ›´æ–°ç¼“å­˜" class="headerlink" title="ä¸‰ã€@CachePut è§¦å‘æ›´æ–°ç¼“å­˜"></a>ä¸‰ã€@CachePut è§¦å‘æ›´æ–°ç¼“å­˜</h4><p>å½“éœ€è¦æ›´æ–°ç¼“å­˜è€Œä¸å¹²æ‰°æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ›´æ–°ç¼“å­˜ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CachePut</span>(cacheNames=<span class="string">"book"</span>, key=<span class="string">"#isbn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">updateBook</span><span class="params">(ISBN isbn, BookDescriptor descriptor)</span></span></span><br></pre></td></tr></table></figure></div><h4 id="å››ã€-Caching-ç»„åˆä½¿ç”¨å¤šä¸ªcacheæ³¨è§£æ–¹æ³•"><a href="#å››ã€-Caching-ç»„åˆä½¿ç”¨å¤šä¸ªcacheæ³¨è§£æ–¹æ³•" class="headerlink" title="å››ã€@Caching ç»„åˆä½¿ç”¨å¤šä¸ªcacheæ³¨è§£æ–¹æ³•"></a>å››ã€@Caching ç»„åˆä½¿ç”¨å¤šä¸ªcacheæ³¨è§£æ–¹æ³•</h4><p>å¦‚æœæƒ³ä½¿ç”¨å¤šä¸ªcacheåŠ¨ä½œæ¥æ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼Œå°±éœ€è¦ä½¿ç”¨<code>Caching</code>æ³¨è§£å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­æ‰€è¡¨ç¤ºçš„ä¸€æ ·ï¼Œæƒ³è¦æ¸…ç©ºå¤šä¸ªkeyçš„ç¼“å­˜</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Caching</span>(evict = &#123; <span class="meta">@CacheEvict</span>(<span class="string">"primary"</span>), <span class="meta">@CacheEvict</span>(cacheNames=<span class="string">"secondary"</span>, key=<span class="string">"#p0"</span>) &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">importBooks</span><span class="params">(String deposit, Date date)</span></span></span><br></pre></td></tr></table></figure></div><h4 id="äº”ã€-CacheConfig-ç±»ä¸Šæ³¨è§£ç”¨æ¥æ³¨è§£å…¬å…±é…ç½®"><a href="#äº”ã€-CacheConfig-ç±»ä¸Šæ³¨è§£ç”¨æ¥æ³¨è§£å…¬å…±é…ç½®" class="headerlink" title="äº”ã€@CacheConfig ç±»ä¸Šæ³¨è§£ç”¨æ¥æ³¨è§£å…¬å…±é…ç½®"></a>äº”ã€@CacheConfig ç±»ä¸Šæ³¨è§£ç”¨æ¥æ³¨è§£å…¬å…±é…ç½®</h4><p>ä¸Šé¢çš„æ³¨è§£éƒ½æ˜¯åœ¨æ–¹æ³•çº§åˆ«ä¸Šçš„å¯¹æ–¹æ³•çš„è¿”å›å€¼è¿›è¡Œè®¾ç½®ï¼Œè€Œ<code>CacheConfig</code>æ˜¯å¯¹ç±»çº§åˆ«ä¸Šçš„å…¬å…±è®¾ç½®ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ä¸­æ‰€å±•ç¤ºçš„ä¸€æ ·ï¼Œè®¾ç½®å…¬å…±çš„<code>cache name</code>.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(<span class="string">"books"</span>) </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">BookRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn)</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="SpringBootä½¿ç”¨redisè¿›è¡Œç¼“å­˜"><a href="#SpringBootä½¿ç”¨redisè¿›è¡Œç¼“å­˜" class="headerlink" title="SpringBootä½¿ç”¨redisè¿›è¡Œç¼“å­˜"></a>SpringBootä½¿ç”¨redisè¿›è¡Œç¼“å­˜</h3><h4 id="ä¸€ã€æ·»åŠ Pomä¾èµ–"><a href="#ä¸€ã€æ·»åŠ Pomä¾èµ–" class="headerlink" title="ä¸€ã€æ·»åŠ Pomä¾èµ–"></a>ä¸€ã€æ·»åŠ Pomä¾èµ–</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h4 id="äºŒã€é…ç½®redisç›¸å…³å±æ€§"><a href="#äºŒã€é…ç½®redisç›¸å…³å±æ€§" class="headerlink" title="äºŒã€é…ç½®redisç›¸å…³å±æ€§"></a>äºŒã€é…ç½®redisç›¸å…³å±æ€§</h4><p>åœ¨å¼•å…¥<code>spring-boot-starter-data-redis</code>åï¼Œå¯åŠ¨ä¸»ç¨‹åºåä¼šè‡ªåŠ¨çš„å¼€å¯<code>redis</code>ç¼“å­˜ã€‚å¦‚æœæƒ³é…ç½®<code>redis</code>ï¼Œåˆ™å¯ä»¥åœ¨<code>org.springframework.boot.autoconfigure.data.redis.RedisProperties</code>è¿™ä¸ªå±æ€§ç±»ä¸­æŸ¥æ‰¾,ç„¶åæ·»åŠ åˆ°application.ymlä¸­ã€‚å¦‚ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> database = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Connection URL. Overrides host, port, and password. User is ignored. Example:</span></span><br><span class="line"><span class="comment"> * redis://user:password@example.com:6379</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String host = <span class="string">"localhost"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Duration timeout;</span><br></pre></td></tr></table></figure></div><h4 id="ä¸‰ã€è‡ªå®šä¹‰redisTemplateå’ŒTtlCacheManager"><a href="#ä¸‰ã€è‡ªå®šä¹‰redisTemplateå’ŒTtlCacheManager" class="headerlink" title="ä¸‰ã€è‡ªå®šä¹‰redisTemplateå’ŒTtlCacheManager"></a>ä¸‰ã€è‡ªå®šä¹‰redisTemplateå’ŒTtlCacheManager</h4><p>æ ¹æ®SpringBootè‡ªåŠ¨é…ç½®æºç ï¼ŒredisTemplateåªæœ‰åœ¨ç¯å¢ƒä¸­æ²¡æœ‰ä»¥<code>redisTemplate</code>åç§°å‘½åçš„beanæ—¶å€™ï¼Œæ‰è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>æ‰€ä»¥ï¼Œå¦‚æœæƒ³è‡ªè¡Œé…ç½®redisTemplateåˆ™å¯ç›´æ¥è£…è½½beanï¼Œå‘½åä¸º<code>redisTemplate</code>ã€‚å¦‚ä¸‹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">    RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">    template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">    <span class="comment">//Jackson2JsonRedisSerializer serializer = new Jackson2JsonRedisSerializer(Object.class);</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨Fastjson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼ </span></span><br><span class="line">    FastJson2JsonRedisSerializer serializer = <span class="keyword">new</span> FastJson2JsonRedisSerializer(Object.class);</span><br><span class="line"></span><br><span class="line">    ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">    mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">    serializer.setObjectMapper(mapper);</span><br><span class="line"></span><br><span class="line">    template.setHashKeySerializer(serializer);</span><br><span class="line">    template.setHashValueSerializer(serializer);</span><br><span class="line">    template.setDefaultSerializer(serializer);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€¼,é˜²æ­¢ä¹±ç </span></span><br><span class="line">    template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">    template.setValueSerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">    template.afterPropertiesSet();</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ @Cacheable(cacheManager="TtlCacheManager") æ¿€æ´»cacheManager</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"TtlCacheManager"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªRedisCacheWriter</span></span><br><span class="line">    RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(connectionFactory);</span><br><span class="line"></span><br><span class="line">    RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">    <span class="comment">//è®¾ç½®é»˜è®¤è¶…è¿‡æœŸæ—¶é—´æ˜¯30ç§’</span></span><br><span class="line">    defaultCacheConfig.entryTtl(Duration.ofSeconds(<span class="number">30</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–RedisCacheManager</span></span><br><span class="line">    RedisCacheManager cacheManager = <span class="keyword">new</span> RedisCacheManager(redisCacheWriter, defaultCacheConfig);</span><br><span class="line">    <span class="keyword">return</span> cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿™é‡Œæ˜¯ç”¨æ¥<code>FastJson2JsonRedisSerializer</code>æ¥ä»£æ›¿é»˜è®¤çš„<code>Jackson2JsonRedisSerializer</code>åºåˆ—åŒ–ç­–ç•¥ã€‚æ˜¯åœ¨ç½‘ä¸ŠæŸ¥æ‰¾åˆ°çš„æ–¹æ³•ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastJson2JsonRedisSerializer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; clazz;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//å¦‚æœé‡åˆ°ååºåˆ—åŒ–autoType is not supporté”™è¯¯ï¼Œè¯·æ·»åŠ å¹¶ä¿®æ”¹ä¸€ä¸‹åŒ…ååˆ°beanæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="comment">// ParserConfig.getGlobalInstance().addAccept("com.xxxxx.xxx");</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastJson2JsonRedisSerializer</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(T t) <span class="keyword">throws</span> SerializationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span> || bytes.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String str = <span class="keyword">new</span> String(bytes, DEFAULT_CHARSET);</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(str, clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObjectMapper</span><span class="params">(ObjectMapper objectMapper)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(objectMapper, <span class="string">"'objectMapper' must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> JavaType <span class="title">getJavaType</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TypeFactory.defaultInstance().constructType(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Springçš„ç¼“å­˜&quot;&gt;&lt;a href=&quot;#Springçš„ç¼“å­˜&quot; class=&quot;headerlink&quot; title=&quot;Springçš„ç¼“å­˜&quot;&gt;&lt;/a&gt;Springçš„ç¼“å­˜&lt;/h1&gt;&lt;p&gt;Javaåœ¨ä½¿ç”¨&lt;code&gt;Cache&lt;/code&gt;çš„æ—¶å€™ï¼Œä¸ºäº†ç»Ÿä¸€ç¼“å­˜çš„ä½¿ç”¨ï¼Œ&lt;co
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘</title>
    <link href="https://nanyiniu.github.io/2019/08/13/2019-08-13-SpringBoot%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89starter%E5%BC%80%E5%8F%91/"/>
    <id>https://nanyiniu.github.io/2019/08/13/2019-08-13-SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘/</id>
    <published>2019-08-13T12:00:00.000Z</published>
    <updated>2019-08-14T07:26:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘"><a href="#SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘" class="headerlink" title="SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘"></a>SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘</h1><p>SpringBootå®˜æ–¹é»˜è®¤æä¾›äº†å¾ˆå¤šçš„starterã€‚å‚è€ƒ<a href="https://docs.spring.io/spring-boot/docs/2.1.7.RELEASE/reference/html/using-boot-build-systems.html#using-boot-starter" target="_blank" rel="noopener">å®˜æ–¹çš„reference</a>ã€‚starterä½œä¸ºåœ¨SpringBootä¸­é‡è¦çš„ç‰¹æ€§ï¼Œä½¿ç”¨æ—¶èƒ½å¤Ÿåœ¨POMæ–‡ä»¶ä¸­ç›´æ¥å¼•ç”¨è¿™äº›starterï¼Œå¯ä»¥ä¸€ç«™å¼çš„è·å–ä¸Springç»“åˆçš„ç›¸å…³æœåŠ¡å’ŒåŠŸèƒ½ã€‚å¦‚æœæƒ³å¼•å…¥<code>redis</code>ç­‰åŠŸèƒ½ã€‚åˆ™ç›´æ¥æ·»åŠ ä½¿ç”¨<code>spring-boot-starter-data-redis</code>ã€‚åªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å°‘é‡å±æ€§ï¼Œå°±å¯ä»¥åœ¨åº”ç”¨ä¸­ä½¿ç”¨ã€‚</p><h2 id="SpringBootçš„è‡ªåŠ¨é…ç½®åŸç†"><a href="#SpringBootçš„è‡ªåŠ¨é…ç½®åŸç†" class="headerlink" title="SpringBootçš„è‡ªåŠ¨é…ç½®åŸç†"></a>SpringBootçš„è‡ªåŠ¨é…ç½®åŸç†</h2><p>SpringBooté€šè¿‡starterï¼Œå¼•ç”¨ç›¸å…³æœåŠ¡ï¼Œç„¶åé€šè¿‡autoConfigureæ¥è‡ªåŠ¨é…ç½®ç›¸å…³æœåŠ¡ã€‚æ›´å¤šå…·ä½“çš„å®ç°å¯ä»¥å‚è€ƒ<a href="https://nanyiniu.github.io/2019/07/08/2019-07-08-SpringBootçš„é…ç½®æ–‡ä»¶ï¼ˆæ‹“å±•ï¼‰/">è¿™ç¯‡æ–‡ç« </a>ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œç®€è¦çš„åˆ†ææ¥å¦‚ä½•å®ç°è‡ªå®šä¹‰starterå’ŒåŸºæœ¬çš„è‡ªåŠ¨é…ç½®å®ç°ã€‚</p><h2 id="starterçš„åŸºæœ¬ç»“æ„"><a href="#starterçš„åŸºæœ¬ç»“æ„" class="headerlink" title="starterçš„åŸºæœ¬ç»“æ„"></a>starterçš„åŸºæœ¬ç»“æ„</h2><ul><li>åŒ…åç§°ä»¥ <code>spring-boot-starter-xxx</code> å‘½åï¼Œå¦‚å¼•ç”¨<code>spring-boot-starter-data-jpa</code>.å…¶ä¸­çš„å†…å®¹åªåŒ…æ‹¬pomæ–‡ä»¶ï¼Œç”¨æ¥å¼•ç”¨ç›¸å…³æœåŠ¡çš„jaråŒ…ã€‚</li><li>åŒ…åç§°ä»¥<code>xxx-spring-boot-autoconfigure</code>å‘½åã€‚åŒ…å«ï¼š<ul><li>xxxAutoConfiguration è‡ªåŠ¨é…ç½®ç±»ï¼Œä½¿ç”¨<code>Configuration</code>æ³¨è§£æ ‡å¿—ä¸ºé…ç½®ç±»ã€‚ä½¿ç”¨<code>Conditionalxxxx</code>ç›¸å…³æ³¨è§£è¡¨ç¤ºæ¡ä»¶ï¼Œä½¿ç”¨<code>EnableConfigurationProperties</code>æ³¨è§£ï¼Œæ¥æŒ‡å®šé…ç½®å±æ€§ç±»ã€‚</li><li>xxxProperties é…ç½®å±æ€§ç±»ã€‚ä½¿ç”¨<code>ConfigurationProperties</code>æ³¨è§£æ¥æ ‡å¿—ä¸ºé…ç½®å±æ€§ç±»ï¼Œå¹¶ä¸”éœ€è¦æŒ‡å®š<code>prefix</code>ï¼Œä»¥ä¾¿åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨prefix+å±æ€§åæ¥è®¾ç½®ç›¸å…³å±æ€§ã€‚</li><li>spring.factories æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³ä¿¡æ¯ï¼Œç”¨æ¥æŒ‡å®šéœ€è¦è¿›è¡Œè‡ªåŠ¨é…ç½®çš„ç±»çš„å…¨é™å®šåç§°ã€‚å¦‚ï¼š</li></ul></li></ul><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,</span><br></pre></td></tr></table></figure></div><h2 id="å¼€å§‹è‡ªå®šä¹‰starter"><a href="#å¼€å§‹è‡ªå®šä¹‰starter" class="headerlink" title="å¼€å§‹è‡ªå®šä¹‰starter"></a>å¼€å§‹è‡ªå®šä¹‰starter</h2><p>åœ¨æ­£å¼è¿›è¡Œä¹‹å‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„Projectï¼Œç”¨æ¥æ”¾<code>spring-boot-starter-xxx</code>å’Œ<code>xxx-spring-boot-autoconfigure</code>ã€‚</p><p><img src="resources/D4E8FA6034BD91653B267CA966CAE105.jpg" alt="IMAGE"></p><h3 id="åˆ›å»ºspring-boot-starter-xxxå’Œxxx-spring-boot-autoconfigure"><a href="#åˆ›å»ºspring-boot-starter-xxxå’Œxxx-spring-boot-autoconfigure" class="headerlink" title="åˆ›å»ºspring-boot-starter-xxxå’Œxxx-spring-boot-autoconfigure"></a>åˆ›å»ºspring-boot-starter-xxxå’Œxxx-spring-boot-autoconfigure</h3><p>åœ¨åˆ›å»ºå®Œç©ºé¡¹ç›®åï¼Œä¼šè¦æ±‚åˆ›å»º<code>module</code>ã€‚é€‰æ‹©<code>maven</code>æˆ–è€…<code>Spring Initializer</code>è¿›è¡Œ<code>spring-boot-starter-xxx</code>çš„åˆ›å»ºã€‚</p><p><img src="resources/81E6646F4498A3F1D325E12360F902AA.jpg" alt="IMAGE"></p><h3 id="é…ç½®starter"><a href="#é…ç½®starter" class="headerlink" title="é…ç½®starter"></a>é…ç½®starter</h3><p>åœ¨å®é™…æ“ä½œé…ç½®starterä¹‹å‰ï¼Œå…ˆæ¥åˆ†æSpringBootå®˜æ–¹æä¾›çš„starterçš„åŸºæœ¬çš„ä¾èµ–ç»“æ„ï¼Œä¸ºæ¥ä¸‹æ¥çš„æ„å»ºèµ·åˆ°æ¨¡ç‰ˆçš„ä½œç”¨ã€‚</p><p>åœ¨å·¦è¾¹çš„ä¸º<code>spring-boot-starter-web</code>çš„çš„ç®€å•çš„ä¾èµ–å…³ç³»ï¼Œå®ƒä¾èµ–<code>spring-boot-starter</code>ã€‚è€Œ<code>spring-boot-starter</code>è¿›ä¸€æ­¥ä¾èµ–äº<code>spring-boot-autoconfigure</code>ç”¨æ¥è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚</p><p>å¦‚æœè‡ªå·±è¿›è¡Œstarterçš„é…ç½®çš„è¯ï¼Œéœ€è¦å‚è€ƒå·¦è¾¹çš„ä¾èµ–ç»“æ„ï¼Œå®Œæˆåï¼Œå‚è€ƒå³è¾¹çš„ä¾èµ–å…³ç³»ã€‚</p><p><img src="resources/E55C2E6426E1702D43CD92FE54055F02.jpg" alt="IMAGE"></p><p>æ³¨ï¼šå¹¶ééœ€è¦å®Œå…¨æŒ‰ç…§è¿™æ ·çš„ä¾èµ–è¿›è¡Œç¨‹åºçš„æ„å»ºã€‚ä¸Šå›¾åªæ˜¯å‚è€ƒã€‚</p><h3 id="é…ç½®autoconfigurationåŒ…"><a href="#é…ç½®autoconfigurationåŒ…" class="headerlink" title="é…ç½®autoconfigurationåŒ…"></a>é…ç½®autoconfigurationåŒ…</h3><h4 id="pomé…ç½®"><a href="#pomé…ç½®" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h4><p>åœ¨pom.xmlä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>ä¸»è¦éœ€è¦ä¾èµ–<code>spring-boot</code>ã€‚å¦‚æœåœ¨è‡ªåŠ¨é…ç½®ç±»éœ€è¦è¿›è¡Œå…¶ä»–ç‰¹æ®Šçš„<code>Conditional</code>è®¾ç½®æ—¶ï¼Œè¿˜éœ€è¦å¼•å…¥<code>spring-boot-autoconfigure</code>ã€‚</p><h4 id="æ·»åŠ xxxAutoConfiurationå’ŒxxxPropertiesç±»"><a href="#æ·»åŠ xxxAutoConfiurationå’ŒxxxPropertiesç±»" class="headerlink" title="æ·»åŠ xxxAutoConfiurationå’ŒxxxPropertiesç±»"></a>æ·»åŠ xxxAutoConfiurationå’ŒxxxPropertiesç±»</h4><p>è¿™ä¸¤ä¸ªç±»æ˜¯è‡ªåŠ¨é…ç½®ä¸­å¿…é¡»çš„ç±»ã€‚å†…å®¹å¯ä»¥å‚è€ƒ<code>WebMvcAutoConfiguration</code>å’Œ<code>WebMvcProperties</code>è¿™ä¸¤ä¸ªç±»ã€‚ä¸‹é¢æ˜¯æˆ‘çš„å…·ä½“å®ç°ç±»ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HelloAutoConfiguration è‡ªå®šä¹‰çš„AutoConfigurationç±»</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123;HelloProperties.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HelloProperties helloProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloAutoConfiguration</span><span class="params">(HelloProperties helloProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.helloProperties = helloProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloService <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HelloService helloService = <span class="keyword">new</span> HelloService();</span><br><span class="line">        <span class="comment">// è®¾ç½®é…ç½®å±æ€§</span></span><br><span class="line">        helloService.setHelloProperties(helloProperties);</span><br><span class="line">        <span class="keyword">return</span> helloService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨serviceç±»æ¥æµ‹è¯•æ˜¯å¦é…ç½®æˆåŠŸï¼Œæ–¹æ³•è°ƒç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    HelloProperties helloProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloProperties <span class="title">getHelloProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHelloProperties</span><span class="params">(HelloProperties helloProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.helloProperties = helloProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•è°ƒç”¨éªŒè¯å±æ€§æ˜¯å¦å…¶ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯è‡ªåŠ¨é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloProperties.getPrefix() + <span class="string">" hello world !"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„Propertiesç±»</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.hello"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String prefix ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="spring-factories"><a href="#spring-factories" class="headerlink" title="spring.factories"></a>spring.factories</h4><p>å¦‚æœæƒ³è¦ä½¿ç”¨è‡ªåŠ¨é…ç½®ï¼Œå¿…é¡»æ·»åŠ <code>spring.factories</code>è¿™ä¸ªæ–‡ä»¶ã€‚æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">com.nanyin.hello.HelloAutoConfiguration</span><br></pre></td></tr></table></figure></div><h3 id="é…ç½®-starter-xxx-åŒ…"><a href="#é…ç½®-starter-xxx-åŒ…" class="headerlink" title="é…ç½® starter-xxx åŒ…"></a>é…ç½® starter-xxx åŒ…</h3><h4 id="pomé…ç½®-1"><a href="#pomé…ç½®-1" class="headerlink" title="pomé…ç½®"></a>pomé…ç½®</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æ„å»ºçš„starterä¾èµ–&gt;spring-boot-starter å’Œå…¶ä»–éœ€è¦çš„starter--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--ä¾èµ–è‡ªåŠ¨é…ç½®åŒ…--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nanyin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hello-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h3 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h3><p>éœ€è¦åˆ é™¤ä¸éœ€è¦çš„ç±»æˆ–ç›®å½•ï¼Œå¦‚SpringBootå¯åŠ¨ç±»ç­‰ã€‚å‚è€ƒç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="resources/13707A6CCACD3FB3FF966B246EE0C736.jpg" alt="IMAGE"></p><h3 id="æ‰“æˆjaråŒ…"><a href="#æ‰“æˆjaråŒ…" class="headerlink" title="æ‰“æˆjaråŒ…"></a>æ‰“æˆjaråŒ…</h3><p>ä½¿ç”¨ideaä¸­çš„mavenå·¥å…·ï¼Œå¯¹ä¸Šä¸ªmoduleè¿›è¡Œåˆ†åˆ«æ‰“åŒ…ï¼Œå®‰è£…åˆ°æœ¬åœ°ã€‚æ‰“åŒ…çš„é¡ºåºæ˜¯å…ˆå®‰è£… <code>autoconfiuration</code> ï¼Œç„¶åå†å®‰è£… <code>starter-xxx</code>ã€‚</p><p><img src="resources/208EB8FC97CEA66C3BA8CA8BEC84535E.jpg" alt="IMAGE"></p><h2 id="ä½¿ç”¨starter"><a href="#ä½¿ç”¨starter" class="headerlink" title="ä½¿ç”¨starter"></a>ä½¿ç”¨starter</h2><p>æ–°å»ºä¸€ä¸ªwebçš„SpringBooté¡¹ç›®ï¼Œæ–°å»ºä¸€ä¸ªControllerï¼Œé‡Œé¢æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> helloService.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="YAML"><figure class="iseeu highlight /yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  hello:</span></span><br><span class="line"><span class="attr">    prefix:</span> <span class="string">PREFIX</span></span><br></pre></td></tr></table></figure></div><p>åœ¨pom.xmlä¸­æ·»åŠ è‡ªå®šä¹‰çš„starterï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ·»åŠ è‡ªå®šä¹‰starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nanyin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-hello<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>è¿è¡Œç¨‹åºï¼Œåœ¨åœ°å€æ ä¸Šè¾“å…¥<code>http://localhost:8081/sayHello</code>,å‡ºç°ä¸‹å›¾æ•ˆæœï¼š</p><p><img src="resources/4F00E62D2255F0CB15BC5E5DF2871A6F.jpg" alt="IMAGE"></p><p>è¯´æ˜è‡ªåŠ¨é…ç½®æˆåŠŸã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘&quot;&gt;&lt;a href=&quot;#SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘&quot; class=&quot;headerlink&quot; title=&quot;SpringBootçš„è‡ªå®šä¹‰starterå¼€å‘&quot;&gt;&lt;/a&gt;SpringBootçš„è‡ªå®šä¹‰sta
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootå¯åŠ¨ä¹‹refreshContext</title>
    <link href="https://nanyiniu.github.io/2019/08/05/SpringBoot%E5%90%AF%E5%8A%A8%E4%B9%8BrefreshContext/"/>
    <id>https://nanyiniu.github.io/2019/08/05/SpringBootå¯åŠ¨ä¹‹refreshContext/</id>
    <published>2019-08-05T12:00:00.000Z</published>
    <updated>2019-08-12T15:40:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBootå¯åŠ¨ä¹‹refreshContext"><a href="#SpringBootå¯åŠ¨ä¹‹refreshContext" class="headerlink" title="SpringBootå¯åŠ¨ä¹‹refreshContext"></a>SpringBootå¯åŠ¨ä¹‹refreshContext</h1><p>è¿™ç¯‡ä¸»è¦è¦é€šè¿‡<code>refreshContext</code>æ–¹æ³•æ¥å°†<code>SpringBoot</code>æ˜¯å¦‚ä½•åˆå§‹åŒ–<code>ioc</code>å®¹å™¨çš„ã€‚</p><h2 id="refreshContext"><a href="#refreshContext" class="headerlink" title="refreshContext"></a>refreshContext</h2><p>åœ¨<code>SpringBoot</code>ä¸­çš„runæ–¹æ³•ä¸­ï¼Œè°ƒç”¨<code>refreshContext()</code>æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ <code>AbstractApplicationContext</code>ç±»ä¸­çš„<code>refresh()</code>æ–¹æ³•ã€‚ç„¶ååˆ†ææ¯ä¸ªæ–¹æ³•çš„ä»£ç ï¼Œæ¥çœ‹è¿™äº›æ–¹æ³•çš„ä½œç”¨ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°ï¼Œè®¾ç½®å…¶å¯åŠ¨æ—¥æœŸ</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”è®¾ç½® active æ ‡å¿—ä»¥åŠæ‰§è¡Œå±æ€§æºï¼ˆç³»ç»Ÿå±æ€§ã€ç¯å¢ƒå˜é‡ï¼‰çš„ä»»ä½•åˆå§‹åŒ–ã€‚</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line">        <span class="comment">// å‘Šè¯‰å­ç±»åˆ·æ–° bean factory.</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line">        <span class="comment">// ä¸ºä¸Šä¸‹æ–‡å‡†å¤‡ bean factory.</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥ä¸‹æ¥çš„æ–¹æ³•å°±æ˜¯è£…è½½ç»„ä»¶çš„æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line">            <span class="comment">// ä½¿ç”¨beanFactoryåœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œbean</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// æ³¨å†Œbeançš„æ‹¦æˆªå™¨</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// åŠ è½½å›½é™…åŒ–</span></span><br><span class="line">            initMessageSource();</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„äº‹ä»¶å¹¿æ’­</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line">            <span class="comment">// åŠ è½½ç‰¹æ®Šçš„bean</span></span><br><span class="line">            onRefresh();</span><br><span class="line">            <span class="comment">// åŠ è½½æ‰€æœ‰çš„listenerså¹¶å¯åŠ¨</span></span><br><span class="line">            registerListeners();</span><br><span class="line">            <span class="comment">// å®Œæˆå¯¹æ‰€æœ‰çš„å‰©ä¸‹çš„éæ‡’åŠ è½½çš„å•ä¾‹çš„åˆ›å»º</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">            <span class="comment">// æœ€åå‘å¸ƒå¯¹åº”çš„äº‹ä»¶ã€‚</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="prepareRefresh-å‡†å¤‡åˆ·æ–°æ–¹æ³•"><a href="#prepareRefresh-å‡†å¤‡åˆ·æ–°æ–¹æ³•" class="headerlink" title="prepareRefresh å‡†å¤‡åˆ·æ–°æ–¹æ³•"></a>prepareRefresh å‡†å¤‡åˆ·æ–°æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä¸ºäº†æ¥ä¸‹æ¥çš„refreshè¿›è¡Œçš„å‡†å¤‡ã€‚ä¸»è¦çš„æœ‰ä¸¤ä¸ªè¿‡ç¨‹</p><ol><li>è°ƒç”¨<code>initPropertySources()</code>æ–¹æ³•è¿›è¡Œ<code>propertySource</code>çš„åˆå§‹åŒ–ã€‚</li><li>éªŒè¯æœ‰æ²¡æœ‰ç¼ºå¤±çš„å¿…è¦çš„Propertyå±æ€§ã€‚</li></ol><h4 id="initPropertySources-åˆå§‹åŒ–propertySource"><a href="#initPropertySources-åˆå§‹åŒ–propertySource" class="headerlink" title="initPropertySources åˆå§‹åŒ–propertySource"></a>initPropertySources åˆå§‹åŒ–propertySource</h4><p>è°ƒç”¨å®ç°ç±»çš„<code>initPropertySources</code>ï¼Œæ ¹æ®debugçš„ç»“æœï¼Œè¿›å…¥åˆ°äº†å­ç±»<code>GenericWebApplication</code>ç±»ä¸­ï¼Œå¯¹<code>servletContex</code>è¿›è¡Œå±æ€§è®¾ç½®ã€‚å¦‚ä¸‹å›¾ä¸­æ‰€å±•ç¤ºçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190812233656.jpg" alt="å›¾1"></p><h3 id="obtainFreshBeanFactory-è·å¾—beanFactory"><a href="#obtainFreshBeanFactory-è·å¾—beanFactory" class="headerlink" title="obtainFreshBeanFactory è·å¾—beanFactory"></a>obtainFreshBeanFactory è·å¾—beanFactory</h3><p>è¯¥æ–¹æ³•ä¾é refreshBeanFactory()æ¥åªæ˜¯beanå·¥å‚çš„å®é™…åˆ·æ–°ã€‚å› ä¸ºSpringBootåœ¨<code>ApplicationContext</code>å·²ç»æŒæœ‰ä¸€ä¸ªç±»å‹ä¸ºDefaultListableBeanFactoryç±»å‹çš„<code>beanFactory</code>ã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›ã€‚</p><h3 id="prepareBeanFactoryå‡†å¤‡BeanFactory"><a href="#prepareBeanFactoryå‡†å¤‡BeanFactory" class="headerlink" title="prepareBeanFactoryå‡†å¤‡BeanFactory"></a>prepareBeanFactoryå‡†å¤‡BeanFactory</h3><p>é…ç½®BeanFactoryçš„æ ‡å‡†ä¸Šä¸‹æ–‡ç‰¹å¾ã€‚ä¸»è¦ä½“ç°åœ¨ä¸€ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li>è®¾ç½®classLoaderå’Œbeanåç§°çš„è§£æç­–ç•¥ç­‰ã€‚</li><li>è®¾ç½®ä»¥<code>Aware</code>ç»“å°¾çš„callbackæ¥å£å‡½æ•°ã€‚é€šè¿‡å¯¹è¿™äº›æ¥å£çš„å®ç°ã€‚æ¥è¾¾åˆ°å¯¹ç¯å¢ƒè®¾ç½®çš„ç›®çš„ã€‚å¦‚å¯ç»§æ‰¿<code>ResourceLoaderAware</code>æ¥å£ï¼Œæ¥è®¾ç½®èµ„æºåŠ è½½å™¨ï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„èµ„æºåŠ è½½ã€‚</li><li>ä½¿ç”¨ç‰¹å®šçš„è‡ªåŠ¨è£…é…å€¼æ³¨å†Œç‰¹æ®Šä¾èµ–å…³ç³»ç±»å‹ã€‚å¦‚<code>beanFactory.registerResolvableDependency(ApplicationContext.class, this);</code></li><li>è®¾ç½®ç¯å¢ƒç›¸å…³çš„bean.å¦‚<code>beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</code></li></ol><h3 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory"></a>postProcessBeanFactory</h3><p>å…è®¸åœ¨ä¸Šä¸‹æ–‡å­ç±»ä¸­å¯¹beanè¿›è¡Œåå¤„ç†ã€‚è°ƒç”¨ç›¸å…³æ–¹æ³•å®Œæˆå¯¹beanFactoryçš„åç½®å¤„ç†å…¶çš„åŠ è½½ã€‚<br>åœ¨ä¹‹åçš„<code>invokeBeanFactoryPostProcessors</code>å®ä¾‹åŒ–å¹¶è°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„BeanFactoryPostProcessor beanã€‚åœ¨æ–¹æ³•<code>registerBeanPostProcessors</code>ä¸­å®ä¾‹åŒ–å¹¶æ³¨å†Œæ‰€æœ‰BeanPostProcessor beanã€‚</p><h3 id="initMessageSource-åˆå§‹åŒ–MessageSource"><a href="#initMessageSource-åˆå§‹åŒ–MessageSource" class="headerlink" title="initMessageSource åˆå§‹åŒ–MessageSource"></a>initMessageSource åˆå§‹åŒ–MessageSource</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆè·å¾—beanå·¥å‚</span></span><br><span class="line">  ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨beanåç§°ä¸ºmessageSourceçš„bean </span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯å›½é™…åŒ–çš„Message</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">    <span class="comment">// è·å¾—messageSource</span></span><br><span class="line">    <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">    <span class="comment">// Make MessageSource aware of parent MessageSource.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">      HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">      <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Only set parent context as parent MessageSource if no parent MessageSource</span></span><br><span class="line">        <span class="comment">// registered already.</span></span><br><span class="line">        hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ã€‚ã€‚ã€‚è¿™é‡Œçœç•¥</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨debugæ—¶çš„ç»“æœï¼Œå› ä¸ºSpringBooté»˜è®¤å®ç°ç±»Messageï¼Œæ‰€ä»¥å®¹å™¨ä¼šåŠ è½½SpringBooté…ç½®å¥½çš„å›½é™…åŒ–é…ç½®æ–‡ä»¶ã€‚å¦‚å›¾ä¸­çš„basenameSet;<br><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190812233841.jpg" alt="å›¾2"></p><h3 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h3><p>åœ¨è¿™ä¸€æ­¥ï¼ŒSpringBootä¼šæ ¹æ®åº”ç”¨ç±»å‹æ¥åˆ¤æ–­ï¼Œå¦‚æœæ˜¯webåº”ç”¨ï¼Œåˆ™ä¼šå¯åŠ¨é»˜è®¤çš„webå®¹å™¨ï¼Œå¦‚tomcatã€‚<br>å®ƒå›å»æ‰¾æ‰€æœ‰çš„ç±»å‹ä¸º<code>ServletWebServerFactory</code>çš„ç±»ã€‚ç„¶åè·å–ç¬¬ä¸€ä¸ª<code>getBeanFactory().getBean(beanNames[0], ServletWebServerFactory.class);</code>è¿›è¡Œbeanæ³¨å…¥ã€‚è¿™æ ·é€šè¿‡æ³¨å…¥çš„beanå°±èƒ½å¤Ÿå¯åŠ¨webå®¹å™¨äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190812233755.jpg" alt="å›¾3"></p><p>SpringBootä¸­é»˜è®¤å®ç°æœ‰ä»¥ä¸Šå‡ ç§ã€‚</p><h3 id="registerListeners-æ³¨å†Œlisteners"><a href="#registerListeners-æ³¨å†Œlisteners" class="headerlink" title="registerListeners æ³¨å†Œlisteners"></a>registerListeners æ³¨å†Œlisteners</h3><p>åœ¨è¿™ä¸€æ­¥ï¼Œæ³¨å†Œç±»å‹ä¸º<code>ApplicationListener</code>çš„æ‰€æœ‰listeners;</p><h3 id="finishBeanFactoryInitialization-å®Œæˆæ‰€æœ‰éæ‡’åŠ è½½çš„beançš„åˆå§‹åŒ–"><a href="#finishBeanFactoryInitialization-å®Œæˆæ‰€æœ‰éæ‡’åŠ è½½çš„beançš„åˆå§‹åŒ–" class="headerlink" title="finishBeanFactoryInitialization å®Œæˆæ‰€æœ‰éæ‡’åŠ è½½çš„beançš„åˆå§‹åŒ–"></a>finishBeanFactoryInitialization å®Œæˆæ‰€æœ‰éæ‡’åŠ è½½çš„beançš„åˆå§‹åŒ–</h3><h3 id="finishRefresh-å®Œæˆåˆ·æ–°"><a href="#finishRefresh-å®Œæˆåˆ·æ–°" class="headerlink" title="finishRefresh å®Œæˆåˆ·æ–°"></a>finishRefresh å®Œæˆåˆ·æ–°</h3><p>è¿™æ­¥æœ‰ä»¥ä¸‹å‡ ä¸ªæ“ä½œã€‚</p><ol><li><code>clearResourceCaches</code>æ–¹æ³•ã€‚ æ¸…ç©º<code>context-level</code>çš„ç¼“å­˜ã€‚</li><li><code>initLifecycleProcessor</code>æ–¹æ³•ï¼Œç”¨æ¥è®¾ç½®ç”Ÿå‘½å‘¨æœŸprocesser</li><li>å‘å¸ƒæœ€åçš„äº‹ä»¶ï¼ˆ<code>ContextRefreshedEvent</code>ï¼‰</li></ol><p>ä»¥ä¸Šå°±å®Œæˆäº†refreshæ–¹æ³•ä¸­çš„æ‰€æœ‰æ“ä½œã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBootå¯åŠ¨ä¹‹refreshContext&quot;&gt;&lt;a href=&quot;#SpringBootå¯åŠ¨ä¹‹refreshContext&quot; class=&quot;headerlink&quot; title=&quot;SpringBootå¯åŠ¨ä¹‹refreshContext&quot;&gt;&lt;/a&gt;Sprin
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootå¯åŠ¨åŸç†</title>
    <link href="https://nanyiniu.github.io/2019/08/05/SpringBoot%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/"/>
    <id>https://nanyiniu.github.io/2019/08/05/SpringBootå¯åŠ¨åŸç†/</id>
    <published>2019-08-05T12:00:00.000Z</published>
    <updated>2019-08-12T15:42:43.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBootçš„å¯åŠ¨åŸç†"><a href="#SpringBootçš„å¯åŠ¨åŸç†" class="headerlink" title="SpringBootçš„å¯åŠ¨åŸç†"></a>SpringBootçš„å¯åŠ¨åŸç†</h1><h2 id="åˆ›å»ºå¯åŠ¨å™¨"><a href="#åˆ›å»ºå¯åŠ¨å™¨" class="headerlink" title="åˆ›å»ºå¯åŠ¨å™¨"></a>åˆ›å»ºå¯åŠ¨å™¨</h2><p>SpringBooté€šè¿‡è°ƒç”¨ä¸»ç¨‹åºå¯åŠ¨åº”ç”¨ç¯å¢ƒã€‚ä¸‹é¢ä»£ç ä¸ºåº”ç”¨å¯åŠ¨å™¨çš„åŸºæœ¬ä»£ç ã€‚</p><h3 id="å¯åŠ¨å™¨"><a href="#å¯åŠ¨å™¨" class="headerlink" title="å¯åŠ¨å™¨"></a>å¯åŠ¨å™¨</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ‡æ³¨è¿™æ˜¯SpringBootåº”ç”¨</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// å¼€å¯cache</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebProjectApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// fastJsonä¸ä½¿ç”¨å¾ªç¯å¼•ç”¨ ï¼ˆ$refï¼‰</span></span><br><span class="line">        JSON.DEFAULT_GENERATE_FEATURE |= SerializerFeature.DisableCircularReferenceDetect.getMask();</span><br><span class="line">        <span class="comment">// ä½¿ç”¨SpringApplicationå¯åŠ¨åº”ç”¨</span></span><br><span class="line">        SpringApplication.run(WebProjectApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿›å…¥<code>SpringApplication.run</code>æ–¹æ³•ä¹‹åï¼Œå‘ç°ç¨‹åºä¼šè°ƒç”¨<code>new SpringApplication</code> æ¥åˆ›å»ºåº”ç”¨ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringApplication(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨<code>new SpringApplication</code>åˆ›å»ºå®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨å®¹å™¨ä¼šä»åŠ è½½ä¸€äº›ä¸»ç±»ã€‚æ¯”å¦‚ä»£ç ä¸­æ‰€å†™çš„ï¼š</p><h3 id="åˆå§‹åŒ–SpringApplication"><a href="#åˆå§‹åŒ–SpringApplication" class="headerlink" title="åˆå§‹åŒ–SpringApplication"></a>åˆå§‹åŒ–SpringApplication</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ primarySources å°±æ˜¯ ä¸Šé¢çš„ WebProjectApplication</span></span><br><span class="line">    <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);</span><br><span class="line">    <span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">// æ ¹æ®classpath æ¥åˆ¤æ–­åº”å½“å¯åŠ¨ä»€ä¹ˆæ ·çš„åº”ç”¨ç¨‹åºï¼Ÿ 1. éweb 2.webå¹¶ä½¿ç”¨å†…å®¹selvletå®¹å™¨</span></span><br><span class="line">    <span class="comment">// 3. web ä½†ä¸å®ç”¨å†…ç½®webå®¹å™¨</span></span><br><span class="line">    <span class="keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="comment">// è®¾ç½® Initializer</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">// è®¾ç½® Listener</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸»è¿è¡Œç¨‹åºæ˜¯å“ªä¸ªï¼Œæ¯”å¦‚æœ‰å¤šä¸ªä¸»ç¨‹åºï¼Œåˆ°åº•ä½¿ç”¨å“ªä¸ªã€‚</span></span><br><span class="line">    <span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œåœ¨<code>setInitializers</code>å’Œ<code>setListeners</code>çš„è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ã€‚ä¸»è¦æ–¹æ³•å°±æ˜¯ä»<code>META-INF/spring.factories</code>ä¸­åŠ è½½ç‰¹å®šçš„keyå€¼ä¸‹çš„valueã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">    ClassLoader classLoader = getClassLoader();</span><br><span class="line">    <span class="comment">// ä½¿ç”¨setåŠ è½½æ‰€æœ‰çš„å…¨ç±»å</span></span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    <span class="comment">// æ ¹æ®ç±»åé€šè¿‡åå°„åˆ›å»ºå®ä¾‹</span></span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="comment">// è¿”å›å®ä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä¸Šé¢åˆ†æäº†<code>getSpringFactoriesInstances</code>è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•è·å–å®ä¾‹çš„ï¼Œå…¶ä¸­è·å–çš„é€”å¾„å°±æ˜¯ä½¿ç”¨<code>SpringFactoriesLoader.loadFactoryNames</code>è·å–å…¨ç±»åï¼Œç„¶åé€šè¿‡åå°„è¿›è¡Œåˆ›å»ºå®ä¾‹ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ä¼ é€’è¿›æ¥çš„ ç±»å</span></span><br><span class="line">    String factoryClassName = factoryClass.getName();</span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨å°±è¿”å›ä¸€ä¸ªç©ºçš„listï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è¿”å›ä¸€ä¸ªå…¨ç±»åçš„ä¸€ä¸ªlist</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªlistæ˜¯ä»ä¸‹é¢æ˜¯æ–¹æ³•ä¸­çš„resultä¸­ç›´æ¥è·å–value</span></span><br><span class="line">    <span class="keyword">return</span> loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// èŠ‚é€‰ä¸€æ®µä»£ç æ¥çœ‹loadSpringFactories æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="comment">// ä»è·¯å¾„ä¸Šè·å–resource è¿™ä¸ªè·¯å¾„æ­£æ˜¯ META-INF/spring.factories åŠ è½½æ‰€æœ‰çš„</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªè·¯å¾„ä¸‹çš„url ç»„æˆä¸€ä¸ªresult</span></span><br><span class="line">    Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ?</span><br><span class="line">            classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">            ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">    result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (urls.hasMoreElements()) &#123; <span class="comment">// å¾ªç¯</span></span><br></pre></td></tr></table></figure></div><p>ä¸Šé¢çš„ä¸€ç³»åˆ—æ–¹æ³•åªæ˜¯ä¸ºç»™<code>SpringApplication</code>è¿›è¡Œåˆå§‹åŒ–çš„ç›¸å…³æ“ä½œï¼Œä¸‹ä¸€æ­¥ï¼Œè°ƒç”¨<code>SpringApplication.run</code>æ­£å¼è¿è¡Œå®¹å™¨.</p><h2 id="å¯åŠ¨å™¨å¯åŠ¨"><a href="#å¯åŠ¨å™¨å¯åŠ¨" class="headerlink" title="å¯åŠ¨å™¨å¯åŠ¨"></a>å¯åŠ¨å™¨å¯åŠ¨</h2><p>åœ¨æ–°å»ºå®ŒSpringApplicationåï¼Œä½¿ç”¨runæ–¹æ³•æ­£å¼å¯åŠ¨å®¹å™¨</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> SpringApplication(primarySources).run(args);</span><br><span class="line"> <span class="comment">// è¿™ä¸ªrunæ–¹æ³•ç›´æ¥è°ƒç”¨çš„æ˜¯ä»¥ä¸‹ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªè·‘è¡¨</span></span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// arrayListç±»å‹çš„Exception Reporters</span></span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// é…ç½®headless</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// è·å–æ‰€æœ‰çš„listeners</span></span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    <span class="comment">// å¯åŠ¨listeners</span></span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°è£…å‘½ä»¤è¡Œargs</span></span><br><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">        <span class="comment">//å‡†å¤‡ç¯å¢ƒ</span></span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">        <span class="comment">//é€šè¿‡è®¾ç½®spring.beaninfo.ignoreæ¥å¿½ç•¥beanè®¾ç½®</span></span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        <span class="comment">// æ‰“å°Springæ ‡è®°</span></span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line">        <span class="comment">// ç­–ç•¥åˆ›å»ºæŒ‡å®šçš„applicationContext</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// åˆ·æ–°ä¸Šä¸‹æ–‡ï¼Œåˆ›å»ºioc</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        <span class="comment">// åœ¨ä¸Šä¸‹æ–‡åˆ·æ–°ä¹‹åè°ƒç”¨</span></span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œæˆç›‘å¬å™¨çš„å¯åŠ¨</span></span><br><span class="line">        listeners.started(context);</span><br><span class="line">        <span class="comment">// è°ƒç”¨callRunners</span></span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        listeners.running(context);</span><br></pre></td></tr></table></figure></div><h3 id="getRunListenersæ–¹æ³•ä¸å¯åŠ¨Listeners"><a href="#getRunListenersæ–¹æ³•ä¸å¯åŠ¨Listeners" class="headerlink" title="getRunListenersæ–¹æ³•ä¸å¯åŠ¨Listeners"></a>getRunListenersæ–¹æ³•ä¸å¯åŠ¨Listeners</h3><p>è·å¾—æ‰€æœ‰çš„listenersï¼Œç„¶åè°ƒç”¨ <code>listeners.starting();</code>è¿è¡Œç›‘å¬å™¨ã€‚</p><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­,ä½¿ç”¨åˆ°äº†<code>getSpringFactoriesInstances</code>æ–¹æ³•ï¼Œä¸Šé¢è¯´åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šå°±æ˜¯ä»<code>spring.factory</code>ä¸­è·å–æ‰€æœ‰çš„keyä¸ºç‰¹å®šå€¼çš„ç±»ã€‚åœ¨getRunListenersæ–¹æ³•é‡Œå°±æ˜¯è·å–æ‰€æœ‰çš„keyä¸º<code>SpringApplicationRunListener</code>çš„æ‰€æœ‰valueã€‚å‚è€ƒä¸‹å›¾ä¸­å†…å®¹ï¼š</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190805222228.png" alt="å›¾1"></p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt;[] types = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger,</span><br><span class="line">            getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="keyword">this</span>, args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œå°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„RunListenersã€‚ä½¿ç”¨startingæ–¹æ³•æ¥æ‰¹é‡çš„å¼€å¯listenerã€‚å…¶å†…éƒ¨å®ç°å¦‚ä¸‹é¢çš„ä»£ç ã€‚æ˜¯ä½¿ç”¨forå¾ªç¯å°†æ‰€æœ‰åŠ è½½åˆ°çš„listenerså¯åŠ¨ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) &#123;</span><br><span class="line">        listener.starting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="prepareEnvironment-å‡†å¤‡ç¯å¢ƒ"><a href="#prepareEnvironment-å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="prepareEnvironment å‡†å¤‡ç¯å¢ƒ"></a>prepareEnvironment å‡†å¤‡ç¯å¢ƒ</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">        ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å¾—é…ç½®ç¯å¢ƒ</span></span><br><span class="line">    ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">// é…ç½®ç¯å¢ƒ</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">// åœ¨ç¯å¢ƒå‡†å¤‡å¥½åç«‹å³è°ƒç”¨ç›‘å¬å™¨çš„environmentPreparedæ–¹æ³•</span></span><br><span class="line">    <span class="comment">// éœ€è¦åœ¨SpringApplicationåˆ›å»ºä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    <span class="comment">// ç»‘å®šåˆ°SpringApplication</span></span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        environment = <span class="keyword">new</span> EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">                deduceEnvironmentClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†ConfigurationPropertySourcesæ”¯æŒæŒ‡å®šçš„ç¯å¢ƒã€‚</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨é…ç½®ç¯å¢ƒçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦é…ç½®<code>properties</code>å±æ€§å’Œ<code>profile</code>ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦è¿›è¡Œåœ¨propertieså±æ€§ä¸Šçš„ç±»å‹è½¬æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) &#123;</span><br><span class="line">        ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">        environment.setConversionService((ConfigurableConversionService) conversionService);</span><br><span class="line">    &#125;</span><br><span class="line">    configurePropertySources(environment, args);</span><br><span class="line">    <span class="comment">// é…ç½®profileï¼ŒåŒ…æ‹¬æ¿€æ´»çš„é…ç½®æ–‡ä»¶ç­‰ã€‚</span></span><br><span class="line">    configureProfiles(environment, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="configureProfiles-é…ç½®profile"><a href="#configureProfiles-é…ç½®profile" class="headerlink" title="configureProfiles é…ç½®profile"></a>configureProfiles é…ç½®profile</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureProfiles</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®æ¿€æ´»çš„profileï¼Œå¯ä»¥é€šè¿‡å±æ€§ spring.profiles.activeæ¥è®¾ç½®</span></span><br><span class="line">    environment.getActiveProfiles();</span><br><span class="line">    Set&lt;String&gt; profiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.additionalProfiles);</span><br><span class="line">    profiles.addAll(Arrays.asList(environment.getActiveProfiles()));</span><br><span class="line">    <span class="comment">// åœ¨ç¯å¢ƒä¸­è®¾ç½®æ¿€æ´»çš„profiles</span></span><br><span class="line">    environment.setActiveProfiles(StringUtils.toStringArray(profiles));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="printBanner-æ‰“å°æ ‡å¿—"><a href="#printBanner-æ‰“å°æ ‡å¿—" class="headerlink" title="printBanner æ‰“å°æ ‡å¿—"></a>printBanner æ‰“å°æ ‡å¿—</h3><p>printBanneræ–¹æ³•ç”¨æ¥æ‰“å°è¿è¡Œç¨‹åºæ—¶çš„æ ‡å¿—ï¼Œè§ä¸‹å›¾</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190807214428.png" alt="å›¾2"></p><p>è¿™ä¸ªæ–¹æ³•æœ€åé€šè¿‡<code>print</code>æ–¹æ³•æ¥è¾“å‡º</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Banner <span class="title">print</span><span class="params">(Environment environment, Class&lt;?&gt; sourceClass, PrintStream out)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–banner</span></span><br><span class="line">    Banner banner = getBanner(environment);</span><br><span class="line">    banner.printBanner(environment, sourceClass, out);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PrintedBanner(banner, sourceClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤æ˜¯ DEFAULT_BANNER</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] BANNER = &#123; <span class="string">""</span>, <span class="string">"  .   ____          _            __ _ _"</span>,</span><br><span class="line">        <span class="string">" /\\\\ / ___'_ __ _ _(_)_ __  __ _ \\ \\ \\ \\"</span>, <span class="string">"( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\"</span>,</span><br><span class="line">        <span class="string">" \\\\/  ___)| |_)| | | | | || (_| |  ) ) ) )"</span>, <span class="string">"  '  |____| .__|_| |_|_| |_\\__, | / / / /"</span>,</span><br><span class="line">        <span class="string">" =========|_|==============|___/=/_/_/_/"</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_BOOT = <span class="string">" :: Spring Boot :: "</span>;</span><br></pre></td></tr></table></figure></div><h3 id="createApplicationContext-åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒ"><a href="#createApplicationContext-åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒ" class="headerlink" title="createApplicationContext åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒ"></a>createApplicationContext åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒ</h3><p><code>createApplicationContext</code>æ–¹æ³•ç”¨æ¥ç­–ç•¥åˆ›å»ºæŒ‡å®šçš„applicationContext;</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">    <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯servletç¯å¢ƒ</span></span><br><span class="line">            <span class="keyword">case</span> SERVLET:</span><br><span class="line">            <span class="comment">// åˆ›å»ºAnnotationConfigServletWebServerApplicationContext</span></span><br><span class="line">            <span class="comment">// é€‚ç”¨äºé»˜è®¤çš„webç¯å¢ƒ</span></span><br><span class="line">                contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> REACTIVE:</span><br><span class="line">            <span class="comment">// åˆ›å»ºAnnotationConfigReactiveWebServerApplicationContext </span></span><br><span class="line">            <span class="comment">// é€‚ç”¨äºreactive webç¯å¢ƒ</span></span><br><span class="line">                contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// åˆ›å»ºAnnotationConfigApplicationContextï¼Œéwebç¯å¢ƒ</span></span><br><span class="line">                contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Unable create a default ApplicationContext, "</span> + <span class="string">"please specify an ApplicationContextClass"</span>,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="prepareContext-å‡†å¤‡ä¸Šä¸‹æ–‡"><a href="#prepareContext-å‡†å¤‡ä¸Šä¸‹æ–‡" class="headerlink" title="prepareContext å‡†å¤‡ä¸Šä¸‹æ–‡"></a>prepareContext å‡†å¤‡ä¸Šä¸‹æ–‡</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">        SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åç½®å¤„ç†context</span></span><br><span class="line"><span class="comment">    * 1. åˆ›å»ºä¸€ä¸ªå•ä¾‹çš„beanNameGenerator</span></span><br><span class="line"><span class="comment">    * 2. å¦‚æœresourceLoaderä¸ä¸ºç©ºï¼Œåˆ™è®¾ç½®resourceLoaderå’ŒclassLoader\</span></span><br><span class="line"><span class="comment">    * 3. è®¾ç½®ç”¨äºå±æ€§å€¼è½¬æ¢çš„ConversionService</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    <span class="comment">// é€šè¿‡åœ¨ åˆå§‹åŒ–SpringApplication è¿™é‡Œè®¾ç½®çš„Initializersæ¥å¯¹ç¯å¢ƒè¿›è¡Œè®¾ç½®</span></span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">// å‘Šè¯‰ç›‘å¬å™¨ä¸Šä¸‹æ–‡å‡†å¤‡å¥½äº†</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... ä¸­é—´çœç•¥</span></span><br><span class="line">    <span class="comment">// å†æ¬¡è°ƒç”¨ç›‘å¬å™¨çš„äº‹ä»¶ï¼Œé€šçŸ¥ç›‘å¬å™¨ä¸Šä¸‹æ–‡å·²ç»åŠ è½½å®Œæˆ</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="refreshContext-åˆ·æ–°ä¸Šä¸‹æ–‡"><a href="#refreshContext-åˆ·æ–°ä¸Šä¸‹æ–‡" class="headerlink" title="refreshContext åˆ·æ–°ä¸Šä¸‹æ–‡"></a>refreshContext åˆ·æ–°ä¸Šä¸‹æ–‡</h3><p>ç”¨äºåˆ·æ–°ä¸Šä¸‹æ–‡ï¼Œåˆ·æ–°ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹å…¶å®å°±æ˜¯IOCå®¹å™¨åˆå§‹åŒ–çš„è¿‡ç¨‹(æ‰«æã€åŠ è½½ã€åˆ›å»ºæ‰€æœ‰çš„ç»„ä»¶)ã€‚å¦‚æœæ˜¯webåº”ç”¨ï¼Œè¿˜ä¼šè‡ªåŠ¨å¯åŠ¨åµŒå…¥å¼çš„tomcat.å…·ä½“æ–¹æ³•ä¼šå•æ‹¿å‡ºæ¥ä¸€ç¯‡æ¥åˆ†ærefreshçš„è¿‡ç¨‹ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°ï¼Œè®¾ç½®å…¶å¯åŠ¨æ—¥æœŸ</span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”è®¾ç½® active æ ‡å¿—ä»¥åŠæ‰§è¡Œå±æ€§æºï¼ˆç³»ç»Ÿå±æ€§ã€ç¯å¢ƒå˜é‡ï¼‰çš„ä»»ä½•åˆå§‹åŒ–ã€‚</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line">        <span class="comment">// å‘Šè¯‰å­ç±»åˆ·æ–° bean factory.</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line">        <span class="comment">// ä¸ºä¸Šä¸‹æ–‡å‡†å¤‡ bean factory.</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥ä¸‹æ¥çš„æ–¹æ³•å°±æ˜¯è£…è½½ç»„ä»¶çš„æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line">            <span class="comment">// ä½¿ç”¨beanFactoryåœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œbean</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// æ³¨å†Œbeançš„æ‹¦æˆªå™¨</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// åŠ è½½å›½é™…åŒ–</span></span><br><span class="line">            initMessageSource();</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„äº‹ä»¶å¹¿æ’­</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line">            <span class="comment">// åŠ è½½ç‰¹æ®Šçš„bean</span></span><br><span class="line">            onRefresh();</span><br><span class="line">            <span class="comment">// åŠ è½½æ‰€æœ‰çš„listenerså¹¶å¯åŠ¨</span></span><br><span class="line">            registerListeners();</span><br><span class="line">            <span class="comment">// å®Œæˆå¯¹æ‰€æœ‰çš„å‰©ä¸‹çš„éæ‡’åŠ è½½çš„å•ä¾‹çš„åˆ›å»º</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">            <span class="comment">// æœ€åå‘å¸ƒå¯¹åº”çš„äº‹ä»¶ã€‚</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="è°ƒç”¨callRunners"><a href="#è°ƒç”¨callRunners" class="headerlink" title="è°ƒç”¨callRunners"></a>è°ƒç”¨callRunners</h3><h2 id="å¯åŠ¨è¿‡ç¨‹å›¾è§£"><a href="#å¯åŠ¨è¿‡ç¨‹å›¾è§£" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹å›¾è§£"></a>å¯åŠ¨è¿‡ç¨‹å›¾è§£</h2><p>ä½¿ç”¨ä¸€å¼ ç®€å•çš„æµç¨‹å›¾å°†ä¸Šé¢æ‰€æœ‰çš„ä¸»è¦æ–¹æ³•ä¸²è”èµ·æ¥ï¼Œæ¥æŸ¥çœ‹SpringBootçš„å¯åŠ¨æµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190811124925.png" alt="å›¾3"></p><p>åœ¨æ•´ä¸ªå¯åŠ¨æµç¨‹çš„è¿‡ç¨‹ä¸­åˆä¸€ä¸ªé‡è¦çš„ç»„ä»¶å°±æ˜¯listeners.å®ƒæ¥ç›‘å¬åº”ç”¨è¿è¡Œçš„è¿‡ç¨‹ã€‚åœ¨ç¨‹åºä¸­çš„ä½“ç°å°±æ˜¯ç‰¹å®šçš„èŠ‚ç‚¹è°ƒç”¨listenersçš„å›è°ƒæ–¹æ³•ã€‚å…·ä½“çš„è°ƒç”¨listenersè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€å±•ç¤ºçš„ï¼š</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190811125247.png" alt="å›¾4"></p><h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>è¿™ç¯‡æ–‡ç« æ ¹æ®ä»£ç æ¥åˆ†æSpringBootçš„å¯åŠ¨è¿‡ç¨‹ã€‚åˆ†æçš„æ¯”è¾ƒæ½¦è‰ï¼Œæœ‰äº›åœ°æ–¹åˆ†æçš„ä¸æ¸…æ™°æˆ–è€…åˆ†æå‡ºé”™çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œå…±åŒè¿›æ­¥ï¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBootçš„å¯åŠ¨åŸç†&quot;&gt;&lt;a href=&quot;#SpringBootçš„å¯åŠ¨åŸç†&quot; class=&quot;headerlink&quot; title=&quot;SpringBootçš„å¯åŠ¨åŸç†&quot;&gt;&lt;/a&gt;SpringBootçš„å¯åŠ¨åŸç†&lt;/h1&gt;&lt;h2 id=&quot;åˆ›å»ºå¯åŠ¨å™¨&quot;&gt;&lt;a hre
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootçš„é”™è¯¯å¤„ç†æœºåˆ¶</title>
    <link href="https://nanyiniu.github.io/2019/07/17/2019-07-17-SpringBoot%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6/"/>
    <id>https://nanyiniu.github.io/2019/07/17/2019-07-17-SpringBooté”™è¯¯å¤„ç†æœºåˆ¶/</id>
    <published>2019-07-17T12:00:00.000Z</published>
    <updated>2019-08-12T05:27:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†"><a href="#åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†" class="headerlink" title="åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†"></a>åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†</h1><p>SpringBooté»˜è®¤æœ‰ä¸€å¥—å¯¹webå¼€å‘é”™è¯¯å¤„ç†çš„æœºåˆ¶ï¼Œåœ¨<code>autoConfiguration</code>åŒ…ä¸‹é¢æ‰¾åˆ°äº†<code>ErrorMvcAutoConfiguration</code>ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// åªæœ‰åŸºäºservletçš„webç¨‹åº</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span>(type = Type.SERVLET)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; Servlet.class, DispatcherServlet.class &#125;)</span><br><span class="line"><span class="comment">// éœ€è¦å…ˆåŠ è½½WebMvcAutoConfiguration</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(WebMvcAutoConfiguration.class)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123; ServerProperties.class, ResourceProperties.class, WebMvcProperties.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorMvcAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure></div><h2 id="å¤„ç†æœºåˆ¶"><a href="#å¤„ç†æœºåˆ¶" class="headerlink" title="å¤„ç†æœºåˆ¶"></a>å¤„ç†æœºåˆ¶</h2><p>åœ¨è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸­ï¼Œç”±ä¸‰ä¸ªæœ€åŸºæœ¬çš„<code>bean</code>ç»„ä»¶ç»„æˆï¼Œä¸‹é¢æŒ¨ä¸ªçœ‹è¿™äº›æ³¨å…¥åˆ°å®¹å™¨ä¸­çš„<code>bean</code>çš„å«ä¹‰</p><h3 id="errorPageCustomizer-å®šä¹‰é”™è¯¯é¡µé¢"><a href="#errorPageCustomizer-å®šä¹‰é”™è¯¯é¡µé¢" class="headerlink" title="errorPageCustomizer å®šä¹‰é”™è¯¯é¡µé¢"></a><code>errorPageCustomizer</code> å®šä¹‰é”™è¯¯é¡µé¢</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ErrorPageCustomizer <span class="title">errorPageCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ErrorPageCustomizer(<span class="keyword">this</span>.serverProperties, <span class="keyword">this</span>.dispatcherServletPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ErrorPageCustomizeræœ‰ä¸€ä¸ªregisterErrorPages æ³¨å†Œé¡µé¢çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerErrorPages</span><span class="params">(ErrorPageRegistry errorPageRegistry)</span> </span>&#123;</span><br><span class="line">ErrorPage errorPage = <span class="keyword">new</span> ErrorPage(</span><br><span class="line">        <span class="comment">// ç”¨äºè·å–erroré¡µé¢çš„åœ°å€</span></span><br><span class="line"><span class="keyword">this</span>.dispatcherServletPath.getRelativePath(<span class="keyword">this</span>.properties.getError().getPath()));</span><br><span class="line">errorPageRegistry.addErrorPages(errorPage);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ°å€åœ¨ this.properties.getError().getPath()å˜é‡ä¸­å…·ä½“çš„å€¼ï¼š</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;error.path:/error&#125;"</span>)</span><br><span class="line"><span class="comment">// é…ç½®æ–‡ä»¶ä¸­error.pathä¸‹çš„/erroræˆ–è€…æ ¹ç›®å½•ä¸‹çš„/erroræ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="keyword">private</span> String path = <span class="string">"/error"</span>;</span><br></pre></td></tr></table></figure></div><p>æ‰€ä»¥<code>errorPageCustomizer</code>çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯æ‰¾åˆ°åœ°å€ï¼Œæ‹¼è£…æˆ<code>ErrorPage</code>;</p><h3 id="WhitelabelErrorViewConfiguration-ç©ºç™½é¡µçš„é…ç½®"><a href="#WhitelabelErrorViewConfiguration-ç©ºç™½é¡µçš„é…ç½®" class="headerlink" title="WhitelabelErrorViewConfiguration ç©ºç™½é¡µçš„é…ç½®"></a><code>WhitelabelErrorViewConfiguration</code> ç©ºç™½é¡µçš„é…ç½®</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WhitelabelErrorViewConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="comment">// åœ¨StaticViewä¸­å®šä¹‰äº†é»˜è®¤çš„Whitelabelé¡µé¢æ ¼å¼ï¼Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StaticView defaultErrorView = <span class="keyword">new</span> StaticView();</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"error"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"error"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">defaultErrorView</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.defaultErrorView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="basicErrorController-æ§åˆ¶å™¨"><a href="#basicErrorController-æ§åˆ¶å™¨" class="headerlink" title="basicErrorController æ§åˆ¶å™¨"></a><code>basicErrorController</code> æ§åˆ¶å™¨</h3><p>basicErrorControllerå°±æ˜¯ç®€å•çš„æ§åˆ¶å™¨</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span> <span class="comment">//controllerå®ç° æ³¨å†Œåˆ°å®¹å™¨ä¸­</span></span><br><span class="line"><span class="comment">// é”™è¯¯æ˜ å°„åœ°å€ error.path æˆ–</span></span><br><span class="line"><span class="comment">// server.error.path ä¸‹ /error</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span></span></span><br></pre></td></tr></table></figure></div><p>åœ¨è¿™ä¸ª<code>Controller</code>ä¸­æ˜ å°„åˆ°äº†<code>/error</code>åœ°å€ä¸Šï¼Œæœ‰å…·æœ‰ä¸¤ä¸ª<code>RequestMapping</code>è¿›è¡Œæ˜ å°„ã€‚</p><h4 id="è¯·æ±‚çš„åª’ä½“ç±»å‹ä¸ºtext-htmlæ—¶"><a href="#è¯·æ±‚çš„åª’ä½“ç±»å‹ä¸ºtext-htmlæ—¶" class="headerlink" title="è¯·æ±‚çš„åª’ä½“ç±»å‹ä¸ºtext/htmlæ—¶"></a>è¯·æ±‚çš„åª’ä½“ç±»å‹ä¸º<code>text/html</code>æ—¶</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE)</span><br><span class="line"><span class="comment">// åª’ä½“ç±»å‹ä¸º text/html æ—¶å€™ä½¿ç”¨è¿™ä¸ªå¯¹/errorçš„æ¥æ”¶</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å¾—requestä¸­çš„çŠ¶æ€ç </span></span><br><span class="line">  <span class="comment">// Integer statusCode = </span></span><br><span class="line">  <span class="comment">// (Integer) request.getAttribute("javax.servlet.error.status_code");</span></span><br><span class="line">  HttpStatus status = getStatus(request);</span><br><span class="line">  Map&lt;String, Object&gt; model = Collections</span><br><span class="line">    .unmodifiableMap(getErrorAttributes(request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));</span><br><span class="line">  response.setStatus(status.value());</span><br><span class="line">  ModelAndView modelAndView = resolveErrorView(request, response, status, model);</span><br><span class="line">  <span class="keyword">return</span> (modelAndView != <span class="keyword">null</span>) ? modelAndView : <span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å…¶ä¸­ä½¿ç”¨å¤«ç±»ä¸­çš„<code>getErrorAttributes</code>æ–¹æ³•æ¥è·å–åŸºæœ¬å±æ€§æ•°æ®ï¼Œé€šè¿‡<code>return this.errorAttributes.getErrorAttributes(webRequest, includeStackTrace)</code>ç›´æ¥è°ƒç”¨å·²ç»æ³¨å…¥åˆ°å®¹å™¨ä¸­çš„<code>ErrorAttributes</code>ç±»åŠå…¶å­ç±»ã€‚å¦‚é»˜è®¤çš„<code>DefaultErrorAttributes</code>ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">  Map&lt;String, Object&gt; errorAttributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">  <span class="comment">// è¿”å›åˆ°é¡µé¢çš„å½“å‰ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">  errorAttributes.put(<span class="string">"timestamp"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">  <span class="comment">// ä¸‹é¢çš„ javax.xxxx éƒ½æ˜¯ä»requesetä¸­å¾—åˆ°çš„</span></span><br><span class="line">  <span class="comment">// è¿”å›çŠ¶æ€ç  javax.servlet.error.status_code</span></span><br><span class="line">  addStatus(errorAttributes, webRequest);</span><br><span class="line">  <span class="comment">//é”™è¯¯ä¿¡æ¯ avax.servlet.error.message</span></span><br><span class="line">  addErrorDetails(errorAttributes, webRequest, includeStackTrace);</span><br><span class="line">  <span class="comment">// è¯·æ±‚è·¯å¾„ javax.servlet.error.request_uri</span></span><br><span class="line">  addPath(errorAttributes, webRequest);</span><br><span class="line">  <span class="keyword">return</span> errorAttributes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>åœ¨è·å–å®Œéœ€è¦è¿”å›çš„æ•°æ®ä¹‹åï¼Œè¿”å›ä¸€ä¸ª<code>modelAndView</code>å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æ˜¾ç¤ºçš„ç•Œé¢ã€‚</p><p>é»˜è®¤ä½¿ç”¨<code>DefaultErrorViewResolver</code>æ¥è¿›è¡Œå¯¹<code>ErrorView</code>çš„è§£æã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveErrorView</span><span class="params">(HttpServletRequest request, HttpStatus status, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–modelandviewå¯¹è±¡</span></span><br><span class="line">  ModelAndView modelAndView = resolve(String.valueOf(status.value()), model);</span><br><span class="line">  <span class="keyword">if</span> (modelAndView == <span class="keyword">null</span> &amp;&amp; SERIES_VIEWS.containsKey(status.series())) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰modelandview</span></span><br><span class="line">    modelAndView = resolve(SERIES_VIEWS.get(status.series()), model);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœæ²¡æœ‰é€šè¿‡resolveæ–¹æ³•æ‰¾åˆ°ä¸€ä¸ªmodelAndViewã€‚åˆ™ä¼šæœ‰ç±»ä¼¼é€šè¿‡ <code>5xx.html</code> é¡µé¢æ¥å±•ç¤º5å¼€å¤´çš„é‚£äº›é”™è¯¯çš„é¡µé¢ã€‚å¯é€‰å€¼æœ‰ä¸‹é¢ä¸¤ç§ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">views.put(Series.CLIENT_ERROR, <span class="string">"4xx"</span>);</span><br><span class="line">views.put(Series.SERVER_ERROR, <span class="string">"5xx"</span>);</span><br><span class="line">SERIES_VIEWS = Collections.unmodifiableMap(views);</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨resolveæ–¹æ³•æ¥è·å–ModelAndView</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">resolve</span><span class="params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è¿™é‡Œçš„viewNameä¸ºçŠ¶æ€ç¼–ç ï¼Œè§†å›¾ä¸º error/ã€ŒçŠ¶æ€ç å€¼ã€</span></span><br><span class="line">  </span><br><span class="line">  String errorViewName = <span class="string">"error/"</span> + viewName;</span><br><span class="line">  TemplateAvailabilityProvider provider = <span class="keyword">this</span>.templateAvailabilityProviders.getProvider(errorViewName,</span><br><span class="line">                                                                                         <span class="keyword">this</span>.applicationContext);</span><br><span class="line">  <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚403é”™è¯¯ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› error/403.html  å‰ææ˜¯æœ‰æ¨¡ç‰ˆå¼•æ“</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(errorViewName, model);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰å°±å»  &#123; "classpath:/META-INF/resources/",</span></span><br><span class="line"><span class="comment">//"classpath:/resources/", "classpath:/static/", "classpath:/public/" &#125;;</span></span><br><span class="line">  <span class="comment">// è¿™å‡ ä¸ªè·¯å¾„ä¸Šæ‰¾ è·¯å¾„ä¸‹çš„error/xxx.htmlï¼Œè¿™äº›è·¯å¾„å°±æ˜¯é»˜è®¤çš„èµ„æºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">  <span class="keyword">return</span> resolveResource(errorViewName, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœåˆ°ä¸Šä¸€æ­¥ä»ä¸å­˜åœ¨viewåˆ™è¯´æ˜ï¼Œæ¨¡ç‰ˆå¼•æ“/åŸºæœ¬èµ„æºæ–‡ä»¶å¤¹ä¸‹å‡ä¸å­˜åœ¨erroræ–‡ä»¶å¤¹ä¸‹çš„xxx.htmlæ–‡ä»¶ï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ªé»˜è®¤çš„view ã€‚<code>(modelAndView != null) ? modelAndView : new ModelAndView(&quot;error&quot;, model);</code>ï¼Œ<strong>å°±æ˜¯åœ¨æ ‡é¢˜ã€WhitelabelErrorViewConfigurationã€‘ä¸­æåŠåˆ°çš„StaticView</strong>ã€‚</p><h4 id="è¯·æ±‚ä¸ºå…¶ä»–åª’ä½“ç±»å‹"><a href="#è¯·æ±‚ä¸ºå…¶ä»–åª’ä½“ç±»å‹" class="headerlink" title="è¯·æ±‚ä¸ºå…¶ä»–åª’ä½“ç±»å‹"></a>è¯·æ±‚ä¸ºå…¶ä»–åª’ä½“ç±»å‹</h4><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">  Map&lt;String, Object&gt; body = getErrorAttributes(request, isIncludeStackTrace(request, MediaType.ALL));</span><br><span class="line">  HttpStatus status = getStatus(request);</span><br><span class="line">  <span class="comment">// ç›´æ¥è¿”å›map</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(body, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="errorAttributes-é”™è¯¯é¡µé¢å±æ€§ä¿¡æ¯"><a href="#errorAttributes-é”™è¯¯é¡µé¢å±æ€§ä¿¡æ¯" class="headerlink" title="errorAttributes é”™è¯¯é¡µé¢å±æ€§ä¿¡æ¯"></a><code>errorAttributes</code> é”™è¯¯é¡µé¢å±æ€§ä¿¡æ¯</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(value = ErrorAttributes.class, search = SearchStrategy.CURRENT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultErrorAttributes <span class="title">errorAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> DefaultErrorAttributes(<span class="keyword">this</span>.serverProperties.getError().isIncludeException());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿™ä¸ªbeanä¸»è¦æ˜¯ä½¿ç”¨<code>getErrorAttributes</code>æä¾›<code>ErrorController</code>è¿”å›å€¼çš„ä¿¡æ¯ï¼Œå¦‚æœçŠ¶æ€ç ç­‰ã€‚ã€‚å¦‚æœæƒ³æ›´æ”¹é”™è¯¯ä¿¡æ¯çš„è¿”å›å€¼å†…å®¹ï¼Œå¯ä»¥ç»§æ‰¿<code>DefaultErrorAttributes</code>,ç„¶ååœ¨<code>getErrorAttributes</code>æ–¹æ³•é‡Œæ·»åŠ æƒ³è¦æ·»åŠ çš„å†…å®¹å³å¯ã€‚</p><h2 id="æ·»åŠ é”™è¯¯é¡µé¢å’Œä¿®æ”¹è¿”å›ä¿¡æ¯"><a href="#æ·»åŠ é”™è¯¯é¡µé¢å’Œä¿®æ”¹è¿”å›ä¿¡æ¯" class="headerlink" title="æ·»åŠ é”™è¯¯é¡µé¢å’Œä¿®æ”¹è¿”å›ä¿¡æ¯"></a>æ·»åŠ é”™è¯¯é¡µé¢å’Œä¿®æ”¹è¿”å›ä¿¡æ¯</h2><p>ä¸‹é¢å…·ä½“æ¥æ ¹æ®SpringBootç‰¹æ€§æ¥æ·»åŠ é”™è¯¯é¡µé¢ï¼Œå¦‚404ï¼Œ500ç­‰ã€‚</p><p>â€‹    å› ä¸ºåœ¨å¤„ç†æœºåˆ¶è¿™ç« é‡Œè¯´æ˜äº†SpringBootå¦‚ä½•å¤„ç†é”™è¯¯ï¼Œä»–ä¼šé»˜è®¤çš„è®¿é—®/error/åœ°å€ï¼Œå¹¶ä¸”å¦‚æœæ˜¯text/htmlçš„åª’ä½“ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç½‘é¡µè®¿é—®çš„è¯ï¼Œå¦‚æœæœ‰æ¨¡ç‰ˆå¼•æ“ï¼Œä»–ä¼šå»æ‰¾åœ¨<code>/error</code>æ–‡ä»¶ä¸­å¯¹åº”ç¼–ç çš„<code>xxx.html</code>é¡µé¢è¿›è€Œå»æ¸²æŸ“è¿™ä¸ªé¡µé¢ã€‚</p><p>â€‹    æ¯”å¦‚è®¿é—®404ï¼Œä»–ä¼šå»æ‰¾<code>classpath:/error/404.html</code>é¡µé¢å»æ¸²æŸ“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»–ä¼šå»æ‰¾<code>classpath:/error/4xx.html</code>ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œä»–ä¼šè¿”å›ä¸€ä¸ªé¡µé¢ã€‚</p><h3 id="æ·»åŠ erroré¡µé¢"><a href="#æ·»åŠ erroré¡µé¢" class="headerlink" title="æ·»åŠ erroré¡µé¢"></a>æ·»åŠ erroré¡µé¢</h3><p>â€‹    ä¸ºäº†æ¼”ç¤ºï¼Œåˆ›å»º<code>404.html</code>å’Œ<code>4xx.html</code>ï¼Œ<strong>æ¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„:å¦‚æœå‘ç”Ÿ404é”™è¯¯ï¼Œåˆ™è®¿é—®404.htmlé¡µé¢ï¼Œå¦‚æœå‘ç”Ÿ402æˆ–è€…ä»¥4å¼€å¤´çš„é”™è¯¯ï¼Œåˆ™è®¿é—®4xx.htmlé¡µé¢</strong>ã€‚</p><p>ç›®å½•ç»“æ„å’Œç¤ºä¾‹å†…å®¹å‚è€ƒå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190718192323.png" alt></p><h3 id="å®šä¹‰å¼‚å¸¸å’Œå¯¹åº”çš„å¼‚å¸¸å¤„ç†"><a href="#å®šä¹‰å¼‚å¸¸å’Œå¯¹åº”çš„å¼‚å¸¸å¤„ç†" class="headerlink" title="å®šä¹‰å¼‚å¸¸å’Œå¯¹åº”çš„å¼‚å¸¸å¤„ç†"></a>å®šä¹‰å¼‚å¸¸å’Œå¯¹åº”çš„å¼‚å¸¸å¤„ç†</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoAuthException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NoAuthException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"æ— æƒé™å¼‚å¸¸"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoUserExcetion</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NoUserExcetion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"æ— ç”¨æˆ·å¼‚å¸¸"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚å¸¸å¤„ç†ç±»</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyExecptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†NoAuthException å¼‚å¸¸</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = NoAuthException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerNoAuthException</span><span class="params">(HttpServletRequest request)</span></span>&#123;</span><br><span class="line">      <span class="comment">// è¿™æ˜¯å¿…é¡»çš„ï¼›å®šä¹‰è¿”å›çš„codeå€¼ï¼Œè¿”å›æŒ‡å®šçš„é”™è¯¯é¡µé¢</span></span><br><span class="line">        request.setAttribute(<span class="string">"javax.servlet.error.status_code"</span>,<span class="number">402</span>);</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"code"</span>,<span class="number">402</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>,<span class="string">"this is my no auth message"</span>);</span><br><span class="line">      <span class="comment">// å°†è‡ªå®šä¹‰ä¿¡æ¯æ”¾å…¥ requestä¸­</span></span><br><span class="line">        request.setAttribute(<span class="string">"errData"</span>,map);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forward:/error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//å¤„ç†NoUserExcetion å¼‚å¸¸</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = NoUserExcetion.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerNoUserException</span><span class="params">(HttpServletRequest request)</span></span>&#123;</span><br><span class="line">        request.setAttribute(<span class="string">"javax.servlet.error.status_code"</span>,<span class="number">400</span>);</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"code"</span>,<span class="number">404</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>,<span class="string">"this is my no auth message"</span>);</span><br><span class="line">        request.setAttribute(<span class="string">"errData"</span>,map);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forward:/error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// controllerç±»</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="string">"abc"</span>.equals(name))&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ /hello?name=abcçš„æ—¶å€™æŠ›å‡ºNoAuthExceptionå¼‚å¸¸ è·³è½¬åˆ°4xxé¡µé¢</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoAuthException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="string">"123"</span>.equals(name))&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ /hello?name=123çš„æ—¶å€™æŠ›å‡ºNoUserExcetionçš„å¼‚å¸¸ è·³è½¬åˆ°404é¡µé¢</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoUserExcetion();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="å®šä¹‰è‡ªå®šä¹‰å±æ€§ç±»"><a href="#å®šä¹‰è‡ªå®šä¹‰å±æ€§ç±»" class="headerlink" title="å®šä¹‰è‡ªå®šä¹‰å±æ€§ç±»"></a>å®šä¹‰è‡ªå®šä¹‰å±æ€§ç±»</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// æ”¾åˆ°å®¹å™¨ä¸­ï¼Œé»˜è®¤ä¼šæ›¿æ¢åˆ°springbootçš„é»˜è®¤çš„DefaultErrorAttributes</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyErrorAttributes</span> <span class="keyword">extends</span> <span class="title">DefaultErrorAttributes</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// è·å–DefaultErrorAttributesçš„åŸºæœ¬å±æ€§</span></span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">super</span>.getErrorAttributes(webRequest,includeStackTrace);</span><br><span class="line">        Map&lt;String,Object&gt; errData = (Map&lt;String, Object&gt;) webRequest.getAttribute(<span class="string">"errData"</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="comment">// ä»requestä¸­è·å–è‡ªå®šä¹‰çš„dataï¼Œæ·»åŠ åˆ°è¿”å›çš„ä¿¡æ¯ä¸­ã€‚</span></span><br><span class="line"> map.put(<span class="string">"errData"</span>,errData);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡ä»¥ä¸Šçš„è®¾ç½®ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><ul><li>å¦‚æœæ˜¯ /hello?name=abcçš„æ—¶å€™æŠ›å‡ºNoAuthExceptionå¼‚å¸¸ è·³è½¬åˆ°4xxé¡µé¢</li><li>å¦‚æœæ˜¯ /hello?name=123çš„æ—¶å€™æŠ›å‡ºNoUserExcetionçš„å¼‚å¸¸ è·³è½¬åˆ°404é¡µé¢</li><li>å¦‚æœæ²¡æœ‰è®¿é—®åœ°å€ä¹Ÿä¼šåˆ°404é¡µé¢</li></ul><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><ul><li>è®¿é—®/hello?name=abc è·³è½¬åˆ°4xxé¡µé¢</li></ul><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190718194227.png" alt="4xx"></p><ul><li>è®¿é—®/hello?name=123 è·³è½¬åˆ°404é¡µé¢</li></ul><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190718194426.png" alt="400"></p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>åœ¨è€ƒè™‘å¯¹webé”™è¯¯é¡µé¢å¤„ç†çš„è§’åº¦ï¼Œæ— éå°±æ˜¯ä¸¤ä¸ªæ–¹é¢ï¼š</p><h3 id="ä¸€ã€-é¡µé¢æ ·å¼"><a href="#ä¸€ã€-é¡µé¢æ ·å¼" class="headerlink" title="ä¸€ã€ é¡µé¢æ ·å¼"></a>ä¸€ã€ é¡µé¢æ ·å¼</h3><p>â€‹    åœ¨æœ‰æ¨¡ç‰ˆå¼•æ“çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡<code>DefaultErrorController</code>åœ¨<code>/error</code>ä¸Šçš„è®¿é—®å¤„ç†ï¼Œæ¥è‡ªåŠ¨æ¸²æŸ“åœ¨<code>template/error/</code>ç›®å½•ä¸‹çš„å¯¹åº”çš„<code>é”™è¯¯code.html</code>çš„çš„å±•ç¤º,å¦‚404.htmlã€‚å¹¶ä¸”æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚åˆ›å»º4xx.htmlé¡µé¢ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰å‘ç°ç‰¹å®šçš„é”™è¯¯ä»£ç é¡µé¢ï¼Œåˆ™è‡ªåŠ¨çš„ä½¿ç”¨4xxé¡µé¢ã€‚</p><h3 id="äºŒã€-é¡µé¢å†…å®¹"><a href="#äºŒã€-é¡µé¢å†…å®¹" class="headerlink" title="äºŒã€ é¡µé¢å†…å®¹"></a>äºŒã€ é¡µé¢å†…å®¹</h3><p>é¡µé¢å†…å®¹å¯ä»¥é€šè¿‡ç»§æ‰¿<code>DefaultErrorAttributes</code>ç±»æ¥è¿›è¡Œç®€å•çš„å®ç°ï¼Œå¦‚æœæƒ³å…¨éƒ¨æ›¿æ¢æ‰SpringBootçš„é»˜è®¤å…¨éƒ¨çš„è¿”å›å†…å®¹ï¼Œåˆ™éœ€è¦å®ç°<code>ErrorAttributes</code>è¿›è¡Œå®ç°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»æ”¾åˆ°å®¹å™¨ä¸­æ‰èƒ½ç”Ÿæ•ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†&quot;&gt;&lt;a href=&quot;#åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†&quot;&gt;&lt;/a&gt;åœ¨webå¼€å‘ä¸­çš„å¼‚å¸¸é”™è¯¯å¤„ç†&lt;/h1&gt;&lt;p&gt;SpringBooté»˜è®¤æœ‰ä¸€å¥—å¯¹webå¼€å‘é”™
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootçš„WEBå¼€å‘ä¹‹å›½é™…åŒ–</title>
    <link href="https://nanyiniu.github.io/2019/07/15/SpringBoot%E7%9A%84WEB%E5%BC%80%E5%8F%91%E4%B9%8B%E5%9B%BD%E9%99%85%E5%8C%96/"/>
    <id>https://nanyiniu.github.io/2019/07/15/SpringBootçš„WEBå¼€å‘ä¹‹å›½é™…åŒ–/</id>
    <published>2019-07-15T12:00:00.000Z</published>
    <updated>2019-08-12T05:27:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>SpringBooté»˜è®¤æ˜¯æ”¯æŒ<code>Thymeleaf</code>æ¨¡ç‰ˆå¼•æ“çš„ã€‚ç›¸åº”çš„å¦‚æœä½¿ç”¨<code>Thymeleaf</code>å°±å¯ä»¥ä½¿ç”¨thymeleafçš„è¯­æ³•åœ¨é¡µé¢æ˜¾ç¤ºè¿”å›ç»™é¡µé¢çš„æ•°æ®ã€‚</p><h2 id="ä½¿ç”¨thymeleaf"><a href="#ä½¿ç”¨thymeleaf" class="headerlink" title="ä½¿ç”¨thymeleaf"></a>ä½¿ç”¨thymeleaf</h2><h3 id="å¯¼å…¥starter"><a href="#å¯¼å…¥starter" class="headerlink" title="å¯¼å…¥starter"></a>å¯¼å…¥starter</h3><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190715214204.png" alt="autoConfig"></p><p>å¦‚å›¾ï¼ŒSpringBootè‡ªåŠ¨é…ç½®æ˜¯å¯¼å…¥æœ‰Thymeleafç›¸å…³è‡ªåŠ¨é…ç½®æ–‡ä»¶çš„ï¼Œä½†æ˜¯ï¼Œçº¢è‰²éƒ¨åˆ†æ˜¯ç¼ºå°‘çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´å°‘åŒ…ã€‚è‡ªç„¶SpringBootä¼šæä¾›è¿™äº›ç›¸å…³çš„åŒ…çš„starters.</p><p>é‚£ä¹ˆåœ¨å®˜ç½‘ä¸Šçš„startersä¸­å¯ä»¥æ‰¾åˆ°<code>spring-boot-starter-thymeleaf</code>ï¼Œè¯´æ˜SpringBootæä¾›Thymeleafçš„starteréœ€è¦å¯¼å…¥ï¼Œæ‰èƒ½ä½¿ç”¨<code>Thymeleaf</code>ã€‚</p><h3 id="åœ¨SpringBootä¸­Thymeleafçš„è‡ªåŠ¨é…ç½®"><a href="#åœ¨SpringBootä¸­Thymeleafçš„è‡ªåŠ¨é…ç½®" class="headerlink" title="åœ¨SpringBootä¸­Thymeleafçš„è‡ªåŠ¨é…ç½®"></a>åœ¨SpringBootä¸­Thymeleafçš„è‡ªåŠ¨é…ç½®</h3><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.thymeleaf"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThymeleafProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  charset</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_ENCODING = StandardCharsets.UTF_8;</span><br><span class="line"><span class="comment">// é»˜è®¤åŠ è½½æ¨¡ç‰ˆçš„è·¯å¾„</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PREFIX = <span class="string">"classpath:/templates/"</span>;</span><br><span class="line"><span class="comment">// é»˜è®¤åŠ è½½çš„æ–‡ä»¶ç±»å‹ æ˜¯html</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SUFFIX = <span class="string">".html"</span>;</span><br><span class="line"><span class="comment">// å¯è‡ªå·±ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ å‰ç¼€å’Œåç¼€ï¼Œå¦‚æœ spring.thymeleaf.suffix=.htmlx</span></span><br><span class="line"><span class="keyword">private</span> String prefix = DEFAULT_PREFIX;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String suffix = DEFAULT_SUFFIX;</span><br></pre></td></tr></table></figure></div><h3 id="ä½¿ç”¨Thymeleafè¿›è¡Œé¡µé¢æ¸²æŸ“"><a href="#ä½¿ç”¨Thymeleafè¿›è¡Œé¡µé¢æ¸²æŸ“" class="headerlink" title="ä½¿ç”¨Thymeleafè¿›è¡Œé¡µé¢æ¸²æŸ“"></a>ä½¿ç”¨Thymeleafè¿›è¡Œé¡µé¢æ¸²æŸ“</h3><p>æ‰€ä»¥åœ¨SpringBootä¸­åœ¨Controllerä¸­ä½¿ç”¨å¦‚ä¸‹ï¼š</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/home"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">home</span><span class="params">(Map&lt;String,String&gt; map)</span></span>&#123;</span><br><span class="line">        map.put(<span class="string">"hello"</span>,<span class="string">"Hello World~~~"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿™æ ·æ˜ å°„å™¨å°±ä¼šè‡ªåŠ¨æ˜ å°„åˆ°<code>classpath:/templates/home.html</code>æ–‡ä»¶ä¸Šã€‚</p><p>åœ¨templatesä¸‹å»ºç«‹home.htmlæ–‡ä»¶</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="HTML"><figure class="iseeu highlight /html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--å¼•å…¥ xmlns:th ç”¨äºthymeleafè¯­æ³•æç¤º--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"$&#123;hello&#125;"</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>é‡å¯åæŸ¥çœ‹<code>http://localhost:8080/home</code>å‘ç°å·²ç»å¯ä»¥è®© <code>/home</code> æ˜ å°„åˆ° <code>home.html</code> æ–‡ä»¶ä¸Šäº†ã€‚å¹¶ä¸”æ ¹æ®æˆ‘ä»¬ä¼ è¿‡æ¥çš„å€¼ <code>Hello World~~~</code> æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šäº†ã€‚</p><p>Thymeleafè¯­æ³•å¯ç›´æ¥å‚è€ƒå®˜æ–¹çš„<a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html" target="_blank" rel="noopener">æ–‡æ¡£</a>;</p><h2 id="ä½¿ç”¨SpringMVC"><a href="#ä½¿ç”¨SpringMVC" class="headerlink" title="ä½¿ç”¨SpringMVC"></a>ä½¿ç”¨SpringMVC</h2><p> SpringMvcæ¡†æ¶æ˜¯ä¸€ç§ä¸°å¯Œ<code>model view controller</code> çš„webæ¡†æ¶ã€‚SpringMVCé€šè¿‡ä½¿ç”¨ <code>@Controller</code> å’Œ <code>@RestController</code> å®Œæˆå¯¹ <code>HTTP</code> è¯·æ±‚çš„å¤„ç†ã€‚é€šè¿‡ä½¿ç”¨ <code>@RequestMapping</code> å®Œæˆå¯¹è¯·æ±‚å¯¹controllerçš„æ˜ å°„ã€‚</p><h3 id="è‡ªåŠ¨é…ç½®"><a href="#è‡ªåŠ¨é…ç½®" class="headerlink" title="è‡ªåŠ¨é…ç½®"></a>è‡ªåŠ¨é…ç½®</h3><p> <code>SpringBoot</code> å¯¹ <code>SpringMVC</code> åœ¨è‡ªåŠ¨é…ç½®çš„æ—¶å€™ï¼Œè¿›è¡Œäº†å¾ˆå¤šé»˜è®¤çš„è®¾ç½®ã€‚åŒ…æ‹¬å‰ä¸€ç¯‡æ–‡ç« ä¸­çš„å…³äºé™æ€èµ„æºåŠ è½½çš„ä¸¤ç§æ–¹å¼ï¼ˆ <code>Webjars</code> å’Œæœ¬åœ°åŠ è½½ä½ç½®ï¼‰ï¼Œä¹Ÿæ˜¯é€šè¿‡ <code>SpringBoot</code> è¿›è¡Œè‡ªåŠ¨é…ç½®çš„ã€‚æ›´å¤šçš„ <code>SpringBoot</code> å¯¹ <code>SpringMVC</code> åœ¨å“ªäº›åœ°æ–¹è¿›è¡Œäº†è‡ªåŠ¨é…ç½®ï¼Œå¯ä»¥å‚è€ƒæ–‡æ¡£ä¸­çš„<a href="RELEASE/reference/html/boot-features-developing-web-applications.html#boot-features-spring-mvc">SpringMVC ç‰¹æ€§</a>ã€‚</p><h3 id="è‡ªåŠ¨é…ç½®ä»£ç å‚è€ƒ"><a href="#è‡ªåŠ¨é…ç½®ä»£ç å‚è€ƒ" class="headerlink" title="è‡ªåŠ¨é…ç½®ä»£ç å‚è€ƒ"></a>è‡ªåŠ¨é…ç½®ä»£ç å‚è€ƒ</h3><p>æ‹¿ <code>ContentNegotiatingViewResolver</code>è¿™ä¸ªbeanæ¥è¯´ï¼ŒSpringMVCçš„è‡ªåŠ¨é…ç½®ç±»æ˜¯å¦‚ä½•å¯¹æ‹“å±•çš„æ”¯æŒã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(ViewResolver.class)</span><br><span class="line"><span class="comment">// å¦‚æœç±»è·¯å¾„ä¸­ä¸å­˜åœ¨ContentNegotiatingViewResolverè¿™ä¸ªç±»çš„æ—¶å€™</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"viewResolver"</span>, value = ContentNegotiatingViewResolver.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ContentNegotiatingViewResolver <span class="title">viewResolver</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line"><span class="comment">//  è¿”å›è¿™ä¸ªResolver</span></span><br><span class="line">    ContentNegotiatingViewResolver resolver = <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">    resolver.setContentNegotiationManager(beanFactory.getBean(ContentNegotiationManager.class));</span><br><span class="line">    <span class="comment">// ContentNegotiatingViewResolver uses all the other view resolvers to locate</span></span><br><span class="line">    <span class="comment">// a view so it should have a high precedence</span></span><br><span class="line">    resolver.setOrder(Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ContentNegotiatingViewResolver ç±»ä¸­çš„åˆå§‹åŒ–servletå®¹å™¨æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line"><span class="comment">// æ‰¾å‡ºæ‰€æœ‰çš„å®¹å™¨ä¸­çš„ViewResolver</span></span><br><span class="line">    Collection&lt;ViewResolver&gt; matchingBeans =</span><br><span class="line">            BeanFactoryUtils.beansOfTypeIncludingAncestors(obtainApplicationContext(), ViewResolver.class).values();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.viewResolvers = <span class="keyword">new</span> ArrayList&lt;&gt;(matchingBeans.size());</span><br><span class="line">        <span class="comment">// å¾ªç¯æ·»åŠ åˆ°viewResolverä¸­</span></span><br><span class="line">        <span class="keyword">for</span> (ViewResolver viewResolver : matchingBeans) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> != viewResolver) &#123;</span><br><span class="line">                <span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="comment">//å®ç°ViewResolverçš„å®ç°æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RequestAttributes attrs = RequestContextHolder.getRequestAttributes();</span><br><span class="line">    Assert.state(attrs <span class="keyword">instanceof</span> ServletRequestAttributes, <span class="string">"No current ServletRequestAttributes"</span>);</span><br><span class="line">    List&lt;MediaType&gt; requestedMediaTypes = getMediaTypes(((ServletRequestAttributes) attrs).getRequest());</span><br><span class="line">    <span class="keyword">if</span> (requestedMediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//  è·å–å€™é€‰çš„view</span></span><br><span class="line">        <span class="comment">// åœ¨getCandidateViewsè¿™ä¸ªæ–¹æ³•é‡Œå°±æ˜¯æŠŠå…¨å±€çš„viewResolverå¾ªç¯ä¸€é</span></span><br><span class="line">        List&lt;View&gt; candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes);</span><br><span class="line">        <span class="comment">// å¯»æ‰¾æœ€å¥½çš„/æœ€åˆé€‚çš„view</span></span><br><span class="line">        View bestView = getBestView(candidateViews, requestedMediaTypes, attrs);</span><br><span class="line">        <span class="keyword">if</span> (bestView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bestView;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡ä¸Šè¿°ä»£ç çš„æè¿°ï¼Œå¯ä»¥å‘ç°å¦‚æœè‡ªå·±å®ç°ViewResolverï¼Œåªéœ€è¦å®ç°ViewResolverååŠ å…¥åˆ°å®¹å™¨ä¸­å³å¯ã€‚SpringBootä¼šè‡ªåŠ¨è·å–å®¹å™¨ä¸­çš„ViewResoverã€‚</p><h3 id="å®šåˆ¶å¼€å‘"><a href="#å®šåˆ¶å¼€å‘" class="headerlink" title="å®šåˆ¶å¼€å‘"></a>å®šåˆ¶å¼€å‘</h3><p>å¦‚æœæƒ³ä¿ç•™ <code>SpringBoot</code> çš„MVCç‰¹æ€§ï¼Œå¹¶ä¸”æƒ³å»æ·»åŠ MVCé…ç½®å¦‚æ‹¦æˆªå™¨ï¼Œè§†å›¾æ§åˆ¶å™¨ç­‰ï¼Œä½ å¯ä»¥æ·»åŠ è‡ªå·±çš„é…ç½®ç±»ï¼Œå¹¶ä¸”ç»§æ‰¿<code>WebMvcConfigurer</code>,ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ä½¿ç”¨ <code>@EnableWebMvc</code> æ³¨è§£ã€‚å¦‚æœä½¿ç”¨ <code>@EnableWebMvc</code> æ³¨è§£ï¼Œåˆ™è¡¨ç¤ºè¦ä½ å…¨é¢æ¥ç®¡SpringMvcé…ç½®åŠŸèƒ½ï¼Œä¸ä½¿ç”¨SpringBootè‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ã€‚</p><ol><li>ä½¿ç”¨beançš„æ–¹å¼ï¼Œè®© <code>InnerViewResolver</code> è‡ªåŠ¨å‘ç°å®¹å™¨ä¸­çš„ViewResolver</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@EnableWebMvc // ä½¿ç”¨è¿™ä¸ªæ³¨è§£è¡¨ç¤ºå®Œå…¨ä¸å®ç”¨SpringBootå¯¹SpringMVCçš„è‡ªåŠ¨é…ç½®åŠŸèƒ½ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyViewResolver <span class="title">myViewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyViewResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InnerViewResolver</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><p>è¿™æ ·å°†ä¸€ä¸ªViewResolveræ”¾åˆ°å®¹å™¨ä¸­ï¼Œé‚£ä¹ˆå‰é¢è¯´åˆ°çš„ <code>InnerViewResolver</code> ä¼šè‡ªåŠ¨çš„å‘ç°è¿™ä¸ªbeanæ¥ä½¿ç”¨ã€‚</p><ol start="2"><li>ä½¿ç”¨ <code>WebMvcConfigurer</code> å®ç°</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        registry.viewResolver(<span class="keyword">new</span> InnerViewResolver());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addRedirectViewController(<span class="string">"/index"</span>,<span class="string">"/home"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ViewResolverRegistry ç±»ä¸­çš„viewResolveræ–¹æ³•ï¼Œç›´æ¥æ·»åŠ åˆ°å…¨å±€å˜é‡ viewResolversä¸­ï¼Œä»£æ›¿å‰é¢çš„éå†</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">viewResolver</span><span class="params">(ViewResolver viewResolver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (viewResolver <span class="keyword">instanceof</span> ContentNegotiatingViewResolver) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(</span><br><span class="line">                <span class="string">"addViewResolver cannot be used to configure a ContentNegotiatingViewResolver. "</span> +</span><br><span class="line">                <span class="string">"Please use the method enableContentNegotiation instead."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ç»§æ‰¿WebMvcConfigurerä½¿ç”¨ç»§æ‰¿æ–¹æ³•ï¼Œå°†ç±»æ”¾åˆ°å®¹å™¨ä¸­ã€‚</p><h1 id="å›½é™…åŒ–å¼€å‘"><a href="#å›½é™…åŒ–å¼€å‘" class="headerlink" title="å›½é™…åŒ–å¼€å‘"></a>å›½é™…åŒ–å¼€å‘</h1><p>ä¸‹é¢ä»è‡ªåŠ¨é…ç½®å…¥æ‰‹ï¼Œæ¥çœ‹SpringBootæ˜¯æ€ä¹ˆé…ç½®å›½é™…åŒ–çš„ã€‚</p><h2 id="è®©SpringBooté…ç½®æŒ‡å®šå›½é™…åŒ–æ–‡ä»¶"><a href="#è®©SpringBooté…ç½®æŒ‡å®šå›½é™…åŒ–æ–‡ä»¶" class="headerlink" title="è®©SpringBooté…ç½®æŒ‡å®šå›½é™…åŒ–æ–‡ä»¶"></a>è®©SpringBooté…ç½®æŒ‡å®šå›½é™…åŒ–æ–‡ä»¶</h2><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Resource[] NO_RESOURCES = &#123;&#125;;</span><br><span class="line"><span class="comment">// åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥è¿›è¡Œé…ç½®çš„å†…å®¹ ä»¥spring.messageå¼€å¤´</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.messages"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSourceProperties <span class="title">messageSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> MessageSourceProperties();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***********************MessageSourceProperties**********************/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageSourceProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥é€—å·åˆ†éš”çš„åŸºæœ¬åç§°åˆ—è¡¨ æ¯ä¸€ä¸ªéƒ½æ˜¯åœ¨å®Œæ•´çš„è·¯å¾„ä¸‹åŠ è½½ï¼Œæ¯”å¦‚ i18n.home,i18n.helloè¿™æ ·</span></span><br><span class="line"><span class="comment">   * å¦‚æœåœ¨ç±»è·¯å¾„ä¸Šï¼Œå°±å»æ‰i18n.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String basename = <span class="string">"messages"</span>;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœå¯¹<code>basename</code>çš„å€¼çš„è®¾ç½®ä»æœ‰ç–‘æƒ‘ï¼Œé‚£æ¥ç›´æ¥çœ‹è§£æ<code>basename</code>çš„ä»£ç ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConditionOutcome <span class="title">getMatchOutcome</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å¾—propertiesfä¸­çš„spring.messages.basenameå±æ€§ï¼Œå¦‚æœæ²¡æœ‰é»˜è®¤æ˜¯messages</span></span><br><span class="line">String basename = context.getEnvironment().getProperty(<span class="string">"spring.messages.basename"</span>, <span class="string">"messages"</span>);</span><br><span class="line">ConditionOutcome outcome = cache.get(basename);</span><br><span class="line"><span class="keyword">if</span> (outcome == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨æ–¹æ³•è§£æbasename</span></span><br><span class="line">outcome = getMatchOutcomeForBasename(context, basename);</span><br><span class="line">cache.put(basename, outcome);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> outcome;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ConditionOutcome <span class="title">getMatchOutcomeForBasename</span><span class="params">(ConditionContext context, String basename)</span> </span>&#123;</span><br><span class="line">ConditionMessage.Builder message = ConditionMessage.forCondition(<span class="string">"ResourceBundle"</span>);</span><br><span class="line"><span class="keyword">for</span> (String name : StringUtils.commaDelimitedListToStringArray(StringUtils.trimAllWhitespace(basename))) &#123;</span><br><span class="line">      <span class="comment">// å°†basenameä»¥é€—å·åˆ†éš”ï¼Œå¾ªç¯è¿™ä¸ªæ•°ç»„</span></span><br><span class="line"><span class="keyword">for</span> (Resource resource : getResources(context.getClassLoader(), name)) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„getResourceæ–¹æ³• æ˜¯åŠ è½½classpath + name + .propertiesä¸­çš„å†…å®¹</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å›½é™…åŒ–æ–‡ä»¶åªæ”¯æŒ propertiesæ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶ä¸æ”¯æŒ</span></span><br><span class="line">        <span class="comment">// return new PathMatchingResourcePatternResolver(classLoader)</span></span><br><span class="line"><span class="comment">// .getResources("classpath*:" + target + ".properties");</span></span><br><span class="line"><span class="keyword">if</span> (resource.exists()) &#123;</span><br><span class="line">          <span class="comment">// å¯¹æ¯ä¸€ä¸ªè·å–Resource æ–°å»ºä¸€ä¸ªmatchå®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> ConditionOutcome.match(message.found(<span class="string">"bundle"</span>).items(resource));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ConditionOutcome.noMatch(message.didNotFind(<span class="string">"bundle with basename "</span> + basename).atAll());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="å›½é™…åŒ–æ­¥éª¤"><a href="#å›½é™…åŒ–æ­¥éª¤" class="headerlink" title="å›½é™…åŒ–æ­¥éª¤"></a>å›½é™…åŒ–æ­¥éª¤</h2><p>ä¸Šé¢é€šè¿‡å¯¹SpringBootå¯¹å›½é™…åŒ–çš„é…ç½®çš„åˆ†æï¼ŒçŸ¥é“äº†åœ¨propertiesæ–‡ä»¶ä¸­æ€ä¹ˆæ›´æ”¹å›½é™…åŒ–æ–‡ä»¶çš„é…ç½®ä¿¡æ¯ã€‚ä¸‹é¢æ¥å…·ä½“æ“ä½œï¼Œè¿›è¡Œå›½é™…åŒ–ã€‚</p><h3 id="é»˜è®¤çš„å›½é™…åŒ–"><a href="#é»˜è®¤çš„å›½é™…åŒ–" class="headerlink" title="é»˜è®¤çš„å›½é™…åŒ–"></a>é»˜è®¤çš„å›½é™…åŒ–</h3><h4 id="åˆ›å»ºå›½é™…åŒ–çš„properties"><a href="#åˆ›å»ºå›½é™…åŒ–çš„properties" class="headerlink" title="åˆ›å»ºå›½é™…åŒ–çš„properties"></a>åˆ›å»ºå›½é™…åŒ–çš„properties</h4><p>åœ¨resourcesæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹<code>i18n</code> ,åœ¨æ–‡ä»¶å¤¹ä¸‹å³é”®åˆ›å»º<code>Resource Bundle</code> æ–‡ä»¶ã€‚</p><p><img src="https://i.loli.net/2019/07/16/5d2dc701793f461130.png" alt="resource"></p><p>å·¦è¾¹<code>project locale</code>ä¸­æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œdefaultå’Œè‡ªå·±æ·»åŠ çš„<code>zh_CN</code>å’Œ<code>en_US</code>åˆ†åˆ«è¡¨ç¤ºä¸­æ–‡å’Œè‹±æ–‡ã€‚ç‚¹å‡»<code>add All</code>åç¡®è®¤ï¼Œåˆ›å»ºæ–‡ä»¶ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://i.loli.net/2019/07/16/5d2dc7ca2479570179.png" alt></p><p>åŒå‡»å…¶ä¸­çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¯”å¦‚<code>index.properties</code>ï¼Œä½¿ç”¨ideaå¯ä»¥å‘ç°ç¼–è¾‘åŒºçš„å·¦ä¸‹è§’æœ‰ä¸€ä¸ª<code>Resource Bundle</code> tabé¡µï¼Œç‚¹å‡»ä¹‹åï¼Œæ¥åˆ°å¦‚ä¸‹å›¾çš„ç•Œé¢ï¼Œæ–°å»ºä¸€ä¸ªé€‰é¡¹ï¼Œè¾“å…¥å„é…ç½®æ–‡ä»¶ä¸­çš„å€¼ã€‚</p><p><img src="https://i.loli.net/2019/07/16/5d2dc82af114521374.png" alt></p><h4 id="åˆ›å»ºcontrollerå’Œhtmlé¡µé¢"><a href="#åˆ›å»ºcontrollerå’Œhtmlé¡µé¢" class="headerlink" title="åˆ›å»ºcontrollerå’Œhtmlé¡µé¢"></a>åˆ›å»ºcontrollerå’Œhtmlé¡µé¢</h4><ol><li><p>åˆ›å»º<code>controller</code></p> <div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/index"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p>åˆ›å»º<code>html</code>é¡µé¢</p> <div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="HTML"><figure class="iseeu highlight /html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">--</span> ä½¿ç”¨<span class="attr">th:text</span>ä¼šæ›¿æ¢æ ‡ç­¾å†…çš„æ–‡æœ¬å†…å®¹ ä½¿ç”¨#&#123;&#125;æ¥è¡¨ç¤ºå›½é™…åŒ–å†…å®¹<span class="attr">--</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"#&#123;index&#125;"</span>&gt;</span>è¿™é‡Œæ˜¯ä¸»é¡µ<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></li></ol><p>é‡å¯ç¨‹åºï¼Œå‘ç°indexé¡µé¢ä¸Šæ˜¾ç¤ºçš„æ˜¯<code>ä¸»é¡µ</code>ï¼Œè¿™ä¸ªå†…å®¹ï¼Œæ­£å¥½æ˜¯åœ¨index_zh_CN.propertiesä¸­å®šä¹‰çš„<code>index</code>çš„å€¼ã€‚SpringBootä¼šæ ¹æ®è¯·æ±‚å¤´ä¸­çš„è¯­è¨€æ¥åˆ¤æ–­ä½¿ç”¨å“ªä¸ªé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</p><h4 id="å¦‚ä½•åˆ‡æ¢é¡µé¢çš„ä¸­è‹±æ–‡ï¼Ÿ"><a href="#å¦‚ä½•åˆ‡æ¢é¡µé¢çš„ä¸­è‹±æ–‡ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ‡æ¢é¡µé¢çš„ä¸­è‹±æ–‡ï¼Ÿ"></a>å¦‚ä½•åˆ‡æ¢é¡µé¢çš„ä¸­è‹±æ–‡ï¼Ÿ</h4><p>åœ¨<code>dispatcherServlet</code>ä¸­åœ¨æ¸²æŸ“è§†å›¾çš„æ—¶å€™ï¼Œä¼šé€šè¿‡<code>locale</code>çš„å±æ€§æ¥æ”¹å˜æ¸²æŸ“åçš„è¯­è¨€ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// å¯ä»¥é€šè¿‡è¯·æ±‚çš„localeæ¥å®šä¹‰è¿”å›çš„locale</span></span><br><span class="line">Locale locale =</span><br><span class="line">(<span class="keyword">this</span>.localeResolver != <span class="keyword">null</span> ? <span class="keyword">this</span>.localeResolver.resolveLocale(request) : request.getLocale());</span><br><span class="line">response.setLocale(locale);</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡debugå‘ç°<code>this.localeResolver</code>ä¸­æ˜¯æœ‰å€¼çš„ï¼Œè¯´æ˜<code>Spring</code>å®¹å™¨ä¸­æœ‰localeResolver,è¿›è€Œå¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong><code>SpringBoot</code>ä¸­è‡ªåŠ¨é…ç½®æ¥é»˜è®¤çš„<code>localeResover</code>ã€‚</strong></p><p><img src="https://i.loli.net/2019/07/16/5d2dd26ac0a7a43943.png" alt="è®¡ç®—"></p><p>åœ¨<code>WebMvcAutoConfiguration</code>ä¸­çš„ç¡®é…ç½®äº†å…³äºlocaleçš„ä¿¡æ¯ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.mvc"</span>, name = <span class="string">"locale"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.mvcProperties.getLocaleResolver() == WebMvcProperties.LocaleResolver.FIXED) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FixedLocaleResolver(<span class="keyword">this</span>.mvcProperties.getLocale());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¾ç½®äº† å®¹å™¨ä¸­çš„localeResolver ä¸º AcceptHeaderLocaleResolver</span></span><br><span class="line">  AcceptHeaderLocaleResolver localeResolver = <span class="keyword">new</span> AcceptHeaderLocaleResolver();</span><br><span class="line">  localeResolver.setDefaultLocale(<span class="keyword">this</span>.mvcProperties.getLocale());</span><br><span class="line">  <span class="keyword">return</span> localeResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å› ä¸ºé…ç½®äº†é»˜è®¤çš„<code>localeResolver</code> ,æ‰€ä»¥åœ¨ä½¿ç”¨<code>this.localeResolver.resolveLocale(request)</code>å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå°±ä¼šä½¿ç”¨<code>AcceptHeaderLocaleResolver</code>ç±»ä¸­çš„æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ­£æ˜¯æ‹¿çš„<code>request</code>ä¸­çš„<code>Accept-Language</code></p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">Locale defaultLocale = getDefaultLocale();</span><br><span class="line"><span class="keyword">if</span> (defaultLocale != <span class="keyword">null</span> &amp;&amp; request.getHeader(<span class="string">"Accept-Language"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// ä»requestä¸­æ‹¿Accept-Languageè¿™ä¸ªå€¼ã€‚</span></span><br><span class="line">Locale requestLocale = request.getLocale();</span><br><span class="line">List&lt;Locale&gt; supportedLocales = getSupportedLocales();</span><br><span class="line"><span class="keyword">if</span> (supportedLocales.isEmpty() || supportedLocales.contains(requestLocale)) &#123;</span><br><span class="line"><span class="keyword">return</span> requestLocale;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿™æ ·çš„è¯ç–‘æƒ‘å°±è§£å¼€äº†ï¼Œ<strong>é»˜è®¤çš„SpringBootæ„ä»¶webåº”ç”¨ä¼šä½¿ç”¨å½“å‰æµè§ˆå™¨çš„åœ°åŒºè¯­è¨€æ¥è¿›è¡Œå›½é™…åŒ–ã€‚</strong></p><h3 id="æ”¹å˜å›½é™…åŒ–è¯­è¨€æ ‡å‡†çš„åˆ¤æ–­æ–¹å¼"><a href="#æ”¹å˜å›½é™…åŒ–è¯­è¨€æ ‡å‡†çš„åˆ¤æ–­æ–¹å¼" class="headerlink" title="æ”¹å˜å›½é™…åŒ–è¯­è¨€æ ‡å‡†çš„åˆ¤æ–­æ–¹å¼"></a>æ”¹å˜å›½é™…åŒ–è¯­è¨€æ ‡å‡†çš„åˆ¤æ–­æ–¹å¼</h3><p>ä¸Šé¢è¯´äº†é»˜è®¤çš„<code>SpringBoot</code>ä¼šä»<code>request</code>ä¸­è·å–åœ°åŒºè¯­è¨€ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­åŠ è½½å“ªä¸ªé…ç½®ã€‚</p><p>åœ¨è‡ªåŠ¨é…ç½®çš„æ–¹æ³•ä¸Šæ ‡æ³¨ç€è¿™æ ·ä¸€æ®µ<code>@ConditionalOnMissingBean</code>,è¯´æ˜å¦‚æœæœ‰<code>localeResolver</code>è¿™ä¸ªç±»é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚æ‰€ä»¥æ”¹å˜çš„æ–¹æ³•å°±æ˜¯è‡ªå·±å®ç°<code>localeResolver</code>.</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocalResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Locale defaultLocale;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Locale defaultLocale = getDefaultLocale();</span><br><span class="line">        String language = request.getParameter(<span class="string">"language"</span>);</span><br><span class="line">      <span class="comment">// è·å–è¯·æ±‚ä¸­çš„ ?language=ã€Œxxxã€ </span></span><br><span class="line">        String[] s = <span class="keyword">new</span> String[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span>(language != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(language))&#123;</span><br><span class="line">            s = getS(language);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ˜¯ç©ºåˆ™æ‰¾æµè§ˆå™¨ä¸­çš„å±æ€§</span></span><br><span class="line">            String header = getFirstLangInRequest(request);</span><br><span class="line">            <span class="keyword">if</span>(header!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(header))&#123;</span><br><span class="line">                s = getS(header);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//å¦åˆ™ç»™ä¸ªé»˜è®¤çš„local</span></span><br><span class="line">                s = getS(<span class="string">"zh-CN"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        defaultLocale = <span class="keyword">new</span> Locale(s[<span class="number">0</span>],s[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> defaultLocale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getFirstLangInRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request.getHeader(<span class="string">"Accept-Language"</span>).split(<span class="string">","</span>)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] getS(String language) &#123;</span><br><span class="line">        <span class="keyword">return</span> language.split(<span class="string">"-"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Locale <span class="title">getDefaultLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ·»åŠ åˆ°beanä¸­ æ–¹æ³•åç§°å¿…é¡»æ˜¯localeResolver æˆ–è€…æŒ‡å®šbeançš„åç§°ä¸ºlocaleResolver</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyLocalResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ç¨å¾®ä¿®æ”¹ä¸€ä¸‹<code>index.html</code>ä¸­çš„å†…å®¹</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="HTML"><figure class="iseeu highlight /html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"#&#123;index&#125;"</span>&gt;</span>è¿™é‡Œæ˜¯ä¸»é¡µ<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">--</span> ç‚¹å‡»æŒ‰é’®æ—¶å˜æ¢ä¸­è‹±æ–‡ <span class="attr">--</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/index(language='zh-CN')&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:text</span>=<span class="string">"#&#123;but1&#125;"</span> &gt;</span>è¿™æ˜¯åˆ‡æ¢ä¸­æ–‡çš„æŒ‰é’®<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/index(language='en-US')&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:text</span>=<span class="string">"#&#123;but2&#125;"</span> &gt;</span>è¿™æ˜¯åˆ‡æ¢è‹±æ–‡çš„æŒ‰é’®<span class="tag">&lt;/<span class="name">button</span>&gt;</span> <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>é‡å¯ç¨‹åºï¼Œè¿›è¡Œæµ‹è¯•ï¼š</p><p><img src="https://i.loli.net/2019/07/16/5d2ded6219ee739593.gif" alt="æµ‹è¯•æˆæœ"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="å¦‚ä½•åœ¨SpringBootä¸­ä½¿ç”¨å›½é™…åŒ–"><a href="#å¦‚ä½•åœ¨SpringBootä¸­ä½¿ç”¨å›½é™…åŒ–" class="headerlink" title="å¦‚ä½•åœ¨SpringBootä¸­ä½¿ç”¨å›½é™…åŒ–"></a>å¦‚ä½•åœ¨SpringBootä¸­ä½¿ç”¨å›½é™…åŒ–</h4><ol><li>ç¼–å†™å›½é™…åŒ–ç›¸å…³çš„ <code>ResourceBundle</code>æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„è¯­è¨€é…ç½®æ–‡ä»¶å¦‚ï¼š<code>index_en_US.properties</code>,<code>index_zh_CN.properties</code>ï¼Œæ³¨æ„è¿™ä¸ª<strong>æ–‡ä»¶æ ¼å¼æ˜¯å›ºå®šçš„<code>xxx_è¯­è¨€ä»£ç _å¤§å†™çš„å›½å®¶ä»£ç </code>ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯propertiesæ–‡ä»¶</strong>ã€‚</li><li>ç¼–å†™<code>html</code>æ¥æ”¶å›½é™…åŒ–å˜é‡ï¼Œä½¿ç”¨<code>Thymeleaf</code>å¼•æ“å¯ä»¥ä½¿ç”¨è¯­æ³•<code>#{}</code>æ¥ä½¿ç”¨å›½é™…åŒ–å˜é‡ã€‚</li></ol><h4 id="å¦‚ä½•æ”¹é€ "><a href="#å¦‚ä½•æ”¹é€ " class="headerlink" title="å¦‚ä½•æ”¹é€ "></a>å¦‚ä½•æ”¹é€ </h4><p>å› ä¸ºSpringBooté»˜è®¤å®ç°äº†<code>LocaleResolver</code>,å¹¶ä¸”æ ‡æ³¨äº†<code>ConditionalOnMissingBean</code>æ³¨è§£ï¼Œæ‰€ä»¥ï¼Œåªéœ€è¦è‡ªå·±å®ç°<code>LocaleResolver</code>ç±»ï¼Œé‡å†™ç›¸å…³æ–¹æ³•ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”¹é€ çš„ç›®çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>åœ¨æ³¨å†Œ<code>bean</code>çš„æ—¶å€™ï¼Œæ–¹æ³•åå¿…é¡»<code>localeResolver</code>,æˆ–è€…æŒ‡å®š<code>bean</code>çš„åç§°ä¸º<code>localeResolver</code>ã€‚</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h1&gt;&lt;p&gt;SpringBooté»˜è®¤æ˜¯æ”¯æŒ&lt;code&gt;Thymeleaf&lt;/code&gt;æ¨¡ç‰ˆå¼•æ“çš„ã€‚ç›¸åº”çš„å¦‚æœä½¿ç”¨&lt;code&gt;Thymel
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootçš„WEBå¼€å‘ä¹‹Hello-World</title>
    <link href="https://nanyiniu.github.io/2019/07/13/2019-07-13-SpringBoot%E7%9A%84WEB%E5%BC%80%E5%8F%91/"/>
    <id>https://nanyiniu.github.io/2019/07/13/2019-07-13-SpringBootçš„WEBå¼€å‘/</id>
    <published>2019-07-13T12:00:00.000Z</published>
    <updated>2019-08-12T05:27:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨"><a href="#åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨" class="headerlink" title="åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨"></a>åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨</h1><p>SpringBootå¯ä»¥å¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªrestfulçš„webåº”ç”¨ã€‚ä¸‹é¢å¼€å§‹ä»é›¶å¼€å§‹åˆ›å»ºä¸€å¥—åŸºæœ¬çš„webåº”ç”¨ã€‚</p><h2 id="ä½¿ç”¨ideaåˆ›å»ºSpring-initializr"><a href="#ä½¿ç”¨ideaåˆ›å»ºSpring-initializr" class="headerlink" title="ä½¿ç”¨ideaåˆ›å»ºSpring initializr"></a>ä½¿ç”¨ideaåˆ›å»º<code>Spring initializr</code></h2><p>æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨ideaä¸­çš„<code>Spring initializr</code> æ¥åˆ›å»ºSpringBootåº”ç”¨ã€‚åŒç†å¯ä»¥ä½¿ç”¨<a href="https://start.spring.io" target="_blank" rel="noopener">start.spring.io</a>ä¸­ã€‚åˆ›å»ºå®Œæˆåç›´æ¥åœ¨IDEä¸­å¯¼å…¥å³å¯ã€‚</p><ol><li>éœ€è¦åœ¨ideaä¸­æ–°å»ºé¡¹ç›®</li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713104139.png" alt="æ–°å»ºé¡¹ç›®"></p><ol start="2"><li>å¡«å†™é¡¹ç›®çš„åŸºæœ¬ä¿¡æ¯ </li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713104731.png" alt="åŸºæœ¬ä¿¡æ¯"></p><ol start="3"><li>å‹¾é€‰éœ€è¦çš„ä¾èµ–</li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713104941.png" alt="å‹¾é€‰ä¾èµ–"></p><ol start="4"><li>æœ€åç‚¹å‡»finishå®Œæˆåˆ›å»ºã€‚</li></ol><h2 id="æ–‡æ¡£ç»“æ„è¯´æ˜"><a href="#æ–‡æ¡£ç»“æ„è¯´æ˜" class="headerlink" title="æ–‡æ¡£ç»“æ„è¯´æ˜"></a>æ–‡æ¡£ç»“æ„è¯´æ˜</h2><div><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713105737.png" style="zoom:50%"></div><p>æ–°å»ºSpringBootåº”ç”¨åè‡ªåŠ¨åˆ›å»ºçš„ç›®å½•ç»“æ„å¦‚å¦‚ä¸Šå›¾ï¼Œå…¶ä¸­SpringBootå¯åŠ¨ç±»<code>StartSpringBootApplication</code>æ”¾åœ¨<code>java/com/example/start</code>æ–‡ä»¶å¤¹ä¸­ï¼Œç”¨äºå¯åŠ¨æ•´ä¸ªé¡¹ç›®ã€‚</p><p>å¯¹äºèµ„æºæ–‡ä»¶ï¼ŒSpringBootç»™å‡ºæ¥ä¸€å¥—ç›®å½•æ ‡å‡†ã€‚</p><p>resourceæ–‡ä»¶å¤¹ä¸­çš„application.properteisä¸ºæ•´ä½“çš„SpringBooté…ç½®æ–‡ä»¶ã€‚å…¶ä¸­æœ‰staticå’Œtemplatesç›®å½•ã€‚</p><ul><li>static æ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾é™æ€èµ„æºï¼Œå¦‚jsï¼Œcss</li><li>templates æ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾æ¨¡ç‰ˆæ–‡ä»¶ï¼Œå¦‚jsp,html</li></ul><p>é‚£ä¹ˆSpringBootæ˜¯å¦‚ä½•å»ºç«‹è¿™äº›ç›®å½•æ–‡ä»¶æ ‡å‡†çš„å‘¢ï¼Ÿ</p><h3 id="webç›®å½•ç›¸å…³çš„è‡ªåŠ¨é…ç½®"><a href="#webç›®å½•ç›¸å…³çš„è‡ªåŠ¨é…ç½®" class="headerlink" title="webç›®å½•ç›¸å…³çš„è‡ªåŠ¨é…ç½®"></a>webç›®å½•ç›¸å…³çš„è‡ªåŠ¨é…ç½®</h3><p>webç›®å½•ç›¸å…³çš„è‡ªåŠ¨é…ç½®æ˜¯åœ¨<code>WebMvcAutoConfiguration</code>è‡ªåŠ¨é…ç½®ç±»ä¸­è¿›è¡Œé…ç½®ã€‚è€Œå¯¹èµ„æºçš„åŠ è½½ä½¿ç”¨çš„æ˜¯<code>addResourceHandler</code> æ–¹æ³•</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ç”¨é»˜è®¤èµ„æºå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Default resource handling disabled"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–èµ„æºå¤„ç†ç¨‹åºæ‰€æœåŠ¡èµ„æºçš„ç¼“å­˜å‘¨æœŸ</span></span><br><span class="line">    Duration cachePeriod = <span class="keyword">this</span>.resourceProperties.getCache().getPeriod();</span><br><span class="line">    CacheControl cacheControl = <span class="keyword">this</span>.resourceProperties.getCache().getCachecontrol().toHttpCacheControl();</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜ å°„å™¨è¿˜æœªæ˜ å°„åˆ°/webjars/** åˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.hasMappingForPattern(<span class="string">"/webjars/**"</span>)) &#123;</span><br><span class="line">    <span class="comment">//  æ·»åŠ å¯¹/webjars/** çš„èµ„æºæ˜ å°„</span></span><br><span class="line">        customizeResourceHandlerRegistration(registry.addResourceHandler(<span class="string">"/webjars/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"classpath:/META-INF/resources/webjars/"</span>)</span><br><span class="line">                <span class="comment">// åŠ è½½åŒ…ä¸‹çš„ /META-INF/resources/webjars/ ä¸‹çš„å†…å®¹</span></span><br><span class="line">                .setCachePeriod(getSeconds(cachePeriod)).setCacheControl(cacheControl));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é™æ€è·¯å¾„pattern ä¸º "/**"</span></span><br><span class="line">    String staticPathPattern = <span class="keyword">this</span>.mvcProperties.getStaticPathPattern();</span><br><span class="line">    <span class="keyword">if</span> (!registry.hasMappingForPattern(staticPathPattern)) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜ å°„å™¨è¿˜æ²¡æœ‰æ˜ å°„ /** è·¯å¾„çš„èµ„æºæ—¶</span></span><br><span class="line">        customizeResourceHandlerRegistration(registry.addResourceHandler(staticPathPattern)</span><br><span class="line">        <span class="comment">// åŠ è½½æ‰€æœ‰çš„é»˜è®¤å®šä¹‰çš„ä½ç½®é‡Œçš„èµ„æºã€‚</span></span><br><span class="line">                .addResourceLocations(getResourceLocations(<span class="keyword">this</span>.resourceProperties.getStaticLocations()))</span><br><span class="line">                .setCachePeriod(getSeconds(cache</span><br><span class="line">                Period)).setCacheControl(cacheControl));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="webjars"><a href="#webjars" class="headerlink" title="webjars"></a>webjars</h4><p>WebJarsæ˜¯æ‰“åŒ…åˆ°JARï¼ˆJava Archiveï¼‰æ–‡ä»¶ä¸­çš„å®¢æˆ·ç«¯Webåº“ï¼ˆä¾‹å¦‚jQueryå’ŒBootstrapï¼‰ã€‚</p><p>from <a href="https://www.webjars.org" target="_blank" rel="noopener">webjarså®˜ç½‘</a></p><p>æ ¹æ®ä»¥ä¸Šå†…å®¹ä¸¾ä¸ªä¾‹å­æ¥è®²è§£å¦‚ä½•ä½¿ç”¨webjarsè¿›è¡Œé™æ€èµ„æºçš„åŠ è½½ï¼š</p><ol><li>å»å®˜ç½‘æ‰¾ç›¸å…³èµ„æºçš„ä¾èµ–</li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713113630.png" alt="ä¾èµ–"></p><ol start="2"><li>æ·»åŠ åˆ°pom.xmlæ–‡ä»¶ä¸­</li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713114028.png" alt="webjar"></p><p>ä»¥ç²‰è‰²çš„ç«–çº¿ä¸ºåˆ†å‰²çº¿ï¼Œå·¦ä¾§ä¸ºä¸‹è½½å®Œçš„webjarsçš„jaråŒ…ï¼Œå³ä¾§ä¸ºåœ¨pom.xmlæ–‡ä»¶ä¸­çš„ä¾èµ–ä¿¡æ¯ã€‚</p><h5 id="åŠ è½½webjars"><a href="#åŠ è½½webjars" class="headerlink" title="åŠ è½½webjars"></a>åŠ è½½webjars</h5><p>å¦‚æœSpringBootå‘ç°æœ‰webjarçš„åº”ç”¨jaråŒ…ï¼Œåˆ™<strong>åŠ è½½è·¯å¾„<code>classpath:/META-INF/resources/webjars/</code>ä¸‹çš„æ–‡ä»¶</strong>ã€‚åœ¨å›¾ä¸­ä¾‹å­ä¸­å°±æ˜¯<code>jquery</code>æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚è¿™æ ·SpringBootå°±èƒ½å¤Ÿè¯†åˆ«jqueryåŒ…ä¸‹çš„æ‰€æœ‰é™æ€æ–‡ä»¶äº†ã€‚</p><h5 id="æ˜ å°„webjars"><a href="#æ˜ å°„webjars" class="headerlink" title="æ˜ å°„webjars"></a>æ˜ å°„webjars</h5><p>SpringBootä¼šå°†æ‰€æœ‰å·²å°†åŠ è½½jarsæ˜ å°„åˆ° <code>/webjars/**</code> è¿™ä¸ªè·¯å¾„ä¸Šã€‚</p><p>æ¯”å¦‚ä¸Šé¢æˆ‘ä»¬æ·»åŠ äº†jquery.min.jsã€‚æˆ‘ä»¬å¯åŠ¨ç¨‹åºï¼Œå¯ä»¥åœ¨<code>http://localhost:8080/webjars/jquery/3.4.1/jquery.min.js</code>è¿™ä¸ªåœ°å€ä¸Šè®¿é—®ï¼Œå‘ç°ç³»ç»Ÿå·²ç»é€šè¿‡webjarså°†èµ„æºåŠ è½½åˆ°äº†ã€‚åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œä½¿ç”¨scriptæ ‡ç­¾å¼•ç”¨webjarsä¹Ÿæ˜¯å¼•ç”¨è¿™ä¸ªåœ°å€çš„é™æ€æ–‡ä»¶ã€‚</p><h4 id="é¡¹ç›®å†…é™æ€èµ„æº"><a href="#é¡¹ç›®å†…é™æ€èµ„æº" class="headerlink" title="é¡¹ç›®å†…é™æ€èµ„æº"></a>é¡¹ç›®å†…é™æ€èµ„æº</h4><p>ä½¿ç”¨webjarsç”¨æ¥åŠ è½½é™æ€èµ„æºéå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯å¦‚æœè‡ªå·±å†™çš„jså’Œcssç­‰é™æ€èµ„æºä¹Ÿéœ€è¦åŠ è½½æ—¶ï¼Œå°±éœ€è¦æ”¾åˆ°SpringBooté»˜è®¤åŠ è½½çš„ç›®å½•ä¸‹ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.resources"</span>, ignoreUnknownFields = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceProperties</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; <span class="string">"classpath:/META-INF/resources/"</span>,</span><br><span class="line">    <span class="string">"classpath:/resources/"</span>, <span class="string">"classpath:/static/"</span>, <span class="string">"classpath:/public/"</span> &#125;;</span><br><span class="line"><span class="keyword">private</span> String[] staticLocations = CLASSPATH_RESOURCE_LOCATIONS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> addMappings = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Chain chain = <span class="keyword">new</span> Chain();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache cache = <span class="keyword">new</span> Cache();</span><br><span class="line">    <span class="comment">// è·å–é™æ€èµ„æºç›®å½•</span></span><br><span class="line"><span class="keyword">public</span> String[] getStaticLocations() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.staticLocations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡getStaticLocationsè·å–é™æ€èµ„æºçš„ç›®å½•ï¼Œé»˜è®¤çš„SpringBootå®šä¹‰äº†classpathä¸‹çš„ä»¥ä¸‹çš„æ–‡ä»¶ï¼Œéƒ½å¯ä»¥æ”¾ç½®é™æ€æ–‡ä»¶ï¼Œéƒ½å¯ä»¥é€šè¿‡urlçš„æ–¹å¼è®¿é—®åˆ°è¿™ä¸ªé™æ€æ–‡ä»¶ã€‚</p><ul><li><code>classpath:/META-INF/resources</code></li><li><code>classpath:/resources/</code></li><li><code>classpath:/static/</code></li><li><code>classpath:/public/</code></li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªclasspathå°±æ˜¯ä¸€å¼€å§‹åˆ›å»ºSpringBootåº”ç”¨å¸®æˆ‘ä»¬åˆ›å»ºå¥½çš„resourceè·¯å¾„</p></blockquote><p>è¿™ä¸ªç±»ä¹Ÿæ˜¯ä¸€ä¸ª<code>xxxxProperties</code>ç±»ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ”¹å˜ç›¸åº”çš„é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§æ¥æ”¹å˜è¿™ä¸ªè·¯å¾„ã€‚è¿™é‡Œçš„è·¯å¾„ä½¿ç”¨çš„å˜é‡æ˜¯<code>staticLocations</code>,æ‰€ä»¥ç›¸åº”çš„åœ¨application.propertiesæ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨<code>spring.resources.staticLocations=è·¯å¾„åç§°</code>å°±è¡Œäº†ã€‚</p><h5 id="ä¸»é¡µçš„è®¾ç½®"><a href="#ä¸»é¡µçš„è®¾ç½®" class="headerlink" title="ä¸»é¡µçš„è®¾ç½®"></a>ä¸»é¡µçš„è®¾ç½®</h5><p>SpringBooté»˜è®¤çš„ä½¿ç”¨é™æ€èµ„æºæ–‡ä»¶å¤¹ä¸‹çš„<code>index.html</code>ä½œä¸ºé¦–é¡µã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Optional&lt;Resource&gt; <span class="title">getWelcomePage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String[] locations = getResourceLocations(<span class="keyword">this</span>.resourceProperties.getStaticLocations());</span><br><span class="line">    <span class="comment">//éå†æ¯ä¸ªlocationså¯»æ‰¾index.htmlé¡µé¢ä½œä¸ºé¦–é¡µ</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(locations).map(<span class="keyword">this</span>::getIndexHtml).filter(<span class="keyword">this</span>::isReadable).findFirst();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Resource <span class="title">getIndexHtml</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.resourceLoader.getResource(location + <span class="string">"index.html"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœæ‰¾åˆ°ä¸»é¡µçš„index.htmlåï¼Œå°±å¼€å§‹åšä¸»é¡µçš„æ˜ å°„æ“ä½œ</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WelcomePageHandlerMapping(<span class="keyword">new</span> TemplateAvailabilityProviders(applicationContext),</span><br><span class="line">            applicationContext, getWelcomePage(), <span class="keyword">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,</span><br><span class="line">ApplicationContext applicationContext, Optional&lt;Resource&gt; welcomePage, String staticPathPattern) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œè®¾ç½®é¦–é¡µä¸ºindex.html æ˜ å°„è·¯å¾„ä¸ºï¼š /**</span></span><br><span class="line">    <span class="keyword">if</span> (welcomePage.isPresent() &amp;&amp; <span class="string">"/**"</span>.equals(staticPathPattern)) &#123;</span><br><span class="line">        logger.info(<span class="string">"Adding welcome page: "</span> + welcomePage.get());</span><br><span class="line">        setRootViewName(<span class="string">"forward:index.html"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><p>ä¸Šé¢æ˜¯ä¾æ®SpringBootåŠ è½½é™æ€èµ„æºçš„æ–¹å¼åšçš„ç®€å•æ€»ç»“ã€‚</p><h2 id="æ·»åŠ controller"><a href="#æ·»åŠ controller" class="headerlink" title="æ·»åŠ controller"></a>æ·»åŠ controller</h2><p>åœ¨ä¸Šä¸€æ­¥åˆ›å»ºå®Œé¡¹ç›®åï¼Œå¯ä»¥ç´§è·Ÿç€å†™ä¸€ä¸ªSpringMVCæµ‹è¯•çš„controllerï¼Œçœ‹çœ‹èƒ½å¦å¯åŠ¨é¡¹ç›®ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èµ·åˆ°äº†@Controllerå’Œ@Responsebodyä¸¤ç§ä½œç”¨ï¼Œå®é™…ä¸Šå°±æ˜¯</span></span><br><span class="line"><span class="comment">// ä¸¤ç§æ³¨è§£çš„æ•´åˆ</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœä½ ä¹Ÿåƒæˆ‘å‹¾é€‰æ¥æ•°æ®åº“ç›¸å…³çš„starters,åœ¨å¯åŠ¨æ—¶ï¼Œæ§åˆ¶å°ä¼šæç¤ºéœ€è¦é…ç½®æ•°æ®åº“çš„åŸºæœ¬é…ç½®ã€‚</p><blockquote><p>é‚£ä¹ˆæ€ä¹ˆæ‰¾è¿™äº›é…ç½®å‘¢ï¼Ÿ</p><ol><li>å»å®˜ç½‘æ‰¾é…ç½®</li><li>ç›´æ¥çœ‹ä»£ç </li></ol></blockquote><p><strong>å¦‚æœä½ æ²¡æœ‰ç¢°åˆ°ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆè¯·å¿½ç•¥ä»¥ä¸‹éƒ¨åˆ†ã€‚</strong></p><p>å› ä¸ºå‰å‡ ç¯‡æ–‡ç« ä¸­å·²ç»åˆ†ææ¥SpringBootæ˜¯å¦‚ä½•å®Œæˆè‡ªåŠ¨é…ç½®çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘æƒ³é€šè¿‡æ‰¾ä»£ç çš„æ–¹å¼ç›´æ¥çœ‹å®ƒèƒ½å¤Ÿé…ç½®å“ªäº›å±æ€§ã€‚</p><ol><li>é¦–å…ˆåœ¨<code>autoconfiguration</code>åŒ…ä¸‹é¢çš„spring.factoryä¸­æœç´¢jdbc</li></ol><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713174948.png" alt="jdbc"></p><ol start="2"><li>ç‚¹å‡»å…³äºDataSourceçš„è‡ªåŠ¨é…ç½®ç±»</li></ol><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties</span>(DataSourceProperties.class)</span><br><span class="line"><span class="meta">@Import</span>(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceInitializationConfiguration.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨DataSourcePropertiesç±»ä½œä¸ºå±æ€§ç±»,ä»¥ä¸‹ä¸ºåŸºæœ¬å±æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProperties</span> <span class="keyword">implements</span> <span class="title">BeanClassLoaderAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> generateUniqueName;</span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends DataSource&gt; type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String driverClassName;</span><br><span class="line"><span class="keyword">private</span> String url;</span><br><span class="line"><span class="keyword">private</span> String username;</span><br><span class="line"><span class="keyword">private</span> String password;</span><br></pre></td></tr></table></figure></div><p>æ ¹æ®DataSourcePropertiesç±»ï¼Œå¯ä»¥çŸ¥é“å¦‚æœæˆ‘ä»¬åƒé…ç½®DataSourceï¼Œé‚£ä¹ˆæœ‰è¿™å‡ ä¸ªå±æ€§å¯ä»¥è¿›è¡Œé…ç½®ã€‚</p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># spring.datasource ä¸ºå‰ç¼€ï¼Œåé¢ä¸ºå±æ€§åï¼Œå’ŒPropertiesç±»ä¸­çš„å±æ€§ç›¸å¯¹åº”ã€‚</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/springboot</span><br><span class="line">spring.datasource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br></pre></td></tr></table></figure></div><h2 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h2><p><img src="https://raw.githubusercontent.com/NanYinIU/PicRoom/master/img/20190713180029.png" alt="ç»“æœ"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨&quot;&gt;&lt;a href=&quot;#åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨&quot; class=&quot;headerlink&quot; title=&quot;åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨&quot;&gt;&lt;/a&gt;åˆ›å»ºåŸºæœ¬çš„webåº”ç”¨&lt;/h1&gt;&lt;p&gt;SpringBootå¯ä»¥å¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªrestfulçš„webåº”ç”¨ã€‚ä¸‹é¢å¼€å§‹ä»
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/categories/SpringBoot/"/>
    
    
      <category term="Java" scheme="https://nanyiniu.github.io/tags/Java/"/>
    
      <category term="SpringBoot" scheme="https://nanyiniu.github.io/tags/SpringBoot/"/>
    
  </entry>
  
</feed>
